<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - ADMIN GURU SUPER APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#1e40af',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans bg-gray-100 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-white rounded-xl p-6 flex flex-col items-center gap-4">
            <div class="loader"></div>
            <p class="text-gray-600">Memproses...</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 right-4 z-[100] hidden">
        <div class="bg-white rounded-lg shadow-lg p-4 flex items-center gap-3 max-w-sm border-l-4 border-green-500">
            <i id="toastIcon" class="fas fa-check-circle text-green-500 text-xl"></i>
            <p id="toastMessage" class="text-gray-700"></p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-red-600 to-red-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-shield-alt text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Super Admin Panel</h1>
                        <p class="text-red-200 text-sm">ADMIN GURU SUPER APP</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="adminEmail" class="text-sm text-red-200"></span>
                    <button onclick="goToDashboard()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm transition-all">
                        <i class="fas fa-home mr-2"></i>Dashboard User
                    </button>
                    <button onclick="handleLogout()" class="px-4 py-2 bg-red-900 hover:bg-red-950 rounded-lg text-sm transition-all">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-users text-blue-600 text-2xl"></i>
                    </div>
                    <div>
                        <p id="totalUsers" class="text-3xl font-bold text-gray-800">0</p>
                        <p class="text-gray-500 text-sm">Total User</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-yellow-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-crown text-yellow-600 text-2xl"></i>
                    </div>
                    <div>
                        <p id="premiumUsers" class="text-3xl font-bold text-gray-800">0</p>
                        <p class="text-gray-500 text-sm">User Premium</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-user-check text-green-600 text-2xl"></i>
                    </div>
                    <div>
                        <p id="freeUsers" class="text-3xl font-bold text-gray-800">0</p>
                        <p class="text-gray-500 text-sm">User Free</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center">
                        <i class="fas fa-clock text-purple-600 text-2xl"></i>
                    </div>
                    <div>
                        <p id="todayLogins" class="text-3xl font-bold text-gray-800">0</p>
                        <p class="text-gray-500 text-sm">Login Hari Ini</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings & Users Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Settings Panel -->
            <div class="bg-white rounded-xl shadow-sm">
                <div class="p-6 border-b">
                    <h2 class="text-lg font-bold text-gray-800">
                        <i class="fas fa-cog text-gray-500 mr-2"></i>Pengaturan
                    </h2>
                </div>
                <div class="p-6 space-y-6">
                    <!-- WhatsApp Setting -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fab fa-whatsapp text-green-500 mr-2"></i>Nomor WhatsApp Upgrade
                        </label>
                        <div class="flex gap-2">
                            <input type="text" id="whatsappNumber" placeholder="6281234567890"
                                class="flex-1 px-4 py-2.5 rounded-lg border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none">
                            <button onclick="saveWhatsApp()" class="px-4 py-2.5 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Format: 628xxx (tanpa + atau 0)</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="pt-4 border-t">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Aksi Cepat</h4>
                        <div class="space-y-2">
                            <button onclick="exportAllUsers()" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg text-left hover:bg-gray-50 transition-all">
                                <i class="fas fa-file-export text-blue-500 mr-2"></i>Export Semua User
                            </button>
                            <button onclick="showBulkUpgradeModal()" class="w-full px-4 py-2.5 border border-gray-200 rounded-lg text-left hover:bg-gray-50 transition-all">
                                <i class="fas fa-users-cog text-yellow-500 mr-2"></i>Upgrade Bulk (Sekolah)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm">
                <div class="p-6 border-b">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-users text-gray-500 mr-2"></i>Daftar User
                        </h2>
                        <div class="flex gap-2">
                            <input type="text" id="searchUser" placeholder="Cari email/nama..." oninput="filterUsers()"
                                class="px-4 py-2 rounded-lg border border-gray-200 focus:border-primary outline-none text-sm w-48">
                            <select id="filterSubscription" onchange="filterUsers()"
                                class="px-4 py-2 rounded-lg border border-gray-200 focus:border-primary outline-none text-sm">
                                <option value="">Semua</option>
                                <option value="free">Free</option>
                                <option value="premium">Premium</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">User</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Sekolah</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Status</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="divide-y">
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                    Memuat data user...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[90] hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">Upgrade User</h3>
                    <button onclick="closeUpgradeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <input type="hidden" id="upgradeUserId">
                <p class="mb-4">User: <strong id="upgradeUserEmail"></strong></p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Durasi Premium</label>
                        <select id="upgradeDuration" class="w-full px-4 py-2.5 rounded-lg border border-gray-200 focus:border-primary outline-none">
                            <option value="30">1 Bulan</option>
                            <option value="90">3 Bulan</option>
                            <option value="180">6 Bulan</option>
                            <option value="365" selected>1 Tahun</option>
                            <option value="lifetime">Selamanya</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="closeUpgradeModal()" class="px-4 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                        Batal
                    </button>
                    <button onclick="confirmUpgrade()" class="px-4 py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-all">
                        <i class="fas fa-crown mr-2"></i>Upgrade
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upgrade Modal -->
    <div id="bulkUpgradeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[90] hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">Upgrade Paket Sekolah</h3>
                    <button onclick="closeBulkUpgradeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email User (satu per baris)</label>
                        <textarea id="bulkEmails" rows="6" placeholder="guru1@gmail.com&#10;guru2@gmail.com&#10;guru3@gmail.com"
                            class="w-full px-4 py-2.5 rounded-lg border border-gray-200 focus:border-primary outline-none resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Durasi Premium</label>
                        <select id="bulkDuration" class="w-full px-4 py-2.5 rounded-lg border border-gray-200 focus:border-primary outline-none">
                            <option value="30">1 Bulan</option>
                            <option value="90">3 Bulan</option>
                            <option value="180">6 Bulan</option>
                            <option value="365" selected>1 Tahun</option>
                            <option value="lifetime">Selamanya</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="closeBulkUpgradeModal()" class="px-4 py-2.5 border border-gray-200 rounded-lg hover:bg-gray-50 transition-all">
                        Batal
                    </button>
                    <button onclick="confirmBulkUpgrade()" class="px-4 py-2.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-all">
                        <i class="fas fa-users-cog mr-2"></i>Upgrade Semua
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        let allUsers = [];
        
        // Check admin auth
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(async user => {
                if (user && user.email.toLowerCase() === SUPER_ADMIN_EMAIL.toLowerCase()) {
                    document.getElementById('adminEmail').textContent = user.email;
                    loadAdminData();
                } else {
                    window.location.href = 'index.html';
                }
            });
        });
        
        async function loadAdminData() {
            try {
                // Load settings
                const settingsDoc = await db.collection('settings').doc('admin').get();
                if (settingsDoc.exists) {
                    document.getElementById('whatsappNumber').value = settingsDoc.data().whatsAppUpgrade || '';
                }
                
                // Load users
                const usersSnapshot = await db.collection('users').get();
                allUsers = [];
                let premium = 0, free = 0, todayLogins = 0;
                const today = new Date().toDateString();
                
                usersSnapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    allUsers.push(user);
                    
                    if (user.subscription === 'premium') premium++;
                    else free++;
                    
                    if (user.lastLogin && user.lastLogin.toDate().toDateString() === today) {
                        todayLogins++;
                    }
                });
                
                // Update stats
                document.getElementById('totalUsers').textContent = allUsers.length;
                document.getElementById('premiumUsers').textContent = premium;
                document.getElementById('freeUsers').textContent = free;
                document.getElementById('todayLogins').textContent = todayLogins;
                
                // Render table
                renderUsersTable(allUsers);
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                            Tidak ada user ditemukan
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div>
                            <p class="font-medium text-gray-800">${user.displayName || '-'}</p>
                            <p class="text-sm text-gray-500">${user.email}</p>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                        ${user.namaSekolah || '-'}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${user.subscription === 'premium' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                            <i class="fas fa-crown mr-1 ${user.subscription === 'premium' ? '' : 'hidden'}"></i>
                            ${user.subscription === 'premium' ? 'Premium' : 'Free'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${user.subscription === 'premium' 
                            ? `<button onclick="revokeSubscription('${user.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Revoke">
                                   <i class="fas fa-times-circle"></i>
                               </button>`
                            : `<button onclick="showUpgradeModal('${user.id}', '${user.email}')" class="p-2 text-yellow-500 hover:bg-yellow-50 rounded-lg transition-all" title="Upgrade">
                                   <i class="fas fa-crown"></i>
                               </button>`
                        }
                    </td>
                </tr>
            `).join('');
        }
        
        function filterUsers() {
            const search = document.getElementById('searchUser').value.toLowerCase();
            const subscription = document.getElementById('filterSubscription').value;
            
            let filtered = allUsers;
            
            if (search) {
                filtered = filtered.filter(u => 
                    (u.email && u.email.toLowerCase().includes(search)) ||
                    (u.displayName && u.displayName.toLowerCase().includes(search))
                );
            }
            
            if (subscription) {
                filtered = filtered.filter(u => u.subscription === subscription);
            }
            
            renderUsersTable(filtered);
        }
        
        async function saveWhatsApp() {
            const number = document.getElementById('whatsappNumber').value.trim();
            
            try {
                await db.collection('settings').doc('admin').set({
                    whatsAppUpgrade: number,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                showToast('Nomor WhatsApp berhasil disimpan', 'success');
            } catch (error) {
                console.error('Error saving WhatsApp:', error);
                showToast('Gagal menyimpan', 'error');
            }
        }
        
        function showUpgradeModal(userId, email) {
            document.getElementById('upgradeUserId').value = userId;
            document.getElementById('upgradeUserEmail').textContent = email;
            document.getElementById('upgradeModal').classList.remove('hidden');
        }
        
        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }
        
        async function confirmUpgrade() {
            const userId = document.getElementById('upgradeUserId').value;
            const duration = document.getElementById('upgradeDuration').value;
            
            showLoading();
            
            try {
                let expiryDate = null;
                
                if (duration !== 'lifetime') {
                    expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + parseInt(duration));
                }
                
                await db.collection('users').doc(userId).update({
                    subscription: 'premium',
                    subscriptionExpiry: expiryDate,
                    upgradedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    upgradedBy: auth.currentUser.email
                });
                
                closeUpgradeModal();
                loadAdminData();
                showToast('User berhasil di-upgrade ke Premium', 'success');
            } catch (error) {
                console.error('Error upgrading user:', error);
                showToast('Gagal upgrade user', 'error');
            }
            
            hideLoading();
        }
        
        async function revokeSubscription(userId) {
            if (!confirm('Yakin ingin mencabut status Premium user ini?')) return;
            
            showLoading();
            
            try {
                await db.collection('users').doc(userId).update({
                    subscription: 'free',
                    subscriptionExpiry: null
                });
                
                loadAdminData();
                showToast('Status Premium berhasil dicabut', 'success');
            } catch (error) {
                console.error('Error revoking subscription:', error);
                showToast('Gagal mencabut status', 'error');
            }
            
            hideLoading();
        }
        
        function showBulkUpgradeModal() {
            document.getElementById('bulkUpgradeModal').classList.remove('hidden');
        }
        
        function closeBulkUpgradeModal() {
            document.getElementById('bulkUpgradeModal').classList.add('hidden');
        }
        
        async function confirmBulkUpgrade() {
            const emailsText = document.getElementById('bulkEmails').value.trim();
            const duration = document.getElementById('bulkDuration').value;
            
            if (!emailsText) {
                showToast('Masukkan email user', 'warning');
                return;
            }
            
            const emails = emailsText.split('\n').map(e => e.trim().toLowerCase()).filter(e => e);
            
            showLoading();
            
            try {
                let expiryDate = null;
                if (duration !== 'lifetime') {
                    expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + parseInt(duration));
                }
                
                let upgraded = 0;
                
                for (const email of emails) {
                    // Find user by email
                    const userSnapshot = await db.collection('users').where('email', '==', email).get();
                    
                    if (!userSnapshot.empty) {
                        const userId = userSnapshot.docs[0].id;
                        await db.collection('users').doc(userId).update({
                            subscription: 'premium',
                            subscriptionExpiry: expiryDate,
                            upgradedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            upgradedBy: auth.currentUser.email
                        });
                        upgraded++;
                    }
                }
                
                closeBulkUpgradeModal();
                loadAdminData();
                showToast(`${upgraded} dari ${emails.length} user berhasil di-upgrade`, 'success');
            } catch (error) {
                console.error('Error bulk upgrading:', error);
                showToast('Terjadi kesalahan', 'error');
            }
            
            hideLoading();
        }
        
        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }
        
        function exportAllUsers() {
            let csv = 'Email;Nama;Sekolah;Jenjang;Subscription;Last Login\n';
            
            allUsers.forEach(user => {
                const lastLogin = user.lastLogin ? user.lastLogin.toDate().toLocaleDateString('id-ID') : '-';
                csv += `${user.email || ''};${user.displayName || ''};${user.namaSekolah || ''};${user.jenjang || ''};${user.subscription || 'free'};${lastLogin}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `users_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('Data user berhasil di-export', 'success');
        }
    </script>

    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc2626;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>