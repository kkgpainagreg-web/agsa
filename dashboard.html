<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'arabic': ['Amiri', 'serif'],
                    },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .rtl-text { direction: rtl; font-family: 'Amiri', serif; font-size: 1.2em; line-height: 2; }
        .sidebar-item.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); border-left: 3px solid #3b82f6; }
        .sidebar-item:hover:not(.active) { background: rgba(59, 130, 246, 0.05); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        @media print { .no-print { display: none !important; } body { background: white; } .print-only { display: block !important; } }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 flex flex-col items-center space-y-4 shadow-2xl">
            <div class="loading-spinner"></div>
            <p class="text-gray-600 font-medium" id="loadingText">Memproses...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-[100] transform translate-x-full transition-transform duration-300">
        <div id="toastContent" class="px-6 py-4 rounded-xl shadow-2xl flex items-center space-x-3">
            <i id="toastIcon" class="text-xl"></i>
            <span id="toastMessage" class="font-medium"></span>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-white shadow-xl z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-chalkboard-teacher text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Admin Guru</h1>
                    <p class="text-xs text-gray-500">Super App v1.0</p>
                </div>
            </div>
        </div>

        <!-- User Info Card -->
        <div class="p-4">
            <div class="bg-gradient-to-r from-primary-500 to-purple-600 rounded-xl p-4 text-white">
                <div class="flex items-center space-x-3">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=ffffff&color=3b82f6" 
                         class="w-12 h-12 rounded-full border-2 border-white border-opacity-30" alt="Avatar">
                    <div class="flex-1 min-w-0">
                        <p id="userName" class="font-semibold truncate">Loading...</p>
                        <p id="userEmail" class="text-xs text-white text-opacity-80 truncate">Loading...</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-white border-opacity-20">
                    <div class="flex items-center justify-between">
                        <span id="subscriptionBadge" class="px-2 py-1 bg-white bg-opacity-20 rounded-full text-xs font-medium">Free</span>
                        <span id="academicYearBadge" class="text-xs text-white text-opacity-80">2024/2025</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto px-3 py-2">
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Menu Utama</p>
                <a href="#" onclick="loadSection('dashboard')" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-home w-5 text-center text-primary-500"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" onclick="loadSection('profile')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-user w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Profil & Sekolah</span>
                </a>
            </div>

            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Data Dasar</p>
                <a href="#" onclick="loadSection('calendar')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-alt w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Kalender Pendidikan</span>
                </a>
                <a href="#" onclick="loadSection('schedule')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-clock w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Jadwal Pelajaran</span>
                </a>
                <a href="#" onclick="loadSection('students')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-users w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Data Siswa</span>
                </a>
            </div>

            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Dokumen Pembelajaran</p>
                <a href="#" onclick="loadSection('cp')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-bullseye w-5 text-center text-gray-400"></i>
                    <span class="font-medium">CP & TP</span>
                </a>
                <a href="#" onclick="loadSection('atp')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-route w-5 text-center text-gray-400"></i>
                    <span class="font-medium">ATP</span>
                </a>
                <a href="#" onclick="loadSection('prota')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-check w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Prota</span>
                </a>
                <a href="#" onclick="loadSection('promes')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-week w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Promes</span>
                </a>
                <a href="#" onclick="loadSection('modul-ajar')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-book w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Modul Ajar</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Pro</span>
                </a>
                <a href="#" onclick="loadSection('lkpd')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-file-alt w-5 text-center text-gray-400"></i>
                    <span class="font-medium">LKPD</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Pro</span>
                </a>
            </div>

            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Akademik</p>
                <a href="#" onclick="loadSection('attendance')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-clipboard-check w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Absensi</span>
                </a>
                <a href="#" onclick="loadSection('journal')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-journal-whills w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Jurnal Pembelajaran</span>
                </a>
                <a href="#" onclick="loadSection('grades')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-star w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Daftar Nilai</span>
                </a>
                <a href="#" onclick="loadSection('bank-soal')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-question-circle w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Bank Soal</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Pro</span>
                </a>
            </div>

            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Tools</p>
                <a href="#" onclick="loadSection('ai-assistant')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-robot w-5 text-center text-gray-400"></i>
                    <span class="font-medium">AI Assistant</span>
                </a>
                <a href="#" onclick="loadSection('import-data')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-file-import w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Import Data</span>
                </a>
                <a href="#" onclick="loadSection('guide')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-book-open w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Panduan</span>
                </a>
            </div>
        </nav>

        <!-- Upgrade Banner -->
        <div id="upgradeBanner" class="p-4 border-t border-gray-100">
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 border border-yellow-200">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-crown text-yellow-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">Upgrade Premium</p>
                        <p class="text-xs text-gray-500">Akses semua fitur</p>
                    </div>
                </div>
                <button onclick="showUpgradeModal()" class="w-full py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-semibold rounded-lg hover:from-yellow-600 hover:to-orange-600 transition-all text-sm">
                    Upgrade Sekarang
                </button>
            </div>
        </div>

        <!-- Logout -->
        <div class="p-4 border-t border-gray-100">
            <button onclick="logout()" class="w-full flex items-center justify-center space-x-2 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-all font-medium">
                <i class="fas fa-sign-out-alt"></i>
                <span>Keluar</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="lg:ml-72 min-h-screen">
        <!-- Top Header -->
        <header class="bg-white shadow-sm sticky top-0 z-30 no-print">
            <div class="flex items-center justify-between px-4 lg:px-8 py-4">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fas fa-bars text-gray-600 text-xl"></i>
                </button>
                <div class="hidden lg:block">
                    <h1 id="pageTitle" class="text-xl font-bold text-gray-800">Dashboard</h1>
                    <p id="pageSubtitle" class="text-sm text-gray-500">Selamat datang kembali!</p>
                </div>
                <div class="flex items-center space-x-4">
                    <select id="academicYearSelect" onchange="changeAcademicYear(this.value)" 
                            class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-transparent"></select>
                    <button class="relative p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-bell text-gray-600 text-lg"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <img id="headerUserAvatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" class="w-8 h-8 rounded-full" alt="Avatar">
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </button>
                        <div id="userMenu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 hidden">
                            <a href="#" onclick="loadSection('profile')" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50"><i class="fas fa-user text-gray-400"></i><span class="text-gray-700">Profil</span></a>
                            <a href="#" onclick="loadSection('guide')" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50"><i class="fas fa-question-circle text-gray-400"></i><span class="text-gray-700">Bantuan</span></a>
                            <hr class="my-1">
                            <a href="#" onclick="logout()" class="flex items-center space-x-3 px-4 py-3 hover:bg-red-50 text-red-600"><i class="fas fa-sign-out-alt"></i><span>Keluar</span></a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="contentArea" class="p-4 lg:p-8"></div>
    </main>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-crown text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Upgrade ke Premium</h3>
                <p class="text-gray-500">Dapatkan akses penuh ke semua fitur aplikasi</p>
            </div>
            <div class="space-y-3 mb-6">
                <div class="flex items-center space-x-3 text-gray-700"><i class="fas fa-check-circle text-green-500"></i><span>Modul Ajar lengkap dengan LKPD</span></div>
                <div class="flex items-center space-x-3 text-gray-700"><i class="fas fa-check-circle text-green-500"></i><span>Bank Soal terintegrasi ATP</span></div>
                <div class="flex items-center space-x-3 text-gray-700"><i class="fas fa-check-circle text-green-500"></i><span>Export dokumen ke Word/PDF</span></div>
                <div class="flex items-center space-x-3 text-gray-700"><i class="fas fa-check-circle text-green-500"></i><span>Support teks Arab (RTL)</span></div>
            </div>
            <div class="space-y-3">
                <a id="whatsappUpgradeLink" href="#" target="_blank" class="block w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl hover:from-green-600 hover:to-green-700 transition-all text-center">
                    <i class="fab fa-whatsapp mr-2"></i>Hubungi via WhatsApp
                </a>
                <button onclick="closeUpgradeModal()" class="w-full py-3 border border-gray-200 text-gray-600 font-medium rounded-xl hover:bg-gray-50 transition-all">Nanti Saja</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
            authDomain: "agsa-e5b08.firebaseapp.com",
            projectId: "agsa-e5b08",
            storageBucket: "agsa-e5b08.firebasestorage.app",
            messagingSenderId: "916052746331",
            appId: "1:916052746331:web:357cbadbfd8658f1689f7e",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ===== GLOBAL STATE =====
        let currentUser = null;
        let userData = null;
        let currentSection = 'dashboard';
        let whatsappAdmin = '6281234567890';
        let calendarData = null;
        let scheduleItems = [];
        let allStudents = [];
        let timeSlots = [];

        // ===== HELPER FUNCTIONS =====
        function academicYearToDocId(year) { return year.replace('/', '-'); }
        function docIdToAcademicYear(docId) { return docId.replace('-', '/'); }

        function showLoading(text = 'Memproses...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastContent = document.getElementById('toastContent');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');
            const types = {
                success: { bg: 'bg-green-500', icon: 'fas fa-check-circle' },
                error: { bg: 'bg-red-500', icon: 'fas fa-exclamation-circle' },
                warning: { bg: 'bg-yellow-500', icon: 'fas fa-exclamation-triangle' },
                info: { bg: 'bg-blue-500', icon: 'fas fa-info-circle' }
            };
            toastContent.className = `${types[type].bg} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center space-x-3`;
            toastIcon.className = `${types[type].icon} text-xl`;
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.toggle('hidden');
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        function getAcademicYearOptions() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            if (month >= 6) {
                return [`${year - 1}/${year}`, `${year}/${year + 1}`];
            }
            return [`${year - 1}/${year}`, `${year}/${year + 1}`];
        }

        function getCurrentAcademicYear() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            return month >= 7 ? `${year}/${year + 1}` : `${year - 1}/${year}`;
        }

        function populateAcademicYearSelect() {
            const select = document.getElementById('academicYearSelect');
            const options = getAcademicYearOptions();
            const current = userData?.academicYear || getCurrentAcademicYear();
            select.innerHTML = options.map(opt => `<option value="${opt}" ${opt === current ? 'selected' : ''}>${opt}</option>`).join('');
        }

        async function changeAcademicYear(year) {
            if (!currentUser) return;
            showLoading('Mengubah tahun ajaran...');
            try {
                await db.collection('users').doc(currentUser.uid).update({ academicYear: year });
                userData.academicYear = year;
                document.getElementById('academicYearBadge').textContent = year;
                showToast('Tahun ajaran berhasil diubah', 'success');
                loadSection(currentSection);
            } catch (error) {
                console.error(error);
                showToast('Gagal mengubah tahun ajaran', 'error');
            }
            hideLoading();
        }

                // ===== PERBAIKAN: CHECK PREMIUM ACCESS =====
        function checkPremiumAccess() {
            if (!userData) {
                console.log('checkPremiumAccess: userData is null');
                return false;
            }
            
            console.log('checkPremiumAccess: subscription =', userData.subscription);
            console.log('checkPremiumAccess: subscriptionExpiry =', userData.subscriptionExpiry);
            
            // Check if subscription is premium
            if (userData.subscription === 'premium') {
                // Check if has expiry date
                if (userData.subscriptionExpiry) {
                    let expiryDate;
                    // Handle both Firestore Timestamp and regular date
                    if (userData.subscriptionExpiry.toDate) {
                        expiryDate = userData.subscriptionExpiry.toDate();
                    } else if (userData.subscriptionExpiry.seconds) {
                        expiryDate = new Date(userData.subscriptionExpiry.seconds * 1000);
                    } else {
                        expiryDate = new Date(userData.subscriptionExpiry);
                    }
                    
                    const now = new Date();
                    console.log('checkPremiumAccess: expiryDate =', expiryDate, ', now =', now);
                    
                    if (expiryDate > now) {
                        console.log('checkPremiumAccess: PREMIUM ACTIVE');
                        return true;
                    } else {
                        console.log('checkPremiumAccess: PREMIUM EXPIRED');
                        // Optional: Auto-downgrade expired premium
                        // updateSubscriptionToFree();
                        return false;
                    }
                } else {
                    // Premium without expiry = lifetime premium
                    console.log('checkPremiumAccess: PREMIUM LIFETIME');
                    return true;
                }
            }
            
            console.log('checkPremiumAccess: NOT PREMIUM');
            return false;
        }

        // Optional: Auto downgrade expired premium
        async function updateSubscriptionToFree() {
            if (!currentUser) return;
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    subscription: 'free',
                    subscriptionExpiry: null
                });
                userData.subscription = 'free';
                userData.subscriptionExpiry = null;
                updateUserDisplay();
            } catch (error) {
                console.error('Error updating subscription:', error);
            }
        }

        function showUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            const link = document.getElementById('whatsappUpgradeLink');
            link.href = `https://wa.me/${whatsappAdmin}?text=Halo, saya ingin upgrade ke Premium untuk Admin Guru Super App. Email: ${currentUser?.email}`;
            modal.classList.remove('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // ===== CP DATA PAI (KEPKA BSKAP 046/H/KR/2025) =====
        const CP_DATA_PAI = {
            phases: {
                'A': {
                    name: 'Fase A', grades: ['1', '2'], level: 'SD',
                    elements: [
                        { id: 'quran-hadis-a', name: 'Al-Quran dan Hadis', description: 'Mengenal huruf hijaiah dan membaca surah pendek',
                          tujuanPembelajaran: [
                            'Peserta didik mampu mengenal huruf hijaiah dengan benar',
                            'Peserta didik mampu membaca surah Al-Fatihah dengan tartil',
                            'Peserta didik mampu menghafal surah-surah pendek (An-Nas, Al-Falaq, Al-Ikhlas)',
                            'Peserta didik mampu mengenal hadis tentang kebersihan'
                          ]
                        },
                        { id: 'akidah-a', name: 'Akidah', description: 'Mengenal rukun iman dan sifat Allah',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menyebutkan rukun iman dengan urut',
                            'Peserta didik mampu meyakini Allah sebagai pencipta',
                            'Peserta didik mampu mengenal sifat-sifat Allah (Ar-Rahman, Ar-Rahim)',
                            'Peserta didik mampu menunjukkan sikap syukur kepada Allah'
                          ]
                        },
                        { id: 'akhlak-a', name: 'Akhlak', description: 'Akhlak terhadap diri sendiri dan keluarga',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menerapkan perilaku jujur dalam kehidupan sehari-hari',
                            'Peserta didik mampu menunjukkan sikap hormat kepada orang tua',
                            'Peserta didik mampu menjaga kebersihan diri',
                            'Peserta didik mampu berbicara dengan sopan'
                          ]
                        },
                        { id: 'fikih-a', name: 'Fikih', description: 'Mengenal rukun Islam dan tata cara bersuci',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menyebutkan rukun Islam dengan urut',
                            'Peserta didik mampu mempraktikkan cara berwudhu',
                            'Peserta didik mampu mengenal gerakan shalat',
                            'Peserta didik mampu membedakan najis dan cara membersihkannya'
                          ]
                        },
                        { id: 'sejarah-a', name: 'Sejarah Peradaban Islam', description: 'Mengenal kisah Nabi dan Rasul',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menceritakan kisah Nabi Adam AS',
                            'Peserta didik mampu menceritakan kisah Nabi Nuh AS',
                            'Peserta didik mampu meneladani sifat terpuji para Nabi',
                            'Peserta didik mampu menghargai perjuangan para Nabi'
                          ]
                        }
                    ]
                },
                'B': {
                    name: 'Fase B', grades: ['3', '4'], level: 'SD',
                    elements: [
                        { id: 'quran-hadis-b', name: 'Al-Quran dan Hadis', description: 'Membaca ayat-ayat tentang shalat',
                          tujuanPembelajaran: [
                            'Peserta didik mampu membaca ayat-ayat Al-Quran tentang shalat dengan tartil',
                            'Peserta didik mampu menghafal surah-surah pendek juz 30',
                            'Peserta didik mampu memahami kandungan ayat tentang perintah shalat',
                            'Peserta didik mampu menghafal hadis tentang shalat lima waktu'
                          ]
                        },
                        { id: 'akidah-b', name: 'Akidah', description: 'Mengenal Asmaul Husna',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menyebutkan 10 Asmaul Husna',
                            'Peserta didik mampu memahami makna sifat-sifat Allah',
                            'Peserta didik mampu meyakini keesaan Allah',
                            'Peserta didik mampu menerapkan nilai-nilai Asmaul Husna dalam kehidupan'
                          ]
                        },
                        { id: 'akhlak-b', name: 'Akhlak', description: 'Adab kepada orang tua dan guru',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menunjukkan sikap berbakti kepada orang tua',
                            'Peserta didik mampu menghormati guru',
                            'Peserta didik mampu menerapkan adab bergaul dengan teman',
                            'Peserta didik mampu menunjukkan sikap tolong-menolong'
                          ]
                        },
                        { id: 'fikih-b', name: 'Fikih', description: 'Tata cara shalat dan puasa',
                          tujuanPembelajaran: [
                            'Peserta didik mampu mempraktikkan shalat lima waktu dengan benar',
                            'Peserta didik mampu memahami syarat sah shalat',
                            'Peserta didik mampu mengenal puasa Ramadhan',
                            'Peserta didik mampu memahami hikmah puasa'
                          ]
                        },
                        { id: 'sejarah-b', name: 'Sejarah Peradaban Islam', description: 'Sirah Nabi periode Makkah',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menceritakan kelahiran Nabi Muhammad SAW',
                            'Peserta didik mampu menceritakan masa kanak-kanak Nabi',
                            'Peserta didik mampu memahami dakwah Nabi di Makkah',
                            'Peserta didik mampu meneladani akhlak Nabi Muhammad SAW'
                          ]
                        }
                    ]
                },
                'C': {
                    name: 'Fase C', grades: ['5', '6'], level: 'SD',
                    elements: [
                        { id: 'quran-hadis-c', name: 'Al-Quran dan Hadis', description: 'Ayat tentang keragaman dan toleransi',
                          tujuanPembelajaran: [
                            'Peserta didik mampu membaca QS. Al-Hujurat ayat 13 tentang keragaman',
                            'Peserta didik mampu memahami makna toleransi dalam Islam',
                            'Peserta didik mampu menghafal hadis tentang persaudaraan',
                            'Peserta didik mampu menerapkan nilai toleransi dalam kehidupan'
                          ]
                        },
                        { id: 'akidah-c', name: 'Akidah', description: 'Iman kepada hari akhir',
                          tujuanPembelajaran: [
                            'Peserta didik mampu memahami konsep hari akhir',
                            'Peserta didik mampu meyakini adanya qada dan qadar',
                            'Peserta didik mampu menjelaskan tanda-tanda hari kiamat',
                            'Peserta didik mampu mengambil hikmah dari iman kepada hari akhir'
                          ]
                        },
                        { id: 'akhlak-c', name: 'Akhlak', description: 'Adab sosial dan bermasyarakat',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menerapkan adab bertetangga',
                            'Peserta didik mampu menunjukkan sikap peduli sosial',
                            'Peserta didik mampu menghargai perbedaan dalam masyarakat',
                            'Peserta didik mampu berpartisipasi dalam kegiatan sosial'
                          ]
                        },
                        { id: 'fikih-c', name: 'Fikih', description: 'Zakat, infaq, dan shadaqah',
                          tujuanPembelajaran: [
                            'Peserta didik mampu memahami pengertian zakat fitrah',
                            'Peserta didik mampu membedakan infaq dan shadaqah',
                            'Peserta didik mampu menghitung zakat fitrah',
                            'Peserta didik mampu mempraktikkan pemberian infaq dan shadaqah'
                          ]
                        },
                        { id: 'sejarah-c', name: 'Sejarah Peradaban Islam', description: 'Sirah Nabi periode Madinah',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menceritakan peristiwa hijrah ke Madinah',
                            'Peserta didik mampu memahami pembentukan masyarakat Madinah',
                            'Peserta didik mampu menceritakan perjanjian Hudaibiyah',
                            'Peserta didik mampu meneladani kepemimpinan Nabi di Madinah'
                          ]
                        }
                    ]
                },
                'D': {
                    name: 'Fase D', grades: ['7', '8', '9'], level: 'SMP',
                    elements: [
                        { id: 'quran-hadis-d', name: 'Al-Quran dan Hadis', description: 'Ayat tentang toleransi dan moderasi',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menganalisis QS. Al-Kafirun tentang toleransi',
                            'Peserta didik mampu memahami konsep moderasi beragama',
                            'Peserta didik mampu menghafal dan memahami hadis tentang toleransi',
                            'Peserta didik mampu menerapkan sikap moderat dalam beragama'
                          ]
                        },
                        { id: 'akidah-d', name: 'Akidah', description: 'Pendalaman rukun iman',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menganalisis bukti-bukti keberadaan Allah',
                            'Peserta didik mampu memahami sifat wajib, mustahil, dan jaiz Allah',
                            'Peserta didik mampu menganalisis fungsi malaikat',
                            'Peserta didik mampu memahami hikmah beriman kepada kitab-kitab Allah'
                          ]
                        },
                        { id: 'akhlak-d', name: 'Akhlak', description: 'Etika digital dan bermedia sosial',
                          tujuanPembelajaran: [
                            'Peserta didik mampu memahami etika dalam bermedia sosial',
                            'Peserta didik mampu menghindari konten negatif di internet',
                            'Peserta didik mampu menyebarkan konten positif',
                            'Peserta didik mampu bijak dalam menggunakan teknologi'
                          ]
                        },
                        { id: 'fikih-d', name: 'Fikih', description: 'Sujud syukur, tilawah, dan haji',
                          tujuanPembelajaran: [
                            'Peserta didik mampu mempraktikkan sujud syukur',
                            'Peserta didik mampu mempraktikkan sujud tilawah',
                            'Peserta didik mampu memahami tata cara haji dan umrah',
                            'Peserta didik mampu menjelaskan hikmah ibadah haji'
                          ]
                        },
                        { id: 'sejarah-d', name: 'Sejarah Peradaban Islam', description: 'Bani Umayyah hingga Mughal',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menganalisis perkembangan Dinasti Umayyah',
                            'Peserta didik mampu memahami kejayaan Dinasti Abbasiyah',
                            'Peserta didik mampu mengenal peradaban Islam di Andalusia',
                            'Peserta didik mampu menganalisis kerajaan Islam di India (Mughal)'
                          ]
                        }
                    ]
                },
                'E': {
                    name: 'Fase E', grades: ['10'], level: 'SMA/SMK',
                    elements: [
                        { id: 'quran-hadis-e', name: 'Al-Quran dan Hadis', description: 'Kompetisi dalam kebaikan',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menganalisis QS. Al-Baqarah: 148 tentang fastabiqul khairat',
                            'Peserta didik mampu memahami konsep berlomba dalam kebaikan',
                            'Peserta didik mampu mengkaji hadis tentang amal terbaik',
                            'Peserta didik mampu menerapkan semangat kompetisi positif'
                          ]
                        },
                        { id: 'akidah-e', name: 'Akidah', description: "Syu'ab al-Iman",
                          tujuanPembelajaran: [
                            "Peserta didik mampu memahami konsep syu'ab al-iman",
                            'Peserta didik mampu mengidentifikasi cabang-cabang iman',
                            'Peserta didik mampu menganalisis hubungan iman dan amal',
                            'Peserta didik mampu menerapkan nilai-nilai iman dalam kehidupan'
                          ]
                        },
                        { id: 'akhlak-e', name: 'Akhlak', description: 'Etika bekerja dan berkarir',
                          tujuanPembelajaran: [
                            'Peserta didik mampu memahami etos kerja Islami',
                            'Peserta didik mampu menerapkan kejujuran dalam bekerja',
                            'Peserta didik mampu memahami konsep rezeki halal',
                            'Peserta didik mampu merencanakan karir sesuai nilai Islam'
                          ]
                        },
                        { id: 'fikih-e', name: 'Fikih', description: 'Prinsip hukum Islam',
                          tujuanPembelajaran: [
                            'Peserta didik mampu memahami sumber hukum Islam',
                            'Peserta didik mampu menganalisis metode istinbath hukum',
                            'Peserta didik mampu memahami prinsip maslahah',
                            'Peserta didik mampu mengaplikasikan fiqih dalam konteks kekinian'
                          ]
                        },
                        { id: 'sejarah-e', name: 'Sejarah Peradaban Islam', description: 'Islam di Indonesia',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menganalisis masuknya Islam ke Indonesia',
                            'Peserta didik mampu memahami peran Walisongo',
                            'Peserta didik mampu mengkaji kerajaan-kerajaan Islam di Nusantara',
                            'Peserta didik mampu mengapresiasi kontribusi ulama Indonesia'
                          ]
                        }
                    ]
                },
                'F': {
                    name: 'Fase F', grades: ['11', '12'], level: 'SMA/SMK',
                    elements: [
                        { id: 'quran-hadis-f', name: 'Al-Quran dan Hadis', description: 'Ayat-ayat kauniyah',
                          tujuanPembelajaran: [
                            'Peserta didik mampu menganalisis ayat-ayat kauniyah dalam Al-Quran',
                            'Peserta didik mampu memahami integrasi sains dan Al-Quran',
                            'Peserta didik mampu mengkaji hadis tentang menuntut ilmu',
                            'Peserta didik mampu mengembangkan sikap ilmiah berbasis Al-Quran'
                          ]
                        },
                        { id: 'akidah-f', name: 'Akidah', description: 'Pemikiran kalam klasik dan modern',
                          tujuanPembelajaran: [
                            'Peserta didik mampu memahami sejarah ilmu kalam',
                            'Peserta didik mampu menganalisis aliran-aliran dalam Islam',
                            'Peserta didik mampu memahami pemikiran Islam modern',
                            'Peserta didik mampu bersikap bijak terhadap perbedaan pemikiran'
                          ]
                        },
                        { id: 'akhlak-f', name: 'Akhlak', description: 'Etika digital dan tanggung jawab global',
                          tujuanPembelajaran: [
                            'Peserta didik mampu memahami etika dalam era digital',
                            'Peserta didik mampu menerapkan literasi digital Islami',
                            'Peserta didik mampu berpartisipasi dalam isu global',
                            'Peserta didik mampu menjadi warga digital yang bertanggung jawab'
                          ]
                        },
                        { id: 'fikih-f', name: 'Fikih', description: 'Mawaris dan muamalah kontemporer',
                          tujuanPembelajaran: [
                            'Peserta didik mampu memahami hukum waris dalam Islam',
                            'Peserta didik mampu menghitung pembagian waris',
                            'Peserta didik mampu menganalisis muamalah kontemporer',
                            'Peserta didik mampu memahami ekonomi syariah'
                          ]
                        },
                        { id: 'sejarah-f', name: 'Sejarah Peradaban Islam', description: 'Organisasi Islam dunia',
                          tujuanPembelajaran: [
                            'Peserta didik mampu mengenal organisasi Islam internasional',
                            'Peserta didik mampu menganalisis isu-isu kontemporer umat Islam',
                            'Peserta didik mampu memahami peran Indonesia di dunia Islam',
                            'Peserta didik mampu berkontribusi untuk kemajuan umat'
                          ]
                        }
                    ]
                }
            }
        };

        function getPhaseByClass(kelas, level) {
            const kelasNum = parseInt(kelas);
            if (level === 'SD') {
                if (kelasNum <= 2) return 'A';
                if (kelasNum <= 4) return 'B';
                return 'C';
            } else if (level === 'SMP') {
                return 'D';
            } else {
                if (kelasNum === 10) return 'E';
                return 'F';
            }
        }

        function generateClassOptions(level) {
            let grades = [];
            switch(level) {
                case 'SD': grades = ['1', '2', '3', '4', '5', '6']; break;
                case 'SMP': grades = ['7', '8', '9']; break;
                case 'SMA': case 'SMK': grades = ['10', '11', '12']; break;
                default: grades = ['1', '2', '3', '4', '5', '6'];
            }
            return grades.map(g => `<option value="${g}">Kelas ${g}</option>`).join('');
        }

        function generateDefaultTimeSlots() {
            const level = userData?.profile?.school?.level || 'SD';
            const duration = level === 'SD' ? 35 : 45;
            let startTime = 7 * 60;
            const slots = [];
            for (let i = 1; i <= 10; i++) {
                const startHour = Math.floor(startTime / 60);
                const startMin = startTime % 60;
                const endTime = startTime + duration;
                const endHour = Math.floor(endTime / 60);
                const endMin = endTime % 60;
                slots.push({
                    number: i,
                    start: `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`,
                    end: `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`,
                    duration: duration
                });
                startTime = endTime + (i === 3 || i === 6 ? 15 : 5);
            }
            return slots;
        }
                // ===== SECTION LOADER (PERBAIKAN) =====
        function loadSection(section) {
            currentSection = section;
            
            // Update active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                const icon = item.querySelector('i');
                if (icon) { icon.classList.remove('text-primary-500'); icon.classList.add('text-gray-400'); }
            });
            
            const activeItem = document.querySelector(`[onclick="loadSection('${section}')"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                const icon = activeItem.querySelector('i');
                if (icon) { icon.classList.remove('text-gray-400'); icon.classList.add('text-primary-500'); }
            }

            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }

            // Check premium features
            const premiumFeatures = ['modul-ajar', 'lkpd', 'bank-soal'];
            if (premiumFeatures.includes(section)) {
                const isPremium = checkPremiumAccess();
                console.log('Loading premium section:', section, ', isPremium:', isPremium);
                
                if (!isPremium) {
                    showUpgradeModal();
                    return;
                }
            }

            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'profile': loadProfile(); break;
                case 'calendar': loadCalendar(); break;
                case 'schedule': loadSchedule(); break;
                case 'students': loadStudents(); break;
                case 'cp': loadCP(); break;
                case 'atp': loadATP(); break;
                case 'prota': loadProta(); break;
                case 'promes': loadPromes(); break;
                case 'modul-ajar': loadModulAjar(); break;
                case 'lkpd': loadLKPD(); break;
                case 'attendance': loadAttendance(); break;
                case 'journal': loadJournal(); break;
                case 'grades': loadGrades(); break;
                case 'bank-soal': loadBankSoal(); break;
                case 'ai-assistant': loadAIAssistant(); break;
                case 'import-data': loadImportData(); break;
                case 'guide': loadGuide(); break;
                default: loadDashboard();
            }
        }

        // ===== DASHBOARD =====
        function loadDashboard() {
            document.getElementById('pageTitle').textContent = 'Dashboard';
            document.getElementById('pageSubtitle').textContent = `Selamat datang, ${userData?.displayName || 'Guru'}!`;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center"><i class="fas fa-users text-blue-600 text-xl"></i></div>
                        </div>
                        <h3 id="totalStudents" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Total Siswa</p>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center"><i class="fas fa-chalkboard text-purple-600 text-xl"></i></div>
                        </div>
                        <h3 id="totalClasses" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Kelas Diampu</p>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center"><i class="fas fa-calendar-check text-green-600 text-xl"></i></div>
                        </div>
                        <h3 id="totalSchedules" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Jadwal/Minggu</p>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center"><i class="fas fa-journal-whills text-orange-600 text-xl"></i></div>
                        </div>
                        <h3 id="totalJournals" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Jurnal Selesai</p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Aksi Cepat</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <button onclick="loadSection('calendar')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-blue-50 border border-transparent hover:border-blue-200 transition-all">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mb-2"><i class="fas fa-calendar-alt text-blue-600"></i></div>
                            <span class="text-sm font-medium text-gray-700">Kalender</span>
                        </button>
                        <button onclick="loadSection('schedule')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-purple-50 border border-transparent hover:border-purple-200 transition-all">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-2"><i class="fas fa-clock text-purple-600"></i></div>
                            <span class="text-sm font-medium text-gray-700">Jadwal</span>
                        </button>
                        <button onclick="loadSection('attendance')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-green-50 border border-transparent hover:border-green-200 transition-all">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mb-2"><i class="fas fa-clipboard-check text-green-600"></i></div>
                            <span class="text-sm font-medium text-gray-700">Absensi</span>
                        </button>
                        <button onclick="loadSection('journal')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-orange-50 border border-transparent hover:border-orange-200 transition-all">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mb-2"><i class="fas fa-journal-whills text-orange-600"></i></div>
                            <span class="text-sm font-medium text-gray-700">Jurnal</span>
                        </button>
                        <button onclick="loadSection('grades')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-pink-50 border border-transparent hover:border-pink-200 transition-all">
                            <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center mb-2"><i class="fas fa-star text-pink-600"></i></div>
                            <span class="text-sm font-medium text-gray-700">Nilai</span>
                        </button>
                        <button onclick="loadSection('ai-assistant')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-cyan-50 border border-transparent hover:border-cyan-200 transition-all">
                            <div class="w-12 h-12 bg-cyan-100 rounded-xl flex items-center justify-center mb-2"><i class="fas fa-robot text-cyan-600"></i></div>
                            <span class="text-sm font-medium text-gray-700">AI Assistant</span>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Jadwal Hari Ini</h2>
                        <div id="todayScheduleList" class="space-y-3">
                            <p class="text-center text-gray-400 py-4">Memuat jadwal...</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Status Dokumen</h2>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3"><i class="fas fa-calendar-alt text-blue-500"></i><span>Kalender</span></div>
                                <span id="statusCalendar" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3"><i class="fas fa-clock text-purple-500"></i><span>Jadwal</span></div>
                                <span id="statusSchedule" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3"><i class="fas fa-users text-green-500"></i><span>Data Siswa</span></div>
                                <span id="statusStudents" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3"><i class="fas fa-route text-orange-500"></i><span>ATP</span></div>
                                <span id="statusATP" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            loadDashboardData();
        }

        async function loadDashboardData() {
            if (!currentUser) return;
            try {
                // Students count
                const studentsSnap = await db.collection('users').doc(currentUser.uid).collection('students').get();
                document.getElementById('totalStudents').textContent = studentsSnap.size;
                if (studentsSnap.size > 0) {
                    document.getElementById('statusStudents').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('statusStudents').textContent = 'Sudah';
                }
                
                // Classes count
                const classes = new Set();
                studentsSnap.forEach(doc => {
                    const s = doc.data();
                    classes.add(`${s.kelas}-${s.rombel}`);
                });
                document.getElementById('totalClasses').textContent = classes.size;
                
                // Schedules count
                const academicYearDocId = academicYearToDocId(userData?.academicYear || getCurrentAcademicYear());
                const schedulesSnap = await db.collection('users').doc(currentUser.uid).collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear()).get();
                document.getElementById('totalSchedules').textContent = schedulesSnap.size;
                if (schedulesSnap.size > 0) {
                    document.getElementById('statusSchedule').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('statusSchedule').textContent = 'Sudah';
                }
                
                // Calendar check
                const calendarDoc = await db.collection('users').doc(currentUser.uid).collection('calendar').doc(academicYearDocId).get();
                if (calendarDoc.exists) {
                    document.getElementById('statusCalendar').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('statusCalendar').textContent = 'Sudah';
                }
                
                // Today's schedule
                const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const today = days[new Date().getDay()];
                const todaySchedules = [];
                schedulesSnap.forEach(doc => {
                    const s = doc.data();
                    if (s.day === today) todaySchedules.push(s);
                });
                
                const scheduleList = document.getElementById('todayScheduleList');
                if (todaySchedules.length === 0) {
                    scheduleList.innerHTML = '<p class="text-center text-gray-400 py-4">Tidak ada jadwal hari ini</p>';
                } else {
                    todaySchedules.sort((a, b) => a.hourStart - b.hourStart);
                    scheduleList.innerHTML = todaySchedules.map(s => `
                        <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="font-bold text-blue-600">${s.class}${s.rombel}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">Kelas ${s.class}-${s.rombel}</p>
                                    <p class="text-sm text-gray-500">Jam ke-${s.hourStart} (${s.duration} JP)</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // ===== PROFILE =====
        function loadProfile() {
            document.getElementById('pageTitle').textContent = 'Profil & Sekolah';
            document.getElementById('pageSubtitle').textContent = 'Kelola data profil dan satuan pendidikan';
            
            const profile = userData?.profile || {};
            const school = profile.school || {};
            const subjects = profile.subjects || [{ name: 'Pendidikan Agama Islam dan Budi Pekerti', hoursPerWeek: 4 }];
            
            document.getElementById('contentArea').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 text-center">
                            <img src="${currentUser?.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData?.displayName || 'User')}&background=3b82f6&color=fff&size=128`}" 
                                 class="w-32 h-32 rounded-full border-4 border-primary-100 mx-auto mb-4" alt="Avatar">
                            <h3 class="text-xl font-bold text-gray-800">${userData?.displayName || 'Nama Guru'}</h3>
                            <p class="text-gray-500">${currentUser?.email}</p>
                            <div class="mt-4">
                                <span class="px-4 py-2 ${userData?.subscription === 'premium' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'} rounded-full text-sm font-medium">
                                    <i class="fas ${userData?.subscription === 'premium' ? 'fa-crown' : 'fa-user'} mr-1"></i>
                                    ${userData?.subscription === 'premium' ? 'Premium' : 'Free'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <form id="profileForm" class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <h3 class="text-lg font-bold text-gray-800 mb-6">Data Pribadi</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                    <input type="text" id="profileName" value="${userData?.displayName || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIP</label>
                                    <input type="text" id="profileNIP" value="${profile.nip || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500" placeholder="198x0x0x 20xx0x x 0xx">
                                </div>
                            </div>

                            <h3 class="text-lg font-bold text-gray-800 mb-4">Mata Pelajaran yang Diampu</h3>
                            <div id="subjectsContainer" class="space-y-3 mb-4">
                                ${subjects.map((subj, idx) => `
                                    <div class="subject-item flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                                        <div class="flex-1">
                                            <input type="text" value="${subj.name}" placeholder="Nama Mata Pelajaran" class="w-full px-4 py-2 border border-gray-200 rounded-lg subject-name">
                                        </div>
                                        <div class="w-24">
                                            <input type="number" value="${subj.hoursPerWeek}" placeholder="JP" min="1" class="w-full px-4 py-2 border border-gray-200 rounded-lg subject-hours text-center">
                                        </div>
                                        <button type="button" onclick="removeSubject(this)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                                    </div>
                                `).join('')}
                            </div>
                            <button type="button" onclick="addSubject()" class="text-primary-600 hover:text-primary-700 font-medium mb-8"><i class="fas fa-plus mr-2"></i>Tambah Mata Pelajaran</button>

                            <h3 class="text-lg font-bold text-gray-800 mb-6">Data Satuan Pendidikan</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Sekolah</label>
                                    <input type="text" id="schoolName" value="${school.name || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="SDN 1 Contoh">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NPSN</label>
                                    <input type="text" id="schoolNPSN" value="${school.npsn || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="20xxxxxx">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang</label>
                                    <select id="schoolLevel" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                        <option value="SD" ${school.level === 'SD' ? 'selected' : ''}>SD/MI</option>
                                        <option value="SMP" ${school.level === 'SMP' ? 'selected' : ''}>SMP/MTs</option>
                                        <option value="SMA" ${school.level === 'SMA' ? 'selected' : ''}>SMA/MA</option>
                                        <option value="SMK" ${school.level === 'SMK' ? 'selected' : ''}>SMK</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Kota/Kabupaten</label>
                                    <input type="text" id="schoolCity" value="${school.city || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl" placeholder="Kota Bandung">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Sekolah</label>
                                <textarea id="schoolAddress" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl">${school.address || ''}</textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Sekolah</label>
                                    <input type="text" id="principalName" value="${school.principalName || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">NIP Kepala Sekolah</label>
                                    <input type="text" id="principalNIP" value="${school.principalNIP || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                </div>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="px-8 py-3 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl hover:from-primary-700 hover:to-purple-700 transition-all shadow-lg">
                                    <i class="fas fa-save mr-2"></i>Simpan Profil
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('profileForm').addEventListener('submit', saveProfile);
        }

        function addSubject() {
            const container = document.getElementById('subjectsContainer');
            const div = document.createElement('div');
            div.className = 'subject-item flex items-center gap-4 p-4 bg-gray-50 rounded-xl';
            div.innerHTML = `
                <div class="flex-1"><input type="text" placeholder="Nama Mata Pelajaran" class="w-full px-4 py-2 border border-gray-200 rounded-lg subject-name"></div>
                <div class="w-24"><input type="number" value="2" placeholder="JP" min="1" class="w-full px-4 py-2 border border-gray-200 rounded-lg subject-hours text-center"></div>
                <button type="button" onclick="removeSubject(this)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
        }

        function removeSubject(btn) {
            const container = document.getElementById('subjectsContainer');
            if (container.children.length > 1) btn.closest('.subject-item').remove();
            else showToast('Minimal harus ada satu mata pelajaran', 'warning');
        }

        async function saveProfile(e) {
            e.preventDefault();
            showLoading('Menyimpan profil...');
            
            try {
                const subjects = [];
                document.querySelectorAll('.subject-item').forEach(item => {
                    const name = item.querySelector('.subject-name').value.trim();
                    const hours = parseInt(item.querySelector('.subject-hours').value) || 2;
                    if (name) subjects.push({ name, hoursPerWeek: hours });
                });
                
                const profileData = {
                    nip: document.getElementById('profileNIP').value.trim(),
                    subjects: subjects,
                    school: {
                        name: document.getElementById('schoolName').value.trim(),
                        npsn: document.getElementById('schoolNPSN').value.trim(),
                        level: document.getElementById('schoolLevel').value,
                        address: document.getElementById('schoolAddress').value.trim(),
                        city: document.getElementById('schoolCity').value.trim(),
                        principalName: document.getElementById('principalName').value.trim(),
                        principalNIP: document.getElementById('principalNIP').value.trim()
                    }
                };
                
                const displayName = document.getElementById('profileName').value.trim();
                
                await db.collection('users').doc(currentUser.uid).update({
                    displayName: displayName,
                    profile: profileData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await currentUser.updateProfile({ displayName: displayName });
                
                userData.displayName = displayName;
                userData.profile = profileData;
                updateUserDisplay();
                
                showToast('Profil berhasil disimpan!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan profil', 'error');
            }
            hideLoading();
        }

        // ===== CALENDAR =====
        function loadCalendar() {
            document.getElementById('pageTitle').textContent = 'Kalender Pendidikan';
            document.getElementById('pageSubtitle').textContent = 'Atur kalender akademik semester';
            
            const academicYear = userData?.academicYear || getCurrentAcademicYear();
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Pengaturan Kalender</h3>
                            <p class="text-gray-500 text-sm">Tahun Ajaran: ${academicYear}</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="showImportCalendarModal()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50"><i class="fas fa-file-csv mr-2"></i>Import CSV</button>
                            <button onclick="saveCalendar()" class="px-6 py-2 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl"><i class="fas fa-save mr-2"></i>Simpan</button>
                        </div>
                    </div>

                    <div class="flex space-x-2 mb-6">
                        <button onclick="switchSemester(1)" id="sem1Tab" class="px-6 py-3 bg-primary-500 text-white font-medium rounded-xl">Semester 1 (Ganjil)</button>
                        <button onclick="switchSemester(2)" id="sem2Tab" class="px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200">Semester 2 (Genap)</button>
                    </div>

                    <div id="semester1Form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                <h4 class="font-semibold text-blue-800 mb-4"><i class="fas fa-calendar-day mr-2"></i>Periode Semester</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Awal</label><input type="date" id="sem1Start" class="w-full px-3 py-2 border border-gray-200 rounded-lg"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Akhir</label><input type="date" id="sem1End" class="w-full px-3 py-2 border border-gray-200 rounded-lg"></div>
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                                <h4 class="font-semibold text-green-800 mb-4"><i class="fas fa-book-reader mr-2"></i>Kegiatan Pembelajaran</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Awal</label><input type="date" id="sem1ActivityStart" class="w-full px-3 py-2 border border-gray-200 rounded-lg"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Akhir</label><input type="date" id="sem1ActivityEnd" class="w-full px-3 py-2 border border-gray-200 rounded-lg"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                                <h4 class="font-semibold text-orange-800 mb-4"><i class="fas fa-file-signature mr-2"></i>Pekan Ujian</h4>
                                <div id="sem1Exams" class="space-y-2">
                                    <div class="exam-item grid grid-cols-5 gap-2"><input type="text" value="PTS" class="col-span-1 px-2 py-1 border rounded text-sm exam-name"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm exam-start"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm exam-end"></div>
                                    <div class="exam-item grid grid-cols-5 gap-2"><input type="text" value="PAS" class="col-span-1 px-2 py-1 border rounded text-sm exam-name"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm exam-start"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm exam-end"></div>
                                </div>
                                <button onclick="addCalendarItem('sem1Exams', 'exam')" class="mt-2 text-sm text-orange-600"><i class="fas fa-plus mr-1"></i>Tambah</button>
                            </div>
                            <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                                <h4 class="font-semibold text-red-800 mb-4"><i class="fas fa-umbrella-beach mr-2"></i>Libur</h4>
                                <div id="sem1Holidays" class="space-y-2">
                                    <div class="holiday-item grid grid-cols-5 gap-2"><input type="text" placeholder="Ket" class="col-span-1 px-2 py-1 border rounded text-sm holiday-name"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm holiday-start"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm holiday-end"></div>
                                </div>
                                <button onclick="addCalendarItem('sem1Holidays', 'holiday')" class="mt-2 text-sm text-red-600"><i class="fas fa-plus mr-1"></i>Tambah</button>
                            </div>
                        </div>
                    </div>

                    <div id="semester2Form" class="space-y-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                <h4 class="font-semibold text-blue-800 mb-4"><i class="fas fa-calendar-day mr-2"></i>Periode Semester</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Awal</label><input type="date" id="sem2Start" class="w-full px-3 py-2 border border-gray-200 rounded-lg"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Akhir</label><input type="date" id="sem2End" class="w-full px-3 py-2 border border-gray-200 rounded-lg"></div>
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                                <h4 class="font-semibold text-green-800 mb-4"><i class="fas fa-book-reader mr-2"></i>Kegiatan Pembelajaran</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Awal</label><input type="date" id="sem2ActivityStart" class="w-full px-3 py-2 border border-gray-200 rounded-lg"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Akhir</label><input type="date" id="sem2ActivityEnd" class="w-full px-3 py-2 border border-gray-200 rounded-lg"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                                <h4 class="font-semibold text-orange-800 mb-4"><i class="fas fa-file-signature mr-2"></i>Pekan Ujian</h4>
                                <div id="sem2Exams" class="space-y-2">
                                    <div class="exam-item grid grid-cols-5 gap-2"><input type="text" value="PTS" class="col-span-1 px-2 py-1 border rounded text-sm exam-name"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm exam-start"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm exam-end"></div>
                                    <div class="exam-item grid grid-cols-5 gap-2"><input type="text" value="PAT" class="col-span-1 px-2 py-1 border rounded text-sm exam-name"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm exam-start"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm exam-end"></div>
                                </div>
                                <button onclick="addCalendarItem('sem2Exams', 'exam')" class="mt-2 text-sm text-orange-600"><i class="fas fa-plus mr-1"></i>Tambah</button>
                            </div>
                            <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                                <h4 class="font-semibold text-red-800 mb-4"><i class="fas fa-umbrella-beach mr-2"></i>Libur</h4>
                                <div id="sem2Holidays" class="space-y-2">
                                    <div class="holiday-item grid grid-cols-5 gap-2"><input type="text" placeholder="Ket" class="col-span-1 px-2 py-1 border rounded text-sm holiday-name"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm holiday-start"><input type="date" class="col-span-2 px-2 py-1 border rounded text-sm holiday-end"></div>
                                </div>
                                <button onclick="addCalendarItem('sem2Holidays', 'holiday')" class="mt-2 text-sm text-red-600"><i class="fas fa-plus mr-1"></i>Tambah</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Preview Minggu Efektif</h3>
                    <div id="calendarPreview" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <p class="col-span-full text-center text-gray-400 py-4">Simpan kalender untuk melihat preview</p>
                    </div>
                </div>
            `;
            
            loadCalendarData();
        }

        function switchSemester(sem) {
            if (sem === 1) {
                document.getElementById('sem1Tab').className = 'px-6 py-3 bg-primary-500 text-white font-medium rounded-xl';
                document.getElementById('sem2Tab').className = 'px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200';
                document.getElementById('semester1Form').classList.remove('hidden');
                document.getElementById('semester2Form').classList.add('hidden');
            } else {
                document.getElementById('sem2Tab').className = 'px-6 py-3 bg-primary-500 text-white font-medium rounded-xl';
                document.getElementById('sem1Tab').className = 'px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200';
                document.getElementById('semester2Form').classList.remove('hidden');
                document.getElementById('semester1Form').classList.add('hidden');
            }
        }

        function addCalendarItem(containerId, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `${type}-item grid grid-cols-5 gap-2`;
            div.innerHTML = `
                <input type="text" placeholder="${type === 'exam' ? 'Ujian' : 'Ket'}" class="col-span-1 px-2 py-1 border rounded text-sm ${type}-name">
                <input type="date" class="col-span-2 px-2 py-1 border rounded text-sm ${type}-start">
                <input type="date" class="col-span-2 px-2 py-1 border rounded text-sm ${type}-end">
            `;
            container.appendChild(div);
        }

        async function loadCalendarData() {
            if (!currentUser) return;
            const docId = academicYearToDocId(userData?.academicYear || getCurrentAcademicYear());
            
            try {
                const doc = await db.collection('users').doc(currentUser.uid).collection('calendar').doc(docId).get();
                if (doc.exists) {
                    const data = doc.data();
                    calendarData = data;
                    
                    if (data.semester1) {
                        document.getElementById('sem1Start').value = data.semester1.start || '';
                        document.getElementById('sem1End').value = data.semester1.end || '';
                        document.getElementById('sem1ActivityStart').value = data.semester1.activityStart || '';
                        document.getElementById('sem1ActivityEnd').value = data.semester1.activityEnd || '';
                    }
                    if (data.semester2) {
                        document.getElementById('sem2Start').value = data.semester2.start || '';
                        document.getElementById('sem2End').value = data.semester2.end || '';
                        document.getElementById('sem2ActivityStart').value = data.semester2.activityStart || '';
                        document.getElementById('sem2ActivityEnd').value = data.semester2.activityEnd || '';
                    }
                    
                    generateCalendarPreview(data);
                }
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        async function saveCalendar() {
            showLoading('Menyimpan kalender...');
            
            const collectItems = (containerId, type) => {
                const items = [];
                document.querySelectorAll(`#${containerId} > div`).forEach(item => {
                    const name = item.querySelector(`.${type}-name`)?.value?.trim() || '';
                    const start = item.querySelector(`.${type}-start`)?.value || '';
                    const end = item.querySelector(`.${type}-end`)?.value || '';
                    if (name || start || end) items.push({ name, start, end });
                });
                return items;
            };
            
            try {
                const docId = academicYearToDocId(userData?.academicYear || getCurrentAcademicYear());
                const data = {
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    semester1: {
                        start: document.getElementById('sem1Start').value,
                        end: document.getElementById('sem1End').value,
                        activityStart: document.getElementById('sem1ActivityStart').value,
                        activityEnd: document.getElementById('sem1ActivityEnd').value,
                        exams: collectItems('sem1Exams', 'exam'),
                        holidays: collectItems('sem1Holidays', 'holiday')
                    },
                    semester2: {
                        start: document.getElementById('sem2Start').value,
                        end: document.getElementById('sem2End').value,
                        activityStart: document.getElementById('sem2ActivityStart').value,
                        activityEnd: document.getElementById('sem2ActivityEnd').value,
                        exams: collectItems('sem2Exams', 'exam'),
                        holidays: collectItems('sem2Holidays', 'holiday')
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).collection('calendar').doc(docId).set(data);
                calendarData = data;
                generateCalendarPreview(data);
                showToast('Kalender berhasil disimpan!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan: ' + error.message, 'error');
            }
            hideLoading();
        }

        function generateCalendarPreview(data) {
            const preview = document.getElementById('calendarPreview');
            const months = ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
            
            let html = '';
            months.forEach((month, idx) => {
                const semData = idx < 6 ? data.semester1 : data.semester2;
                const weeks = semData?.activityStart && semData?.activityEnd ? 4 : 0;
                html += `<div class="p-4 bg-gray-50 rounded-xl text-center">
                    <p class="font-semibold text-gray-700">${month}</p>
                    <p class="text-2xl font-bold ${weeks > 0 ? 'text-primary-600' : 'text-gray-400'}">${weeks}</p>
                    <p class="text-xs text-gray-500">Minggu Efektif</p>
                </div>`;
            });
            preview.innerHTML = html;
        }

        function showImportCalendarModal() {
            const modal = document.createElement('div');
            modal.id = 'importCalendarModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">Import Kalender dari CSV</h3>
                        <button onclick="this.closest('#importCalendarModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                        <p class="text-sm text-blue-700"><strong>Format:</strong> jenis,nama,tanggal_mulai,tanggal_selesai</p>
                        <p class="text-xs text-blue-600 mt-1">jenis: semester / kegiatan / ujian / libur</p>
                    </div>
                    <input type="url" id="calendarCsvUrl" class="w-full px-4 py-3 border rounded-xl mb-4" placeholder="URL CSV Google Sheets">
                    <div class="flex justify-end gap-3">
                        <button onclick="this.closest('#importCalendarModal').remove()" class="px-4 py-2 border rounded-xl">Batal</button>
                        <button onclick="importCalendarCSV()" class="px-4 py-2 bg-primary-500 text-white rounded-xl">Import</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function importCalendarCSV() {
            const url = document.getElementById('calendarCsvUrl').value.trim();
            if (!url) { showToast('Masukkan URL', 'warning'); return; }
            
            showLoading('Mengimpor kalender...');
            try {
                const response = await fetch(url);
                const text = await response.text();
                const lines = text.split('\n');
                const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
                
                const sem1 = { exams: [], holidays: [] };
                const sem2 = { exams: [], holidays: [] };
                
                for (let i = 1; i < lines.length; i++) {
                    const vals = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (vals.length < 4) continue;
                    
                    const jenis = vals[headers.indexOf('jenis')]?.toLowerCase() || '';
                    const nama = vals[headers.indexOf('nama')] || '';
                    const mulai = vals[headers.indexOf('tanggal_mulai')] || '';
                    const selesai = vals[headers.indexOf('tanggal_selesai')] || '';
                    
                    const month = new Date(mulai).getMonth();
                    const target = month >= 6 ? sem1 : sem2;
                    
                    if (jenis === 'semester') { target.start = mulai; target.end = selesai; }
                    else if (jenis === 'kegiatan') { target.activityStart = mulai; target.activityEnd = selesai; }
                    else if (jenis === 'ujian') { target.exams.push({ name: nama, start: mulai, end: selesai }); }
                    else if (jenis === 'libur') { target.holidays.push({ name: nama, start: mulai, end: selesai }); }
                }
                
                if (sem1.start) document.getElementById('sem1Start').value = sem1.start;
                if (sem1.end) document.getElementById('sem1End').value = sem1.end;
                if (sem1.activityStart) document.getElementById('sem1ActivityStart').value = sem1.activityStart;
                if (sem1.activityEnd) document.getElementById('sem1ActivityEnd').value = sem1.activityEnd;
                
                if (sem2.start) document.getElementById('sem2Start').value = sem2.start;
                if (sem2.end) document.getElementById('sem2End').value = sem2.end;
                if (sem2.activityStart) document.getElementById('sem2ActivityStart').value = sem2.activityStart;
                if (sem2.activityEnd) document.getElementById('sem2ActivityEnd').value = sem2.activityEnd;
                
                document.getElementById('importCalendarModal')?.remove();
                showToast('Import berhasil! Klik Simpan untuk menyimpan.', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal import: ' + error.message, 'error');
            }
            hideLoading();
        }
        // ===== SCHEDULE (JADWAL PELAJARAN) =====
        function loadSchedule() {
            document.getElementById('pageTitle').textContent = 'Jadwal Pelajaran';
            document.getElementById('pageSubtitle').textContent = 'Atur jadwal mengajar dengan validasi anti-bentrok';
            
            const level = userData?.profile?.school?.level || 'SD';
            const duration = level === 'SD' ? 35 : 45;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Pengaturan Jadwal</h3>
                            <p class="text-gray-500 text-sm">Durasi JP: ${duration} menit (${level})</p>
                        </div>
                        <button onclick="showTimeConfig()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50">
                            <i class="fas fa-clock mr-2"></i>Konfigurasi Jam
                        </button>
                    </div>

                    <!-- Add Schedule Form -->
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6 p-4 bg-blue-50 rounded-xl">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hari</label>
                            <select id="scheduleDay" class="w-full px-3 py-2 border rounded-lg">
                                <option value="Senin">Senin</option>
                                <option value="Selasa">Selasa</option>
                                <option value="Rabu">Rabu</option>
                                <option value="Kamis">Kamis</option>
                                <option value="Jumat">Jumat</option>
                                <option value="Sabtu">Sabtu</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jam Ke</label>
                            <select id="scheduleHour" class="w-full px-3 py-2 border rounded-lg">
                                ${Array.from({length: 10}, (_, i) => `<option value="${i+1}">${i+1}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Durasi (JP)</label>
                            <select id="scheduleDuration" class="w-full px-3 py-2 border rounded-lg">
                                <option value="1">1 JP</option>
                                <option value="2" selected>2 JP</option>
                                <option value="3">3 JP</option>
                                <option value="4">4 JP</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kelas</label>
                            <select id="scheduleClass" class="w-full px-3 py-2 border rounded-lg">${generateClassOptions(level)}</select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rombel</label>
                            <select id="scheduleRombel" class="w-full px-3 py-2 border rounded-lg">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="addScheduleItem()" class="w-full px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">
                                <i class="fas fa-plus mr-1"></i>Tambah
                            </button>
                        </div>
                    </div>

                    <!-- Schedule Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border px-3 py-2 text-sm font-semibold">Jam</th>
                                    <th class="border px-3 py-2 text-sm font-semibold">Senin</th>
                                    <th class="border px-3 py-2 text-sm font-semibold">Selasa</th>
                                    <th class="border px-3 py-2 text-sm font-semibold">Rabu</th>
                                    <th class="border px-3 py-2 text-sm font-semibold">Kamis</th>
                                    <th class="border px-3 py-2 text-sm font-semibold">Jumat</th>
                                    <th class="border px-3 py-2 text-sm font-semibold">Sabtu</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Schedule List -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Daftar Jadwal Anda</h3>
                    <div id="scheduleList" class="space-y-3"></div>
                </div>
            `;
            
            loadScheduleData();
        }

        async function loadScheduleData() {
            if (!currentUser) return;
            
            timeSlots = generateDefaultTimeSlots();
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid).collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear()).get();
                
                scheduleItems = [];
                snap.forEach(doc => scheduleItems.push({ id: doc.id, ...doc.data() }));
                
                renderScheduleTable();
                renderScheduleList();
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        function renderScheduleTable() {
            const tbody = document.getElementById('scheduleTableBody');
            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            
            let html = '';
            for (let i = 1; i <= 10; i++) {
                const slot = timeSlots[i-1] || { number: i, start: '00:00', end: '00:00' };
                html += `<tr class="hover:bg-gray-50">`;
                html += `<td class="border px-3 py-2 text-sm text-center bg-gray-50">
                    <div class="font-medium">JP ${slot.number}</div>
                    <div class="text-xs text-gray-400">${slot.start}-${slot.end}</div>
                </td>`;
                
                days.forEach(day => {
                    const schedule = scheduleItems.find(s => s.day === day && s.hourStart === i);
                    if (schedule) {
                        html += `<td class="border px-2 py-1 text-center" rowspan="${schedule.duration}">
                            <div class="bg-primary-100 text-primary-700 rounded-lg p-2 text-sm relative group">
                                <div class="font-bold">${schedule.class}-${schedule.rombel}</div>
                                <div class="text-xs">${schedule.duration} JP</div>
                                <button onclick="deleteScheduleItem('${schedule.id}')" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity"></button>
                            </div>
                        </td>`;
                    } else {
                        const isOccupied = scheduleItems.some(s => s.day === day && s.hourStart < i && (s.hourStart + s.duration) > i);
                        if (!isOccupied) {
                            html += `<td class="border px-2 py-1 text-center text-gray-300">-</td>`;
                        }
                    }
                });
                html += `</tr>`;
            }
            tbody.innerHTML = html;
        }

        function renderScheduleList() {
            const container = document.getElementById('scheduleList');
            
            if (scheduleItems.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-4">Belum ada jadwal</p>';
                return;
            }
            
            const grouped = {};
            scheduleItems.forEach(item => {
                if (!grouped[item.day]) grouped[item.day] = [];
                grouped[item.day].push(item);
            });
            
            const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            let html = '';
            
            days.forEach(day => {
                if (grouped[day]?.length > 0) {
                    html += `<div class="mb-4">
                        <h4 class="font-semibold text-gray-700 mb-2">${day}</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">`;
                    
                    grouped[day].sort((a, b) => a.hourStart - b.hourStart).forEach(item => {
                        html += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
                                    <span class="font-bold text-primary-600 text-sm">${item.class}${item.rombel}</span>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800 text-sm">Kelas ${item.class}-${item.rombel}</p>
                                    <p class="text-xs text-gray-500">Jam ${item.hourStart}-${item.hourStart + item.duration - 1} (${item.duration} JP)</p>
                                </div>
                            </div>
                            <button onclick="deleteScheduleItem('${item.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`;
                    });
                    html += `</div></div>`;
                }
            });
            
            container.innerHTML = html;
        }

        async function addScheduleItem() {
            const day = document.getElementById('scheduleDay').value;
            const hourStart = parseInt(document.getElementById('scheduleHour').value);
            const duration = parseInt(document.getElementById('scheduleDuration').value);
            const classNum = document.getElementById('scheduleClass').value;
            const rombel = document.getElementById('scheduleRombel').value;
            
            // Validation: Check for time conflicts
            for (let s of scheduleItems) {
                if (s.day !== day) continue;
                
                const existStart = s.hourStart;
                const existEnd = s.hourStart + s.duration - 1;
                const newStart = hourStart;
                const newEnd = hourStart + duration - 1;
                
                // Check overlap
                if (newStart <= existEnd && newEnd >= existStart) {
                    showToast(`Jadwal bentrok dengan ${s.class}-${s.rombel} di jam ${existStart}-${existEnd}`, 'error');
                    return;
                }
            }
            
            showLoading('Menyimpan jadwal...');
            
            try {
                const data = {
                    day, hourStart, duration,
                    class: classNum, rombel,
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('users').doc(currentUser.uid).collection('schedules').add(data);
                scheduleItems.push({ id: docRef.id, ...data });
                
                renderScheduleTable();
                renderScheduleList();
                showToast('Jadwal berhasil ditambahkan!', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan jadwal', 'error');
            }
            hideLoading();
        }

        async function deleteScheduleItem(id) {
            if (!confirm('Hapus jadwal ini?')) return;
            
            showLoading('Menghapus...');
            try {
                await db.collection('users').doc(currentUser.uid).collection('schedules').doc(id).delete();
                scheduleItems = scheduleItems.filter(s => s.id !== id);
                renderScheduleTable();
                renderScheduleList();
                showToast('Jadwal dihapus', 'success');
            } catch (error) {
                console.error(error);
                showToast('Gagal menghapus', 'error');
            }
            hideLoading();
        }

        // ===== STUDENTS =====
        function loadStudents() {
            document.getElementById('pageTitle').textContent = 'Data Siswa';
            document.getElementById('pageSubtitle').textContent = 'Kelola data siswa per kelas';
            
            const level = userData?.profile?.school?.level || 'SD';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Daftar Siswa</h3>
                            <p class="text-gray-500 text-sm">Total: <span id="studentCount">0</span> siswa</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="showImportStudentsModal()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50">
                                <i class="fas fa-file-csv mr-2"></i>Import CSV
                            </button>
                            <button onclick="showAddStudentModal()" class="px-4 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600">
                                <i class="fas fa-plus mr-2"></i>Tambah Siswa
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mb-6">
                        <select id="filterClass" onchange="filterStudents()" class="px-4 py-2 border rounded-xl">
                            <option value="">Semua Kelas</option>
                            ${generateClassOptions(level)}
                        </select>
                        <select id="filterRombel" onchange="filterStudents()" class="px-4 py-2 border rounded-xl">
                            <option value="">Semua Rombel</option>
                            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                        </select>
                        <input type="text" id="searchStudent" onkeyup="filterStudents()" placeholder="Cari nama..." class="flex-1 min-w-48 px-4 py-2 border rounded-xl">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-semibold">No</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">NISN</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Nama Siswa</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">L/P</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">Kelas</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">Rombel</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr><td colspan="7" class="text-center py-8 text-gray-400">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            loadStudentsData();
        }

        async function loadStudentsData() {
            try {
                const snap = await db.collection('users').doc(currentUser.uid).collection('students').orderBy('kelas').orderBy('nama').get();
                allStudents = [];
                snap.forEach(doc => allStudents.push({ id: doc.id, ...doc.data() }));
                
                document.getElementById('studentCount').textContent = allStudents.length;
                renderStudentsTable(allStudents);
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function filterStudents() {
            const classFilter = document.getElementById('filterClass').value;
            const rombelFilter = document.getElementById('filterRombel').value;
            const search = document.getElementById('searchStudent').value.toLowerCase();
            
            let filtered = allStudents;
            if (classFilter) filtered = filtered.filter(s => s.kelas === classFilter);
            if (rombelFilter) filtered = filtered.filter(s => s.rombel === rombelFilter);
            if (search) filtered = filtered.filter(s => s.nama.toLowerCase().includes(search));
            
            renderStudentsTable(filtered);
        }

        function renderStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-400">Tidak ada data siswa</td></tr>';
                return;
            }
            
            tbody.innerHTML = students.map((s, idx) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${idx + 1}</td>
                    <td class="px-4 py-3 text-sm">${s.nisn || '-'}</td>
                    <td class="px-4 py-3 text-sm font-medium">${s.nama}</td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 ${s.jk === 'L' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'} text-xs rounded-full">${s.jk}</span></td>
                    <td class="px-4 py-3 text-center text-sm">${s.kelas}</td>
                    <td class="px-4 py-3 text-center text-sm">${s.rombel}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteStudent('${s.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddStudentModal() {
            const level = userData?.profile?.school?.level || 'SD';
            const modal = document.createElement('div');
            modal.id = 'studentModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Tambah Siswa</h3>
                        <button onclick="this.closest('#studentModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="addStudentForm" class="space-y-4">
                        <div><label class="block text-sm font-medium mb-1">NISN</label><input type="text" id="studentNISN" class="w-full px-4 py-2 border rounded-xl"></div>
                        <div><label class="block text-sm font-medium mb-1">Nama Lengkap *</label><input type="text" id="studentName" required class="w-full px-4 py-2 border rounded-xl"></div>
                        <div class="grid grid-cols-3 gap-4">
                            <div><label class="block text-sm font-medium mb-1">L/P</label><select id="studentGender" class="w-full px-4 py-2 border rounded-xl"><option value="L">L</option><option value="P">P</option></select></div>
                            <div><label class="block text-sm font-medium mb-1">Kelas</label><select id="studentClass" class="w-full px-4 py-2 border rounded-xl">${generateClassOptions(level)}</select></div>
                            <div><label class="block text-sm font-medium mb-1">Rombel</label><select id="studentRombel" class="w-full px-4 py-2 border rounded-xl"><option>A</option><option>B</option><option>C</option><option>D</option></select></div>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="this.closest('#studentModal').remove()" class="px-4 py-2 border rounded-xl">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-xl">Simpan</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('addStudentForm').addEventListener('submit', saveStudent);
        }

        async function saveStudent(e) {
            e.preventDefault();
            showLoading('Menyimpan...');
            
            try {
                const data = {
                    nisn: document.getElementById('studentNISN').value.trim(),
                    nama: document.getElementById('studentName').value.trim(),
                    jk: document.getElementById('studentGender').value,
                    kelas: document.getElementById('studentClass').value,
                    rombel: document.getElementById('studentRombel').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).collection('students').add(data);
                document.getElementById('studentModal')?.remove();
                showToast('Siswa berhasil ditambahkan!', 'success');
                loadStudentsData();
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan', 'error');
            }
            hideLoading();
        }

        async function deleteStudent(id) {
            if (!confirm('Hapus siswa ini?')) return;
            showLoading('Menghapus...');
            try {
                await db.collection('users').doc(currentUser.uid).collection('students').doc(id).delete();
                showToast('Siswa dihapus', 'success');
                loadStudentsData();
            } catch (error) {
                showToast('Gagal menghapus', 'error');
            }
            hideLoading();
        }

        function showImportStudentsModal() {
            const modal = document.createElement('div');
            modal.id = 'importStudentModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Import Data Siswa</h3>
                        <button onclick="this.closest('#importStudentModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                        <p class="text-sm text-blue-700"><strong>Format CSV:</strong> nisn,nama,jk,kelas,rombel</p>
                        <p class="text-xs text-blue-600 mt-1">Contoh: 0012345678,Ahmad Fadhil,L,7,A</p>
                    </div>
                    <input type="url" id="studentCsvUrl" class="w-full px-4 py-3 border rounded-xl mb-4" placeholder="URL CSV Google Sheets">
                    <div class="flex justify-end gap-3">
                        <button onclick="this.closest('#importStudentModal').remove()" class="px-4 py-2 border rounded-xl">Batal</button>
                        <button onclick="importStudentsCSV()" class="px-4 py-2 bg-primary-500 text-white rounded-xl">Import</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function importStudentsCSV() {
            const url = document.getElementById('studentCsvUrl').value.trim();
            if (!url) { showToast('Masukkan URL', 'warning'); return; }
            
            showLoading('Mengimpor siswa...');
            try {
                const response = await fetch(url);
                const text = await response.text();
                const lines = text.split('\n');
                const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
                
                const batch = db.batch();
                let count = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const vals = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (vals.length < 5 || !vals[headers.indexOf('nama')]) continue;
                    
                    const data = {
                        nisn: vals[headers.indexOf('nisn')] || '',
                        nama: vals[headers.indexOf('nama')],
                        jk: vals[headers.indexOf('jk')] || 'L',
                        kelas: vals[headers.indexOf('kelas')] || '1',
                        rombel: vals[headers.indexOf('rombel')] || 'A',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const docRef = db.collection('users').doc(currentUser.uid).collection('students').doc();
                    batch.set(docRef, data);
                    count++;
                }
                
                await batch.commit();
                document.getElementById('importStudentModal')?.remove();
                showToast(`${count} siswa berhasil diimpor!`, 'success');
                loadStudentsData();
            } catch (error) {
                console.error(error);
                showToast('Gagal import: ' + error.message, 'error');
            }
            hideLoading();
        }

        // ===== CP & TP =====
        function loadCP() {
            document.getElementById('pageTitle').textContent = 'Capaian Pembelajaran & TP';
            document.getElementById('pageSubtitle').textContent = 'Berdasarkan Kepka BSKAP No. 046/H/KR/2025';
            
            const level = userData?.profile?.school?.level || 'SD';
            const phaseMap = { 'SD': ['A', 'B', 'C'], 'SMP': ['D'], 'SMA': ['E', 'F'], 'SMK': ['E', 'F'] };
            const phases = phaseMap[level] || ['A', 'B', 'C'];
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Pilih Fase</h3>
                        <div class="flex flex-wrap gap-3" id="phaseButtons">
                            ${phases.map(p => {
                                const pd = CP_DATA_PAI.phases[p];
                                return `<button onclick="showPhaseCP('${p}')" class="phase-btn px-6 py-3 border-2 border-gray-200 rounded-xl hover:border-primary-500 hover:bg-primary-50 transition-all" data-phase="${p}">
                                    <div class="font-bold text-primary-600">Fase ${p}</div>
                                    <div class="text-sm text-gray-500">Kelas ${pd.grades.join('-')}</div>
                                </button>`;
                            }).join('')}
                        </div>
                    </div>
                    <div id="cpContent">
                        <div class="text-center py-12 text-gray-400">
                            <i class="fas fa-bullseye text-5xl mb-4"></i>
                            <p>Pilih fase untuk melihat Capaian Pembelajaran</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function showPhaseCP(phase) {
            document.querySelectorAll('.phase-btn').forEach(btn => {
                btn.classList.remove('border-primary-500', 'bg-primary-50');
                btn.classList.add('border-gray-200');
            });
            document.querySelector(`[data-phase="${phase}"]`).classList.add('border-primary-500', 'bg-primary-50');
            document.querySelector(`[data-phase="${phase}"]`).classList.remove('border-gray-200');
            
            const pd = CP_DATA_PAI.phases[phase];
            
            document.getElementById('cpContent').innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
                    <h4 class="font-bold text-green-800"><i class="fas fa-info-circle mr-2"></i>Fase ${phase} - ${pd.level}</h4>
                    <p class="text-green-700">Kelas: ${pd.grades.join(', ')}</p>
                </div>
                <div class="space-y-4">
                    ${pd.elements.map((el, idx) => `
                        <div class="border rounded-xl overflow-hidden">
                            <button onclick="toggleCP('cp-${idx}')" class="w-full px-4 py-3 bg-gray-50 flex justify-between items-center hover:bg-gray-100">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center"><i class="fas fa-book text-primary-600"></i></div>
                                    <div class="text-left">
                                        <h4 class="font-semibold text-gray-800">${el.name}</h4>
                                        <p class="text-sm text-gray-500">${el.description}</p>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400" id="icon-cp-${idx}"></i>
                            </button>
                            <div id="cp-${idx}" class="hidden p-4 border-t bg-white">
                                <h5 class="font-semibold text-gray-700 mb-3">Tujuan Pembelajaran:</h5>
                                <div class="space-y-2">
                                    ${el.tujuanPembelajaran.map((tp, tpIdx) => `
                                        <div class="flex items-start space-x-3 p-3 bg-blue-50 rounded-lg">
                                            <span class="w-6 h-6 bg-primary-500 text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">${tpIdx + 1}</span>
                                            <p class="text-gray-700 text-sm">${tp}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleCP(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            el.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        // ===== ATP =====
        function loadATP() {
            document.getElementById('pageTitle').textContent = 'Alur Tujuan Pembelajaran (ATP)';
            document.getElementById('pageSubtitle').textContent = 'Susun alur pembelajaran';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">ATP</h3>
                            <p class="text-gray-500 text-sm">Sinkron dengan Kalender dan Jadwal</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="atpClass" onchange="loadATPForClass()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option></select>
                            <button onclick="printDocument()" class="px-4 py-2 bg-primary-500 text-white rounded-xl"><i class="fas fa-print mr-2"></i>Cetak</button>
                        </div>
                    </div>
                    <div id="atpContainer"><p class="text-center text-gray-400 py-12">Pilih kelas untuk melihat ATP</p></div>
                </div>
            `;
            populateClassSelect('atpClass');
        }

        async function populateClassSelect(selectId) {
            try {
                const snap = await db.collection('users').doc(currentUser.uid).collection('schedules')
                    .where('academicYear', '==', userData?.academicYear || getCurrentAcademicYear()).get();
                
                const classes = new Set();
                snap.forEach(doc => { const d = doc.data(); classes.add(`${d.class}-${d.rombel}`); });
                
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
            } catch (error) {
                console.error(error);
            }
        }

        function loadATPForClass() {
            const val = document.getElementById('atpClass').value;
            if (!val) return;
            
            const [kelas, rombel] = val.split('-');
            const level = userData?.profile?.school?.level || 'SD';
            const phase = getPhaseByClass(kelas, level);
            const pd = CP_DATA_PAI.phases[phase];
            const school = userData?.profile?.school || {};
            
            let allTP = [];
            pd.elements.forEach(el => {
                el.tujuanPembelajaran.forEach(tp => allTP.push({ element: el.name, tp }));
            });
            
            document.getElementById('atpContainer').innerHTML = `
                <div class="print-only text-center mb-6">
                    <h2 class="text-xl font-bold">ALUR TUJUAN PEMBELAJARAN</h2>
                    <p>${school.name || ''}</p>
                </div>
                <div class="mb-4 p-4 bg-blue-50 rounded-xl no-print">
                    <span class="font-semibold text-blue-800">Kelas ${kelas}-${rombel}</span>
                    <span class="text-blue-600 ml-2">| Fase ${phase} | ${userData?.academicYear}</span>
                </div>
                <table class="w-full border-collapse text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border px-3 py-2">No</th>
                            <th class="border px-3 py-2">Elemen</th>
                            <th class="border px-3 py-2">Tujuan Pembelajaran</th>
                            <th class="border px-3 py-2 w-20">JP</th>
                            <th class="border px-3 py-2 w-24">Semester</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allTP.map((item, idx) => `
                            <tr>
                                <td class="border px-3 py-2 text-center">${idx + 1}</td>
                                <td class="border px-3 py-2">${item.element}</td>
                                <td class="border px-3 py-2">${item.tp}</td>
                                <td class="border px-3 py-2 text-center"><input type="number" value="4" min="1" class="w-16 px-2 py-1 border rounded text-center"></td>
                                <td class="border px-3 py-2 text-center"><select class="px-2 py-1 border rounded"><option>1</option><option>2</option></select></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${generateSignature()}
            `;
        }

        // ===== PROTA =====
        function loadProta() {
            document.getElementById('pageTitle').textContent = 'Program Tahunan (Prota)';
            document.getElementById('pageSubtitle').textContent = 'Sinkron dengan Kalender & ATP';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <div><h3 class="text-lg font-bold text-gray-800">Program Tahunan</h3></div>
                        <div class="flex gap-3">
                            <select id="protaClass" onchange="loadProtaForClass()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option></select>
                            <button onclick="printDocument()" class="px-4 py-2 bg-primary-500 text-white rounded-xl"><i class="fas fa-print mr-2"></i>Cetak</button>
                        </div>
                    </div>
                    <div id="protaContainer"><p class="text-center text-gray-400 py-12">Pilih kelas untuk melihat Prota</p></div>
                </div>
            `;
            populateClassSelect('protaClass');
        }

        function loadProtaForClass() {
            const val = document.getElementById('protaClass').value;
            if (!val) return;
            
            const [kelas, rombel] = val.split('-');
            const level = userData?.profile?.school?.level || 'SD';
            const phase = getPhaseByClass(kelas, level);
            const pd = CP_DATA_PAI.phases[phase];
            const school = userData?.profile?.school || {};
            
            let allTP = [];
            pd.elements.forEach(el => {
                el.tujuanPembelajaran.forEach(tp => allTP.push({ element: el.name, tp }));
            });
            
            const mid = Math.ceil(allTP.length / 2);
            const sem1 = allTP.slice(0, mid);
            const sem2 = allTP.slice(mid);
            
            document.getElementById('protaContainer').innerHTML = `
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold">PROGRAM TAHUNAN</h2>
                    <p class="text-gray-600">Tahun Pelajaran ${userData?.academicYear}</p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div>
                        <p><strong>Satuan Pendidikan:</strong> ${school.name || '-'}</p>
                        <p><strong>Mata Pelajaran:</strong> ${userData?.profile?.subjects?.[0]?.name || 'PAI'}</p>
                    </div>
                    <div>
                        <p><strong>Kelas:</strong> ${kelas}</p>
                        <p><strong>Fase:</strong> ${phase}</p>
                    </div>
                </div>
                
                <h3 class="font-bold bg-primary-100 text-primary-700 px-4 py-2 rounded mb-4">SEMESTER 1 (GANJIL)</h3>
                <table class="w-full border-collapse text-sm mb-8">
                    <thead><tr class="bg-gray-100"><th class="border px-3 py-2">No</th><th class="border px-3 py-2">Tujuan Pembelajaran</th><th class="border px-3 py-2">JP</th><th class="border px-3 py-2">Keterangan</th></tr></thead>
                    <tbody>${sem1.map((item, idx) => `<tr><td class="border px-3 py-2 text-center">${idx + 1}</td><td class="border px-3 py-2">${item.tp}</td><td class="border px-3 py-2 text-center">4</td><td class="border px-3 py-2">${item.element}</td></tr>`).join('')}</tbody>
                </table>
                
                <h3 class="font-bold bg-primary-100 text-primary-700 px-4 py-2 rounded mb-4">SEMESTER 2 (GENAP)</h3>
                <table class="w-full border-collapse text-sm mb-8">
                    <thead><tr class="bg-gray-100"><th class="border px-3 py-2">No</th><th class="border px-3 py-2">Tujuan Pembelajaran</th><th class="border px-3 py-2">JP</th><th class="border px-3 py-2">Keterangan</th></tr></thead>
                    <tbody>${sem2.map((item, idx) => `<tr><td class="border px-3 py-2 text-center">${idx + 1}</td><td class="border px-3 py-2">${item.tp}</td><td class="border px-3 py-2 text-center">4</td><td class="border px-3 py-2">${item.element}</td></tr>`).join('')}</tbody>
                </table>
                ${generateSignature()}
            `;
        }

        // ===== PROMES =====
        function loadPromes() {
            document.getElementById('pageTitle').textContent = 'Program Semester (Promes)';
            document.getElementById('pageSubtitle').textContent = 'Detail dengan tanggal dan JP per minggu';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <div><h3 class="text-lg font-bold text-gray-800">Program Semester</h3></div>
                        <div class="flex gap-3">
                            <select id="promesClass" onchange="loadPromesForClass()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option></select>
                            <select id="promesSem" onchange="loadPromesForClass()" class="px-4 py-2 border rounded-xl"><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                            <button onclick="printDocument()" class="px-4 py-2 bg-primary-500 text-white rounded-xl"><i class="fas fa-print mr-2"></i>Cetak</button>
                        </div>
                    </div>
                    <div id="promesContainer"><p class="text-center text-gray-400 py-12">Pilih kelas dan semester</p></div>
                </div>
            `;
            populateClassSelect('promesClass');
        }

        function loadPromesForClass() {
            const val = document.getElementById('promesClass').value;
            const sem = document.getElementById('promesSem').value;
            if (!val) return;
            
            const [kelas, rombel] = val.split('-');
            const level = userData?.profile?.school?.level || 'SD';
            const phase = getPhaseByClass(kelas, level);
            const pd = CP_DATA_PAI.phases[phase];
            const school = userData?.profile?.school || {};
            const months = sem === '1' ? ['Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'] : ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'];
            
            let allTP = [];
            pd.elements.forEach(el => el.tujuanPembelajaran.forEach(tp => allTP.push({ element: el.name, tp })));
            const mid = Math.ceil(allTP.length / 2);
            const semTP = sem === '1' ? allTP.slice(0, mid) : allTP.slice(mid);
            
            let weekCounter = 0;
            
            document.getElementById('promesContainer').innerHTML = `
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold">PROGRAM SEMESTER ${sem === '1' ? 'GANJIL' : 'GENAP'}</h2>
                    <p class="text-gray-600">${userData?.academicYear}</p>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div><p><strong>Satuan Pendidikan:</strong> ${school.name || '-'}</p><p><strong>Kelas:</strong> ${kelas}-${rombel}</p></div>
                    <div><p><strong>Mata Pelajaran:</strong> ${userData?.profile?.subjects?.[0]?.name || 'PAI'}</p></div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-xs">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="border px-2 py-1" rowspan="2">No</th>
                                <th class="border px-2 py-1" rowspan="2" style="min-width:200px">Tujuan Pembelajaran</th>
                                <th class="border px-2 py-1" rowspan="2">JP</th>
                                ${months.map(m => `<th class="border px-1 py-1" colspan="4">${m}</th>`).join('')}
                            </tr>
                            <tr class="bg-gray-50">${months.map(() => '<th class="border px-1 py-1">1</th><th class="border px-1 py-1">2</th><th class="border px-1 py-1">3</th><th class="border px-1 py-1">4</th>').join('')}</tr>
                        </thead>
                        <tbody>
                            ${semTP.map((item, idx) => {
                                const startWeek = weekCounter;
                                weekCounter += 2;
                                let cells = '';
                                for (let m = 0; m < 6; m++) {
                                    for (let w = 0; w < 4; w++) {
                                        const wn = m * 4 + w;
                                        const active = wn >= startWeek && wn < startWeek + 2;
                                        cells += `<td class="border px-1 py-1 text-center ${active ? 'bg-primary-200' : ''}">${active ? '' : ''}</td>`;
                                    }
                                }
                                return `<tr><td class="border px-2 py-1 text-center">${idx + 1}</td><td class="border px-2 py-1">${item.tp}</td><td class="border px-2 py-1 text-center">4</td>${cells}</tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ${generateSignature()}
            `;
        }

        // ===== ATTENDANCE =====
        function loadAttendance() {
            document.getElementById('pageTitle').textContent = 'Absensi Siswa';
            document.getElementById('pageSubtitle').textContent = 'Kelola kehadiran siswa';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <h3 class="text-lg font-bold text-gray-800">Absensi</h3>
                        <div class="flex gap-3">
                            <select id="attClass" onchange="loadAttendanceForClass()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option></select>
                            <input type="date" id="attDate" value="${new Date().toISOString().split('T')[0]}" onchange="loadAttendanceForClass()" class="px-4 py-2 border rounded-xl">
                            <button onclick="saveAttendance()" class="px-4 py-2 bg-primary-500 text-white rounded-xl"><i class="fas fa-save mr-2"></i>Simpan</button>
                        </div>
                    </div>
                    <div id="attContainer"><p class="text-center text-gray-400 py-12">Pilih kelas dan tanggal</p></div>
                </div>
            `;
            populateClassSelect('attClass');
        }

        async function loadAttendanceForClass() {
            const val = document.getElementById('attClass').value;
            const date = document.getElementById('attDate').value;
            if (!val || !date) return;
            
            const [kelas, rombel] = val.split('-');
            
            try {
                const studentsSnap = await db.collection('users').doc(currentUser.uid).collection('students')
                    .where('kelas', '==', kelas).where('rombel', '==', rombel).orderBy('nama').get();
                
                const students = [];
                studentsSnap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
                
                const attDoc = await db.collection('users').doc(currentUser.uid).collection('attendance').doc(`${kelas}-${rombel}-${date}`).get();
                const existing = attDoc.exists ? attDoc.data().records : {};
                
                if (students.length === 0) {
                    document.getElementById('attContainer').innerHTML = '<p class="text-center text-gray-400 py-8">Tidak ada siswa di kelas ini</p>';
                    return;
                }
                
                document.getElementById('attContainer').innerHTML = `
                    <div class="mb-4 flex justify-between items-center">
                        <div><span class="font-semibold">Kelas ${kelas}-${rombel}</span> | ${formatDate(date)}</div>
                        <div class="flex gap-4 text-sm">
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full">H: <span id="cH">0</span></span>
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full">I: <span id="cI">0</span></span>
                            <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full">S: <span id="cS">0</span></span>
                            <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full">A: <span id="cA">0</span></span>
                        </div>
                    </div>
                    <table class="w-full">
                        <thead><tr class="bg-gray-50"><th class="px-4 py-2 text-left">No</th><th class="px-4 py-2 text-left">Nama</th><th class="px-4 py-2 text-center">L/P</th><th class="px-4 py-2 text-center">H</th><th class="px-4 py-2 text-center">I</th><th class="px-4 py-2 text-center">S</th><th class="px-4 py-2 text-center">A</th></tr></thead>
                        <tbody>
                            ${students.map((s, idx) => {
                                const status = existing[s.id] || 'H';
                                return `<tr class="border-b">
                                    <td class="px-4 py-2">${idx + 1}</td>
                                    <td class="px-4 py-2 font-medium">${s.nama}</td>
                                    <td class="px-4 py-2 text-center">${s.jk}</td>
                                    <td class="px-4 py-2 text-center"><input type="radio" name="att-${s.id}" value="H" ${status === 'H' ? 'checked' : ''} onchange="updateAttCount()" class="w-4 h-4"></td>
                                    <td class="px-4 py-2 text-center"><input type="radio" name="att-${s.id}" value="I" ${status === 'I' ? 'checked' : ''} onchange="updateAttCount()" class="w-4 h-4"></td>
                                    <td class="px-4 py-2 text-center"><input type="radio" name="att-${s.id}" value="S" ${status === 'S' ? 'checked' : ''} onchange="updateAttCount()" class="w-4 h-4"></td>
                                    <td class="px-4 py-2 text-center"><input type="radio" name="att-${s.id}" value="A" ${status === 'A' ? 'checked' : ''} onchange="updateAttCount()" class="w-4 h-4"></td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                updateAttCount();
            } catch (error) {
                console.error(error);
            }
        }

        function updateAttCount() {
            const counts = { H: 0, I: 0, S: 0, A: 0 };
            document.querySelectorAll('input[type="radio"]:checked').forEach(r => counts[r.value]++);
            document.getElementById('cH').textContent = counts.H;
            document.getElementById('cI').textContent = counts.I;
            document.getElementById('cS').textContent = counts.S;
            document.getElementById('cA').textContent = counts.A;
        }

        async function saveAttendance() {
            const val = document.getElementById('attClass').value;
            const date = document.getElementById('attDate').value;
            if (!val || !date) { showToast('Pilih kelas dan tanggal', 'warning'); return; }
            
            const [kelas, rombel] = val.split('-');
            showLoading('Menyimpan...');
            
            try {
                const records = {};
                document.querySelectorAll('input[type="radio"]:checked').forEach(r => {
                    records[r.name.replace('att-', '')] = r.value;
                });
                
                await db.collection('users').doc(currentUser.uid).collection('attendance').doc(`${kelas}-${rombel}-${date}`).set({
                    kelas, rombel, tanggal: date, records,
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Absensi tersimpan!', 'success');
            } catch (error) {
                showToast('Gagal menyimpan', 'error');
            }
            hideLoading();
        }

        // ===== JOURNAL =====
        function loadJournal() {
            document.getElementById('pageTitle').textContent = 'Jurnal Pembelajaran';
            document.getElementById('pageSubtitle').textContent = 'Sinkron dengan Promes dan Absensi';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <h3 class="text-lg font-bold text-gray-800">Jurnal Pembelajaran</h3>
                        <div class="flex gap-3">
                            <select id="jrnClass" onchange="loadJournalForClass()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option></select>
                            <select id="jrnSem" class="px-4 py-2 border rounded-xl"><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                            <button onclick="addJournalEntry()" class="px-4 py-2 bg-primary-500 text-white rounded-xl"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            <button onclick="printDocument()" class="px-4 py-2 border rounded-xl"><i class="fas fa-print mr-2"></i>Cetak</button>
                        </div>
                    </div>
                    <div id="jrnContainer"><p class="text-center text-gray-400 py-12">Pilih kelas untuk melihat jurnal</p></div>
                </div>
            `;
            populateClassSelect('jrnClass');
        }

        async function loadJournalForClass() {
            const val = document.getElementById('jrnClass').value;
            if (!val) return;
            
            const [kelas, rombel] = val.split('-');
            const sem = document.getElementById('jrnSem').value;
            const school = userData?.profile?.school || {};
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid).collection('journals')
                    .where('kelas', '==', kelas).where('rombel', '==', rombel).where('semester', '==', sem)
                    .orderBy('tanggal', 'desc').get();
                
                const journals = [];
                snap.forEach(doc => journals.push({ id: doc.id, ...doc.data() }));
                
                document.getElementById('jrnContainer').innerHTML = `
                    <div class="text-center mb-6"><h2 class="text-xl font-bold">JURNAL PEMBELAJARAN</h2></div>
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                        <div><p><strong>Mata Pelajaran:</strong> ${userData?.profile?.subjects?.[0]?.name || 'PAI'}</p><p><strong>Semester:</strong> ${sem}</p></div>
                        <div><p><strong>Tahun Pelajaran:</strong> ${userData?.academicYear}</p></div>
                    </div>
                    <table class="w-full border-collapse text-sm">
                        <thead><tr class="bg-gray-100"><th class="border px-3 py-2">No</th><th class="border px-3 py-2">Kelas</th><th class="border px-3 py-2">Materi</th><th class="border px-3 py-2">Tujuan Pembelajaran</th><th class="border px-3 py-2">Kehadiran</th><th class="border px-3 py-2">Hari/Tanggal</th><th class="border px-3 py-2">Hasil</th></tr></thead>
                        <tbody>
                            ${journals.length === 0 ? '<tr><td colspan="7" class="border px-3 py-8 text-center text-gray-400">Belum ada jurnal</td></tr>' :
                            journals.map((j, idx) => `<tr><td class="border px-3 py-2 text-center">${idx + 1}</td><td class="border px-3 py-2">${j.kelas}-${j.rombel}</td><td class="border px-3 py-2">${j.materi || '-'}</td><td class="border px-3 py-2">${j.tp || '-'}</td><td class="border px-3 py-2 text-center">${j.kehadiran || '-'}</td><td class="border px-3 py-2">${j.tanggal || '-'}</td><td class="border px-3 py-2">${j.hasil || '-'}</td></tr>`).join('')}
                        </tbody>
                    </table>
                    ${generateSignature()}
                `;
            } catch (error) {
                console.error(error);
            }
        }

        function addJournalEntry() {
            const val = document.getElementById('jrnClass')?.value;
            if (!val) { showToast('Pilih kelas dulu', 'warning'); return; }
            
            const [kelas, rombel] = val.split('-');
            const level = userData?.profile?.school?.level || 'SD';
            const phase = getPhaseByClass(kelas, level);
            const pd = CP_DATA_PAI.phases[phase];
            
            let tpOptions = '';
            pd.elements.forEach(el => {
                el.tujuanPembelajaran.forEach(tp => {
                    tpOptions += `<option value="${tp}">${el.name}: ${tp.substring(0, 50)}...</option>`;
                });
            });
            
            const modal = document.createElement('div');
            modal.id = 'jrnModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">Tambah Jurnal</h3>
                        <button onclick="this.closest('#jrnModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="jrnForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Tanggal</label><input type="date" id="jrnDate" value="${new Date().toISOString().split('T')[0]}" required class="w-full px-3 py-2 border rounded-lg"></div>
                            <div><label class="block text-sm font-medium mb-1">Kehadiran</label><input type="text" id="jrnHadir" placeholder="30/32" class="w-full px-3 py-2 border rounded-lg"></div>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">Tujuan Pembelajaran</label><select id="jrnTP" class="w-full px-3 py-2 border rounded-lg">${tpOptions}</select></div>
                        <div><label class="block text-sm font-medium mb-1">Materi</label><input type="text" id="jrnMateri" class="w-full px-3 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium mb-1">Hasil Pembelajaran</label><textarea id="jrnHasil" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea></div>
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="this.closest('#jrnModal').remove()" class="px-4 py-2 border rounded-xl">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-xl">Simpan</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('jrnForm').addEventListener('submit', saveJournal);
        }

        async function saveJournal(e) {
            e.preventDefault();
            const val = document.getElementById('jrnClass').value;
            const [kelas, rombel] = val.split('-');
            const sem = document.getElementById('jrnSem').value;
            
            showLoading('Menyimpan...');
            try {
                await db.collection('users').doc(currentUser.uid).collection('journals').add({
                    kelas, rombel, semester: sem,
                    tanggal: document.getElementById('jrnDate').value,
                    tp: document.getElementById('jrnTP').value,
                    materi: document.getElementById('jrnMateri').value,
                    kehadiran: document.getElementById('jrnHadir').value,
                    hasil: document.getElementById('jrnHasil').value,
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('jrnModal')?.remove();
                showToast('Jurnal tersimpan!', 'success');
                loadJournalForClass();
            } catch (error) {
                showToast('Gagal menyimpan', 'error');
            }
            hideLoading();
        }

        // ===== GRADES =====
        function loadGrades() {
            document.getElementById('pageTitle').textContent = 'Daftar Nilai';
            document.getElementById('pageSubtitle').textContent = 'PH, PTS, PAS, dan Nilai Raport';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <h3 class="text-lg font-bold text-gray-800">Daftar Nilai</h3>
                        <div class="flex gap-3">
                            <select id="gradeClass" onchange="loadGradesForClass()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option></select>
                            <select id="gradeSem" onchange="loadGradesForClass()" class="px-4 py-2 border rounded-xl"><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                            <button onclick="saveGrades()" class="px-4 py-2 bg-primary-500 text-white rounded-xl"><i class="fas fa-save mr-2"></i>Simpan</button>
                        </div>
                    </div>
                    <div id="gradeContainer"><p class="text-center text-gray-400 py-12">Pilih kelas dan semester</p></div>
                </div>
            `;
            populateClassSelect('gradeClass');
        }

        async function loadGradesForClass() {
            const val = document.getElementById('gradeClass').value;
            const sem = document.getElementById('gradeSem').value;
            if (!val) return;
            
            const [kelas, rombel] = val.split('-');
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid).collection('students')
                    .where('kelas', '==', kelas).where('rombel', '==', rombel).orderBy('nama').get();
                
                const students = [];
                snap.forEach(doc => students.push({ id: doc.id, ...doc.data() }));
                
                if (students.length === 0) {
                    document.getElementById('gradeContainer').innerHTML = '<p class="text-center text-gray-400 py-8">Tidak ada siswa</p>';
                    return;
                }
                
                document.getElementById('gradeContainer').innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr class="bg-gray-100"><th class="px-3 py-2 text-left">No</th><th class="px-3 py-2 text-left">Nama</th><th class="px-3 py-2 text-center">PH1</th><th class="px-3 py-2 text-center">PH2</th><th class="px-3 py-2 text-center">PTS</th><th class="px-3 py-2 text-center">${sem === '1' ? 'PAS' : 'PAT'}</th><th class="px-3 py-2 text-center bg-green-100">NA</th></tr></thead>
                            <tbody>
                                ${students.map((s, idx) => `
                                    <tr class="border-b" data-student="${s.id}">
                                        <td class="px-3 py-2">${idx + 1}</td>
                                        <td class="px-3 py-2 font-medium">${s.nama}</td>
                                        <td class="px-3 py-2"><input type="number" class="w-16 px-2 py-1 border rounded text-center grade-input" data-type="PH1" min="0" max="100"></td>
                                        <td class="px-3 py-2"><input type="number" class="w-16 px-2 py-1 border rounded text-center grade-input" data-type="PH2" min="0" max="100"></td>
                                        <td class="px-3 py-2"><input type="number" class="w-16 px-2 py-1 border rounded text-center grade-input" data-type="PTS" min="0" max="100"></td>
                                        <td class="px-3 py-2"><input type="number" class="w-16 px-2 py-1 border rounded text-center grade-input" data-type="PAS" min="0" max="100"></td>
                                        <td class="px-3 py-2 text-center font-bold text-green-700 na-val">-</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.querySelectorAll('.grade-input').forEach(inp => inp.addEventListener('input', calcNA));
            } catch (error) {
                console.error(error);
            }
        }

        function calcNA() {
            document.querySelectorAll('tbody tr').forEach(row => {
                const inputs = row.querySelectorAll('.grade-input');
                let total = 0, count = 0;
                inputs.forEach(inp => {
                    const v = parseFloat(inp.value);
                    if (!isNaN(v)) { total += v; count++; }
                });
                row.querySelector('.na-val').textContent = count > 0 ? Math.round(total / count) : '-';
            });
        }

                // ===== MODUL AJAR (PREMIUM - FULL FEATURE) =====
        function loadModulAjar() {
            document.getElementById('pageTitle').textContent = 'Modul Ajar';
            document.getElementById('pageSubtitle').textContent = 'Sinkron dengan Promes, terintegrasi Jurnal & LKPD';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Modul Ajar</h3>
                            <p class="text-gray-500 text-sm">Support teks Arab (RTL)</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="modulClass" onchange="loadModulList()" class="px-4 py-2 border rounded-xl">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <button onclick="showAddModulModal()" class="px-4 py-2 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl">
                                <i class="fas fa-plus mr-2"></i>Buat Modul Baru
                            </button>
                        </div>
                    </div>
                    <div id="modulListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="col-span-full text-center text-gray-400 py-8">Pilih kelas untuk melihat modul ajar</p>
                    </div>
                </div>
            `;
            
            populateClassSelect('modulClass');
        }

        async function loadModulList() {
            const val = document.getElementById('modulClass').value;
            if (!val) return;
            
            const [kelas, rombel] = val.split('-');
            const container = document.getElementById('modulListContainer');
            
            try {
                const snap = await db.collection('users').doc(currentUser.uid).collection('moduls')
                    .where('kelas', '==', kelas).where('rombel', '==', rombel)
                    .orderBy('createdAt', 'desc').get();
                
                if (snap.empty) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-book text-5xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Belum ada modul ajar untuk kelas ini</p>
                            <button onclick="showAddModulModal()" class="mt-4 px-4 py-2 bg-primary-500 text-white rounded-xl">
                                <i class="fas fa-plus mr-2"></i>Buat Modul Pertama
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    html += `
                        <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-book text-primary-600"></i>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="editModul('${doc.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteModul('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-1">${m.judul || 'Modul Tanpa Judul'}</h4>
                            <p class="text-sm text-gray-500 mb-3">${m.tp ? m.tp.substring(0, 60) + '...' : '-'}</p>
                            <div class="flex justify-between items-center text-xs text-gray-400">
                                <span><i class="fas fa-clock mr-1"></i>${m.alokasi || '2'} JP</span>
                                <span>${m.pertemuan || 'Pertemuan 1'}</span>
                            </div>
                            ${m.includeLKPD ? '<span class="mt-2 inline-block px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full"><i class="fas fa-file-alt mr-1"></i>LKPD</span>' : ''}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading moduls:', error);
                container.innerHTML = '<p class="col-span-full text-center text-red-500">Gagal memuat data</p>';
            }
        }

        function showAddModulModal() {
            const val = document.getElementById('modulClass')?.value;
            if (!val) { showToast('Pilih kelas dulu', 'warning'); return; }
            
            const [kelas, rombel] = val.split('-');
            const level = userData?.profile?.school?.level || 'SD';
            const phase = getPhaseByClass(kelas, level);
            const pd = CP_DATA_PAI.phases[phase];
            
            let tpOptions = '<option value="">Pilih TP...</option>';
            pd.elements.forEach(el => {
                el.tujuanPembelajaran.forEach(tp => {
                    tpOptions += `<option value="${tp}">${el.name}: ${tp.substring(0, 50)}...</option>`;
                });
            });
            
            const modal = document.createElement('div');
            modal.id = 'modulModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6 my-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Buat Modul Ajar</h3>
                        <button onclick="this.closest('#modulModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="modulForm" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Judul Modul *</label><input type="text" id="modulJudul" required class="w-full px-4 py-2 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-1">Pertemuan Ke</label><input type="text" id="modulPertemuan" value="1" class="w-full px-4 py-2 border rounded-xl"></div>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">Tujuan Pembelajaran</label><select id="modulTP" class="w-full px-4 py-2 border rounded-xl">${tpOptions}</select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Alokasi Waktu (JP)</label><input type="number" id="modulAlokasi" value="2" min="1" class="w-full px-4 py-2 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-1">Model Pembelajaran</label><input type="text" id="modulModel" placeholder="Discovery Learning, dll" class="w-full px-4 py-2 border rounded-xl"></div>
                        </div>
                        
                        <div class="border-t pt-4 mt-4">
                            <h4 class="font-semibold mb-3">Kegiatan Pembelajaran</h4>
                            <div><label class="block text-sm font-medium mb-1">Pendahuluan</label><textarea id="modulPendahuluan" rows="3" class="w-full px-4 py-2 border rounded-xl" placeholder="Kegiatan pembuka, apersepsi, motivasi..."></textarea></div>
                            <div class="mt-3"><label class="block text-sm font-medium mb-1">Inti</label><textarea id="modulInti" rows="5" class="w-full px-4 py-2 border rounded-xl" placeholder="Kegiatan inti pembelajaran..."></textarea></div>
                            <div class="mt-3"><label class="block text-sm font-medium mb-1">Penutup</label><textarea id="modulPenutup" rows="3" class="w-full px-4 py-2 border rounded-xl" placeholder="Refleksi, kesimpulan, tindak lanjut..."></textarea></div>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <h4 class="font-semibold mb-3">Materi (Support Teks Arab)</h4>
                            <div><label class="block text-sm font-medium mb-1">Materi Pembelajaran</label>
                            <textarea id="modulMateri" rows="4" class="w-full px-4 py-2 border rounded-xl" placeholder="Tulis materi di sini. Untuk teks Arab, cukup paste langsung."></textarea>
                            <p class="text-xs text-gray-500 mt-1">Contoh teks Arab:    </p>
                            </div>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <h4 class="font-semibold mb-3">Penilaian</h4>
                            <div><label class="block text-sm font-medium mb-1">Teknik Penilaian</label><input type="text" id="modulPenilaian" placeholder="Tes tertulis, observasi, dll" class="w-full px-4 py-2 border rounded-xl"></div>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="modulLKPD" class="w-5 h-5 rounded border-gray-300 text-primary-600">
                                <span class="font-medium">Sertakan LKPD (Lembar Kerja Peserta Didik)</span>
                            </label>
                            <div id="lkpdSection" class="hidden mt-3 p-4 bg-gray-50 rounded-xl">
                                <label class="block text-sm font-medium mb-1">Isi LKPD (Bahasa untuk siswa)</label>
                                <textarea id="modulLKPDContent" rows="4" class="w-full px-4 py-2 border rounded-xl" placeholder="Tulis lembar kerja untuk siswa..."></textarea>
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button type="button" onclick="this.closest('#modulModal').remove()" class="px-6 py-2 border rounded-xl">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-gradient-to-r from-primary-600 to-purple-600 text-white rounded-xl">Simpan Modul</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('modulLKPD').addEventListener('change', function() {
                document.getElementById('lkpdSection').classList.toggle('hidden', !this.checked);
            });
            
            document.getElementById('modulForm').addEventListener('submit', saveModul);
        }

        async function saveModul(e) {
            e.preventDefault();
            const val = document.getElementById('modulClass').value;
            const [kelas, rombel] = val.split('-');
            
            showLoading('Menyimpan modul...');
            
            try {
                const modulData = {
                    kelas, rombel,
                    judul: document.getElementById('modulJudul').value.trim(),
                    pertemuan: document.getElementById('modulPertemuan').value.trim(),
                    tp: document.getElementById('modulTP').value,
                    alokasi: document.getElementById('modulAlokasi').value,
                    model: document.getElementById('modulModel').value.trim(),
                    pendahuluan: document.getElementById('modulPendahuluan').value.trim(),
                    inti: document.getElementById('modulInti').value.trim(),
                    penutup: document.getElementById('modulPenutup').value.trim(),
                    materi: document.getElementById('modulMateri').value.trim(),
                    penilaian: document.getElementById('modulPenilaian').value.trim(),
                    includeLKPD: document.getElementById('modulLKPD').checked,
                    lkpdContent: document.getElementById('modulLKPDContent')?.value?.trim() || '',
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).collection('moduls').add(modulData);
                
                document.getElementById('modulModal')?.remove();
                showToast('Modul ajar berhasil disimpan!', 'success');
                loadModulList();
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan modul', 'error');
            }
            hideLoading();
        }

        async function deleteModul(id) {
            if (!confirm('Hapus modul ini?')) return;
            showLoading('Menghapus...');
            try {
                await db.collection('users').doc(currentUser.uid).collection('moduls').doc(id).delete();
                showToast('Modul dihapus', 'success');
                loadModulList();
            } catch (error) {
                showToast('Gagal menghapus', 'error');
            }
            hideLoading();
        }

        // ===== LKPD (PREMIUM - FULL FEATURE) =====
        function loadLKPD() {
            document.getElementById('pageTitle').textContent = 'LKPD';
            document.getElementById('pageSubtitle').textContent = 'Lembar Kerja Peserta Didik - Terintegrasi Modul Ajar';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">LKPD</h3>
                            <p class="text-gray-500 text-sm">Bahasa untuk siswa, support teks Arab</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="lkpdClass" onchange="loadLKPDList()" class="px-4 py-2 border rounded-xl">
                                <option value="">Pilih Kelas</option>
                            </select>
                            <button onclick="showAddLKPDModal()" class="px-4 py-2 bg-primary-500 text-white rounded-xl">
                                <i class="fas fa-plus mr-2"></i>Buat LKPD
                            </button>
                        </div>
                    </div>
                    <div id="lkpdListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="col-span-full text-center text-gray-400 py-8">Pilih kelas untuk melihat LKPD</p>
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6">
                    <h4 class="font-semibold text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Tips</h4>
                    <p class="text-blue-700 text-sm">LKPD juga dapat dibuat otomatis saat membuat Modul Ajar dengan mencentang opsi "Sertakan LKPD".</p>
                </div>
            `;
            
            populateClassSelect('lkpdClass');
        }

        async function loadLKPDList() {
            const val = document.getElementById('lkpdClass').value;
            if (!val) return;
            
            const [kelas, rombel] = val.split('-');
            const container = document.getElementById('lkpdListContainer');
            
            try {
                // Get LKPD from both standalone and from moduls with LKPD
                const [lkpdSnap, modulSnap] = await Promise.all([
                    db.collection('users').doc(currentUser.uid).collection('lkpd')
                        .where('kelas', '==', kelas).where('rombel', '==', rombel).get(),
                    db.collection('users').doc(currentUser.uid).collection('moduls')
                        .where('kelas', '==', kelas).where('rombel', '==', rombel)
                        .where('includeLKPD', '==', true).get()
                ]);
                
                if (lkpdSnap.empty && modulSnap.empty) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <i class="fas fa-file-alt text-5xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Belum ada LKPD untuk kelas ini</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // Standalone LKPD
                lkpdSnap.forEach(doc => {
                    const l = doc.data();
                    html += `
                        <div class="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-file-alt text-green-600"></i>
                                </div>
                                <button onclick="deleteLKPD('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-1">${l.judul || 'LKPD'}</h4>
                            <p class="text-sm text-gray-500 mb-3">${l.materi ? l.materi.substring(0, 60) + '...' : '-'}</p>
                            <button onclick="printLKPD('${doc.id}')" class="text-sm text-primary-600 hover:text-primary-700"><i class="fas fa-print mr-1"></i>Cetak</button>
                        </div>
                    `;
                });
                
                // LKPD from Moduls
                modulSnap.forEach(doc => {
                    const m = doc.data();
                    html += `
                        <div class="bg-white border border-green-200 rounded-xl p-5 hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-file-alt text-green-600"></i>
                                </div>
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Dari Modul</span>
                            </div>
                            <h4 class="font-bold text-gray-800 mb-1">LKPD: ${m.judul || ''}</h4>
                            <p class="text-sm text-gray-500 mb-3">${m.lkpdContent ? m.lkpdContent.substring(0, 60) + '...' : '-'}</p>
                            <button onclick="viewModulLKPD('${doc.id}')" class="text-sm text-primary-600 hover:text-primary-700"><i class="fas fa-eye mr-1"></i>Lihat</button>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error(error);
                container.innerHTML = '<p class="col-span-full text-center text-red-500">Gagal memuat data</p>';
            }
        }

        function showAddLKPDModal() {
            const val = document.getElementById('lkpdClass')?.value;
            if (!val) { showToast('Pilih kelas dulu', 'warning'); return; }
            
            const [kelas, rombel] = val.split('-');
            
            const modal = document.createElement('div');
            modal.id = 'lkpdModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Buat LKPD</h3>
                        <button onclick="this.closest('#lkpdModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="lkpdForm" class="space-y-4">
                        <div><label class="block text-sm font-medium mb-1">Judul LKPD *</label><input type="text" id="lkpdJudul" required class="w-full px-4 py-2 border rounded-xl"></div>
                        <div><label class="block text-sm font-medium mb-1">Materi Pokok</label><input type="text" id="lkpdMateri" class="w-full px-4 py-2 border rounded-xl"></div>
                        <div><label class="block text-sm font-medium mb-1">Petunjuk Pengerjaan</label><textarea id="lkpdPetunjuk" rows="3" class="w-full px-4 py-2 border rounded-xl"></textarea></div>
                        <div><label class="block text-sm font-medium mb-1">Isi LKPD / Soal / Kegiatan (Support Teks Arab)</label>
                        <textarea id="lkpdIsi" rows="6" class="w-full px-4 py-2 border rounded-xl" placeholder="Tulis lembar kerja untuk siswa. Untuk teks Arab, paste langsung."></textarea>
                        <p class="text-xs text-gray-500 mt-1">Contoh:   </p>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="this.closest('#lkpdModal').remove()" class="px-6 py-2 border rounded-xl">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-primary-500 text-white rounded-xl">Simpan LKPD</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('lkpdForm').addEventListener('submit', saveLKPD);
        }

        async function saveLKPD(e) {
            e.preventDefault();
            const val = document.getElementById('lkpdClass').value;
            const [kelas, rombel] = val.split('-');
            
            showLoading('Menyimpan LKPD...');
            try {
                await db.collection('users').doc(currentUser.uid).collection('lkpd').add({
                    kelas, rombel,
                    judul: document.getElementById('lkpdJudul').value.trim(),
                    materi: document.getElementById('lkpdMateri').value.trim(),
                    petunjuk: document.getElementById('lkpdPetunjuk').value.trim(),
                    isi: document.getElementById('lkpdIsi').value.trim(),
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('lkpdModal')?.remove();
                showToast('LKPD berhasil disimpan!', 'success');
                loadLKPDList();
            } catch (error) {
                showToast('Gagal menyimpan', 'error');
            }
            hideLoading();
        }

        async function deleteLKPD(id) {
            if (!confirm('Hapus LKPD ini?')) return;
            showLoading('Menghapus...');
            try {
                await db.collection('users').doc(currentUser.uid).collection('lkpd').doc(id).delete();
                showToast('LKPD dihapus', 'success');
                loadLKPDList();
            } catch (error) {
                showToast('Gagal menghapus', 'error');
            }
            hideLoading();
        }

        // ===== BANK SOAL (PREMIUM - FULL FEATURE) =====
        function loadBankSoal() {
            document.getElementById('pageTitle').textContent = 'Bank Soal';
            document.getElementById('pageSubtitle').textContent = 'Terintegrasi ATP, support teks Arab';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Bank Soal</h3>
                            <p class="text-gray-500 text-sm">Total: <span id="soalCount">0</span> soal</p>
                        </div>
                        <div class="flex gap-3">
                            <select id="soalPhase" onchange="loadSoalList()" class="px-4 py-2 border rounded-xl">
                                <option value="">Semua Fase</option>
                                <option value="A">Fase A</option>
                                <option value="B">Fase B</option>
                                <option value="C">Fase C</option>
                                <option value="D">Fase D</option>
                                <option value="E">Fase E</option>
                                <option value="F">Fase F</option>
                            </select>
                            <select id="soalType" onchange="loadSoalList()" class="px-4 py-2 border rounded-xl">
                                <option value="">Semua Tipe</option>
                                <option value="PG">Pilihan Ganda</option>
                                <option value="Uraian">Uraian</option>
                            </select>
                            <button onclick="showAddSoalModal()" class="px-4 py-2 bg-primary-500 text-white rounded-xl">
                                <i class="fas fa-plus mr-2"></i>Tambah Soal
                            </button>
                        </div>
                    </div>
                    <div id="soalListContainer" class="space-y-4">
                        <p class="text-center text-gray-400 py-8">Memuat data...</p>
                    </div>
                </div>
            `;
            
            loadSoalList();
        }

        async function loadSoalList() {
            const container = document.getElementById('soalListContainer');
            const phaseFilter = document.getElementById('soalPhase').value;
            const typeFilter = document.getElementById('soalType').value;
            
            try {
                let query = db.collection('users').doc(currentUser.uid).collection('banksoal');
                
                if (phaseFilter) query = query.where('fase', '==', phaseFilter);
                if (typeFilter) query = query.where('tipe', '==', typeFilter);
                
                const snap = await query.orderBy('createdAt', 'desc').get();
                
                document.getElementById('soalCount').textContent = snap.size;
                
                if (snap.empty) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-question-circle text-5xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Belum ada soal</p>
                            <button onclick="showAddSoalModal()" class="mt-4 px-4 py-2 bg-primary-500 text-white rounded-xl">
                                <i class="fas fa-plus mr-2"></i>Tambah Soal Pertama
                            </button>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                let no = 1;
                snap.forEach(doc => {
                    const s = doc.data();
                    html += `
                        <div class="border rounded-xl p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="w-8 h-8 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold text-sm">${no}</span>
                                    <div>
                                        <span class="px-2 py-1 ${s.tipe === 'PG' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'} text-xs rounded-full">${s.tipe}</span>
                                        <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full ml-1">Fase ${s.fase || '-'}</span>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="editSoal('${doc.id}')" class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg text-sm"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteSoal('${doc.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg text-sm"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="mb-3 ${s.soal && /[\u0600-\u06FF]/.test(s.soal) ? 'rtl-text text-right' : ''}">
                                <p class="text-gray-800">${s.soal || '-'}</p>
                            </div>
                            ${s.tipe === 'PG' ? `
                                <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                                    <div class="p-2 ${s.jawaban === 'A' ? 'bg-green-100 text-green-700' : 'bg-gray-50'}">A. ${s.opsiA || '-'}</div>
                                    <div class="p-2 ${s.jawaban === 'B' ? 'bg-green-100 text-green-700' : 'bg-gray-50'}">B. ${s.opsiB || '-'}</div>
                                    <div class="p-2 ${s.jawaban === 'C' ? 'bg-green-100 text-green-700' : 'bg-gray-50'}">C. ${s.opsiC || '-'}</div>
                                    <div class="p-2 ${s.jawaban === 'D' ? 'bg-green-100 text-green-700' : 'bg-gray-50'}">D. ${s.opsiD || '-'}</div>
                                </div>
                            ` : `
                                <div class="p-2 bg-green-50 text-green-700 text-sm rounded mb-3">
                                    <strong>Jawaban:</strong> ${s.jawaban || '-'}
                                </div>
                            `}
                            ${s.pembahasan ? `<div class="p-2 bg-yellow-50 text-yellow-800 text-sm rounded"><strong>Pembahasan:</strong> ${s.pembahasan}</div>` : ''}
                        </div>
                    `;
                    no++;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error(error);
                container.innerHTML = '<p class="text-center text-red-500">Gagal memuat data</p>';
            }
        }

        function showAddSoalModal() {
            const level = userData?.profile?.school?.level || 'SD';
            const phaseMap = { 'SD': ['A', 'B', 'C'], 'SMP': ['D'], 'SMA': ['E', 'F'], 'SMK': ['E', 'F'] };
            const phases = phaseMap[level] || ['A', 'B', 'C'];
            
            const modal = document.createElement('div');
            modal.id = 'soalModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 my-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Tambah Soal</h3>
                        <button onclick="this.closest('#soalModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-times"></i></button>
                    </div>
                    <form id="soalForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-1">Fase</label>
                                <select id="soalFase" class="w-full px-4 py-2 border rounded-xl">
                                    ${phases.map(p => `<option value="${p}">Fase ${p}</option>`).join('')}
                                </select>
                            </div>
                            <div><label class="block text-sm font-medium mb-1">Tipe Soal</label>
                                <select id="soalTipe" onchange="toggleSoalOptions()" class="w-full px-4 py-2 border rounded-xl">
                                    <option value="PG">Pilihan Ganda</option>
                                    <option value="Uraian">Uraian</option>
                                </select>
                            </div>
                        </div>
                        
                        <div><label class="block text-sm font-medium mb-1">Soal (Support Teks Arab)</label>
                            <textarea id="soalText" rows="3" required class="w-full px-4 py-2 border rounded-xl" placeholder="Tulis soal di sini. Untuk teks Arab, paste langsung."></textarea>
                            <p class="text-xs text-gray-500 mt-1">Contoh:     </p>
                        </div>
                        
                        <div id="pgOptions" class="space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="block text-sm font-medium mb-1">Opsi A</label><input type="text" id="opsiA" class="w-full px-4 py-2 border rounded-xl"></div>
                                <div><label class="block text-sm font-medium mb-1">Opsi B</label><input type="text" id="opsiB" class="w-full px-4 py-2 border rounded-xl"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="block text-sm font-medium mb-1">Opsi C</label><input type="text" id="opsiC" class="w-full px-4 py-2 border rounded-xl"></div>
                                <div><label class="block text-sm font-medium mb-1">Opsi D</label><input type="text" id="opsiD" class="w-full px-4 py-2 border rounded-xl"></div>
                            </div>
                            <div><label class="block text-sm font-medium mb-1">Jawaban Benar</label>
                                <select id="jawabanPG" class="w-full px-4 py-2 border rounded-xl">
                                    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="uraianOptions" class="hidden">
                            <label class="block text-sm font-medium mb-1">Kunci Jawaban</label>
                            <textarea id="jawabanUraian" rows="3" class="w-full px-4 py-2 border rounded-xl"></textarea>
                        </div>
                        
                        <div><label class="block text-sm font-medium mb-1">Pembahasan (Opsional)</label>
                            <textarea id="pembahasan" rows="2" class="w-full px-4 py-2 border rounded-xl"></textarea>
                        </div>
                        
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" onclick="this.closest('#soalModal').remove()" class="px-6 py-2 border rounded-xl">Batal</button>
                            <button type="submit" class="px-6 py-2 bg-primary-500 text-white rounded-xl">Simpan Soal</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('soalForm').addEventListener('submit', saveSoal);
        }

        function toggleSoalOptions() {
            const tipe = document.getElementById('soalTipe').value;
            document.getElementById('pgOptions').classList.toggle('hidden', tipe !== 'PG');
            document.getElementById('uraianOptions').classList.toggle('hidden', tipe !== 'Uraian');
        }

        async function saveSoal(e) {
            e.preventDefault();
            showLoading('Menyimpan soal...');
            
            const tipe = document.getElementById('soalTipe').value;
            
            try {
                const soalData = {
                    fase: document.getElementById('soalFase').value,
                    tipe: tipe,
                    soal: document.getElementById('soalText').value.trim(),
                    pembahasan: document.getElementById('pembahasan').value.trim(),
                    academicYear: userData?.academicYear || getCurrentAcademicYear(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (tipe === 'PG') {
                    soalData.opsiA = document.getElementById('opsiA').value.trim();
                    soalData.opsiB = document.getElementById('opsiB').value.trim();
                    soalData.opsiC = document.getElementById('opsiC').value.trim();
                    soalData.opsiD = document.getElementById('opsiD').value.trim();
                    soalData.jawaban = document.getElementById('jawabanPG').value;
                } else {
                    soalData.jawaban = document.getElementById('jawabanUraian').value.trim();
                }
                
                await db.collection('users').doc(currentUser.uid).collection('banksoal').add(soalData);
                
                document.getElementById('soalModal')?.remove();
                showToast('Soal berhasil disimpan!', 'success');
                loadSoalList();
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan soal', 'error');
            }
            hideLoading();
        }

        async function deleteSoal(id) {
            if (!confirm('Hapus soal ini?')) return;
            showLoading('Menghapus...');
            try {
                await db.collection('users').doc(currentUser.uid).collection('banksoal').doc(id).delete();
                showToast('Soal dihapus', 'success');
                loadSoalList();
            } catch (error) {
                showToast('Gagal menghapus', 'error');
            }
            hideLoading();
        }

        // ===== AI ASSISTANT =====
        function loadAIAssistant() {
            document.getElementById('pageTitle').textContent = 'AI Assistant';
            document.getElementById('pageSubtitle').textContent = 'Bantu format data untuk import';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-magic mr-2 text-purple-500"></i>Generator Prompt</h3>
                        <p class="text-gray-600 mb-4">Pilih jenis data, copy prompt, paste ke ChatGPT/Claude dengan data mentah Anda.</p>
                        <select id="aiType" onchange="generatePrompt()" class="w-full px-4 py-3 border rounded-xl mb-4">
                            <option value="">Pilih jenis data...</option>
                            <option value="students">Data Siswa</option>
                            <option value="calendar">Kalender Pendidikan</option>
                            <option value="tp">Tujuan Pembelajaran</option>
                            <option value="soal">Bank Soal</option>
                        </select>
                        <div id="promptResult" class="hidden">
                            <label class="block text-sm font-medium mb-2">Prompt untuk AI:</label>
                            <div class="relative">
                                <textarea id="promptText" readonly rows="12" class="w-full px-4 py-3 border rounded-xl bg-gray-50 text-sm"></textarea>
                                <button onclick="copyPrompt()" class="absolute top-2 right-2 px-3 py-1 bg-primary-500 text-white rounded-lg text-sm"><i class="fas fa-copy mr-1"></i>Copy</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-info-circle mr-2 text-blue-500"></i>Cara Penggunaan</h3>
                        <div class="space-y-4">
                            <div class="flex items-start space-x-3"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"><span class="font-bold text-blue-600">1</span></div><div><h4 class="font-medium">Pilih Jenis Data</h4><p class="text-sm text-gray-600">Pilih dari dropdown di atas</p></div></div>
                            <div class="flex items-start space-x-3"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"><span class="font-bold text-blue-600">2</span></div><div><h4 class="font-medium">Copy Prompt</h4><p class="text-sm text-gray-600">Salin prompt yang dihasilkan</p></div></div>
                            <div class="flex items-start space-x-3"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"><span class="font-bold text-blue-600">3</span></div><div><h4 class="font-medium">Paste ke AI</h4><p class="text-sm text-gray-600">Buka ChatGPT/Claude, paste prompt + data Anda</p></div></div>
                            <div class="flex items-start space-x-3"><div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0"><span class="font-bold text-blue-600">4</span></div><div><h4 class="font-medium">Import Hasil</h4><p class="text-sm text-gray-600">Copy CSV, publish ke Google Sheets, import</p></div></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generatePrompt() {
            const type = document.getElementById('aiType').value;
            if (!type) { document.getElementById('promptResult').classList.add('hidden'); return; }
            
            const prompts = {
                students: `Ubah data siswa berikut ke format CSV dengan header: nisn,nama,jk,kelas,rombel

Keterangan:
- nisn: 10 digit (boleh kosong)
- nama: Nama lengkap
- jk: L atau P
- kelas: Angka kelas
- rombel: Huruf (A, B, C, D)

Contoh output:
nisn,nama,jk,kelas,rombel
0012345678,Ahmad Fadhil,L,7,A

DATA SISWA:
[PASTE DATA ANDA DI SINI]`,

                calendar: `Ubah data kalender berikut ke format CSV dengan header: jenis,nama,tanggal_mulai,tanggal_selesai

Keterangan jenis:
- semester: Periode semester
- kegiatan: Periode pembelajaran efektif
- ujian: PTS, PAS, PAT, dll
- libur: Periode libur

Format tanggal: YYYY-MM-DD

Contoh output:
jenis,nama,tanggal_mulai,tanggal_selesai
semester,Semester 1,2025-07-14,2025-12-20
kegiatan,Pembelajaran Sem 1,2025-07-14,2025-12-06
ujian,PTS,2025-09-15,2025-09-20
libur,Libur Semester,2025-12-21,2026-01-04

DATA KALENDER:
[PASTE DATA ANDA DI SINI]`,

                tp: `Ubah Tujuan Pembelajaran berikut ke format CSV dengan header: fase,elemen,nomor_tp,tujuan_pembelajaran,alokasi_jp

Contoh output:
fase,elemen,nomor_tp,tujuan_pembelajaran,alokasi_jp
A,Al-Quran dan Hadis,1,Peserta didik mampu mengenal huruf hijaiah,4

DATA TP:
[PASTE DATA ANDA DI SINI]`,

                soal: `Ubah soal-soal berikut ke format CSV dengan header: tipe,soal,opsi_a,opsi_b,opsi_c,opsi_d,jawaban,pembahasan

tipe: PG (Pilihan Ganda) atau Uraian
Untuk teks Arab, tulis langsung - sistem mendukung RTL

Contoh:
tipe,soal,opsi_a,opsi_b,opsi_c,opsi_d,jawaban,pembahasan
PG,"Huruf pertama Al-Fatihah adalah...",Alif,Ba,Ta,Jim,A,"Alif adalah huruf pertama"

SOAL-SOAL:
[PASTE DATA ANDA DI SINI]`
            };
            
            document.getElementById('promptText').value = prompts[type];
            document.getElementById('promptResult').classList.remove('hidden');
        }

        function copyPrompt() {
            document.getElementById('promptText').select();
            document.execCommand('copy');
            showToast('Prompt disalin!', 'success');
        }

        // ===== IMPORT DATA =====
        function loadImportData() {
            document.getElementById('pageTitle').textContent = 'Import Data';
            document.getElementById('pageSubtitle').textContent = 'Import data massal dari CSV';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center"><i class="fas fa-users text-blue-600"></i></div>
                                <div><h3 class="font-bold">Import Siswa</h3><p class="text-sm text-gray-500">Format: nisn,nama,jk,kelas,rombel</p></div>
                            </div>
                            <input type="url" id="importStudentUrl" placeholder="URL CSV Google Sheets" class="w-full px-4 py-2 border rounded-xl mb-3">
                            <button onclick="doImport('students')" class="w-full py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600">Import Siswa</button>
                        </div>
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center"><i class="fas fa-calendar-alt text-green-600"></i></div>
                                <div><h3 class="font-bold">Import Kalender</h3><p class="text-sm text-gray-500">Format: jenis,nama,tanggal_mulai,tanggal_selesai</p></div>
                            </div>
                            <input type="url" id="importCalendarUrl" placeholder="URL CSV Google Sheets" class="w-full px-4 py-2 border rounded-xl mb-3">
                            <button onclick="doImport('calendar')" class="w-full py-2 bg-green-500 text-white rounded-xl hover:bg-green-600">Import Kalender</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Panduan Import CSV</h3>
                        <div class="space-y-4 text-sm">
                            <div><h4 class="font-semibold">1. Siapkan Data di Google Sheets</h4><p class="text-gray-600">Buat spreadsheet dengan format header yang sesuai</p></div>
                            <div><h4 class="font-semibold">2. Publish sebagai CSV</h4><p class="text-gray-600">File  Share  Publish to web  CSV  Publish</p></div>
                            <div><h4 class="font-semibold">3. Copy URL & Import</h4><p class="text-gray-600">Paste URL ke field di atas, klik Import</p></div>
                        </div>
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-xl">
                            <p class="text-sm text-yellow-800"><i class="fas fa-lightbulb mr-2"></i>Gunakan AI Assistant untuk memformat data mentah Anda menjadi CSV yang benar.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function doImport(type) {
            const urlInput = type === 'students' ? 'importStudentUrl' : 'importCalendarUrl';
            const url = document.getElementById(urlInput).value.trim();
            if (!url) { showToast('Masukkan URL', 'warning'); return; }
            
            if (type === 'students') {
                document.getElementById('studentCsvUrl') = { value: url };
                await importStudentsCSV();
            } else {
                document.getElementById('calendarCsvUrl') = { value: url };
                await importCalendarCSV();
            }
        }

        // ===== GUIDE =====
        function loadGuide() {
            document.getElementById('pageTitle').textContent = 'Panduan Penggunaan';
            document.getElementById('pageSubtitle').textContent = 'Cara menggunakan Admin Guru Super App';
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <div class="bg-gradient-to-r from-primary-500 to-purple-600 rounded-2xl p-8 text-white mb-8">
                        <h2 class="text-2xl font-bold mb-2">Selamat Datang!</h2>
                        <p class="text-white text-opacity-90">Admin Guru Super App menggunakan konsep <strong>Single Input  Multi Output</strong>. Input data dasar sekali, dokumen akan otomatis sinkron.</p>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                        <h3 class="text-xl font-bold mb-4"><i class="fas fa-rocket mr-2 text-primary-500"></i>Quick Start</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center p-4 bg-gray-50 rounded-xl"><div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3"><span class="text-2xl font-bold text-blue-600">1</span></div><h4 class="font-semibold mb-2">Lengkapi Profil</h4><p class="text-sm text-gray-600">Data diri & sekolah</p></div>
                            <div class="text-center p-4 bg-gray-50 rounded-xl"><div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3"><span class="text-2xl font-bold text-green-600">2</span></div><h4 class="font-semibold mb-2">Atur Kalender</h4><p class="text-sm text-gray-600">Semester, ujian, libur</p></div>
                            <div class="text-center p-4 bg-gray-50 rounded-xl"><div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3"><span class="text-2xl font-bold text-purple-600">3</span></div><h4 class="font-semibold mb-2">Input Jadwal</h4><p class="text-sm text-gray-600">Jadwal per kelas</p></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                        <h3 class="text-xl font-bold mb-4"><i class="fas fa-question-circle mr-2 text-primary-500"></i>FAQ</h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-gray-50 rounded-xl"><h4 class="font-semibold mb-1">Perbedaan Free dan Premium?</h4><p class="text-sm text-gray-600">Free: Kalender, Jadwal, ATP, Prota. Premium: + Modul Ajar, LKPD, Bank Soal, Export.</p></div>
                            <div class="p-4 bg-gray-50 rounded-xl"><h4 class="font-semibold mb-1">Cara upgrade Premium?</h4><p class="text-sm text-gray-600">Klik Upgrade di sidebar atau hubungi admin via WhatsApp.</p></div>
                            <div class="p-4 bg-gray-50 rounded-xl"><h4 class="font-semibold mb-1">Data siswa dari mana?</h4><p class="text-sm text-gray-600">Input manual atau import CSV dari Google Sheets. Gunakan AI Assistant untuk format data.</p></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                        <h3 class="text-xl font-bold mb-4"><i class="fas fa-headset mr-2 text-primary-500"></i>Butuh Bantuan?</h3>
                        <p class="text-gray-600 mb-4">Hubungi kami via WhatsApp:</p>
                        <a href="https://wa.me/${whatsappAdmin}" target="_blank" class="inline-flex items-center px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600">
                            <i class="fab fa-whatsapp mr-2 text-xl"></i>Chat WhatsApp
                        </a>
                    </div>
                </div>
            `;
        }

        // ===== UTILITY FUNCTIONS =====
        function generateSignature() {
            const school = userData?.profile?.school || {};
            const teacher = userData?.displayName || '';
            const nip = userData?.profile?.nip || '';
            
            return `
                <div class="grid grid-cols-2 gap-8 mt-12 text-center text-sm">
                    <div>
                        <p>Mengetahui,</p>
                        <p>Kepala ${school.name || 'Sekolah'}</p>
                        <div class="h-20"></div>
                        <p class="font-semibold underline">${school.principalName || '.........................'}</p>
                        <p>NIP. ${school.principalNIP || '.........................'}</p>
                    </div>
                    <div>
                        <p>${school.city || '.............'}, .................... 20.....</p>
                        <p>Guru Mata Pelajaran</p>
                        <div class="h-20"></div>
                        <p class="font-semibold underline">${teacher || '.........................'}</p>
                        <p>NIP. ${nip || '.........................'}</p>
                    </div>
                </div>
            `;
        }

        function printDocument() {
            window.print();
        }

        function showTimeConfig() {
            showToast('Konfigurasi jam pelajaran akan segera tersedia', 'info');
        }

                // ===== USER DISPLAY (PERBAIKAN) =====
        function updateUserDisplay() {
            if (!currentUser || !userData) return;
            
            document.getElementById('userName').textContent = userData.displayName || currentUser.displayName || 'User';
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'U')}&background=fff&color=3b82f6`;
            document.getElementById('headerUserAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'U')}&background=3b82f6&color=fff`;
            
            const badge = document.getElementById('subscriptionBadge');
            const upgradeBanner = document.getElementById('upgradeBanner');
            const isPremium = checkPremiumAccess();
            
            console.log('updateUserDisplay: isPremium =', isPremium);
            
            if (isPremium) {
                badge.innerHTML = '<i class="fas fa-crown mr-1"></i>Premium';
                badge.className = 'px-2 py-1 bg-yellow-400 text-yellow-900 rounded-full text-xs font-medium';
                upgradeBanner.classList.add('hidden');
                
                // Update sidebar premium badges
                document.querySelectorAll('.sidebar-item .bg-yellow-100').forEach(el => {
                    el.classList.remove('bg-yellow-100', 'text-yellow-700');
                    el.classList.add('bg-green-100', 'text-green-700');
                    el.innerHTML = '<i class="fas fa-check"></i>';
                });
            } else {
                badge.textContent = 'Free';
                badge.className = 'px-2 py-1 bg-white bg-opacity-20 rounded-full text-xs font-medium';
                upgradeBanner.classList.remove('hidden');
            }
            
            document.getElementById('academicYearBadge').textContent = userData.academicYear || getCurrentAcademicYear();
        }

        // ===== LOGOUT =====
        async function logout() {
            if (confirm('Yakin ingin keluar?')) {
                showLoading('Keluar...');
                await auth.signOut();
                window.location.href = 'index.html';
            }
        }

        // ===== AUTH STATE =====
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists) {
                        userData = doc.data();
                        if (userData.settings?.whatsappAdmin) whatsappAdmin = userData.settings.whatsappAdmin;
                        await db.collection('users').doc(user.uid).update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
                    } else {
                        userData = {
                            uid: user.uid, email: user.email, displayName: user.displayName, photoURL: user.photoURL,
                            subscription: 'free', academicYear: getCurrentAcademicYear(),
                            profile: { nip: '', subjects: [{ name: 'Pendidikan Agama Islam dan Budi Pekerti', hoursPerWeek: 4 }], school: {} }
                        };
                        await db.collection('users').doc(user.uid).set({ ...userData, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
                    }
                    
                    // Load global settings
                    const settingsDoc = await db.collection('settings').doc('global').get();
                    if (settingsDoc.exists && settingsDoc.data().whatsappAdmin) {
                        whatsappAdmin = settingsDoc.data().whatsappAdmin;
                    }
                    
                    updateUserDisplay();
                    populateAcademicYearSelect();
                    loadSection('dashboard');
                } catch (error) {
                    console.error('Error loading user:', error);
                    showToast('Gagal memuat data', 'error');
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // Close menus on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#userMenu') && !e.target.closest('[onclick="toggleUserMenu()"]')) {
                document.getElementById('userMenu').classList.add('hidden');
            }
        });
    </script>
</body>

</html>
