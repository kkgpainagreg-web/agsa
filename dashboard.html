<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                        'arabic': ['Traditional Arabic', 'Scheherazade New', 'serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .rtl-text { direction: rtl; font-family: 'Traditional Arabic', 'Scheherazade New', serif; }
        .sidebar-item.active { background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); border-left: 3px solid #3b82f6; }
        .sidebar-item:hover:not(.active) { background: rgba(59, 130, 246, 0.05); }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15); }
        .gradient-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        @media print {
            .no-print { display: none !important; }
            .print-content { padding: 0 !important; margin: 0 !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 flex flex-col items-center space-y-4 shadow-2xl">
            <div class="loading-spinner"></div>
            <p class="text-gray-600 font-medium" id="loadingText">Memproses...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-[100] transform translate-x-full transition-transform duration-300">
        <div id="toastContent" class="px-6 py-4 rounded-xl shadow-2xl flex items-center space-x-3">
            <i id="toastIcon" class="text-xl"></i>
            <span id="toastMessage" class="font-medium"></span>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-white shadow-xl z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
        <!-- Logo -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-chalkboard-teacher text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Admin Guru</h1>
                    <p class="text-xs text-gray-500">Super App</p>
                </div>
            </div>
        </div>

        <!-- User Info Card -->
        <div class="p-4">
            <div class="bg-gradient-to-r from-primary-500 to-purple-600 rounded-xl p-4 text-white">
                <div class="flex items-center space-x-3">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=User&background=ffffff&color=3b82f6" 
                         class="w-12 h-12 rounded-full border-2 border-white border-opacity-30" alt="Avatar">
                    <div class="flex-1 min-w-0">
                        <p id="userName" class="font-semibold truncate">Loading...</p>
                        <p id="userEmail" class="text-xs text-white text-opacity-80 truncate">Loading...</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-white border-opacity-20">
                    <div class="flex items-center justify-between">
                        <span id="subscriptionBadge" class="px-2 py-1 bg-white bg-opacity-20 rounded-full text-xs font-medium">
                            Free
                        </span>
                        <span id="academicYearBadge" class="text-xs text-white text-opacity-80">
                            2024/2025
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto px-3 py-2">
            <!-- Main Menu -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Menu Utama</p>
                <a href="#" onclick="loadSection('dashboard')" class="sidebar-item active flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-home w-5 text-center text-primary-500"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" onclick="loadSection('profile')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-user w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Profil & Sekolah</span>
                </a>
            </div>

            <!-- Data Dasar -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Data Dasar</p>
                <a href="#" onclick="loadSection('calendar')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-alt w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Kalender Pendidikan</span>
                </a>
                <a href="#" onclick="loadSection('schedule')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-clock w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Jadwal Pelajaran</span>
                </a>
                <a href="#" onclick="loadSection('students')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-users w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Data Siswa</span>
                </a>
            </div>

            <!-- Dokumen -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Dokumen Pembelajaran</p>
                <a href="#" onclick="loadSection('cp')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-bullseye w-5 text-center text-gray-400"></i>
                    <span class="font-medium">CP & TP</span>
                </a>
                <a href="#" onclick="loadSection('atp')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-route w-5 text-center text-gray-400"></i>
                    <span class="font-medium">ATP</span>
                </a>
                <a href="#" onclick="loadSection('prota')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-check w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Prota</span>
                </a>
                <a href="#" onclick="loadSection('promes')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-calendar-week w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Promes</span>
                </a>
                <a href="#" onclick="loadSection('modul-ajar')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all premium-feature">
                    <i class="fas fa-book w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Modul Ajar</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Premium</span>
                </a>
                <a href="#" onclick="loadSection('lkpd')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all premium-feature">
                    <i class="fas fa-file-alt w-5 text-center text-gray-400"></i>
                    <span class="font-medium">LKPD</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Premium</span>
                </a>
            </div>

            <!-- Akademik -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Akademik</p>
                <a href="#" onclick="loadSection('attendance')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-clipboard-check w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Absensi</span>
                </a>
                <a href="#" onclick="loadSection('journal')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-journal-whills w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Jurnal Pembelajaran</span>
                </a>
                <a href="#" onclick="loadSection('grades')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-star w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Daftar Nilai</span>
                </a>
                <a href="#" onclick="loadSection('bank-soal')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all premium-feature">
                    <i class="fas fa-question-circle w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Bank Soal</span>
                    <span class="ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">Premium</span>
                </a>
            </div>

            <!-- Tools -->
            <div class="mb-6">
                <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Tools</p>
                <a href="#" onclick="loadSection('ai-assistant')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-robot w-5 text-center text-gray-400"></i>
                    <span class="font-medium">AI Assistant</span>
                </a>
                <a href="#" onclick="loadSection('import-data')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-file-import w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Import Data</span>
                </a>
                <a href="#" onclick="loadSection('guide')" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-700 transition-all">
                    <i class="fas fa-book-open w-5 text-center text-gray-400"></i>
                    <span class="font-medium">Panduan</span>
                </a>
            </div>
        </nav>

        <!-- Upgrade Banner -->
        <div id="upgradeBanner" class="p-4 border-t border-gray-100">
            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 border border-yellow-200">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-crown text-yellow-600"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">Upgrade Premium</p>
                        <p class="text-xs text-gray-500">Akses semua fitur</p>
                    </div>
                </div>
                <button onclick="showUpgradeModal()" class="w-full py-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-semibold rounded-lg hover:from-yellow-600 hover:to-orange-600 transition-all text-sm">
                    Upgrade Sekarang
                </button>
            </div>
        </div>

        <!-- Logout -->
        <div class="p-4 border-t border-gray-100">
            <button onclick="logout()" class="w-full flex items-center justify-center space-x-2 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-all font-medium">
                <i class="fas fa-sign-out-alt"></i>
                <span>Keluar</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="lg:ml-72 min-h-screen">
        <!-- Top Header -->
        <header class="bg-white shadow-sm sticky top-0 z-30 no-print">
            <div class="flex items-center justify-between px-4 lg:px-8 py-4">
                <!-- Mobile Menu Button -->
                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fas fa-bars text-gray-600 text-xl"></i>
                </button>

                <!-- Page Title -->
                <div class="hidden lg:block">
                    <h1 id="pageTitle" class="text-xl font-bold text-gray-800">Dashboard</h1>
                    <p id="pageSubtitle" class="text-sm text-gray-500">Selamat datang kembali!</p>
                </div>

                <!-- Right Actions -->
                <div class="flex items-center space-x-4">
                    <!-- Academic Year Selector -->
                    <select id="academicYearSelect" onchange="changeAcademicYear(this.value)" 
                            class="px-4 py-2 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                    </select>

                    <!-- Notifications -->
                    <button class="relative p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-bell text-gray-600 text-lg"></i>
                        <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                    </button>

                    <!-- User Menu -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                            <img id="headerUserAvatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" 
                                 class="w-8 h-8 rounded-full" alt="Avatar">
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </button>
                        <div id="userMenu" class="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 hidden">
                            <a href="#" onclick="loadSection('profile')" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 transition-colors">
                                <i class="fas fa-user text-gray-400"></i>
                                <span class="text-gray-700">Profil</span>
                            </a>
                            <a href="#" onclick="loadSection('guide')" class="flex items-center space-x-3 px-4 py-3 hover:bg-gray-50 transition-colors">
                                <i class="fas fa-question-circle text-gray-400"></i>
                                <span class="text-gray-700">Bantuan</span>
                            </a>
                            <hr class="my-1">
                            <a href="#" onclick="logout()" class="flex items-center space-x-3 px-4 py-3 hover:bg-red-50 transition-colors text-red-600">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Keluar</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <div id="contentArea" class="p-4 lg:p-8">
            <!-- Content will be loaded here -->
        </div>
    </main>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i class="fas fa-crown text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Upgrade ke Premium</h3>
                <p class="text-gray-500">Dapatkan akses penuh ke semua fitur aplikasi</p>
            </div>

            <div class="space-y-3 mb-6">
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Modul Ajar lengkap dengan LKPD</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Bank Soal terintegrasi ATP</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Export dokumen ke Word/PDF</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Support teks Arab (RTL)</span>
                </div>
                <div class="flex items-center space-x-3 text-gray-700">
                    <i class="fas fa-check-circle text-green-500"></i>
                    <span>Prioritas dukungan teknis</span>
                </div>
            </div>

            <div class="space-y-3">
                <a id="whatsappUpgradeLink" href="#" target="_blank" 
                   class="block w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl hover:from-green-600 hover:to-green-700 transition-all text-center">
                    <i class="fab fa-whatsapp mr-2"></i>
                    Hubungi via WhatsApp
                </a>
                <button onclick="closeUpgradeModal()" class="w-full py-3 border border-gray-200 text-gray-600 font-medium rounded-xl hover:bg-gray-50 transition-all">
                    Nanti Saja
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
            authDomain: "agsa-e5b08.firebaseapp.com",
            projectId: "agsa-e5b08",
            storageBucket: "agsa-e5b08.firebasestorage.app",
            messagingSenderId: "916052746331",
            appId: "1:916052746331:web:357cbadbfd8658f1689f7e",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ===== GLOBAL STATE =====
        let currentUser = null;
        let userData = null;
        let currentSection = 'dashboard';
        let whatsappAdmin = '6281234567890';

        // ===== HELPER: Convert Academic Year for Firestore ID =====
        // Mengubah format 2025/2026 menjadi 2025-2026 untuk document ID
        function academicYearToDocId(year) {
            return year.replace('/', '-');
        }

        // Mengubah format 2025-2026 menjadi 2025/2026 untuk display
        function docIdToAcademicYear(docId) {
            return docId.replace('-', '/');
        }

        // ===== CP DATA (PAI - Kepka BSKAP No. 046/H/KR/2025) =====
        const CP_DATA_PAI = {
            phases: {
                'A': {
                    name: 'Fase A',
                    grades: ['1', '2'],
                    level: 'SD',
                    elements: [
                        {
                            id: 'quran-hadis-a',
                            name: 'Al-Quran dan Hadis',
                            description: 'Mengenal huruf hijaiah dan membaca surah pendek',
                            tujuanPembelajaran: [
                                'Peserta didik mampu mengenal huruf hijaiah dengan benar',
                                'Peserta didik mampu membaca surah Al-Fatihah dengan tartil',
                                'Peserta didik mampu menghafal surah-surah pendek (An-Nas, Al-Falaq, Al-Ikhlas)',
                                'Peserta didik mampu mengenal hadis tentang kebersihan'
                            ]
                        },
                        {
                            id: 'akidah-a',
                            name: 'Akidah',
                            description: 'Mengenal rukun iman dan sifat Allah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menyebutkan rukun iman dengan urut',
                                'Peserta didik mampu meyakini Allah sebagai pencipta',
                                'Peserta didik mampu mengenal sifat-sifat Allah (Ar-Rahman, Ar-Rahim)',
                                'Peserta didik mampu menunjukkan sikap syukur kepada Allah'
                            ]
                        },
                        {
                            id: 'akhlak-a',
                            name: 'Akhlak',
                            description: 'Akhlak terhadap diri sendiri dan keluarga',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menerapkan perilaku jujur dalam kehidupan sehari-hari',
                                'Peserta didik mampu menunjukkan sikap hormat kepada orang tua',
                                'Peserta didik mampu menjaga kebersihan diri',
                                'Peserta didik mampu berbicara dengan sopan'
                            ]
                        },
                        {
                            id: 'fikih-a',
                            name: 'Fikih',
                            description: 'Mengenal rukun Islam dan tata cara bersuci',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menyebutkan rukun Islam dengan urut',
                                'Peserta didik mampu mempraktikkan cara berwudhu',
                                'Peserta didik mampu mengenal gerakan shalat',
                                'Peserta didik mampu membedakan najis dan cara membersihkannya'
                            ]
                        },
                        {
                            id: 'sejarah-a',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Mengenal kisah Nabi dan Rasul',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menceritakan kisah Nabi Adam AS',
                                'Peserta didik mampu menceritakan kisah Nabi Nuh AS',
                                'Peserta didik mampu meneladani sifat terpuji para Nabi',
                                'Peserta didik mampu menghargai perjuangan para Nabi'
                            ]
                        }
                    ]
                },
                'B': {
                    name: 'Fase B',
                    grades: ['3', '4'],
                    level: 'SD',
                    elements: [
                        {
                            id: 'quran-hadis-b',
                            name: 'Al-Quran dan Hadis',
                            description: 'Membaca ayat-ayat tentang shalat dan hadis pilihan',
                            tujuanPembelajaran: [
                                'Peserta didik mampu membaca ayat-ayat Al-Quran tentang shalat dengan tartil',
                                'Peserta didik mampu menghafal surah-surah pendek juz 30',
                                'Peserta didik mampu memahami kandungan ayat tentang perintah shalat',
                                'Peserta didik mampu menghafal hadis tentang shalat lima waktu'
                            ]
                        },
                        {
                            id: 'akidah-b',
                            name: 'Akidah',
                            description: 'Mengenal sifat-sifat Allah (Asmaul Husna)',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menyebutkan 10 Asmaul Husna',
                                'Peserta didik mampu memahami makna sifat-sifat Allah',
                                'Peserta didik mampu meyakini keesaan Allah',
                                'Peserta didik mampu menerapkan nilai-nilai Asmaul Husna dalam kehidupan'
                            ]
                        },
                        {
                            id: 'akhlak-b',
                            name: 'Akhlak',
                            description: 'Adab kepada orang tua dan guru',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menunjukkan sikap berbakti kepada orang tua',
                                'Peserta didik mampu menghormati guru',
                                'Peserta didik mampu menerapkan adab bergaul dengan teman',
                                'Peserta didik mampu menunjukkan sikap tolong-menolong'
                            ]
                        },
                        {
                            id: 'fikih-b',
                            name: 'Fikih',
                            description: 'Tata cara shalat dan puasa',
                            tujuanPembelajaran: [
                                'Peserta didik mampu mempraktikkan shalat lima waktu dengan benar',
                                'Peserta didik mampu memahami syarat sah shalat',
                                'Peserta didik mampu mengenal puasa Ramadhan',
                                'Peserta didik mampu memahami hikmah puasa'
                            ]
                        },
                        {
                            id: 'sejarah-b',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Sirah Nabi periode Makkah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menceritakan kelahiran Nabi Muhammad SAW',
                                'Peserta didik mampu menceritakan masa kanak-kanak Nabi',
                                'Peserta didik mampu memahami dakwah Nabi di Makkah',
                                'Peserta didik mampu meneladani akhlak Nabi Muhammad SAW'
                            ]
                        }
                    ]
                },
                'C': {
                    name: 'Fase C',
                    grades: ['5', '6'],
                    level: 'SD',
                    elements: [
                        {
                            id: 'quran-hadis-c',
                            name: 'Al-Quran dan Hadis',
                            description: 'Membaca ayat tentang keragaman dan toleransi',
                            tujuanPembelajaran: [
                                'Peserta didik mampu membaca QS. Al-Hujurat ayat 13 tentang keragaman',
                                'Peserta didik mampu memahami makna toleransi dalam Islam',
                                'Peserta didik mampu menghafal hadis tentang persaudaraan',
                                'Peserta didik mampu menerapkan nilai toleransi dalam kehidupan'
                            ]
                        },
                        {
                            id: 'akidah-c',
                            name: 'Akidah',
                            description: 'Iman kepada hari akhir dan qada qadar',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami konsep hari akhir',
                                'Peserta didik mampu meyakini adanya qada dan qadar',
                                'Peserta didik mampu menjelaskan tanda-tanda hari kiamat',
                                'Peserta didik mampu mengambil hikmah dari iman kepada hari akhir'
                            ]
                        },
                        {
                            id: 'akhlak-c',
                            name: 'Akhlak',
                            description: 'Adab sosial dan bermasyarakat',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menerapkan adab bertetangga',
                                'Peserta didik mampu menunjukkan sikap peduli sosial',
                                'Peserta didik mampu menghargai perbedaan dalam masyarakat',
                                'Peserta didik mampu berpartisipasi dalam kegiatan sosial'
                            ]
                        },
                        {
                            id: 'fikih-c',
                            name: 'Fikih',
                            description: 'Zakat, infaq, dan shadaqah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami pengertian zakat fitrah',
                                'Peserta didik mampu membedakan infaq dan shadaqah',
                                'Peserta didik mampu menghitung zakat fitrah',
                                'Peserta didik mampu mempraktikkan pemberian infaq dan shadaqah'
                            ]
                        },
                        {
                            id: 'sejarah-c',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Sirah Nabi periode Madinah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menceritakan peristiwa hijrah ke Madinah',
                                'Peserta didik mampu memahami pembentukan masyarakat Madinah',
                                'Peserta didik mampu menceritakan perjanjian Hudaibiyah',
                                'Peserta didik mampu meneladani kepemimpinan Nabi di Madinah'
                            ]
                        }
                    ]
                },
                'D': {
                    name: 'Fase D',
                    grades: ['7', '8', '9'],
                    level: 'SMP',
                    elements: [
                        {
                            id: 'quran-hadis-d',
                            name: 'Al-Quran dan Hadis',
                            description: 'Memahami ayat-ayat tentang toleransi dan moderasi',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis QS. Al-Kafirun tentang toleransi',
                                'Peserta didik mampu memahami konsep moderasi beragama',
                                'Peserta didik mampu menghafal dan memahami hadis tentang toleransi',
                                'Peserta didik mampu menerapkan sikap moderat dalam beragama'
                            ]
                        },
                        {
                            id: 'akidah-d',
                            name: 'Akidah',
                            description: 'Pendalaman rukun iman',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis bukti-bukti keberadaan Allah',
                                'Peserta didik mampu memahami sifat wajib, mustahil, dan jaiz Allah',
                                'Peserta didik mampu menganalisis fungsi malaikat',
                                'Peserta didik mampu memahami hikmah beriman kepada kitab-kitab Allah'
                            ]
                        },
                        {
                            id: 'akhlak-d',
                            name: 'Akhlak',
                            description: 'Etika digital dan bermedia sosial',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami etika dalam bermedia sosial',
                                'Peserta didik mampu menghindari konten negatif di internet',
                                'Peserta didik mampu menyebarkan konten positif',
                                'Peserta didik mampu bijak dalam menggunakan teknologi'
                            ]
                        },
                        {
                            id: 'fikih-d',
                            name: 'Fikih',
                            description: 'Sujud syukur, tilawah, dan ibadah haji',
                            tujuanPembelajaran: [
                                'Peserta didik mampu mempraktikkan sujud syukur',
                                'Peserta didik mampu mempraktikkan sujud tilawah',
                                'Peserta didik mampu memahami tata cara haji dan umrah',
                                'Peserta didik mampu menjelaskan hikmah ibadah haji'
                            ]
                        },
                        {
                            id: 'sejarah-d',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Peradaban Islam dari Bani Umayyah hingga Mughal',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis perkembangan Dinasti Umayyah',
                                'Peserta didik mampu memahami kejayaan Dinasti Abbasiyah',
                                'Peserta didik mampu mengenal peradaban Islam di Andalusia',
                                'Peserta didik mampu menganalisis kerajaan Islam di India (Mughal)'
                            ]
                        }
                    ]
                },
                'E': {
                    name: 'Fase E',
                    grades: ['10'],
                    level: 'SMA/SMK',
                    elements: [
                        {
                            id: 'quran-hadis-e',
                            name: 'Al-Quran dan Hadis',
                            description: 'Kompetisi dalam kebaikan',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis QS. Al-Baqarah: 148 tentang fastabiqul khairat',
                                'Peserta didik mampu memahami konsep berlomba dalam kebaikan',
                                'Peserta didik mampu mengkaji hadis tentang amal terbaik',
                                'Peserta didik mampu menerapkan semangat kompetisi positif'
                            ]
                        },
                        {
                            id: 'akidah-e',
                            name: 'Akidah',
                            description: "Syu'ab al-Iman (cabang-cabang iman)",
                            tujuanPembelajaran: [
                                "Peserta didik mampu memahami konsep syu'ab al-iman",
                                'Peserta didik mampu mengidentifikasi cabang-cabang iman',
                                'Peserta didik mampu menganalisis hubungan iman dan amal',
                                'Peserta didik mampu menerapkan nilai-nilai iman dalam kehidupan'
                            ]
                        },
                        {
                            id: 'akhlak-e',
                            name: 'Akhlak',
                            description: 'Etika dalam bekerja dan berkarir',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami etos kerja Islami',
                                'Peserta didik mampu menerapkan kejujuran dalam bekerja',
                                'Peserta didik mampu memahami konsep rezeki halal',
                                'Peserta didik mampu merencanakan karir sesuai nilai Islam'
                            ]
                        },
                        {
                            id: 'fikih-e',
                            name: 'Fikih',
                            description: 'Prinsip-prinsip hukum Islam',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami sumber hukum Islam',
                                'Peserta didik mampu menganalisis metode istinbath hukum',
                                'Peserta didik mampu memahami prinsip maslahah',
                                'Peserta didik mampu mengaplikasikan fiqih dalam konteks kekinian'
                            ]
                        },
                        {
                            id: 'sejarah-e',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Perkembangan Islam di Indonesia',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis masuknya Islam ke Indonesia',
                                'Peserta didik mampu memahami peran Walisongo',
                                'Peserta didik mampu mengkaji kerajaan-kerajaan Islam di Nusantara',
                                'Peserta didik mampu mengapresiasi kontribusi ulama Indonesia'
                            ]
                        }
                    ]
                },
                'F': {
                    name: 'Fase F',
                    grades: ['11', '12'],
                    level: 'SMA/SMK',
                    elements: [
                        {
                            id: 'quran-hadis-f',
                            name: 'Al-Quran dan Hadis',
                            description: 'Berpikir kritis dan mengkaji ayat-ayat kauniyah',
                            tujuanPembelajaran: [
                                'Peserta didik mampu menganalisis ayat-ayat kauniyah dalam Al-Quran',
                                'Peserta didik mampu memahami integrasi sains dan Al-Quran',
                                'Peserta didik mampu mengkaji hadis tentang menuntut ilmu',
                                'Peserta didik mampu mengembangkan sikap ilmiah berbasis Al-Quran'
                            ]
                        },
                        {
                            id: 'akidah-f',
                            name: 'Akidah',
                            description: 'Pemikiran kalam klasik dan modern',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami sejarah ilmu kalam',
                                'Peserta didik mampu menganalisis aliran-aliran dalam Islam',
                                'Peserta didik mampu memahami pemikiran Islam modern',
                                'Peserta didik mampu bersikap bijak terhadap perbedaan pemikiran'
                            ]
                        },
                        {
                            id: 'akhlak-f',
                            name: 'Akhlak',
                            description: 'Etika digital dan tanggung jawab global',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami etika dalam era digital',
                                'Peserta didik mampu menerapkan literasi digital Islami',
                                'Peserta didik mampu berpartisipasi dalam isu global',
                                'Peserta didik mampu menjadi warga digital yang bertanggung jawab'
                            ]
                        },
                        {
                            id: 'fikih-f',
                            name: 'Fikih',
                            description: 'Mawaris dan muamalah kontemporer',
                            tujuanPembelajaran: [
                                'Peserta didik mampu memahami hukum waris dalam Islam',
                                'Peserta didik mampu menghitung pembagian waris',
                                'Peserta didik mampu menganalisis muamalah kontemporer',
                                'Peserta didik mampu memahami ekonomi syariah'
                            ]
                        },
                        {
                            id: 'sejarah-f',
                            name: 'Sejarah Peradaban Islam',
                            description: 'Organisasi Islam dunia dan isu kontemporer',
                            tujuanPembelajaran: [
                                'Peserta didik mampu mengenal organisasi Islam internasional',
                                'Peserta didik mampu menganalisis isu-isu kontemporer umat Islam',
                                'Peserta didik mampu memahami peran Indonesia di dunia Islam',
                                'Peserta didik mampu berkontribusi untuk kemajuan umat'
                            ]
                        }
                    ]
                }
            },
            dimensions: [
                'Keimanan dan Ketakwaan kepada Tuhan Yang Maha Esa',
                'Kewargaan',
                'Penalaran Kritis',
                'Kreativitas',
                'Bergotong Royong (Kolaborasi)',
                'Kemandirian',
                'Kesehatan Jasmani dan Rohani',
                'Berkomunikasi'
            ]
        };

        // ===== UTILITY FUNCTIONS =====
        function showLoading(text = 'Memproses...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastContent = document.getElementById('toastContent');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');

            const types = {
                success: { bg: 'bg-green-500', icon: 'fas fa-check-circle' },
                error: { bg: 'bg-red-500', icon: 'fas fa-exclamation-circle' },
                warning: { bg: 'bg-yellow-500', icon: 'fas fa-exclamation-triangle' },
                info: { bg: 'bg-blue-500', icon: 'fas fa-info-circle' }
            };

            toastContent.className = `${types[type].bg} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center space-x-3`;
            toastIcon.className = `${types[type].icon} text-xl`;
            toastMessage.textContent = message;

            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        function getAcademicYearOptions() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            
            let options = [];
            if (month >= 6) {
                options = [
                    `${year - 1}/${year}`,
                    `${year}/${year + 1}`
                ];
            } else {
                options = [
                    `${year - 1}/${year}`,
                    `${year}/${year + 1}`
                ];
            }
            return options;
        }

        function getCurrentAcademicYear() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear();
            
            if (month >= 7) {
                return `${year}/${year + 1}`;
            } else {
                return `${year - 1}/${year}`;
            }
        }

        function populateAcademicYearSelect() {
            const select = document.getElementById('academicYearSelect');
            const options = getAcademicYearOptions();
            const current = userData?.academicYear || getCurrentAcademicYear();
            
            select.innerHTML = options.map(opt => 
                `<option value="${opt}" ${opt === current ? 'selected' : ''}>${opt}</option>`
            ).join('');
        }

        async function changeAcademicYear(year) {
            if (!currentUser) return;
            
            showLoading('Mengubah tahun ajaran...');
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    academicYear: year
                });
                userData.academicYear = year;
                document.getElementById('academicYearBadge').textContent = year;
                showToast('Tahun ajaran berhasil diubah', 'success');
                loadSection(currentSection);
            } catch (error) {
                console.error(error);
                showToast('Gagal mengubah tahun ajaran', 'error');
            }
            hideLoading();
        }

        function checkPremiumAccess(feature) {
            if (!userData) return false;
            if (userData.subscription === 'premium') return true;
            if (userData.subscriptionExpiry && new Date(userData.subscriptionExpiry.toDate()) > new Date()) {
                return true;
            }
            return false;
        }

        function showUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            const link = document.getElementById('whatsappUpgradeLink');
            link.href = `https://wa.me/${whatsappAdmin}?text=Halo, saya ingin upgrade ke Premium untuk Admin Guru Super App. Email: ${currentUser?.email}`;
            modal.classList.remove('hidden');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
        }

        // ===== SECTION LOADERS =====
        function loadSection(section) {
            currentSection = section;
            
            // Update active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                const icon = item.querySelector('i');
                if (icon) {
                    icon.classList.remove('text-primary-500');
                    icon.classList.add('text-gray-400');
                }
            });
            
            const activeItem = document.querySelector(`[onclick="loadSection('${section}')"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                const icon = activeItem.querySelector('i');
                if (icon) {
                    icon.classList.remove('text-gray-400');
                    icon.classList.add('text-primary-500');
                }
            }

            // Close mobile sidebar
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }

            // Check premium features
            const premiumFeatures = ['modul-ajar', 'lkpd', 'bank-soal'];
            if (premiumFeatures.includes(section) && !checkPremiumAccess(section)) {
                showUpgradeModal();
                return;
            }

            // Load section content
            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'profile': loadProfile(); break;
                case 'calendar': loadCalendar(); break;
                case 'schedule': loadSchedule(); break;
                case 'students': loadStudents(); break;
                case 'cp': loadCP(); break;
                case 'atp': loadATP(); break;
                case 'prota': loadProta(); break;
                case 'promes': loadPromes(); break;
                case 'modul-ajar': loadModulAjar(); break;
                case 'lkpd': loadLKPD(); break;
                case 'attendance': loadAttendance(); break;
                case 'journal': loadJournal(); break;
                case 'grades': loadGrades(); break;
                case 'bank-soal': loadBankSoal(); break;
                case 'ai-assistant': loadAIAssistant(); break;
                case 'import-data': loadImportData(); break;
                case 'guide': loadGuide(); break;
                default: loadDashboard();
            }
        }

        // ===== DASHBOARD SECTION =====
        function loadDashboard() {
            document.getElementById('pageTitle').textContent = 'Dashboard';
            document.getElementById('pageSubtitle').textContent = 'Selamat datang kembali!';
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-users text-blue-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 id="totalStudents" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Total Siswa</p>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-chalkboard text-purple-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 id="totalClasses" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Kelas Diampu</p>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-book text-green-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 id="totalModules" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Modul Ajar</p>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-sm card-hover border border-gray-100">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar-check text-orange-600 text-xl"></i>
                            </div>
                        </div>
                        <h3 id="completedJournals" class="text-3xl font-bold text-gray-800">0</h3>
                        <p class="text-gray-500 text-sm">Jurnal Selesai</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Aksi Cepat</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <button onclick="loadSection('attendance')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-clipboard-check text-blue-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Absensi</span>
                        </button>
                        <button onclick="loadSection('journal')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-journal-whills text-purple-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Jurnal</span>
                        </button>
                        <button onclick="loadSection('grades')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-star text-green-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Nilai</span>
                        </button>
                        <button onclick="loadSection('promes')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-calendar-week text-orange-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Promes</span>
                        </button>
                        <button onclick="loadSection('modul-ajar')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-book text-pink-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">Modul Ajar</span>
                        </button>
                        <button onclick="loadSection('ai-assistant')" class="flex flex-col items-center p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-200 border border-transparent transition-all">
                            <div class="w-12 h-12 bg-cyan-100 rounded-xl flex items-center justify-center mb-2">
                                <i class="fas fa-robot text-cyan-600"></i>
                            </div>
                            <span class="text-sm font-medium text-gray-700">AI Assistant</span>
                        </button>
                    </div>
                </div>

                <!-- Document Status -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Status Dokumen</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-calendar-alt text-blue-500"></i>
                                <span class="font-medium text-gray-700">Kalender</span>
                            </div>
                            <span id="calendarStatus" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-clock text-green-500"></i>
                                <span class="font-medium text-gray-700">Jadwal</span>
                            </div>
                            <span id="scheduleStatus" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-route text-purple-500"></i>
                                <span class="font-medium text-gray-700">ATP</span>
                            </div>
                            <span id="atpStatus" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-calendar-check text-orange-500"></i>
                                <span class="font-medium text-gray-700">Prota</span>
                            </div>
                            <span id="protaStatus" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-calendar-week text-red-500"></i>
                                <span class="font-medium text-gray-700">Promes</span>
                            </div>
                            <span id="promesStatus" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs rounded-full">Belum</span>
                        </div>
                    </div>
                </div>
            `;
            
            loadDashboardData();
        }

        async function loadDashboardData() {
            if (!currentUser) return;
            
            try {
                const studentsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('students').get();
                document.getElementById('totalStudents').textContent = studentsSnap.size;
                
                const classes = new Set();
                studentsSnap.forEach(doc => {
                    const student = doc.data();
                    classes.add(`${student.kelas}-${student.rombel}`);
                });
                document.getElementById('totalClasses').textContent = classes.size;
                
                // Check statuses
                const academicYearDocId = academicYearToDocId(userData?.academicYear || getCurrentAcademicYear());
                
                const calendarSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('calendar').doc(academicYearDocId).get();
                if (calendarSnap.exists) {
                    document.getElementById('calendarStatus').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('calendarStatus').textContent = 'Sudah';
                }
                
                const scheduleSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').limit(1).get();
                if (!scheduleSnap.empty) {
                    document.getElementById('scheduleStatus').className = 'px-3 py-1 bg-green-100 text-green-600 text-xs rounded-full';
                    document.getElementById('scheduleStatus').textContent = 'Sudah';
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // ===== CALENDAR SECTION =====
        let calendarData = null;

        function loadCalendar() {
            document.getElementById('pageTitle').textContent = 'Kalender Pendidikan';
            document.getElementById('pageSubtitle').textContent = 'Atur kalender akademik semester';
            
            const academicYear = userData?.academicYear || getCurrentAcademicYear();
            
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Pengaturan Kalender</h3>
                            <p class="text-gray-500 text-sm">Tahun Ajaran: ${academicYear}</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="showImportCalendarModal()" class="px-4 py-2 border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 transition-all flex items-center space-x-2">
                                <i class="fas fa-file-csv"></i>
                                <span>Import CSV</span>
                            </button>
                            <button onclick="saveCalendar()" class="px-6 py-2 bg-gradient-to-r from-primary-600 to-purple-600 text-white font-semibold rounded-xl hover:from-primary-700 hover:to-purple-700 transition-all">
                                <i class="fas fa-save mr-2"></i>Simpan
                            </button>
                        </div>
                    </div>

                    <!-- Semester Tabs -->
                    <div class="flex space-x-2 mb-6">
                        <button onclick="switchSemester(1)" id="sem1Tab" class="px-6 py-3 bg-primary-500 text-white font-medium rounded-xl transition-all">
                            Semester 1 (Ganjil)
                        </button>
                        <button onclick="switchSemester(2)" id="sem2Tab" class="px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-all">
                            Semester 2 (Genap)
                        </button>
                    </div>

                    <!-- Semester 1 Form -->
                    <div id="semester1Form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                <h4 class="font-semibold text-blue-800 mb-4"><i class="fas fa-calendar-day mr-2"></i>Periode Semester</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Awal Semester</label>
                                        <input type="date" id="sem1Start" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Semester</label>
                                        <input type="date" id="sem1End" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                                <h4 class="font-semibold text-green-800 mb-4"><i class="fas fa-book-reader mr-2"></i>Kegiatan Pembelajaran</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Awal Kegiatan</label>
                                        <input type="date" id="sem1ActivityStart" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Kegiatan</label>
                                        <input type="date" id="sem1ActivityEnd" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                                <h4 class="font-semibold text-orange-800 mb-4"><i class="fas fa-file-signature mr-2"></i>Pekan Ujian</h4>
                                <div id="sem1Exams" class="space-y-3">
                                    <div class="exam-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" value="PTS" placeholder="Nama" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end text-sm">
                                    </div>
                                    <div class="exam-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" value="PAS" placeholder="Nama" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end text-sm">
                                    </div>
                                </div>
                                <button type="button" onclick="addExam('sem1Exams')" class="mt-3 text-sm text-orange-600 hover:text-orange-700 font-medium">
                                    <i class="fas fa-plus mr-1"></i>Tambah Ujian
                                </button>
                            </div>
                            <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                                <h4 class="font-semibold text-red-800 mb-4"><i class="fas fa-umbrella-beach mr-2"></i>Libur</h4>
                                <div id="sem1Holidays" class="space-y-3">
                                    <div class="holiday-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" placeholder="Keterangan" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg holiday-name text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-start text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-end text-sm">
                                    </div>
                                </div>
                                <button type="button" onclick="addHoliday('sem1Holidays')" class="mt-3 text-sm text-red-600 hover:text-red-700 font-medium">
                                    <i class="fas fa-plus mr-1"></i>Tambah Libur
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Semester 2 Form (Hidden) -->
                    <div id="semester2Form" class="space-y-6 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                <h4 class="font-semibold text-blue-800 mb-4"><i class="fas fa-calendar-day mr-2"></i>Periode Semester</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Awal Semester</label>
                                        <input type="date" id="sem2Start" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Semester</label>
                                        <input type="date" id="sem2End" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-xl border border-green-100">
                                <h4 class="font-semibold text-green-800 mb-4"><i class="fas fa-book-reader mr-2"></i>Kegiatan Pembelajaran</h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Awal Kegiatan</label>
                                        <input type="date" id="sem2ActivityStart" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Akhir Kegiatan</label>
                                        <input type="date" id="sem2ActivityEnd" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary-500">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="p-4 bg-orange-50 rounded-xl border border-orange-100">
                                <h4 class="font-semibold text-orange-800 mb-4"><i class="fas fa-file-signature mr-2"></i>Pekan Ujian</h4>
                                <div id="sem2Exams" class="space-y-3">
                                    <div class="exam-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" value="PTS" placeholder="Nama" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end text-sm">
                                    </div>
                                    <div class="exam-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" value="PAT" placeholder="Nama" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end text-sm">
                                    </div>
                                </div>
                                <button type="button" onclick="addExam('sem2Exams')" class="mt-3 text-sm text-orange-600 hover:text-orange-700 font-medium">
                                    <i class="fas fa-plus mr-1"></i>Tambah Ujian
                                </button>
                            </div>
                            <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                                <h4 class="font-semibold text-red-800 mb-4"><i class="fas fa-umbrella-beach mr-2"></i>Libur</h4>
                                <div id="sem2Holidays" class="space-y-3">
                                    <div class="holiday-item grid grid-cols-5 gap-2 items-center">
                                        <input type="text" placeholder="Keterangan" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg holiday-name text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-start text-sm">
                                        <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-end text-sm">
                                    </div>
                                </div>
                                <button type="button" onclick="addHoliday('sem2Holidays')" class="mt-3 text-sm text-red-600 hover:text-red-700 font-medium">
                                    <i class="fas fa-plus mr-1"></i>Tambah Libur
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Preview -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Preview Minggu Efektif</h3>
                    <div id="calendarPreview" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <p class="col-span-full text-center text-gray-400">Simpan kalender untuk melihat preview</p>
                    </div>
                </div>
            `;
            
            loadCalendarData();
        }

        function switchSemester(sem) {
            const sem1Tab = document.getElementById('sem1Tab');
            const sem2Tab = document.getElementById('sem2Tab');
            const sem1Form = document.getElementById('semester1Form');
            const sem2Form = document.getElementById('semester2Form');
            
            if (sem === 1) {
                sem1Tab.className = 'px-6 py-3 bg-primary-500 text-white font-medium rounded-xl transition-all';
                sem2Tab.className = 'px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-all';
                sem1Form.classList.remove('hidden');
                sem2Form.classList.add('hidden');
            } else {
                sem2Tab.className = 'px-6 py-3 bg-primary-500 text-white font-medium rounded-xl transition-all';
                sem1Tab.className = 'px-6 py-3 bg-gray-100 text-gray-600 font-medium rounded-xl hover:bg-gray-200 transition-all';
                sem2Form.classList.remove('hidden');
                sem1Form.classList.add('hidden');
            }
        }

        function addExam(containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'exam-item grid grid-cols-5 gap-2 items-center';
            div.innerHTML = `
                <input type="text" placeholder="Nama" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg exam-name text-sm">
                <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-start text-sm">
                <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg exam-end text-sm">
            `;
            container.appendChild(div);
        }

        function addHoliday(containerId) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'holiday-item grid grid-cols-5 gap-2 items-center';
            div.innerHTML = `
                <input type="text" placeholder="Keterangan" class="col-span-1 px-3 py-2 border border-gray-200 rounded-lg holiday-name text-sm">
                <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-start text-sm">
                <input type="date" class="col-span-2 px-3 py-2 border border-gray-200 rounded-lg holiday-end text-sm">
            `;
            container.appendChild(div);
        }

        async function loadCalendarData() {
            if (!currentUser) return;
            
            const academicYear = userData?.academicYear || getCurrentAcademicYear();
            const docId = academicYearToDocId(academicYear);
            
            try {
                const calendarDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('calendar').doc(docId).get();
                
                if (calendarDoc.exists) {
                    const data = calendarDoc.data();
                    calendarData = data;
                    
                    // Populate Semester 1
                    if (data.semester1) {
                        document.getElementById('sem1Start').value = data.semester1.start || '';
                        document.getElementById('sem1End').value = data.semester1.end || '';
                        document.getElementById('sem1ActivityStart').value = data.semester1.activityStart || '';
                        document.getElementById('sem1ActivityEnd').value = data.semester1.activityEnd || '';
                    }
                    
                    // Populate Semester 2
                    if (data.semester2) {
                        document.getElementById('sem2Start').value = data.semester2.start || '';
                        document.getElementById('sem2End').value = data.semester2.end || '';
                        document.getElementById('sem2ActivityStart').value = data.semester2.activityStart || '';
                        document.getElementById('sem2ActivityEnd').value = data.semester2.activityEnd || '';
                    }
                    
                    generateCalendarPreview(data);
                    showToast('Kalender berhasil dimuat', 'success');
                }
            } catch (error) {
                console.error('Error loading calendar:', error);
                showToast('Gagal memuat kalender', 'error');
            }
        }

        async function saveCalendar() {
            if (!currentUser) return;
            
            showLoading('Menyimpan kalender...');
            
            try {
                // Collect exam data
                const collectItems = (containerId, nameClass, startClass, endClass) => {
                    const items = [];
                    document.querySelectorAll(`#${containerId} > div`).forEach(item => {
                        const name = item.querySelector(`.${nameClass}`)?.value?.trim() || '';
                        const start = item.querySelector(`.${startClass}`)?.value || '';
                        const end = item.querySelector(`.${endClass}`)?.value || '';
                        if (name || start || end) {
                            items.push({ name, start, end });
                        }
                    });
                    return items;
                };
                
                const academicYear = userData?.academicYear || getCurrentAcademicYear();
                const docId = academicYearToDocId(academicYear);
                
                const calendarDataToSave = {
                    academicYear: academicYear,
                    semester1: {
                        start: document.getElementById('sem1Start').value,
                        end: document.getElementById('sem1End').value,
                        activityStart: document.getElementById('sem1ActivityStart').value,
                        activityEnd: document.getElementById('sem1ActivityEnd').value,
                        exams: collectItems('sem1Exams', 'exam-name', 'exam-start', 'exam-end'),
                        holidays: collectItems('sem1Holidays', 'holiday-name', 'holiday-start', 'holiday-end')
                    },
                    semester2: {
                        start: document.getElementById('sem2Start').value,
                        end: document.getElementById('sem2End').value,
                        activityStart: document.getElementById('sem2ActivityStart').value,
                        activityEnd: document.getElementById('sem2ActivityEnd').value,
                        exams: collectItems('sem2Exams', 'exam-name', 'exam-start', 'exam-end'),
                        holidays: collectItems('sem2Holidays', 'holiday-name', 'holiday-start', 'holiday-end')
                    },
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid)
                    .collection('calendar')
                    .doc(docId)
                    .set(calendarDataToSave);
                
                calendarData = calendarDataToSave;
                generateCalendarPreview(calendarDataToSave);
                showToast('Kalender berhasil disimpan!', 'success');
                
            } catch (error) {
                console.error(error);
                showToast('Gagal menyimpan kalender: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        function generateCalendarPreview(data) {
            const preview = document.getElementById('calendarPreview');
            if (!preview) return;
            
            const months = [
                { name: 'Juli', sem: 1 },
                { name: 'Agustus', sem: 1 },
                { name: 'September', sem: 1 },
                { name: 'Oktober', sem: 1 },
                { name: 'November', sem: 1 },
                { name: 'Desember', sem: 1 },
                { name: 'Januari', sem: 2 },
                { name: 'Februari', sem: 2 },
                { name: 'Maret', sem: 2 },
                { name: 'April', sem: 2 },
                { name: 'Mei', sem: 2 },
                { name: 'Juni', sem: 2 }
            ];
            
            let html = '';
            months.forEach(month => {
                const semData = month.sem === 1 ? data.semester1 : data.semester2;
                const weeks = semData?.activityStart && semData?.activityEnd ? 4 : 0;
                
                html += `
                    <div class="p-4 bg-gray-50 rounded-xl text-center">
                        <p class="font-semibold text-gray-700">${month.name}</p>
                        <p class="text-2xl font-bold ${weeks > 0 ? 'text-primary-600' : 'text-gray-400'}">${weeks}</p>
                        <p class="text-xs text-gray-500">Minggu Efektif</p>
                    </div>
                `;
            });
            
            preview.innerHTML = html;
        }

        function showImportCalendarModal() {
            const modal = document.createElement('div');
            modal.id = 'importCalendarModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800">Import Kalender dari CSV</h3>
                        <button onclick="this.closest('#importCalendarModal').remove()" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-times text-gray-400"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-gray-600 mb-4">Import data kalender dari Google Spreadsheet yang sudah dipublikasikan sebagai CSV.</p>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                            <h4 class="font-semibold text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Format CSV</h4>
                            <code class="text-xs bg-blue-100 px-2 py-1 rounded block">jenis,nama,tanggal_mulai,tanggal_selesai</code>
                            <p class="text-xs text-blue-600 mt-2">jenis: semester/kegiatan/ujian/libur</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL Google Spreadsheet (CSV)</label>
                            <input type="url" id="calendarCsvUrl" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500"
                                   placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="this.closest('#importCalendarModal').remove()" class="px-6 py-2 border border-gray-200 text-gray-600 rounded-xl hover:bg-gray-50">
                            Batal
                        </button>
                        <button onclick="importCalendarFromCSV()" class="px-6 py-2 bg-primary-500 text-white rounded-xl hover:bg-primary-600">
                            <i class="fas fa-file-import mr-2"></i>Import
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function importCalendarFromCSV() {
            const url = document.getElementById('calendarCsvUrl').value.trim();
            
            if (!url) {
                showToast('Masukkan URL CSV', 'warning');
                return;
            }
            
            showLoading('Mengimpor kalender...');
            
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
                
                const sem1Data = { exams: [], holidays: [] };
                const sem2Data = { exams: [], holidays: [] };
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                    if (values.length < 4) continue;
                    
                    const jenis = values[headers.indexOf('jenis')]?.toLowerCase() || '';
                    const nama = values[headers.indexOf('nama')] || '';
                    const mulai = values[headers.indexOf('tanggal_mulai')] || '';
                    const selesai = values[headers.indexOf('tanggal_selesai')] || '';
                    
                    // Determine semester based on date
                    const month = new Date(mulai).getMonth();
                    const isSem1 = month >= 6; // July-December = Sem 1
                    const targetSem = isSem1 ? sem1Data : sem2Data;
                    
                    if (jenis === 'semester') {
                        targetSem.start = mulai;
                        targetSem.end = selesai;
                    } else if (jenis === 'kegiatan') {
                        targetSem.activityStart = mulai;
                        targetSem.activityEnd = selesai;
                    } else if (jenis === 'ujian') {
                        targetSem.exams.push({ name: nama, start: mulai, end: selesai });
                    } else if (jenis === 'libur') {
                        targetSem.holidays.push({ name: nama, start: mulai, end: selesai });
                    }
                }
                
                // Populate form
                if (sem1Data.start) document.getElementById('sem1Start').value = sem1Data.start;
                if (sem1Data.end) document.getElementById('sem1End').value = sem1Data.end;
                if (sem1Data.activityStart) document.getElementById('sem1ActivityStart').value = sem1Data.activityStart;
                if (sem1Data.activityEnd) document.getElementById('sem1ActivityEnd').value = sem1Data.activityEnd;
                
                if (sem2Data.start) document.getElementById('sem2Start').value = sem2Data.start;
                if (sem2Data.end) document.getElementById('sem2End').value = sem2Data.end;
                if (sem2Data.activityStart) document.getElementById('sem2ActivityStart').value = sem2Data.activityStart;
                if (sem2Data.activityEnd) document.getElementById('sem2ActivityEnd').value = sem2Data.activityEnd;
                
                document.getElementById('importCalendarModal')?.remove();
                showToast('Data kalender berhasil diimpor! Klik Simpan untuk menyimpan.', 'success');
                
            } catch (error) {
                console.error(error);
                showToast('Gagal mengimpor data: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        // ===== Remaining sections (shortened for space) =====
        
        function loadProfile() {
            document.getElementById('pageTitle').textContent = 'Profil & Sekolah';
            document.getElementById('pageSubtitle').textContent = 'Kelola data profil dan satuan pendidikan';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman profil - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadSchedule() {
            document.getElementById('pageTitle').textContent = 'Jadwal Pelajaran';
            document.getElementById('pageSubtitle').textContent = 'Atur jadwal mengajar';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman jadwal - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadStudents() {
            document.getElementById('pageTitle').textContent = 'Data Siswa';
            document.getElementById('pageSubtitle').textContent = 'Kelola data siswa';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman siswa - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadCP() {
            document.getElementById('pageTitle').textContent = 'CP & TP';
            document.getElementById('pageSubtitle').textContent = 'Capaian dan Tujuan Pembelajaran';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman CP - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadATP() {
            document.getElementById('pageTitle').textContent = 'ATP';
            document.getElementById('pageSubtitle').textContent = 'Alur Tujuan Pembelajaran';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman ATP - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadProta() {
            document.getElementById('pageTitle').textContent = 'Prota';
            document.getElementById('pageSubtitle').textContent = 'Program Tahunan';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Prota - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadPromes() {
            document.getElementById('pageTitle').textContent = 'Promes';
            document.getElementById('pageSubtitle').textContent = 'Program Semester';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Promes - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadModulAjar() {
            document.getElementById('pageTitle').textContent = 'Modul Ajar';
            document.getElementById('pageSubtitle').textContent = 'Premium Feature';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Modul Ajar - Premium</p></div>';
        }

        function loadLKPD() {
            document.getElementById('pageTitle').textContent = 'LKPD';
            document.getElementById('pageSubtitle').textContent = 'Premium Feature';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman LKPD - Premium</p></div>';
        }

        function loadAttendance() {
            document.getElementById('pageTitle').textContent = 'Absensi';
            document.getElementById('pageSubtitle').textContent = 'Kelola kehadiran siswa';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Absensi - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadJournal() {
            document.getElementById('pageTitle').textContent = 'Jurnal';
            document.getElementById('pageSubtitle').textContent = 'Jurnal Pembelajaran';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Jurnal - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadGrades() {
            document.getElementById('pageTitle').textContent = 'Daftar Nilai';
            document.getElementById('pageSubtitle').textContent = 'Kelola nilai siswa';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Nilai - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadBankSoal() {
            document.getElementById('pageTitle').textContent = 'Bank Soal';
            document.getElementById('pageSubtitle').textContent = 'Premium Feature';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Bank Soal - Premium</p></div>';
        }

        function loadAIAssistant() {
            document.getElementById('pageTitle').textContent = 'AI Assistant';
            document.getElementById('pageSubtitle').textContent = 'Bantu format data';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman AI Assistant - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadImportData() {
            document.getElementById('pageTitle').textContent = 'Import Data';
            document.getElementById('pageSubtitle').textContent = 'Import data massal';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Import - implementasi lengkap di file sebelumnya</p></div>';
        }

        function loadGuide() {
            document.getElementById('pageTitle').textContent = 'Panduan';
            document.getElementById('pageSubtitle').textContent = 'Cara penggunaan';
            document.getElementById('contentArea').innerHTML = '<div class="bg-white rounded-2xl p-6 shadow-sm"><p>Halaman Panduan - implementasi lengkap di file sebelumnya</p></div>';
        }

        // ===== USER DISPLAY UPDATE =====
        function updateUserDisplay() {
            if (!currentUser || !userData) return;
            
            document.getElementById('userName').textContent = userData.displayName || currentUser.displayName || 'User';
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.photoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'User')}&background=ffffff&color=3b82f6`;
            
            const subBadge = document.getElementById('subscriptionBadge');
            if (userData.subscription === 'premium') {
                subBadge.innerHTML = '<i class="fas fa-crown mr-1"></i>Premium';
                subBadge.className = 'px-2 py-1 bg-yellow-400 text-yellow-900 rounded-full text-xs font-medium';
                document.getElementById('upgradeBanner').classList.add('hidden');
            } else {
                subBadge.textContent = 'Free';
                document.getElementById('upgradeBanner').classList.remove('hidden');
            }
            
            document.getElementById('academicYearBadge').textContent = userData.academicYear || getCurrentAcademicYear();
            document.getElementById('headerUserAvatar').src = currentUser.photoURL || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName || 'User')}&background=3b82f6&color=fff`;
        }

        // ===== LOGOUT =====
        async function logout() {
            if (confirm('Yakin ingin keluar?')) {
                showLoading('Keluar...');
                try {
                    await auth.signOut();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error(error);
                    showToast('Gagal keluar', 'error');
                }
                hideLoading();
            }
        }

        // ===== AUTH STATE LISTENER =====
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        
                        if (userData.settings?.whatsappAdmin) {
                            whatsappAdmin = userData.settings.whatsappAdmin;
                        }
                        
                        await db.collection('users').doc(user.uid).update({
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } else {
                        const academicYear = getCurrentAcademicYear();
                        userData = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName,
                            photoURL: user.photoURL,
                            subscription: 'free',
                            academicYear: academicYear,
                            profile: { nip: '', subjects: [], school: {} }
                        };
                        await db.collection('users').doc(user.uid).set({
                            ...userData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    updateUserDisplay();
                    populateAcademicYearSelect();
                    loadSection('dashboard');
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showToast('Gagal memuat data pengguna', 'error');
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('userMenu');
            if (!e.target.closest('#userMenu') && !e.target.closest('[onclick="toggleUserMenu()"]')) {
                userMenu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>

