<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si Gumart - Aplikasi Guru Smart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 12px; color: #6b7280; transition: all 0.2s; cursor: pointer; }
        .nav-link:hover { background: #f3f4f6; }
        .nav-link.active { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; }
        .btn-primary { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 500; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: #f3f4f6; color: #374151; padding: 10px 20px; border-radius: 10px; font-weight: 500; border: none; cursor: pointer; }
        .btn-danger { background: #ef4444; color: white; padding: 10px 20px; border-radius: 10px; font-weight: 500; border: none; cursor: pointer; }
        .form-input { width: 100%; padding: 10px 14px; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; font-size: 14px; }
        .form-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: #374151; margin-bottom: 6px; }
        .stats-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stats-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .card-hover { transition: all 0.3s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 16px; }
        .modal-content { background: white; border-radius: 16px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 10px; }
        .badge { display: inline-flex; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
        .badge-primary { background: rgba(37,99,235,0.1); color: #2563eb; }
        .badge-success { background: rgba(16,185,129,0.1); color: #10b981; }
        .badge-warning { background: rgba(245,158,11,0.1); color: #f59e0b; }
        .badge-danger { background: rgba(239,68,68,0.1); color: #ef4444; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .data-table th { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; padding: 12px; text-align: left; font-weight: 500; }
        .data-table td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .data-table tr:hover td { background: #f9fafb; }
        .animate-fadeIn { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dimension-card { background: white; border-radius: 10px; padding: 12px; border-left: 4px solid; }
        .tab-btn { padding: 10px 20px; font-weight: 500; color: #6b7280; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
        .schedule-cell { min-height: 50px; padding: 6px; font-size: 11px; border: 1px solid #e5e7eb; background: white; }
        .schedule-header { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; padding: 10px; text-align: center; font-weight: 600; font-size: 12px; }
        @media print { 
            .no-print { display: none !important; } 
            body { background: white; }
            .print-content { padding: 20px; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent"></div>
            <p class="mt-4 text-gray-600" id="loadingText">Memproses...</p>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300">
        <div class="bg-white rounded-lg shadow-xl p-4 flex items-center gap-3 min-w-72 border-l-4" id="toastContainer">
            <span id="toastIcon" class="text-xl"></span>
            <div>
                <p id="toastTitle" class="font-semibold text-sm"></p>
                <p id="toastMessage" class="text-xs text-gray-600"></p>
            </div>
        </div>
    </div>

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg">
                    <i class="fas fa-graduation-cap text-white text-3xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Si Gumart</h1>
                <p class="text-gray-500 mt-2">Aplikasi Guru Smart</p>
            </div>
            <button id="googleLoginBtn" class="w-full bg-white border-2 border-gray-200 rounded-xl py-3 px-4 flex items-center justify-center gap-3 hover:border-blue-500 hover:bg-blue-50 transition-all">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-6 h-6">
                <span class="font-medium text-gray-700">Masuk dengan Google</span>
            </button>
            <p class="mt-6 text-center text-xs text-gray-400">Kurikulum Merdeka • SD/SMP/SMA</p>
        </div>
    </div>

    <!-- SETUP PAGE -->
    <div id="setupPage" class="min-h-screen p-4 hidden">
        <div class="max-w-xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-6">
                <div class="text-center mb-6">
                    <div class="w-14 h-14 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl mx-auto flex items-center justify-center mb-3">
                        <i class="fas fa-user-cog text-white text-xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800">Lengkapi Profil</h2>
                </div>
                <form id="setupForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="form-label">Nama Lengkap *</label>
                            <input type="text" id="setupNamaGuru" required class="form-input">
                        </div>
                        <div>
                            <label class="form-label">NIP</label>
                            <input type="text" id="setupNIP" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Jenjang *</label>
                            <select id="setupJenjang" required class="form-input">
                                <option value="">Pilih</option>
                                <option value="SD">SD/MI</option>
                                <option value="SMP">SMP/MTs</option>
                                <option value="SMA">SMA/MA/SMK</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">NPSN Sekolah *</label>
                        <div class="flex gap-2">
                            <input type="text" id="setupNPSN" required maxlength="8" class="form-input flex-1" placeholder="8 digit">
                            <button type="button" id="cekNPSNBtn" class="btn-primary whitespace-nowrap">Cek NPSN</button>
                        </div>
                        <p id="npsnStatus" class="mt-1 text-xs hidden"></p>
                    </div>
                    <div id="sekolahSection" class="hidden space-y-4 pt-2 border-t">
                        <div>
                            <label class="form-label">Nama Sekolah *</label>
                            <input type="text" id="setupNamaSekolah" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Alamat</label>
                            <input type="text" id="setupAlamat" class="form-input">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Kepala Sekolah</label>
                                <input type="text" id="setupKepsek" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">NIP Kepsek</label>
                                <input type="text" id="setupNIPKepsek" class="form-input">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-medium hover:opacity-90">
                        <i class="fas fa-save mr-2"></i>Simpan & Lanjutkan
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed left-0 top-0 h-full w-60 bg-white shadow-xl z-40 transform -translate-x-full lg:translate-x-0 transition-transform">
            <div class="p-4 border-b">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-graduation-cap text-white text-sm"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-800 text-sm">Si Gumart</h1>
                        <p class="text-xs text-gray-400">v2.0</p>
                    </div>
                </div>
            </div>
            <div class="p-3 border-b bg-gray-50">
                <div class="flex items-center gap-2">
                    <img id="userPhoto" src="" class="w-8 h-8 rounded-full">
                    <div class="flex-1 min-w-0">
                        <p id="userName" class="font-medium text-gray-800 text-xs truncate"></p>
                        <p id="userSchool" class="text-xs text-gray-400 truncate"></p>
                    </div>
                </div>
            </div>
            <nav class="p-2 overflow-y-auto h-[calc(100vh-140px)]">
                <ul class="space-y-0.5 text-sm" id="navMenu">
                    <li><a class="nav-link active" data-page="dashboard"><i class="fas fa-home w-5 text-center"></i><span>Dashboard</span></a></li>
                    <li><a class="nav-link" data-page="profil"><i class="fas fa-user w-5 text-center"></i><span>Profil</span></a></li>
                    <li class="pt-3 pb-1"><p class="px-3 text-xs font-semibold text-gray-400 uppercase">Master Data</p></li>
                    <li><a class="nav-link" data-page="mapel"><i class="fas fa-book w-5 text-center"></i><span>Mata Pelajaran</span></a></li>
                    <li><a class="nav-link" data-page="cp"><i class="fas fa-bullseye w-5 text-center"></i><span>Capaian Pembelajaran</span></a></li>
                    <li><a class="nav-link" data-page="kelas"><i class="fas fa-users w-5 text-center"></i><span>Kelas & Rombel</span></a></li>
                    <li class="pt-3 pb-1"><p class="px-3 text-xs font-semibold text-gray-400 uppercase">Dokumen</p></li>
                    <li><a class="nav-link" data-page="kalender"><i class="fas fa-calendar w-5 text-center"></i><span>Kalender</span></a></li>
                    <li><a class="nav-link" data-page="jadwal"><i class="fas fa-clock w-5 text-center"></i><span>Jadwal</span></a></li>
                    <li><a class="nav-link" data-page="atp"><i class="fas fa-project-diagram w-5 text-center"></i><span>ATP</span></a></li>
                    <li><a class="nav-link" data-page="modul"><i class="fas fa-file-alt w-5 text-center"></i><span>Modul Ajar</span></a></li>
                    <li><a class="nav-link" data-page="lkpd"><i class="fas fa-clipboard-list w-5 text-center"></i><span>LKPD</span></a></li>
                    <li><a class="nav-link" data-page="banksoal"><i class="fas fa-question-circle w-5 text-center"></i><span>Bank Soal</span></a></li>
                    <li class="pt-3"><a class="nav-link text-red-500 hover:bg-red-50" id="logoutBtn"><i class="fas fa-sign-out-alt w-5 text-center"></i><span>Keluar</span></a></li>
                </ul>
            </nav>
        </aside>
        
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
        
        <!-- Main Content -->
        <main class="lg:ml-60 min-h-screen">
            <header class="bg-white shadow-sm sticky top-0 z-20 no-print">
                <div class="flex items-center justify-between px-4 py-3">
                    <div class="flex items-center gap-3">
                        <button id="menuToggle" class="lg:hidden text-gray-600"><i class="fas fa-bars"></i></button>
                        <h2 id="pageTitle" class="font-semibold text-gray-800">Dashboard</h2>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="currentDate" class="text-xs text-gray-500 hidden sm:block"></span>
                    </div>
                </div>
            </header>
            <div id="pageContent" class="p-4"></div>
        </main>
    </div>

    <!-- Global Modal Container -->
    <div id="modalContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIG
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCyRKvngA1EqlQmgxgxU4465qgRw8TdT08",
            authDomain: "si-gumart.firebaseapp.com",
            projectId: "si-gumart",
            storageBucket: "si-gumart.firebasestorage.app",
            messagingSenderId: "544375918988",
            appId: "1:544375918988:web:3375b3025b7d51ea2546a9"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // ============================================
        // GLOBAL STATE
        // ============================================
        let currentUser = null;
        let userData = null;
        let schoolData = null;
        let appData = {
            mapel: [],
            cp: [],
            kelas: [],
            jadwal: [],
            kalender: [],
            modul: [],
            lkpd: [],
            soal: []
        };

        // ============================================
        // CONSTANTS
        // ============================================
        const DIMENSI_PROFIL = [
            { id: 'keimanan', nama: 'Keimanan dan Ketakwaan', warna: '#8B5CF6', icon: 'fa-pray', desc: 'Keyakinan teguh pada Tuhan YME' },
            { id: 'kewargaan', nama: 'Kewargaan', warna: '#EF4444', icon: 'fa-flag', desc: 'Cinta tanah air, sadar aturan' },
            { id: 'penalaran', nama: 'Penalaran Kritis', warna: '#3B82F6', icon: 'fa-brain', desc: 'Berpikir logis dan analitis' },
            { id: 'kreativitas', nama: 'Kreativitas', warna: '#F59E0B', icon: 'fa-lightbulb', desc: 'Inovatif dan fleksibel' },
            { id: 'kolaborasi', nama: 'Kolaborasi', warna: '#10B981', icon: 'fa-users', desc: 'Bekerja sama mencapai tujuan' },
            { id: 'kemandirian', nama: 'Kemandirian', warna: '#6366F1', icon: 'fa-user-check', desc: 'Mampu mengelola diri sendiri' },
            { id: 'kesehatan', nama: 'Kesehatan', warna: '#EC4899', icon: 'fa-heart', desc: 'Fisik prima dan mental sehat' },
            { id: 'komunikasi', nama: 'Komunikasi', warna: '#14B8A6', icon: 'fa-comments', desc: 'Efektif menyampaikan ide' }
        ];

        const HARI = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        
        const JAM_PELAJARAN = {
            SD: Array.from({length: 8}, (_, i) => ({ jam: i+1, mulai: `${7 + Math.floor(i*35/60)}:${String((i*35)%60).padStart(2,'0')}`, selesai: `${7 + Math.floor((i+1)*35/60)}:${String(((i+1)*35)%60).padStart(2,'0')}` })),
            SMP: Array.from({length: 10}, (_, i) => ({ jam: i+1, mulai: `${7 + Math.floor(i*40/60)}:${String((i*40)%60).padStart(2,'0')}`, selesai: `${7 + Math.floor((i+1)*40/60)}:${String(((i+1)*40)%60).padStart(2,'0')}` })),
            SMA: Array.from({length: 10}, (_, i) => ({ jam: i+1, mulai: `${7 + Math.floor(i*45/60)}:${String((i*45)%60).padStart(2,'0')}`, selesai: `${7 + Math.floor((i+1)*45/60)}:${String(((i+1)*45)%60).padStart(2,'0')}` }))
        };

        const MAPEL_TEMPLATE = {
            SD: [
                { nama: 'Pendidikan Agama Islam dan Budi Pekerti', kode: 'PAI', elemen: ['Al-Quran Hadis', 'Aqidah', 'Akhlak', 'Fikih', 'Sejarah Peradaban Islam'] },
                { nama: 'PPKn', kode: 'PPKN', elemen: ['Pancasila', 'UUD 1945', 'Bhinneka Tunggal Ika', 'NKRI'] },
                { nama: 'Bahasa Indonesia', kode: 'BI', elemen: ['Menyimak', 'Membaca', 'Berbicara', 'Menulis'] },
                { nama: 'Matematika', kode: 'MTK', elemen: ['Bilangan', 'Aljabar', 'Pengukuran', 'Geometri', 'Statistika'] },
                { nama: 'IPAS', kode: 'IPAS', elemen: ['Pemahaman IPA', 'Keterampilan Proses', 'Pemahaman IPS'] },
                { nama: 'Seni Budaya', kode: 'SB', elemen: ['Seni Musik', 'Seni Rupa', 'Seni Tari', 'Seni Teater'] },
                { nama: 'PJOK', kode: 'PJOK', elemen: ['Keterampilan Gerak', 'Pengetahuan Gerak', 'Pengembangan Karakter'] },
                { nama: 'Bahasa Inggris', kode: 'BING', elemen: ['Menyimak-Berbicara', 'Membaca-Memirsa', 'Menulis'] }
            ],
            SMP: [
                { nama: 'Pendidikan Agama Islam dan Budi Pekerti', kode: 'PAI', elemen: ['Al-Quran Hadis', 'Aqidah', 'Akhlak', 'Fikih', 'Sejarah Peradaban Islam'] },
                { nama: 'PPKn', kode: 'PPKN', elemen: ['Pancasila', 'UUD 1945', 'Bhinneka Tunggal Ika', 'NKRI'] },
                { nama: 'Bahasa Indonesia', kode: 'BI', elemen: ['Menyimak', 'Membaca', 'Berbicara', 'Menulis'] },
                { nama: 'Matematika', kode: 'MTK', elemen: ['Bilangan', 'Aljabar', 'Pengukuran', 'Geometri', 'Statistika'] },
                { nama: 'IPA', kode: 'IPA', elemen: ['Pemahaman Sains', 'Keterampilan Proses'] },
                { nama: 'IPS', kode: 'IPS', elemen: ['Pemahaman Konsep', 'Keterampilan Sosial'] },
                { nama: 'Bahasa Inggris', kode: 'BING', elemen: ['Menyimak-Berbicara', 'Membaca-Memirsa', 'Menulis'] },
                { nama: 'PJOK', kode: 'PJOK', elemen: ['Keterampilan Gerak', 'Pengetahuan Gerak'] },
                { nama: 'Informatika', kode: 'INF', elemen: ['Berpikir Komputasional', 'TIK', 'Sistem Komputer'] },
                { nama: 'Seni Budaya', kode: 'SB', elemen: ['Seni Musik', 'Seni Rupa', 'Seni Tari'] }
            ],
            SMA: [
                { nama: 'Pendidikan Agama Islam dan Budi Pekerti', kode: 'PAI', elemen: ['Al-Quran Hadis', 'Aqidah', 'Akhlak', 'Fikih', 'Sejarah Peradaban Islam'] },
                { nama: 'PPKn', kode: 'PPKN', elemen: ['Pancasila', 'UUD 1945', 'Bhinneka Tunggal Ika', 'NKRI'] },
                { nama: 'Bahasa Indonesia', kode: 'BI', elemen: ['Menyimak', 'Membaca', 'Berbicara', 'Menulis'] },
                { nama: 'Matematika', kode: 'MTK', elemen: ['Bilangan', 'Aljabar', 'Fungsi', 'Geometri', 'Kalkulus', 'Statistika'] },
                { nama: 'Fisika', kode: 'FIS', elemen: ['Pemahaman Fisika', 'Keterampilan Proses'] },
                { nama: 'Kimia', kode: 'KIM', elemen: ['Pemahaman Kimia', 'Keterampilan Proses'] },
                { nama: 'Biologi', kode: 'BIO', elemen: ['Pemahaman Biologi', 'Keterampilan Proses'] },
                { nama: 'Sejarah', kode: 'SEJ', elemen: ['Pemahaman Konsep', 'Keterampilan Sejarah'] },
                { nama: 'Geografi', kode: 'GEO', elemen: ['Pengetahuan', 'Keterampilan'] },
                { nama: 'Ekonomi', kode: 'EKO', elemen: ['Pemahaman Konsep', 'Keterampilan Ekonomi'] },
                { nama: 'Bahasa Inggris', kode: 'BING', elemen: ['Menyimak-Berbicara', 'Membaca-Memirsa', 'Menulis'] },
                { nama: 'Informatika', kode: 'INF', elemen: ['Berpikir Komputasional', 'TIK', 'Pemrograman'] }
            ]
        };

        const TIPE_SOAL = ['Pilihan Ganda', 'Isian Singkat', 'Uraian', 'Benar/Salah', 'Menjodohkan'];
        const LEVEL_KOGNITIF = ['C1-Mengingat', 'C2-Memahami', 'C3-Menerapkan', 'C4-Menganalisis', 'C5-Mengevaluasi', 'C6-Mencipta'];
                // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showLoading(text = 'Memproses...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const container = document.getElementById('toastContainer');
            const colors = { success: 'border-green-500', error: 'border-red-500', warning: 'border-yellow-500', info: 'border-blue-500' };
            const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
            
            container.className = 'bg-white rounded-lg shadow-xl p-4 flex items-center gap-3 min-w-72 border-l-4 ' + (colors[type] || colors.info);
            document.getElementById('toastIcon').textContent = icons[type] || icons.info;
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3500);
        }

        function showModal(content, maxWidth = 'max-w-lg') {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content ${maxWidth}">${content}</div>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        function updateDate() {
            const el = document.getElementById('currentDate');
            if (el) el.textContent = new Date().toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
        }

        function getGreeting() {
            const h = new Date().getHours();
            return h < 12 ? 'Selamat Pagi' : h < 15 ? 'Selamat Siang' : h < 18 ? 'Selamat Sore' : 'Selamat Malam';
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getTingkatByJenjang(jenjang) {
            return { SD: [1,2,3,4,5,6], SMP: [7,8,9], SMA: [10,11,12] }[jenjang] || [];
        }

        function getFaseByTingkat(tingkat) {
            if (tingkat <= 2) return 'A';
            if (tingkat <= 4) return 'B';
            if (tingkat <= 6) return 'C';
            if (tingkat <= 9) return 'D';
            if (tingkat === 10) return 'E';
            return 'F';
        }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        async function loginWithGoogle() {
            try {
                showLoading('Masuk dengan Google...');
                await auth.signInWithPopup(googleProvider);
            } catch (error) {
                showToast('error', 'Login Gagal', error.message);
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            if (confirm('Keluar dari aplikasi?')) {
                showLoading('Keluar...');
                await auth.signOut();
                hideLoading();
            }
        }

        // ============================================
        // DATABASE FUNCTIONS
        // ============================================
        async function getDoc(collection, id) {
            try {
                const doc = await db.collection(collection).doc(id).get();
                return doc.exists ? { id: doc.id, ...doc.data() } : null;
            } catch (e) { return null; }
        }

        async function getDocs(collection, conditions = []) {
            try {
                let query = db.collection(collection);
                conditions.forEach(c => { query = query.where(c.field, c.op, c.value); });
                const snapshot = await query.get();
                return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { return []; }
        }

        async function saveDoc(collection, data, id = null) {
            try {
                const docData = { ...data, updatedAt: new Date().toISOString() };
                if (id) {
                    await db.collection(collection).doc(id).set(docData, { merge: true });
                    return id;
                } else {
                    docData.createdAt = new Date().toISOString();
                    const ref = await db.collection(collection).add(docData);
                    return ref.id;
                }
            } catch (e) { 
                console.error('Save error:', e);
                return null; 
            }
        }

        async function deleteDoc(collection, id) {
            try {
                await db.collection(collection).doc(id).delete();
                return true;
            } catch (e) { return false; }
        }

        // ============================================
        // LOAD DATA FUNCTIONS
        // ============================================
        async function loadUserData(uid) {
            userData = await getDoc('users', uid);
            if (userData) {
                schoolData = await getDoc('schools', userData.npsn);
            }
            return userData;
        }

        async function loadAppData() {
            if (!userData) return;
            
            appData.mapel = await getDocs('mapel', [{ field: 'userId', op: '==', value: userData.uid }]);
            appData.cp = await getDocs('cp', [{ field: 'userId', op: '==', value: userData.uid }]);
            appData.kelas = await getDocs('kelas', [{ field: 'npsn', op: '==', value: userData.npsn }]);
            appData.jadwal = await getDocs('jadwal', [{ field: 'npsn', op: '==', value: userData.npsn }]);
            appData.modul = await getDocs('modul', [{ field: 'userId', op: '==', value: userData.uid }]);
            appData.lkpd = await getDocs('lkpd', [{ field: 'userId', op: '==', value: userData.uid }]);
            appData.soal = await getDocs('soal', [{ field: 'userId', op: '==', value: userData.uid }]);
        }

        // ============================================
        // PAGE NAVIGATION
        // ============================================
        function navigateTo(page) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === page);
            });
            
            const titles = {
                dashboard: 'Dashboard', profil: 'Profil', mapel: 'Mata Pelajaran',
                cp: 'Capaian Pembelajaran', kelas: 'Kelas & Rombel', kalender: 'Kalender',
                jadwal: 'Jadwal Pelajaran', atp: 'ATP', modul: 'Modul Ajar',
                lkpd: 'LKPD', banksoal: 'Bank Soal'
            };
            document.getElementById('pageTitle').textContent = titles[page] || page;
            
            renderPage(page);
            
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            }
        }

        function renderPage(page) {
            const container = document.getElementById('pageContent');
            
            const renderers = {
                dashboard: renderDashboard,
                profil: renderProfil,
                mapel: renderMapel,
                cp: renderCP,
                kelas: renderKelas,
                jadwal: renderJadwal,
                modul: renderModul,
                lkpd: renderLKPD,
                banksoal: renderBankSoal
            };
            
            container.innerHTML = renderers[page] ? renderers[page]() : renderComingSoon(page);
        }

        // ============================================
        // RENDER: DASHBOARD
        // ============================================
        function renderDashboard() {
            return `
                <div class="animate-fadeIn space-y-4">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-5 text-white">
                        <p class="text-white/80 text-sm">${getGreeting()},</p>
                        <h1 class="text-xl font-bold">${userData?.namaGuru || 'Guru'}</h1>
                        <p class="text-white/80 text-sm mt-1"><i class="fas fa-school mr-1"></i>${schoolData?.namaSekolah || '-'}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        ${[
                            { label: 'Mapel', value: appData.mapel.length, icon: 'fa-book', color: 'blue' },
                            { label: 'CP', value: appData.cp.length, icon: 'fa-bullseye', color: 'green' },
                            { label: 'Modul', value: appData.modul.length, icon: 'fa-file-alt', color: 'purple' },
                            { label: 'Soal', value: appData.soal.length, icon: 'fa-question-circle', color: 'orange' }
                        ].map(s => `
                            <div class="stats-card card-hover">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-xs">${s.label}</p>
                                        <p class="text-xl font-bold text-gray-800">${s.value}</p>
                                    </div>
                                    <div class="stats-icon bg-${s.color}-100 text-${s.color}-600"><i class="fas ${s.icon}"></i></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="grid lg:grid-cols-3 gap-4">
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-4">
                            <h3 class="font-semibold text-gray-800 text-sm mb-3"><i class="fas fa-bolt text-yellow-500 mr-2"></i>Aksi Cepat</h3>
                            <div class="grid grid-cols-3 gap-2">
                                ${[
                                    { page: 'mapel', icon: 'fa-book', label: 'Mapel', color: 'blue' },
                                    { page: 'cp', icon: 'fa-bullseye', label: 'CP', color: 'green' },
                                    { page: 'modul', icon: 'fa-file-alt', label: 'Modul', color: 'purple' },
                                    { page: 'jadwal', icon: 'fa-clock', label: 'Jadwal', color: 'cyan' },
                                    { page: 'lkpd', icon: 'fa-clipboard', label: 'LKPD', color: 'pink' },
                                    { page: 'banksoal', icon: 'fa-question', label: 'Soal', color: 'orange' }
                                ].map(a => `
                                    <button onclick="navigateTo('${a.page}')" class="flex flex-col items-center p-3 rounded-lg bg-gray-50 hover:bg-${a.color}-50 hover:text-${a.color}-600 transition-all text-xs">
                                        <i class="fas ${a.icon} text-lg mb-1"></i>
                                        <span class="font-medium">${a.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <h3 class="font-semibold text-gray-800 text-sm mb-3"><i class="fas fa-star text-yellow-500 mr-2"></i>8 Dimensi</h3>
                            <div class="grid grid-cols-2 gap-2">
                                ${DIMENSI_PROFIL.slice(0, 4).map(d => `
                                    <div class="dimension-card text-xs" style="border-left-color: ${d.warna}">
                                        <div class="flex items-center gap-1">
                                            <i class="fas ${d.icon}" style="color: ${d.warna}"></i>
                                            <span class="font-medium truncate">${d.nama.split(' ')[0]}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================
        // RENDER: PROFIL (EDITABLE)
        // ============================================
        function renderProfil() {
            return `
                <div class="animate-fadeIn max-w-2xl mx-auto space-y-4">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-6 text-white text-center">
                        <img src="${userData?.photoURL || 'https://ui-avatars.com/api/?name=G'}" class="w-20 h-20 rounded-full border-4 border-white/30 mx-auto mb-3">
                        <h1 class="text-lg font-bold">${userData?.namaGuru || '-'}</h1>
                        <p class="text-white/80 text-sm">${userData?.email || '-'}</p>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800"><i class="fas fa-user text-blue-600 mr-2"></i>Data Guru</h3>
                            <button onclick="showEditProfilModal()" class="text-blue-600 text-sm hover:underline"><i class="fas fa-edit mr-1"></i>Edit</button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-500 text-xs">Nama</p><p class="font-medium">${userData?.namaGuru || '-'}</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-500 text-xs">NIP</p><p class="font-medium">${userData?.nip || '-'}</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-500 text-xs">Email</p><p class="font-medium truncate">${userData?.email || '-'}</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-500 text-xs">Jenjang</p><p class="font-medium">${userData?.jenjang || '-'}</p></div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-800"><i class="fas fa-school text-blue-600 mr-2"></i>Data Sekolah</h3>
                            <button onclick="showEditSekolahModal()" class="text-blue-600 text-sm hover:underline"><i class="fas fa-edit mr-1"></i>Edit</button>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-500 text-xs">NPSN</p><p class="font-medium">${userData?.npsn || '-'}</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-500 text-xs">Nama Sekolah</p><p class="font-medium">${schoolData?.namaSekolah || '-'}</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-500 text-xs">Kepala Sekolah</p><p class="font-medium">${schoolData?.kepalaSekolah || '-'}</p></div>
                            <div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-500 text-xs">NIP Kepsek</p><p class="font-medium">${schoolData?.nipKepsek || '-'}</p></div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showEditProfilModal() {
            showModal(`
                <div class="modal-header">
                    <h3 class="font-semibold">Edit Profil Guru</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <form onsubmit="saveEditProfil(event)" class="modal-body space-y-4">
                    <div>
                        <label class="form-label">Nama Lengkap</label>
                        <input type="text" id="editNamaGuru" value="${userData?.namaGuru || ''}" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">NIP</label>
                        <input type="text" id="editNIP" value="${userData?.nip || ''}" class="form-input">
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeModal()" class="btn-secondary">Batal</button>
                        <button type="submit" class="btn-primary">Simpan</button>
                    </div>
                </form>
            `);
        }

        async function saveEditProfil(e) {
            e.preventDefault();
            showLoading('Menyimpan...');
            
            const data = {
                namaGuru: document.getElementById('editNamaGuru').value.trim(),
                nip: document.getElementById('editNIP').value.trim()
            };
            
            await saveDoc('users', data, userData.uid);
            userData = { ...userData, ...data };
            
            document.getElementById('userName').textContent = data.namaGuru;
            
            hideLoading();
            closeModal();
            showToast('success', 'Berhasil', 'Profil diperbarui');
            navigateTo('profil');
        }

        function showEditSekolahModal() {
            showModal(`
                <div class="modal-header">
                    <h3 class="font-semibold">Edit Data Sekolah</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <form onsubmit="saveEditSekolah(event)" class="modal-body space-y-4">
                    <div>
                        <label class="form-label">Nama Sekolah</label>
                        <input type="text" id="editNamaSekolah" value="${schoolData?.namaSekolah || ''}" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Alamat</label>
                        <input type="text" id="editAlamatSekolah" value="${schoolData?.alamat || ''}" class="form-input">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="form-label">Kepala Sekolah</label>
                            <input type="text" id="editKepsek" value="${schoolData?.kepalaSekolah || ''}" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">NIP Kepsek</label>
                            <input type="text" id="editNIPKepsek" value="${schoolData?.nipKepsek || ''}" class="form-input">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeModal()" class="btn-secondary">Batal</button>
                        <button type="submit" class="btn-primary">Simpan</button>
                    </div>
                </form>
            `);
        }

        async function saveEditSekolah(e) {
            e.preventDefault();
            showLoading('Menyimpan...');
            
            const data = {
                namaSekolah: document.getElementById('editNamaSekolah').value.trim(),
                alamat: document.getElementById('editAlamatSekolah').value.trim(),
                kepalaSekolah: document.getElementById('editKepsek').value.trim(),
                nipKepsek: document.getElementById('editNIPKepsek').value.trim()
            };
            
            await saveDoc('schools', data, userData.npsn);
            schoolData = { ...schoolData, ...data };
            
            document.getElementById('userSchool').textContent = data.namaSekolah;
            
            hideLoading();
            closeModal();
            showToast('success', 'Berhasil', 'Data sekolah diperbarui');
            navigateTo('profil');
        }

        // ============================================
        // RENDER: MATA PELAJARAN
        // ============================================
        function renderMapel() {
            return `
                <div class="animate-fadeIn space-y-4">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Mata Pelajaran</h2>
                            <p class="text-gray-500 text-sm">Kelola mata pelajaran yang diampu</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showTemplateMapelModal()" class="btn-secondary text-sm"><i class="fas fa-magic mr-1"></i>Template</button>
                            <button onclick="showAddMapelModal()" class="btn-primary text-sm"><i class="fas fa-plus mr-1"></i>Tambah</button>
                        </div>
                    </div>
                    
                    <div id="mapelList" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                        ${appData.mapel.length === 0 ? `
                            <div class="col-span-full text-center py-12 bg-white rounded-xl">
                                <i class="fas fa-book-open text-gray-300 text-4xl mb-3"></i>
                                <p class="text-gray-500">Belum ada mata pelajaran</p>
                            </div>
                        ` : appData.mapel.map(m => `
                            <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-sm">
                                            ${m.kode?.substring(0, 2) || 'MP'}
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-800 text-sm">${m.nama}</h4>
                                            <p class="text-xs text-gray-500">${m.kode || '-'}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="showEditMapelModal('${m.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded"><i class="fas fa-edit text-xs"></i></button>
                                        <button onclick="hapusMapel('${m.id}')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded"><i class="fas fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                                ${m.elemen?.length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${m.elemen.slice(0, 3).map(e => `<span class="badge badge-primary">${e}</span>`).join('')}
                                        ${m.elemen.length > 3 ? `<span class="badge badge-secondary">+${m.elemen.length - 3}</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showTemplateMapelModal() {
            const templates = MAPEL_TEMPLATE[userData?.jenjang] || [];
            showModal(`
                <div class="modal-header">
                    <h3 class="font-semibold">Pilih dari Template</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="selectAllTemplate" onchange="toggleSelectAllTemplate()">
                        <label for="selectAllTemplate" class="text-sm font-medium">Pilih Semua</label>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${templates.map((t, i) => `
                            <label class="flex items-start gap-2 p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" class="template-cb mt-1" value="${i}">
                                <div class="flex-1">
                                    <p class="font-medium text-sm">${t.nama}</p>
                                    <p class="text-xs text-gray-500">${t.elemen.slice(0, 3).join(', ')}${t.elemen.length > 3 ? '...' : ''}</p>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal()" class="btn-secondary">Batal</button>
                    <button onclick="addFromTemplate()" class="btn-primary">Tambahkan</button>
                </div>
            `, 'max-w-md');
        }

        function toggleSelectAllTemplate() {
            const checked = document.getElementById('selectAllTemplate').checked;
            document.querySelectorAll('.template-cb').forEach(cb => cb.checked = checked);
        }

        async function addFromTemplate() {
            const templates = MAPEL_TEMPLATE[userData?.jenjang] || [];
            const selected = [...document.querySelectorAll('.template-cb:checked')].map(cb => parseInt(cb.value));
            
            if (selected.length === 0) {
                showToast('warning', 'Perhatian', 'Pilih minimal satu mapel');
                return;
            }
            
            showLoading('Menambahkan...');
            
            for (const idx of selected) {
                const t = templates[idx];
                const exists = appData.mapel.find(m => m.kode === t.kode);
                if (!exists) {
                    const id = await saveDoc('mapel', {
                        userId: userData.uid,
                        npsn: userData.npsn,
                        nama: t.nama,
                        kode: t.kode,
                        elemen: t.elemen
                    });
                    if (id) appData.mapel.push({ id, ...t, userId: userData.uid });
                }
            }
            
            hideLoading();
            closeModal();
            showToast('success', 'Berhasil', `${selected.length} mapel ditambahkan`);
            navigateTo('mapel');
        }

        function showAddMapelModal(mapel = null) {
            const isEdit = !!mapel;
            showModal(`
                <div class="modal-header">
                    <h3 class="font-semibold">${isEdit ? 'Edit' : 'Tambah'} Mata Pelajaran</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <form onsubmit="saveMapel(event, '${mapel?.id || ''}')" class="modal-body space-y-4">
                    <div>
                        <label class="form-label">Nama Mata Pelajaran *</label>
                        <input type="text" id="mapelNama" value="${mapel?.nama || ''}" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Kode *</label>
                        <input type="text" id="mapelKode" value="${mapel?.kode || ''}" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Elemen (pisah dengan koma)</label>
                        <textarea id="mapelElemen" class="form-input" rows="3" placeholder="Elemen 1, Elemen 2, Elemen 3">${mapel?.elemen?.join(', ') || ''}</textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeModal()" class="btn-secondary">Batal</button>
                        <button type="submit" class="btn-primary">Simpan</button>
                    </div>
                </form>
            `);
        }

        function showEditMapelModal(id) {
            const mapel = appData.mapel.find(m => m.id === id);
            if (mapel) showAddMapelModal(mapel);
        }

        async function saveMapel(e, id) {
            e.preventDefault();
            showLoading('Menyimpan...');
            
            const data = {
                userId: userData.uid,
                npsn: userData.npsn,
                nama: document.getElementById('mapelNama').value.trim(),
                kode: document.getElementById('mapelKode').value.trim().toUpperCase(),
                elemen: document.getElementById('mapelElemen').value.split(',').map(e => e.trim()).filter(e => e)
            };
            
            const savedId = await saveDoc('mapel', data, id || null);
            
            if (savedId) {
                if (id) {
                    const idx = appData.mapel.findIndex(m => m.id === id);
                    if (idx >= 0) appData.mapel[idx] = { id, ...data };
                } else {
                    appData.mapel.push({ id: savedId, ...data });
                }
            }
            
            hideLoading();
            closeModal();
            showToast('success', 'Berhasil', 'Mapel disimpan');
            navigateTo('mapel');
        }

        async function hapusMapel(id) {
            if (!confirm('Hapus mata pelajaran ini?')) return;
            
            showLoading('Menghapus...');
            await deleteDoc('mapel', id);
            appData.mapel = appData.mapel.filter(m => m.id !== id);
            hideLoading();
            showToast('success', 'Berhasil', 'Mapel dihapus');
            navigateTo('mapel');
        }

        // ============================================
        // RENDER: CAPAIAN PEMBELAJARAN
        // ============================================
        function renderCP() {
            const mapelOptions = appData.mapel.map(m => `<option value="${m.id}">${m.nama}</option>`).join('');
            
            return `
                <div class="animate-fadeIn space-y-4">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Capaian Pembelajaran</h2>
                            <p class="text-gray-500 text-sm">Input CP berdasarkan elemen</p>
                        </div>
                        <button onclick="showAddCPModal()" class="btn-primary text-sm" ${appData.mapel.length === 0 ? 'disabled' : ''}>
                            <i class="fas fa-plus mr-1"></i>Tambah CP
                        </button>
                    </div>
                    
                    ${appData.mapel.length === 0 ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Tambahkan mata pelajaran terlebih dahulu
                        </div>
                    ` : `
                        <div class="bg-white rounded-xl shadow-sm p-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="form-label">Filter Mapel</label>
                                    <select id="filterCPMapel" onchange="filterCP()" class="form-input">
                                        <option value="">Semua Mapel</option>
                                        ${mapelOptions}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Filter Fase</label>
                                    <select id="filterCPFase" onchange="filterCP()" class="form-input">
                                        <option value="">Semua Fase</option>
                                        <option value="A">Fase A</option>
                                        <option value="B">Fase B</option>
                                        <option value="C">Fase C</option>
                                        <option value="D">Fase D</option>
                                        <option value="E">Fase E</option>
                                        <option value="F">Fase F</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `}
                    
                    <div id="cpList" class="space-y-3">
                        ${renderCPList(appData.cp)}
                    </div>
                </div>
            `;
        }

        function renderCPList(cpList) {
            if (cpList.length === 0) {
                return `
                    <div class="text-center py-12 bg-white rounded-xl">
                        <i class="fas fa-bullseye text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">Belum ada CP</p>
                    </div>
                `;
            }
            
            // Group by mapel
            const grouped = {};
            cpList.forEach(cp => {
                const mapel = appData.mapel.find(m => m.id === cp.mapelId);
                const key = mapel?.nama || 'Unknown';
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push({ ...cp, mapelNama: key });
            });
            
            return Object.entries(grouped).map(([mapelNama, cps]) => `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-4 py-2">
                        <h3 class="text-white font-medium text-sm">${mapelNama}</h3>
                    </div>
                    <div class="divide-y">
                        ${cps.map(cp => `
                            <div class="p-4 hover:bg-gray-50">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="badge badge-primary">Fase ${cp.fase}</span>
                                            <span class="badge badge-success">${cp.elemen}</span>
                                        </div>
                                        <p class="text-sm text-gray-700">${cp.deskripsi}</p>
                                        ${cp.dimensi?.length > 0 ? `
                                            <div class="flex flex-wrap gap-1 mt-2">
                                                ${cp.dimensi.map(d => {
                                                    const dim = DIMENSI_PROFIL.find(x => x.id === d);
                                                    return dim ? `<span class="text-xs px-2 py-0.5 rounded-full" style="background:${dim.warna}20;color:${dim.warna}">${dim.nama.split(' ')[0]}</span>` : '';
                                                }).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="showEditCPModal('${cp.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded"><i class="fas fa-edit text-xs"></i></button>
                                        <button onclick="hapusCP('${cp.id}')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded"><i class="fas fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function filterCP() {
            const mapelId = document.getElementById('filterCPMapel')?.value || '';
            const fase = document.getElementById('filterCPFase')?.value || '';
            
            let filtered = appData.cp;
            if (mapelId) filtered = filtered.filter(c => c.mapelId === mapelId);
            if (fase) filtered = filtered.filter(c => c.fase === fase);
            
            document.getElementById('cpList').innerHTML = renderCPList(filtered);
        }

        function showAddCPModal(cp = null) {
            const isEdit = !!cp;
            const mapelOptions = appData.mapel.map(m => `<option value="${m.id}" ${cp?.mapelId === m.id ? 'selected' : ''}>${m.nama}</option>`).join('');
            const selectedMapel = cp ? appData.mapel.find(m => m.id === cp.mapelId) : null;
            const elemenOptions = selectedMapel?.elemen?.map(e => `<option value="${e}" ${cp?.elemen === e ? 'selected' : ''}>${e}</option>`).join('') || '';
            
            showModal(`
                <div class="modal-header">
                    <h3 class="font-semibold">${isEdit ? 'Edit' : 'Tambah'} Capaian Pembelajaran</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <form onsubmit="saveCP(event, '${cp?.id || ''}')" class="modal-body space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="form-label">Mata Pelajaran *</label>
                            <select id="cpMapelId" class="form-input" required onchange="updateElemenOptions()">
                                <option value="">Pilih</option>
                                ${mapelOptions}
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Elemen *</label>
                            <select id="cpElemen" class="form-input" required>
                                <option value="">Pilih</option>
                                ${elemenOptions}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Fase *</label>
                        <select id="cpFase" class="form-input" required>
                            ${['A','B','C','D','E','F'].map(f => `<option value="${f}" ${cp?.fase === f ? 'selected' : ''}>Fase ${f}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Deskripsi CP *</label>
                        <textarea id="cpDeskripsi" class="form-input" rows="4" required>${cp?.deskripsi || ''}</textarea>
                    </div>
                    <div>
                        <label class="form-label">Dimensi Profil Lulusan</label>
                        <div class="grid grid-cols-2 gap-2 mt-1">
                            ${DIMENSI_PROFIL.map(d => `
                                <label class="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer text-xs">
                                    <input type="checkbox" name="cpDimensi" value="${d.id}" ${cp?.dimensi?.includes(d.id) ? 'checked' : ''}>
                                    <i class="fas ${d.icon}" style="color:${d.warna}"></i>
                                    <span>${d.nama}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeModal()" class="btn-secondary">Batal</button>
                        <button type="submit" class="btn-primary">Simpan</button>
                    </div>
                </form>
            `, 'max-w-xl');
        }

        function updateElemenOptions() {
            const mapelId = document.getElementById('cpMapelId').value;
            const mapel = appData.mapel.find(m => m.id === mapelId);
            const elemenSelect = document.getElementById('cpElemen');
            
            elemenSelect.innerHTML = '<option value="">Pilih</option>' + 
                (mapel?.elemen?.map(e => `<option value="${e}">${e}</option>`).join('') || '');
        }

        function showEditCPModal(id) {
            const cp = appData.cp.find(c => c.id === id);
            if (cp) showAddCPModal(cp);
        }

        async function saveCP(e, id) {
            e.preventDefault();
            showLoading('Menyimpan...');
            
            const data = {
                userId: userData.uid,
                mapelId: document.getElementById('cpMapelId').value,
                elemen: document.getElementById('cpElemen').value,
                fase: document.getElementById('cpFase').value,
                deskripsi: document.getElementById('cpDeskripsi').value.trim(),
                dimensi: [...document.querySelectorAll('input[name="cpDimensi"]:checked')].map(cb => cb.value)
            };
            
            const savedId = await saveDoc('cp', data, id || null);
            
            if (savedId) {
                if (id) {
                    const idx = appData.cp.findIndex(c => c.id === id);
                    if (idx >= 0) appData.cp[idx] = { id, ...data };
                } else {
                    appData.cp.push({ id: savedId, ...data });
                }
            }
            
            hideLoading();
            closeModal();
            showToast('success', 'Berhasil', 'CP disimpan');
            navigateTo('cp');
        }

        async function hapusCP(id) {
            if (!confirm('Hapus CP ini?')) return;
            showLoading('Menghapus...');
            await deleteDoc('cp', id);
            appData.cp = appData.cp.filter(c => c.id !== id);
            hideLoading();
            showToast('success', 'Berhasil', 'CP dihapus');
            navigateTo('cp');
        }

        // ============================================
        // RENDER: KELAS
        // ============================================
        function renderKelas() {
            const tingkat = getTingkatByJenjang(userData?.jenjang);
            
            return `
                <div class="animate-fadeIn space-y-4">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">Kelas & Rombel</h2>
                            <p class="text-gray-500 text-sm">Kelola data kelas</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="generateKelasOtomatis()" class="btn-secondary text-sm"><i class="fas fa-magic mr-1"></i>Generate</button>
                            <button onclick="showAddKelasModal()" class="btn-primary text-sm"><i class="fas fa-plus mr-1"></i>Tambah</button>
                        </div>
                    </div>
                    
                    <div id="kelasList" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
                        ${appData.kelas.length === 0 ? `
                            <div class="col-span-full text-center py-12 bg-white rounded-xl">
                                <i class="fas fa-users text-gray-300 text-4xl mb-3"></i>
                                <p class="text-gray-500">Belum ada kelas</p>
                            </div>
                        ` : appData.kelas.sort((a,b) => a.tingkat - b.tingkat || a.rombel.localeCompare(b.rombel)).map(k => `
                            <div class="bg-white rounded-xl shadow-sm p-4 card-hover">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-white font-bold">
                                        ${k.tingkat}${k.rombel}
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="showEditKelasModal('${k.id}')" class="p-1.5 text-gray-400 hover:text-blue-600 rounded"><i class="fas fa-edit text-xs"></i></button>
                                        <button onclick="hapusKelas('${k.id}')" class="p-1.5 text-gray-400 hover:text-red-600 rounded"><i class="fas fa-trash text-xs"></i></button>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 space-y-1">
                                    <p><i class="fas fa-user-tie w-4"></i>${k.waliKelas || '-'}</p>
                                    <p><i class="fas fa-users w-4"></i>${k.jumlahSiswa || 0} siswa</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        async function generateKelasOtomatis() {
            const tingkat = getTingkatByJenjang(userData?.jenjang);
            const rombel = ['A', 'B'];
            
            if (!confirm(`Generate ${tingkat.length * rombel.length} kelas otomatis?`)) return;
            
            showLoading('Generating...');
            
            for (const t of tingkat) {
                for (const r of rombel) {
                    const exists = appData.kelas.find(k => k.tingkat === t && k.rombel === r);
                    if (!exists) {
                        const id = await saveDoc('kelas', {
                            npsn: userData.npsn,
                            tingkat: t,
                            rombel: r,
                            waliKelas: '',
                            jumlahSiswa: 0
                        });
                        if (id) appData.kelas.push({ id, npsn: userData.npsn, tingkat: t, rombel: r });
                    }
                }
            }
            
            hideLoading();
            showToast('success', 'Berhasil', 'Kelas digenerate');
            navigateTo('kelas');
        }

        function showAddKelasModal(kelas = null) {
            const isEdit = !!kelas;
            const tingkat = getTingkatByJenjang(userData?.jenjang);
            
            showModal(`
                <div class="modal-header">
                    <h3 class="font-semibold">${isEdit ? 'Edit' : 'Tambah'} Kelas</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <form onsubmit="saveKelas(event, '${kelas?.id || ''}')" class="modal-body space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="form-label">Tingkat *</label>
                            <select id="kelasTingkat" class="form-input" required>
                                ${tingkat.map(t => `<option value="${t}" ${kelas?.tingkat === t ? 'selected' : ''}>Kelas ${t}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Rombel *</label>
                            <input type="text" id="kelasRombel" value="${kelas?.rombel || 'A'}" class="form-input" required maxlength="1">
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Wali Kelas</label>
                        <input type="text" id="kelasWali" value="${kelas?.waliKelas || ''}" class="form-input">
                    </div>
                    <div>
                        <label class="form-label">Jumlah Siswa</label>
                        <input type="number" id="kelasJumlah" value="${kelas?.jumlahSiswa || 0}" class="form-input" min="0">
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeModal()" class="btn-secondary">Batal</button>
                        <button type="submit" class="btn-primary">Simpan</button>
                    </div>
                </form>
            `);
        }

        function showEditKelasModal(id) {
            const kelas = appData.kelas.find(k => k.id === id);
            if (kelas) showAddKelasModal(kelas);
        }

        async function saveKelas(e, id) {
            e.preventDefault();
            showLoading('Menyimpan...');
            
            const data = {
                npsn: userData.npsn,
                tingkat: parseInt(document.getElementById('kelasTingkat').value),
                rombel: document.getElementById('kelasRombel').value.toUpperCase(),
                waliKelas: document.getElementById('kelasWali').value.trim(),
                jumlahSiswa: parseInt(document.getElementById('kelasJumlah').value) || 0
            };
            
            const savedId = await saveDoc('kelas', data, id || null);
            
            if (savedId) {
                if (id) {
                    const idx = appData.kelas.findIndex(k => k.id === id);
                    if (idx >= 0) appData.kelas[idx] = { id, ...data };
                } else {
                    appData.kelas.push({ id: savedId, ...data });
                }
            }
            
            hideLoading();
            closeModal();
            showToast('success', 'Berhasil', 'Kelas disimpan');
            navigateTo('kelas');
        }

        async function hapusKelas(id) {
            if (!confirm('Hapus kelas ini?')) return;
            showLoading('Menghapus...');
            await deleteDoc('kelas', id);
            appData.kelas = appData.kelas.filter(k => k.id !== id);
            hideLoading();
            showToast('success', 'Berhasil', 'Kelas dihapus');
            navigateTo('kelas');
        }

        // ============================================
        // COMING SOON & OTHER PAGES
        // ============================================
        function renderJadwal() {
            return renderComingSoon('Jadwal Pelajaran', 'Fitur jadwal dengan validasi anti-bentrok');
        }

        function renderModul() {
            return renderComingSoon('Modul Ajar', 'Buat modul ajar sesuai format Kurikulum Merdeka');
        }

        function renderLKPD() {
            return renderComingSoon('LKPD', 'Lembar Kerja Peserta Didik');
        }

        function renderBankSoal() {
            return renderComingSoon('Bank Soal', 'Kelola soal dengan level kognitif C1-C6');
        }

        function renderComingSoon(title, desc) {
            return `
                <div class="animate-fadeIn text-center py-16">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-tools text-blue-600 text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">${title}</h2>
                    <p class="text-gray-500 text-sm mb-6">${desc || 'Fitur ini sedang dalam pengembangan'}</p>
                    <button onclick="navigateTo('dashboard')" class="btn-primary">
                        <i class="fas fa-arrow-left mr-2"></i>Kembali
                    </button>
                </div>
            `;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Si Gumart v2.0');
            updateDate();
            setupEventListeners();
            
            auth.onAuthStateChanged(async (user) => {
                console.log('Auth:', user ? 'logged in' : 'logged out');
                
                if (user) {
                    currentUser = user;
                    showLoading('Memuat data...');
                    
                    const uData = await loadUserData(user.uid);
                    
                    if (uData) {
                        await loadAppData();
                        showMainApp();
                    } else {
                        showSetup(user);
                    }
                    
                    hideLoading();
                } else {
                    showLogin();
                }
            });
        });

        function showLogin() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('setupPage').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showSetup(user) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('setupPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('setupNamaGuru').value = user.displayName || '';
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('setupPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('userPhoto').src = userData?.photoURL || 'https://ui-avatars.com/api/?name=G';
            document.getElementById('userName').textContent = userData?.namaGuru || '-';
            document.getElementById('userSchool').textContent = schoolData?.namaSekolah || '-';
            
            navigateTo('dashboard');
        }

        function setupEventListeners() {
            // Login
            document.getElementById('googleLoginBtn').addEventListener('click', loginWithGoogle);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Check NPSN
            document.getElementById('cekNPSNBtn').addEventListener('click', async () => {
                const npsn = document.getElementById('setupNPSN').value.trim();
                const statusEl = document.getElementById('npsnStatus');
                const sekolahSection = document.getElementById('sekolahSection');
                
                if (npsn.length !== 8) {
                    statusEl.textContent = 'NPSN harus 8 digit';
                    statusEl.className = 'mt-1 text-xs text-red-500';
                    statusEl.classList.remove('hidden');
                    return;
                }
                
                showLoading('Mengecek...');
                const school = await getDoc('schools', npsn);
                hideLoading();
                
                sekolahSection.classList.remove('hidden');
                
                if (school) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Sekolah ditemukan: ' + school.namaSekolah;
                    statusEl.className = 'mt-1 text-xs text-green-600';
                    document.getElementById('setupNamaSekolah').value = school.namaSekolah;
                    document.getElementById('setupNamaSekolah').readOnly = true;
                    document.getElementById('setupAlamat').value = school.alamat || '';
                    document.getElementById('setupKepsek').value = school.kepalaSekolah || '';
                    document.getElementById('setupNIPKepsek').value = school.nipKepsek || '';
                } else {
                    statusEl.innerHTML = '<i class="fas fa-info-circle mr-1"></i>Sekolah baru - lengkapi data';
                    statusEl.className = 'mt-1 text-xs text-blue-600';
                    document.getElementById('setupNamaSekolah').readOnly = false;
                }
                statusEl.classList.remove('hidden');
            });
            
            // Setup Form
            document.getElementById('setupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const namaSekolah = document.getElementById('setupNamaSekolah').value.trim();
                if (!namaSekolah) {
                    showToast('error', 'Error', 'Klik Cek NPSN dahulu');
                    return;
                }
                
                showLoading('Menyimpan...');
                
                const npsn = document.getElementById('setupNPSN').value.trim();
                
                // Save user
                await saveDoc('users', {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    photoURL: currentUser.photoURL,
                    namaGuru: document.getElementById('setupNamaGuru').value.trim(),
                    nip: document.getElementById('setupNIP').value.trim(),
                    jenjang: document.getElementById('setupJenjang').value,
                    npsn: npsn
                }, currentUser.uid);
                
                // Save/update school
                await saveDoc('schools', {
                    npsn: npsn,
                    namaSekolah: namaSekolah,
                    alamat: document.getElementById('setupAlamat').value.trim(),
                    jenjang: document.getElementById('setupJenjang').value,
                    kepalaSekolah: document.getElementById('setupKepsek').value.trim(),
                    nipKepsek: document.getElementById('setupNIPKepsek').value.trim()
                }, npsn);
                
                await loadUserData(currentUser.uid);
                await loadAppData();
                
                hideLoading();
                showToast('success', 'Berhasil', 'Profil tersimpan');
                showMainApp();
            });
            
            // Sidebar Toggle
            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.toggle('hidden');
            });
            
            document.getElementById('sidebarOverlay').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebarOverlay').classList.add('hidden');
            });
            
            // Navigation
            document.querySelectorAll('.nav-link[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(e.currentTarget.dataset.page);
                });
            });
        }

        console.log('✅ Si Gumart loaded');
    </script>
</body>
</html>
