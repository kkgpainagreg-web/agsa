<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .arabic-text { font-family: 'Amiri', serif; direction: rtl; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { transform: translateX(4px); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gradient-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .gradient-warning { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .gradient-info { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        input:focus, select:focus, textarea:focus { outline: none; ring: 2px; ring-color: #667eea; }
        .schedule-cell { min-height: 60px; }
        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#667eea', 600: '#5b21b6', 700: '#4c1d95', 800: '#3c1361', 900: '#2e1065' },
                        accent: { 50: '#fdf4ff', 100: '#fae8ff', 200: '#f5d0fe', 300: '#f0abfc', 400: '#e879f9', 500: '#d946ef', 600: '#c026d3', 700: '#a21caf', 800: '#86198f', 900: '#701a75' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-700">Admin Guru Super App</h2>
            <p class="text-gray-500">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="hidden min-h-screen">
        <div class="min-h-screen flex">
            <!-- Left Panel - Branding -->
            <div class="hidden lg:flex lg:w-1/2 gradient-primary items-center justify-center p-12">
                <div class="text-white max-w-lg text-center">
                    <div class="text-6xl mb-6">ğŸ“š</div>
                    <h1 class="text-4xl font-bold mb-4">Admin Guru Super App</h1>
                    <p class="text-xl text-purple-100 mb-8">Single Input - Multi Output</p>
                    <div class="space-y-4 text-left bg-white/10 rounded-2xl p-6">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ“…</span>
                            <span>Kalender & Jadwal Otomatis</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ“</span>
                            <span>ATP, Prota, Promes Sinkron</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ“–</span>
                            <span>Modul Ajar & LKPD Lengkap</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ“Š</span>
                            <span>Jurnal & Penilaian Terintegrasi</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel - Auth Form -->
            <div class="w-full lg:w-1/2 flex items-center justify-center p-8">
                <div class="w-full max-w-md">
                    <div class="lg:hidden text-center mb-8">
                        <div class="text-5xl mb-4">ğŸ“š</div>
                        <h1 class="text-2xl font-bold text-gray-800">Admin Guru Super App</h1>
                    </div>
                    
                    <!-- Login Form -->
                    <div id="loginForm" class="bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang!</h2>
                        <p class="text-gray-500 mb-6">Masuk ke akun Anda untuk melanjutkan</p>
                        
                        <div id="authError" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-4"></div>
                        
                        <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all mb-6">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            <span class="font-medium">Masuk dengan Google</span>
                        </button>
                        
                        <div class="text-center text-sm text-gray-500">
                            <p>Hanya akun Gmail yang dapat digunakan</p>
                            <p class="mt-2">Belum punya akun? <button onclick="showRegisterForm()" class="text-primary-500 hover:text-primary-600 font-medium">Daftar Sekarang</button></p>
                        </div>
                    </div>
                    
                    <!-- Register Form -->
                    <div id="registerForm" class="hidden bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Buat Akun Baru</h2>
                        <p class="text-gray-500 mb-6">Daftar untuk mulai menggunakan aplikasi</p>
                        
                        <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all mb-6">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            <span class="font-medium">Daftar dengan Google</span>
                        </button>
                        
                        <div class="text-center text-sm text-gray-500">
                            <p>Dengan mendaftar, Anda menyetujui syarat dan ketentuan</p>
                            <p class="mt-2">Sudah punya akun? <button onclick="showLoginForm()" class="text-primary-500 hover:text-primary-600 font-medium">Masuk</button></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Mobile Header -->
        <header class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-40 px-4 py-3">
            <div class="flex items-center justify-between">
                <button onclick="toggleMobileSidebar()" class="p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h1 class="font-bold text-gray-800">Admin Guru Super App</h1>
                <button onclick="showUserMenu()" class="p-2 hover:bg-gray-100 rounded-lg">
                    <img id="mobileUserAvatar" src="" alt="User" class="w-8 h-8 rounded-full">
                </button>
            </div>
        </header>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobileSidebarOverlay" class="hidden fixed inset-0 bg-black/50 z-40 lg:hidden" onclick="toggleMobileSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-white shadow-xl z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center text-white text-2xl">ğŸ“š</div>
                        <div>
                            <h1 class="font-bold text-gray-800">Admin Guru</h1>
                            <p class="text-xs text-gray-500">Super App v1.0</p>
                        </div>
                    </div>
                </div>

                <!-- User Info -->
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <img id="sidebarUserAvatar" src="" alt="User" class="w-10 h-10 rounded-full">
                        <div class="flex-1 min-w-0">
                            <p id="sidebarUserName" class="font-medium text-gray-800 truncate"></p>
                            <p id="sidebarUserEmail" class="text-xs text-gray-500 truncate"></p>
                        </div>
                        <span id="subscriptionBadge" class="px-2 py-1 text-xs font-medium rounded-full"></span>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                    <button onclick="navigateTo('dashboard')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="dashboard">
                        <span class="text-xl">ğŸ </span>
                        <span>Dashboard</span>
                    </button>
                    
                    <div class="pt-4 pb-2">
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Data Dasar</p>
                    </div>
                    <button onclick="navigateTo('profile')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="profile">
                        <span class="text-xl">ğŸ‘¤</span>
                        <span>Profil</span>
                    </button>
                    <button onclick="navigateTo('calendar')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="calendar">
                        <span class="text-xl">ğŸ“…</span>
                        <span>Kalender Pendidikan</span>
                    </button>
                    <button onclick="navigateTo('schedule')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="schedule">
                        <span class="text-xl">ğŸ•</span>
                        <span>Jadwal Pelajaran</span>
                    </button>
                    <button onclick="navigateTo('students')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="students">
                        <span class="text-xl">ğŸ‘¨â€ğŸ“</span>
                        <span>Data Siswa</span>
                    </button>
                    
                    <div class="pt-4 pb-2">
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Perangkat Ajar</p>
                    </div>
                    <button onclick="navigateTo('cp')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="cp">
                        <span class="text-xl">ğŸ¯</span>
                        <span>Capaian Pembelajaran</span>
                    </button>
                    <button onclick="navigateTo('atp')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="atp">
                        <span class="text-xl">ğŸ“‹</span>
                        <span>ATP</span>
                    </button>
                    <button onclick="navigateTo('prota')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="prota">
                        <span class="text-xl">ğŸ“†</span>
                        <span>Prota</span>
                    </button>
                    <button onclick="navigateTo('promes')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="promes">
                        <span class="text-xl">ğŸ“‘</span>
                        <span>Promes</span>
                    </button>
                    <button onclick="navigateTo('modul')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100 premium-feature" data-nav="modul">
                        <span class="text-xl">ğŸ“–</span>
                        <span>Modul Ajar</span>
                        <span class="ml-auto text-xs bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">Premium</span>
                    </button>
                    
                    <div class="pt-4 pb-2">
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Pembelajaran</p>
                    </div>
                    <button onclick="navigateTo('journal')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="journal">
                        <span class="text-xl">ğŸ““</span>
                        <span>Jurnal</span>
                    </button>
                    <button onclick="navigateTo('attendance')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="attendance">
                        <span class="text-xl">âœ…</span>
                        <span>Absensi</span>
                    </button>
                    <button onclick="navigateTo('grades')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="grades">
                        <span class="text-xl">ğŸ“Š</span>
                        <span>Daftar Nilai</span>
                    </button>
                    <button onclick="navigateTo('lkpd')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100 premium-feature" data-nav="lkpd">
                        <span class="text-xl">ğŸ“</span>
                        <span>LKPD</span>
                        <span class="ml-auto text-xs bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">Premium</span>
                    </button>
                    <button onclick="navigateTo('bank')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100 premium-feature" data-nav="bank">
                        <span class="text-xl">ğŸ¦</span>
                        <span>Bank Soal</span>
                        <span class="ml-auto text-xs bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">Premium</span>
                    </button>
                    
                    <div class="pt-4 pb-2">
                        <p class="px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Bantuan</p>
                    </div>
                    <button onclick="navigateTo('ai')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="ai">
                        <span class="text-xl">ğŸ¤–</span>
                        <span>AI Assistant</span>
                    </button>
                    <button onclick="navigateTo('guide')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="guide">
                        <span class="text-xl">ğŸ“š</span>
                        <span>Panduan</span>
                    </button>
                    
                    <!-- Admin Menu (for super admin only) -->
                    <div id="adminMenu" class="hidden">
                        <div class="pt-4 pb-2">
                            <p class="px-4 text-xs font-semibold text-red-400 uppercase tracking-wider">Admin</p>
                        </div>
                        <button onclick="navigateTo('admin')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-600 hover:bg-red-50" data-nav="admin">
                            <span class="text-xl">âš™ï¸</span>
                            <span>Panel Admin</span>
                        </button>
                    </div>
                </nav>

                <!-- Bottom Actions -->
                <div class="p-4 border-t border-gray-100 space-y-2">
                    <button id="upgradeBtn" onclick="showUpgradeModal()" class="w-full gradient-secondary text-white px-4 py-3 rounded-xl font-medium hover:opacity-90 transition-opacity">
                        â­ Upgrade Premium
                    </button>
                    <button onclick="signOut()" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-xl">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Keluar</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="lg:ml-72 min-h-screen pt-16 lg:pt-0">
            <div id="contentArea" class="p-4 lg:p-8">
                <!-- Content will be loaded here -->
            </div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modalsContainer"></div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Firebase & App Scripts -->
    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
            authDomain: "agsa-e5b08.firebaseapp.com",
            projectId: "agsa-e5b08",
            storageBucket: "agsa-e5b08.firebasestorage.app",
            messagingSenderId: "916052746331",
            appId: "1:916052746331:web:357cbadbfd8658f1689f7e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let userProfile = null;
        let currentPage = 'dashboard';
        const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';
        let APP_CONFIG = {
            whatsappNumber: '6281234567890',
            schoolPackagePrice: 500000,
            individualPrice: 100000
        };

        // ==================== ACADEMIC YEAR HELPER ====================
        function getAcademicYears() {
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-11
            const currentYear = now.getFullYear();
            
            let years = [];
            
            if (currentMonth >= 5) { // June onwards (month 5 = June)
                years = [
                    `${currentYear}/${currentYear + 1}`,
                    `${currentYear + 1}/${currentYear + 2}`
                ];
            } else {
                years = [
                    `${currentYear - 1}/${currentYear}`,
                    `${currentYear}/${currentYear + 1}`
                ];
            }
            
            return years;
        }

        function getCurrentAcademicYear() {
            const years = getAcademicYears();
            return years[0];
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-amber-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg animate-fade-in flex items-center gap-2`;
            toast.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-70">Ã—</button>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function showModal(content, options = {}) {
            const container = document.getElementById('modalsContainer');
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-overlay animate-fade-in';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-${options.size || 'lg'} w-full mx-4 max-h-[90vh] overflow-y-auto">
                    ${options.title ? `
                        <div class="flex items-center justify-between p-6 border-b border-gray-100">
                            <h3 class="text-xl font-bold text-gray-800">${options.title}</h3>
                            <button onclick="closeModal(this)" class="p-2 hover:bg-gray-100 rounded-lg">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    ` : ''}
                    <div class="p-6">${content}</div>
                </div>
            `;
            
            if (!options.persistent) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }
            
            container.appendChild(modal);
            return modal;
        }

        function closeModal(btn) {
            btn.closest('.fixed').remove();
        }

        function formatDate(date, format = 'long') {
            const d = new Date(date);
            const options = format === 'long' 
                ? { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
                : { year: 'numeric', month: '2-digit', day: '2-digit' };
            return d.toLocaleDateString('id-ID', options);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // ==================== AUTHENTICATION ====================
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            
            try {
                const result = await auth.signInWithPopup(provider);
                const email = result.user.email;
                
                // Check if email is Gmail
                if (!email.endsWith('@gmail.com')) {
                    await auth.signOut();
                    document.getElementById('authError').textContent = 'Hanya akun Gmail yang dapat digunakan!';
                    document.getElementById('authError').classList.remove('hidden');
                    return;
                }
                
                showToast('Berhasil masuk!', 'success');
            } catch (error) {
                console.error('Auth error:', error);
                document.getElementById('authError').textContent = error.message;
                document.getElementById('authError').classList.remove('hidden');
            }
        }

        async function signOut() {
            try {
                await auth.signOut();
                showToast('Berhasil keluar', 'info');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // ==================== USER PROFILE MANAGEMENT ====================
        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                
                if (doc.exists) {
                    userProfile = doc.data();
                } else {
                    // Create new user profile
                    userProfile = {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName || '',
                        photoURL: currentUser.photoURL || '',
                        subscription: 'free',
                        subscriptionExpiry: null,
                        subjects: [],
                        school: {
                            name: '',
                            npsn: '',
                            level: 'SD',
                            location: '',
                            principalName: ''
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('users').doc(currentUser.uid).set(userProfile);
                }
                
                updateUIWithUserData();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function updateUIWithUserData() {
            // Update sidebar user info
            const avatar = currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.displayName || currentUser.email);
            
            document.getElementById('sidebarUserAvatar').src = avatar;
            document.getElementById('mobileUserAvatar').src = avatar;
            document.getElementById('sidebarUserName').textContent = userProfile?.name || currentUser.displayName || 'User';
            document.getElementById('sidebarUserEmail').textContent = currentUser.email;
            
            // Update subscription badge
            const badge = document.getElementById('subscriptionBadge');
            if (userProfile?.subscription === 'premium') {
                badge.textContent = 'Premium';
                badge.className = 'px-2 py-1 text-xs font-medium rounded-full bg-amber-100 text-amber-600';
                document.getElementById('upgradeBtn').classList.add('hidden');
            } else {
                badge.textContent = 'Free';
                badge.className = 'px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600';
                document.getElementById('upgradeBtn').classList.remove('hidden');
            }
            
            // Show admin menu for super admin
            if (currentUser.email === SUPER_ADMIN_EMAIL) {
                document.getElementById('adminMenu').classList.remove('hidden');
            }
        }

        function isPremiumUser() {
            return userProfile?.subscription === 'premium' || currentUser?.email === SUPER_ADMIN_EMAIL;
        }

        // ==================== NAVIGATION ====================
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileSidebarOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function navigateTo(page) {
            // Check premium features
            const premiumPages = ['modul', 'lkpd', 'bank'];
            if (premiumPages.includes(page) && !isPremiumUser()) {
                showUpgradeModal();
                return;
            }
            
            currentPage = page;
            
            // Update active nav
            document.querySelectorAll('[data-nav]').forEach(btn => {
                if (btn.dataset.nav === page) {
                    btn.classList.add('bg-primary-50', 'text-primary-600');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    btn.classList.remove('bg-primary-50', 'text-primary-600');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });
            
            // Close mobile sidebar
            if (window.innerWidth < 1024) {
                toggleMobileSidebar();
            }
            
            // Load page content
            loadPageContent(page);
        }

        function loadPageContent(page) {
            const content = document.getElementById('contentArea');
            
            switch (page) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'profile':
                    renderProfile();
                    break;
                case 'calendar':
                    renderCalendar();
                    break;
                case 'schedule':
                    renderSchedule();
                    break;
                case 'students':
                    renderStudents();
                    break;
                case 'cp':
                    renderCP();
                    break;
                case 'atp':
                    renderATP();
                    break;
                case 'prota':
                    renderProta();
                    break;
                case 'promes':
                    renderPromes();
                    break;
                case 'modul':
                    renderModul();
                    break;
                case 'journal':
                    renderJournal();
                    break;
                case 'attendance':
                    renderAttendance();
                    break;
                case 'grades':
                    renderGrades();
                    break;
                case 'lkpd':
                    renderLKPD();
                    break;
                case 'bank':
                    renderBankSoal();
                    break;
                case 'ai':
                    renderAIAssistant();
                    break;
                case 'guide':
                    renderGuide();
                    break;
                case 'admin':
                    renderAdmin();
                    break;
                default:
                    content.innerHTML = '<p>Halaman tidak ditemukan</p>';
            }
        }

        // ==================== UPGRADE MODAL ====================
        function showUpgradeModal() {
            const content = `
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">â­</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Upgrade ke Premium</h3>
                    <p class="text-gray-600">Dapatkan akses penuh ke semua fitur aplikasi</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="border-2 border-gray-200 rounded-xl p-6">
                        <h4 class="font-bold text-gray-800 mb-2">Paket Perorangan</h4>
                        <p class="text-3xl font-bold text-primary-600 mb-4">${formatCurrency(APP_CONFIG.individualPrice)}<span class="text-sm text-gray-500">/tahun</span></p>
                        <ul class="text-sm text-gray-600 space-y-2">
                            <li class="flex items-center gap-2">âœ… Semua fitur Premium</li>
                            <li class="flex items-center gap-2">âœ… Modul Ajar lengkap</li>
                            <li class="flex items-center gap-2">âœ… Bank Soal</li>
                            <li class="flex items-center gap-2">âœ… LKPD Generator</li>
                        </ul>
                    </div>
                    <div class="border-2 border-primary-500 rounded-xl p-6 bg-primary-50">
                        <div class="text-xs font-medium text-primary-600 mb-2">HEMAT!</div>
                        <h4 class="font-bold text-gray-800 mb-2">Paket Sekolah</h4>
                        <p class="text-3xl font-bold text-primary-600 mb-4">${formatCurrency(APP_CONFIG.schoolPackagePrice)}<span class="text-sm text-gray-500">/tahun</span></p>
                        <ul class="text-sm text-gray-600 space-y-2">
                            <li class="flex items-center gap-2">âœ… Unlimited guru</li>
                            <li class="flex items-center gap-2">âœ… Semua fitur Premium</li>
                            <li class="flex items-center gap-2">âœ… Support prioritas</li>
                            <li class="flex items-center gap-2">âœ… Training online</li>
                        </ul>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <p class="text-sm text-gray-600 text-center">Untuk upgrade, silakan hubungi admin melalui WhatsApp:</p>
                </div>
                
                <a href="https://wa.me/${APP_CONFIG.whatsappNumber}?text=Halo, saya ingin upgrade ke Premium Admin Guru Super App. Email: ${currentUser?.email}" target="_blank" class="block w-full bg-green-500 text-white text-center px-6 py-3 rounded-xl font-medium hover:bg-green-600 transition-colors">
                    ğŸ“± Hubungi via WhatsApp
                </a>
            `;
            
            showModal(content, { title: 'Upgrade Premium', size: 'xl' });
        }

        // ==================== AUTH STATE OBSERVER ====================
        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loadingScreen').classList.add('hidden');
            
            if (user) {
                currentUser = user;
                await loadUserProfile();
                
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                navigateTo('dashboard');
            } else {
                currentUser = null;
                userProfile = null;
                
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });
    </script>

    <!-- Dashboard Page -->
    <script>
        function renderDashboard() {
            const content = document.getElementById('contentArea');
            const years = getAcademicYears();
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Selamat Datang, ${userProfile?.name || 'Guru'}! ğŸ‘‹</h1>
                            <p class="text-gray-500">Tahun Ajaran: 
                                <select id="academicYearSelect" onchange="changeAcademicYear(this.value)" class="border-0 bg-transparent font-medium text-primary-600 focus:ring-0">
                                    ${years.map(y => `<option value="${y}" ${y === getCurrentAcademicYear() ? 'selected' : ''}>${y}</option>`).join('')}
                                </select>
                            </p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="quickAddData()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>â•</span> Input Data
                            </button>
                            <button onclick="generateAll()" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                                <span>âš¡</span> Generate Semua
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white rounded-2xl p-6 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center text-2xl">ğŸ“…</div>
                                <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded-full">Aktif</span>
                            </div>
                            <p class="text-2xl font-bold text-gray-800" id="dashWeeksLeft">--</p>
                            <p class="text-sm text-gray-500">Minggu Efektif</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 gradient-success rounded-xl flex items-center justify-center text-2xl">ğŸ‘¨â€ğŸ“</div>
                            </div>
                            <p class="text-2xl font-bold text-gray-800" id="dashStudentCount">--</p>
                            <p class="text-sm text-gray-500">Total Siswa</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 gradient-warning rounded-xl flex items-center justify-center text-2xl">ğŸ“</div>
                            </div>
                            <p class="text-2xl font-bold text-gray-800" id="dashClassCount">--</p>
                            <p class="text-sm text-gray-500">Kelas Diampu</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6 card-hover">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 gradient-secondary rounded-xl flex items-center justify-center text-2xl">ğŸ“–</div>
                            </div>
                            <p class="text-2xl font-bold text-gray-800" id="dashModulCount">--</p>
                            <p class="text-sm text-gray-500">Modul Ajar</p>
                        </div>
                    </div>
                    
                    <!-- Main Content Grid -->
                    <div class="grid lg:grid-cols-3 gap-6">
                        <!-- Left Column - Document Status -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Document Progress -->
                            <div class="bg-white rounded-2xl p-6">
                                <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“‹ Status Dokumen</h2>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">ğŸ“…</span>
                                            <div>
                                                <p class="font-medium text-gray-800">Kalender Pendidikan</p>
                                                <p class="text-sm text-gray-500">Data dasar semester</p>
                                            </div>
                                        </div>
                                        <span id="statusCalendar" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-600">Belum diisi</span>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">ğŸ•</span>
                                            <div>
                                                <p class="font-medium text-gray-800">Jadwal Pelajaran</p>
                                                <p class="text-sm text-gray-500">Jadwal mengajar mingguan</p>
                                            </div>
                                        </div>
                                        <span id="statusSchedule" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-600">Belum diisi</span>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">ğŸ¯</span>
                                            <div>
                                                <p class="font-medium text-gray-800">Capaian Pembelajaran</p>
                                                <p class="text-sm text-gray-500">CP/TP Mapel</p>
                                            </div>
                                        </div>
                                        <span id="statusCP" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-600">Belum diisi</span>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">ğŸ“‹</span>
                                            <div>
                                                <p class="font-medium text-gray-800">ATP</p>
                                                <p class="text-sm text-gray-500">Alur Tujuan Pembelajaran</p>
                                            </div>
                                        </div>
                                        <span id="statusATP" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-600">Belum dibuat</span>
                                    </div>
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">ğŸ“†</span>
                                            <div>
                                                <p class="font-medium text-gray-800">Prota & Promes</p>
                                                <p class="text-sm text-gray-500">Program tahunan & semester</p>
                                            </div>
                                        </div>
                                        <span id="statusProta" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-100 text-gray-600">Belum dibuat</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Activity -->
                            <div class="bg-white rounded-2xl p-6">
                                <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ• Aktivitas Terbaru</h2>
                                <div id="recentActivity" class="space-y-3">
                                    <p class="text-gray-500 text-center py-8">Belum ada aktivitas</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="space-y-6">
                            <!-- Today's Schedule -->
                            <div class="bg-white rounded-2xl p-6">
                                <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“š Jadwal Hari Ini</h2>
                                <div id="todaySchedule" class="space-y-3">
                                    <p class="text-gray-500 text-center py-4">Belum ada jadwal</p>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="bg-white rounded-2xl p-6">
                                <h2 class="text-lg font-bold text-gray-800 mb-4">âš¡ Aksi Cepat</h2>
                                <div class="space-y-2">
                                    <button onclick="navigateTo('attendance')" class="w-full flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-left">
                                        <span class="text-xl">âœ…</span>
                                        <span class="font-medium text-gray-700">Input Absensi</span>
                                    </button>
                                    <button onclick="navigateTo('journal')" class="w-full flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-left">
                                        <span class="text-xl">ğŸ““</span>
                                        <span class="font-medium text-gray-700">Isi Jurnal</span>
                                    </button>
                                    <button onclick="navigateTo('grades')" class="w-full flex items-center gap-3 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-left">
                                        <span class="text-xl">ğŸ“Š</span>
                                        <span class="font-medium text-gray-700">Input Nilai</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tips -->
                            <div class="bg-gradient-to-br from-primary-500 to-purple-600 rounded-2xl p-6 text-white">
                                <h2 class="text-lg font-bold mb-2">ğŸ’¡ Tips</h2>
                                <p class="text-sm text-purple-100 mb-4">Lengkapi data Kalender dan Jadwal terlebih dahulu untuk mengaktifkan fitur auto-generate dokumen.</p>
                                <button onclick="navigateTo('guide')" class="w-full bg-white/20 hover:bg-white/30 transition-colors rounded-xl py-2 text-sm font-medium">
                                    Baca Panduan â†’
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            loadDashboardData();
        }

        async function loadDashboardData() {
            if (!currentUser) return;
            
            try {
                // Load student count
                const studentsSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('students').get();
                document.getElementById('dashStudentCount').textContent = studentsSnap.size;
                
                // Load class count from schedule
                const scheduleSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').get();
                const classes = new Set();
                scheduleSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.class) classes.add(data.class);
                });
                document.getElementById('dashClassCount').textContent = classes.size;
                
                // Load modul count
                const modulSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('modules').get();
                document.getElementById('dashModulCount').textContent = modulSnap.size;
                
                // Check document status
                const calendarDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('calendar').get();
                if (calendarDoc.exists) {
                    document.getElementById('statusCalendar').textContent = 'Lengkap';
                    document.getElementById('statusCalendar').className = 'px-3 py-1 text-sm font-medium rounded-full bg-green-100 text-green-600';
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function quickAddData() {
            const content = `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button onclick="closeModal(this.closest('.fixed')); navigateTo('calendar')" class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-center">
                        <span class="text-3xl block mb-2">ğŸ“…</span>
                        <span class="font-medium text-gray-700">Kalender</span>
                    </button>
                    <button onclick="closeModal(this.closest('.fixed')); navigateTo('schedule')" class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-center">
                        <span class="text-3xl block mb-2">ğŸ•</span>
                        <span class="font-medium text-gray-700">Jadwal</span>
                    </button>
                    <button onclick="closeModal(this.closest('.fixed')); navigateTo('students')" class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-center">
                        <span class="text-3xl block mb-2">ğŸ‘¨â€ğŸ“</span>
                        <span class="font-medium text-gray-700">Siswa</span>
                    </button>
                    <button onclick="closeModal(this.closest('.fixed')); navigateTo('cp')" class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-center">
                        <span class="text-3xl block mb-2">ğŸ¯</span>
                        <span class="font-medium text-gray-700">CP/TP</span>
                    </button>
                    <button onclick="closeModal(this.closest('.fixed')); navigateTo('attendance')" class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-center">
                        <span class="text-3xl block mb-2">âœ…</span>
                        <span class="font-medium text-gray-700">Absensi</span>
                    </button>
                    <button onclick="closeModal(this.closest('.fixed')); navigateTo('grades')" class="p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-center">
                        <span class="text-3xl block mb-2">ğŸ“Š</span>
                        <span class="font-medium text-gray-700">Nilai</span>
                    </button>
                </div>
            `;
            
            showModal(content, { title: 'Input Data', size: 'xl' });
        }

        async function generateAll() {
            showToast('Memproses generate dokumen...', 'info');
            
            // This would trigger the generation of ATP, Prota, Promes based on input data
            // Implementation depends on having complete input data
            
            setTimeout(() => {
                showToast('Silakan lengkapi data Kalender, Jadwal, dan CP terlebih dahulu', 'warning');
            }, 1000);
        }

        function changeAcademicYear(year) {
            // Store selected year and reload data
            localStorage.setItem('academicYear', year);
            loadDashboardData();
        }
    </script>

    <!-- Profile Page -->
    <script>
        function renderProfile() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Profil Saya</h1>
                            <p class="text-gray-500">Kelola data pribadi dan satuan pendidikan</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Personal Info -->
                        <div class="bg-white rounded-2xl p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                                <span>ğŸ‘¤</span> Data Pribadi
                            </h2>
                            
                            <form id="profileForm" class="space-y-4">
                                <div class="flex items-center gap-6 mb-6">
                                    <img src="${currentUser?.photoURL || ''}" alt="Profile" class="w-20 h-20 rounded-full">
                                    <div>
                                        <p class="font-medium text-gray-800">${currentUser?.email}</p>
                                        <p class="text-sm text-gray-500">Akun Google</p>
                                    </div>
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                        <input type="text" id="profileName" value="${userProfile?.name || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">NIP/NIK</label>
                                        <input type="text" id="profileNIP" value="${userProfile?.nip || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">No. HP/WhatsApp</label>
                                    <input type="tel" id="profilePhone" value="${userProfile?.phone || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                </div>
                            </form>
                        </div>
                        
                        <!-- School Info -->
                        <div class="bg-white rounded-2xl p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-6 flex items-center gap-2">
                                <span>ğŸ«</span> Satuan Pendidikan
                            </h2>
                            
                            <div class="space-y-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Sekolah</label>
                                        <input type="text" id="schoolName" value="${userProfile?.school?.name || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">NPSN</label>
                                        <input type="text" id="schoolNPSN" value="${userProfile?.school?.npsn || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    </div>
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang</label>
                                        <select id="schoolLevel" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                            <option value="SD" ${userProfile?.school?.level === 'SD' ? 'selected' : ''}>SD/MI</option>
                                            <option value="SMP" ${userProfile?.school?.level === 'SMP' ? 'selected' : ''}>SMP/MTs</option>
                                            <option value="SMA" ${userProfile?.school?.level === 'SMA' ? 'selected' : ''}>SMA/MA/SMK</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi (Kota/Kabupaten)</label>
                                        <input type="text" id="schoolLocation" value="${userProfile?.school?.location || ''}" placeholder="Contoh: Jakarta Selatan" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Sekolah</label>
                                    <input type="text" id="principalName" value="${userProfile?.school?.principalName || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Teaching Subjects -->
                        <div class="bg-white rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    <span>ğŸ“š</span> Mata Pelajaran yang Diampu
                                </h2>
                                <button onclick="addSubject()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 transition-colors">
                                    + Tambah Mapel
                                </button>
                            </div>
                            
                            <div id="subjectsList" class="space-y-4">
                                ${renderSubjectsList()}
                            </div>
                        </div>
                        
                        <!-- Save Button -->
                        <div class="flex justify-end">
                            <button onclick="saveProfile()" class="px-8 py-3 gradient-primary text-white rounded-xl font-medium hover:opacity-90 transition-opacity">
                                ğŸ’¾ Simpan Profil
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSubjectsList() {
            const subjects = userProfile?.subjects || [];
            
            if (subjects.length === 0) {
                return `
                    <div class="text-center py-8 text-gray-500">
                        <p>Belum ada mata pelajaran. Klik "Tambah Mapel" untuk menambahkan.</p>
                    </div>
                `;
            }
            
            return subjects.map((subject, index) => `
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                    <div class="flex-1 grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Nama Mapel</label>
                            <input type="text" value="${subject.name}" onchange="updateSubject(${index}, 'name', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">JP/Pertemuan</label>
                            <input type="number" value="${subject.hoursPerMeeting || 2}" min="1" max="4" onchange="updateSubject(${index}, 'hoursPerMeeting', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Pertemuan/Minggu</label>
                            <input type="number" value="${subject.meetingsPerWeek || 1}" min="1" max="5" onchange="updateSubject(${index}, 'meetingsPerWeek', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm">
                        </div>
                    </div>
                    <button onclick="removeSubject(${index})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function addSubject() {
            if (!userProfile.subjects) userProfile.subjects = [];
            
            userProfile.subjects.push({
                name: 'Mata Pelajaran Baru',
                hoursPerMeeting: 2,
                meetingsPerWeek: 1
            });
            
            document.getElementById('subjectsList').innerHTML = renderSubjectsList();
        }

        function updateSubject(index, field, value) {
            if (userProfile.subjects && userProfile.subjects[index]) {
                userProfile.subjects[index][field] = field === 'name' ? value : parseInt(value);
            }
        }

        function removeSubject(index) {
            if (userProfile.subjects) {
                userProfile.subjects.splice(index, 1);
                document.getElementById('subjectsList').innerHTML = renderSubjectsList();
            }
        }

        async function saveProfile() {
            try {
                const data = {
                    name: document.getElementById('profileName').value,
                    nip: document.getElementById('profileNIP').value,
                    phone: document.getElementById('profilePhone').value,
                    school: {
                        name: document.getElementById('schoolName').value,
                        npsn: document.getElementById('schoolNPSN').value,
                        level: document.getElementById('schoolLevel').value,
                        location: document.getElementById('schoolLocation').value,
                        principalName: document.getElementById('principalName').value
                    },
                    subjects: userProfile.subjects || [],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).update(data);
                
                userProfile = { ...userProfile, ...data };
                updateUIWithUserData();
                
                showToast('Profil berhasil disimpan!', 'success');
            } catch (error) {
                console.error('Error saving profile:', error);
                showToast('Gagal menyimpan profil', 'error');
            }
        }
    </script>

    <!-- Calendar Page -->
    <script>
        let calendarData = {
            academicYear: getCurrentAcademicYear(),
            semester1: { start: '', end: '' },
            semester2: { start: '', end: '' },
            holidays: []
        };

        const defaultHolidays = [
            { name: 'Tahun Baru', date: '01-01', fixed: true },
            { name: 'Hari Kemerdekaan RI', date: '08-17', fixed: true },
            { name: 'Hari Natal', date: '12-25', fixed: true },
        ];

        function renderCalendar() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ“… Kalender Pendidikan</h1>
                            <p class="text-gray-500">Atur periode semester dan hari libur</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="importCalendarCSV()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors flex items-center gap-2">
                                <span>ğŸ“¥</span> Import CSV
                            </button>
                            <button onclick="saveCalendar()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>ğŸ’¾</span> Simpan
                            </button>
                        </div>
                    </div>
                    
                    <!-- Academic Year Selection -->
                    <div class="bg-white rounded-2xl p-6 mb-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Tahun Ajaran</h2>
                        <select id="calendarYear" onchange="loadCalendarForYear(this.value)" class="w-full md:w-auto px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                            ${getAcademicYears().map(y => `<option value="${y}" ${y === calendarData.academicYear ? 'selected' : ''}>${y}</option>`).join('')}
                        </select>
                    </div>
                    
                    <!-- Semester Settings -->
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-2xl p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center text-sm font-bold">1</span>
                                Semester 1 (Ganjil)
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                                    <input type="date" id="sem1Start" value="${calendarData.semester1.start}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai</label>
                                    <input type="date" id="sem1End" value="${calendarData.semester1.end}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div class="pt-2 border-t border-gray-100">
                                    <p class="text-sm text-gray-500">Minggu Efektif: <span id="sem1Weeks" class="font-bold text-primary-600">--</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                <span class="w-8 h-8 bg-green-100 text-green-600 rounded-lg flex items-center justify-center text-sm font-bold">2</span>
                                Semester 2 (Genap)
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                                    <input type="date" id="sem2Start" value="${calendarData.semester2.start}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai</label>
                                    <input type="date" id="sem2End" value="${calendarData.semester2.end}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div class="pt-2 border-t border-gray-100">
                                    <p class="text-sm text-gray-500">Minggu Efektif: <span id="sem2Weeks" class="font-bold text-primary-600">--</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Holidays -->
                    <div class="bg-white rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-gray-800">ğŸ‰ Hari Libur</h2>
                            <button onclick="addHoliday()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 transition-colors">
                                + Tambah Libur
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-gray-500">Hari libur nasional baku sudah termasuk otomatis. Anda dapat menambahkan libur khusus sekolah.</p>
                        </div>
                        
                        <div id="holidaysList" class="space-y-3">
                            ${renderHolidaysList()}
                        </div>
                    </div>
                </div>
            `;
            
            loadCalendarData();
            
            // Add event listeners for calculating weeks
            document.getElementById('sem1Start').addEventListener('change', calculateWeeks);
            document.getElementById('sem1End').addEventListener('change', calculateWeeks);
            document.getElementById('sem2Start').addEventListener('change', calculateWeeks);
            document.getElementById('sem2End').addEventListener('change', calculateWeeks);
        }

        function renderHolidaysList() {
            const allHolidays = [...defaultHolidays, ...(calendarData.holidays || [])];
            
            return allHolidays.map((holiday, index) => `
                <div class="flex items-center gap-4 p-4 ${holiday.fixed ? 'bg-gray-100' : 'bg-gray-50'} rounded-xl">
                    <div class="flex-1 grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Nama Libur</label>
                            <input type="text" value="${holiday.name}" ${holiday.fixed ? 'readonly' : `onchange="updateHoliday(${index - defaultHolidays.length}, 'name', this.value)"`} class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm ${holiday.fixed ? 'bg-gray-100' : ''}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Tanggal</label>
                            <input type="date" value="${formatHolidayDate(holiday.date)}" ${holiday.fixed ? 'readonly' : `onchange="updateHoliday(${index - defaultHolidays.length}, 'date', this.value)"`} class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm ${holiday.fixed ? 'bg-gray-100' : ''}">
                        </div>
                    </div>
                    ${holiday.fixed ? `
                        <span class="text-xs text-gray-500 bg-gray-200 px-2 py-1 rounded">Baku</span>
                    ` : `
                        <button onclick="removeHoliday(${index - defaultHolidays.length})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    `}
                </div>
            `).join('');
        }

        function formatHolidayDate(date) {
            if (date.includes('-') && date.length <= 5) {
                const year = new Date().getFullYear();
                return `${year}-${date}`;
            }
            return date;
        }

        function addHoliday() {
            if (!calendarData.holidays) calendarData.holidays = [];
            
            calendarData.holidays.push({
                name: 'Libur Baru',
                date: new Date().toISOString().split('T')[0],
                fixed: false
            });
            
            document.getElementById('holidaysList').innerHTML = renderHolidaysList();
        }

        function updateHoliday(index, field, value) {
            if (calendarData.holidays && calendarData.holidays[index]) {
                calendarData.holidays[index][field] = value;
            }
        }

        function removeHoliday(index) {
            if (calendarData.holidays) {
                calendarData.holidays.splice(index, 1);
                document.getElementById('holidaysList').innerHTML = renderHolidaysList();
            }
        }

        function calculateWeeks() {
            const sem1Start = new Date(document.getElementById('sem1Start').value);
            const sem1End = new Date(document.getElementById('sem1End').value);
            const sem2Start = new Date(document.getElementById('sem2Start').value);
            const sem2End = new Date(document.getElementById('sem2End').value);
            
            if (sem1Start && sem1End && !isNaN(sem1Start) && !isNaN(sem1End)) {
                const weeks1 = Math.floor((sem1End - sem1Start) / (7 * 24 * 60 * 60 * 1000));
                document.getElementById('sem1Weeks').textContent = weeks1 + ' minggu';
            }
            
            if (sem2Start && sem2End && !isNaN(sem2Start) && !isNaN(sem2End)) {
                const weeks2 = Math.floor((sem2End - sem2Start) / (7 * 24 * 60 * 60 * 1000));
                document.getElementById('sem2Weeks').textContent = weeks2 + ' minggu';
            }
        }

        async function loadCalendarData() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('calendar').get();
                
                if (doc.exists) {
                    calendarData = doc.data();
                    
                    document.getElementById('sem1Start').value = calendarData.semester1?.start || '';
                    document.getElementById('sem1End').value = calendarData.semester1?.end || '';
                    document.getElementById('sem2Start').value = calendarData.semester2?.start || '';
                    document.getElementById('sem2End').value = calendarData.semester2?.end || '';
                    
                    calculateWeeks();
                    document.getElementById('holidaysList').innerHTML = renderHolidaysList();
                }
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        async function saveCalendar() {
            try {
                calendarData = {
                    academicYear: document.getElementById('calendarYear').value,
                    semester1: {
                        start: document.getElementById('sem1Start').value,
                        end: document.getElementById('sem1End').value
                    },
                    semester2: {
                        start: document.getElementById('sem2Start').value,
                        end: document.getElementById('sem2End').value
                    },
                    holidays: calendarData.holidays || [],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('calendar').set(calendarData);
                
                showToast('Kalender berhasil disimpan!', 'success');
            } catch (error) {
                console.error('Error saving calendar:', error);
                showToast('Gagal menyimpan kalender', 'error');
            }
        }

        function importCalendarCSV() {
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-600">Import data kalender dari Google Spreadsheet (format CSV).</p>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL Google Spreadsheet (Published)</label>
                        <input type="url" id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/..." class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <h4 class="font-medium text-blue-800 mb-2">Format CSV:</h4>
                        <code class="text-sm text-blue-600">nama,tanggal</code>
                        <p class="text-xs text-blue-600 mt-1">Contoh: Libur Semester,2025-01-01</p>
                    </div>
                    
                    <button onclick="processCalendarCSV()" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                        Import Data
                    </button>
                </div>
            `;
            
            showModal(content, { title: 'ğŸ“¥ Import Kalender dari CSV', size: 'lg' });
        }
    </script>

    <!-- Schedule Page -->
    <script>
        let scheduleData = [];
        const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        let lessonHours = [
            { start: '07:00', end: '07:35', duration: 35 },
            { start: '07:35', end: '08:10', duration: 35 },
            { start: '08:10', end: '08:45', duration: 35 },
            { start: '08:45', end: '09:20', duration: 35 },
            { start: '09:20', end: '09:35', duration: 15, isBreak: true, label: 'Istirahat' },
            { start: '09:35', end: '10:10', duration: 35 },
            { start: '10:10', end: '10:45', duration: 35 },
            { start: '10:45', end: '11:20', duration: 35 },
            { start: '11:20', end: '11:55', duration: 35 },
        ];

        function renderSchedule() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ• Jadwal Pelajaran</h1>
                            <p class="text-gray-500">Atur jadwal mengajar mingguan</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="showHourSettings()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors flex items-center gap-2">
                                <span>âš™ï¸</span> Atur Jam
                            </button>
                            <button onclick="addScheduleEntry()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>â•</span> Tambah Jadwal
                            </button>
                        </div>
                    </div>
                    
                    <!-- Schedule Grid -->
                    <div class="bg-white rounded-2xl overflow-hidden shadow-lg">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b">Jam</th>
                                        ${days.map(day => `<th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 border-b min-w-[140px]">${day}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody id="scheduleBody">
                                    ${renderScheduleRows()}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Schedule List View for Mobile -->
                    <div class="mt-6 lg:hidden">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Daftar Jadwal</h2>
                        <div id="scheduleListMobile" class="space-y-3">
                            ${renderScheduleList()}
                        </div>
                    </div>
                    
                    <!-- Validation Info -->
                    <div class="mt-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
                        <h3 class="font-medium text-amber-800 mb-2">âš ï¸ Validasi Jadwal</h3>
                        <ul class="text-sm text-amber-700 space-y-1">
                            <li>â€¢ Guru tidak dapat mengajar di dua kelas berbeda pada jam yang sama</li>
                            <li>â€¢ Satu rombel tidak dapat memiliki lebih dari satu guru pada mata pelajaran yang sama di jam yang sama</li>
                            <li>â€¢ Sistem akan memberikan peringatan jika ada konflik jadwal</li>
                        </ul>
                    </div>
                </div>
            `;
            
            loadScheduleData();
        }

        function renderScheduleRows() {
            return lessonHours.map((hour, index) => {
                if (hour.isBreak) {
                    return `
                        <tr class="bg-gray-100">
                            <td colspan="${days.length + 1}" class="px-4 py-2 text-center text-sm text-gray-500 font-medium">
                                ${hour.label} (${hour.start} - ${hour.end})
                            </td>
                        </tr>
                    `;
                }
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-700">
                            <div>Jam ${index + 1}</div>
                            <div class="text-xs text-gray-400">${hour.start} - ${hour.end}</div>
                        </td>
                        ${days.map(day => `
                            <td class="px-2 py-2 schedule-cell" data-day="${day}" data-hour="${index}">
                                ${getScheduleCell(day, index)}
                            </td>
                        `).join('')}
                    </tr>
                `;
            }).join('');
        }

        function getScheduleCell(day, hourIndex) {
            const entry = scheduleData.find(s => s.day === day && s.hourIndex === hourIndex);
            
            if (entry) {
                return `
                    <div class="bg-primary-100 border border-primary-200 rounded-lg p-2 text-xs cursor-pointer hover:bg-primary-200 transition-colors" onclick="editScheduleEntry('${entry.id}')">
                        <div class="font-medium text-primary-800">${entry.subject}</div>
                        <div class="text-primary-600">${entry.class}</div>
                    </div>
                `;
            }
            
            return `
                <button onclick="addScheduleAtSlot('${day}', ${hourIndex})" class="w-full h-full min-h-[50px] border-2 border-dashed border-gray-200 rounded-lg hover:border-primary-300 hover:bg-primary-50 transition-colors flex items-center justify-center text-gray-400 hover:text-primary-500">
                    <span class="text-lg">+</span>
                </button>
            `;
        }

        function renderScheduleList() {
            if (scheduleData.length === 0) {
                return '<p class="text-gray-500 text-center py-8">Belum ada jadwal. Klik "Tambah Jadwal" untuk menambahkan.</p>';
            }
            
            return scheduleData.map(entry => `
                <div class="bg-white rounded-xl p-4 flex items-center justify-between">
                    <div>
                        <p class="font-medium text-gray-800">${entry.subject}</p>
                        <p class="text-sm text-gray-500">${entry.day}, ${lessonHours[entry.hourIndex]?.start || ''} - ${entry.class}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editScheduleEntry('${entry.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button onclick="deleteScheduleEntry('${entry.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function addScheduleEntry() {
            addScheduleAtSlot(days[0], 0);
        }

        function addScheduleAtSlot(day, hourIndex) {
            const subjects = userProfile?.subjects || [{ name: 'PAI dan Budi Pekerti' }];
            
            const content = `
                <form id="scheduleForm" class="space-y-4">
                    <input type="hidden" id="scheduleId" value="">
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hari</label>
                            <select id="scheduleDay" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                ${days.map(d => `<option value="${d}" ${d === day ? 'selected' : ''}>${d}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jam Ke</label>
                            <select id="scheduleHour" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                ${lessonHours.filter(h => !h.isBreak).map((h, i) => `<option value="${i}" ${i === hourIndex ? 'selected' : ''}>Jam ${i + 1} (${h.start})</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                        <select id="scheduleSubject" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas / Rombel</label>
                        <input type="text" id="scheduleClass" placeholder="Contoh: 4A" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div id="scheduleConflict" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg"></div>
                    
                    <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                        Simpan Jadwal
                    </button>
                </form>
            `;
            
            showModal(content, { title: 'ğŸ“… Tambah Jadwal', size: 'lg' });
            
            document.getElementById('scheduleForm').addEventListener('submit', saveScheduleEntry);
        }

        async function saveScheduleEntry(e) {
            e.preventDefault();
            
            const id = document.getElementById('scheduleId').value || db.collection('temp').doc().id;
            const day = document.getElementById('scheduleDay').value;
            const hourIndex = parseInt(document.getElementById('scheduleHour').value);
            const subject = document.getElementById('scheduleSubject').value;
            const classRoom = document.getElementById('scheduleClass').value;
            
            // Validate conflicts
            const conflict = scheduleData.find(s => 
                s.id !== id && 
                s.day === day && 
                s.hourIndex === hourIndex
            );
            
            if (conflict) {
                document.getElementById('scheduleConflict').textContent = `Konflik: Sudah ada jadwal "${conflict.subject}" di ${conflict.class} pada waktu yang sama.`;
                document.getElementById('scheduleConflict').classList.remove('hidden');
                return;
            }
            
            const entry = {
                id,
                day,
                hourIndex,
                subject,
                class: classRoom,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').doc(id).set(entry);
                
                closeModal(document.querySelector('.modal-overlay button'));
                showToast('Jadwal berhasil disimpan!', 'success');
                loadScheduleData();
            } catch (error) {
                console.error('Error saving schedule:', error);
                showToast('Gagal menyimpan jadwal', 'error');
            }
        }

        async function loadScheduleData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').get();
                
                scheduleData = [];
                snapshot.forEach(doc => {
                    scheduleData.push(doc.data());
                });
                
                document.getElementById('scheduleBody').innerHTML = renderScheduleRows();
                
                const listMobile = document.getElementById('scheduleListMobile');
                if (listMobile) {
                    listMobile.innerHTML = renderScheduleList();
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
            }
        }

        function editScheduleEntry(id) {
            const entry = scheduleData.find(s => s.id === id);
            if (!entry) return;
            
            addScheduleAtSlot(entry.day, entry.hourIndex);
            
            setTimeout(() => {
                document.getElementById('scheduleId').value = entry.id;
                document.getElementById('scheduleDay').value = entry.day;
                document.getElementById('scheduleHour').value = entry.hourIndex;
                document.getElementById('scheduleSubject').value = entry.subject;
                document.getElementById('scheduleClass').value = entry.class;
            }, 100);
        }

        async function deleteScheduleEntry(id) {
            if (!confirm('Yakin ingin menghapus jadwal ini?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('schedules').doc(id).delete();
                
                showToast('Jadwal berhasil dihapus', 'success');
                loadScheduleData();
            } catch (error) {
                console.error('Error deleting schedule:', error);
                showToast('Gagal menghapus jadwal', 'error');
            }
        }

        function showHourSettings() {
            const jenjang = userProfile?.school?.level || 'SD';
            const defaultDurations = { SD: 35, SMP: 40, SMA: 45 };
            
            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang</label>
                        <select id="hourJenjang" onchange="updateDefaultDuration()" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            <option value="SD" ${jenjang === 'SD' ? 'selected' : ''}>SD/MI (35 menit)</option>
                            <option value="SMP" ${jenjang === 'SMP' ? 'selected' : ''}>SMP/MTs (40 menit)</option>
                            <option value="SMA" ${jenjang === 'SMA' ? 'selected' : ''}>SMA/MA/SMK (45 menit)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Durasi per JP (menit)</label>
                        <input type="number" id="hourDuration" value="${defaultDurations[jenjang]}" min="30" max="60" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Mulai</label>
                        <input type="time" id="hourStart" value="07:00" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Jam Pelajaran</label>
                        <input type="number" id="hourCount" value="${lessonHours.filter(h => !h.isBreak).length}" min="6" max="12" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="hourBreak" checked class="w-5 h-5 rounded border-gray-300 text-primary-600">
                        <label class="text-sm text-gray-700">Tambahkan istirahat setelah jam ke-4</label>
                    </div>
                    
                    <button onclick="generateLessonHours()" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                        Terapkan Pengaturan
                    </button>
                </div>
            `;
            
            showModal(content, { title: 'âš™ï¸ Pengaturan Jam Pelajaran', size: 'lg' });
        }

        function generateLessonHours() {
            const duration = parseInt(document.getElementById('hourDuration').value);
            const startTime = document.getElementById('hourStart').value;
            const count = parseInt(document.getElementById('hourCount').value);
            const hasBreak = document.getElementById('hourBreak').checked;
            
            lessonHours = [];
            let currentTime = startTime.split(':').map(Number);
            
            for (let i = 0; i < count; i++) {
                // Add break after 4th hour
                if (hasBreak && i === 4) {
                    const breakStart = `${String(currentTime[0]).padStart(2, '0')}:${String(currentTime[1]).padStart(2, '0')}`;
                    currentTime[1] += 15;
                    if (currentTime[1] >= 60) {
                        currentTime[0]++;
                        currentTime[1] -= 60;
                    }
                    const breakEnd = `${String(currentTime[0]).padStart(2, '0')}:${String(currentTime[1]).padStart(2, '0')}`;
                    
                    lessonHours.push({
                        start: breakStart,
                        end: breakEnd,
                        duration: 15,
                        isBreak: true,
                        label: 'Istirahat'
                    });
                }
                
                const start = `${String(currentTime[0]).padStart(2, '0')}:${String(currentTime[1]).padStart(2, '0')}`;
                
                currentTime[1] += duration;
                if (currentTime[1] >= 60) {
                    currentTime[0]++;
                    currentTime[1] -= 60;
                }
                
                const end = `${String(currentTime[0]).padStart(2, '0')}:${String(currentTime[1]).padStart(2, '0')}`;
                
                lessonHours.push({
                    start,
                    end,
                    duration
                });
            }
            
            closeModal(document.querySelector('.modal-overlay button'));
            document.getElementById('scheduleBody').innerHTML = renderScheduleRows();
            showToast('Pengaturan jam pelajaran berhasil diterapkan', 'success');
        }
    </script>

    <!-- Students Page -->
    <script>
        let studentsData = [];
        let classesData = new Set();

        function renderStudents() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ‘¨â€ğŸ“ Data Siswa</h1>
                            <p class="text-gray-500">Kelola data siswa per kelas</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="importStudentsCSV()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors flex items-center gap-2">
                                <span>ğŸ“¥</span> Import CSV
                            </button>
                            <button onclick="addStudent()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>â•</span> Tambah Siswa
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[200px]">
                            <input type="text" id="studentSearch" placeholder="Cari nama atau NISN..." onkeyup="filterStudents()" class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <select id="studentClassFilter" onchange="filterStudents()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Kelas</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Students Table -->
                    <div class="bg-white rounded-2xl overflow-hidden shadow-lg">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">NISN</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">L/P</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kelas</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rombel</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                            Memuat data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Summary -->
                    <div class="mt-6 bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š Ringkasan</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-gray-50 rounded-xl">
                                <p class="text-2xl font-bold text-primary-600" id="totalStudents">0</p>
                                <p class="text-sm text-gray-500">Total Siswa</p>
                            </div>
                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                <p class="text-2xl font-bold text-blue-600" id="totalMale">0</p>
                                <p class="text-sm text-gray-500">Laki-laki</p>
                            </div>
                            <div class="text-center p-4 bg-pink-50 rounded-xl">
                                <p class="text-2xl font-bold text-pink-600" id="totalFemale">0</p>
                                <p class="text-sm text-gray-500">Perempuan</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-xl">
                                <p class="text-2xl font-bold text-green-600" id="totalClasses">0</p>
                                <p class="text-sm text-gray-500">Kelas</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            loadStudentsData();
        }

        async function loadStudentsData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('students').orderBy('name').get();
                
                studentsData = [];
                classesData = new Set();
                
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    studentsData.push(data);
                    classesData.add(`${data.class}${data.rombel || ''}`);
                });
                
                renderStudentsTable(studentsData);
                updateStudentsSummary();
                updateClassFilter();
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-red-500">
                            Gagal memuat data siswa
                        </td>
                    </tr>
                `;
            }
        }

        function renderStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            Belum ada data siswa. Klik "Tambah Siswa" atau "Import CSV" untuk menambahkan.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = students.map((student, index) => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-600">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${student.nisn || '-'}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">${student.name}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${student.gender === 'L' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'}">
                            ${student.gender}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center text-sm text-gray-600">${student.class}</td>
                    <td class="px-4 py-3 text-center text-sm text-gray-600">${student.rombel || '-'}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="editStudent('${student.id}')" class="p-1 text-primary-600 hover:bg-primary-50 rounded">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button onclick="deleteStudent('${student.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStudentsSummary() {
            document.getElementById('totalStudents').textContent = studentsData.length;
            document.getElementById('totalMale').textContent = studentsData.filter(s => s.gender === 'L').length;
            document.getElementById('totalFemale').textContent = studentsData.filter(s => s.gender === 'P').length;
            document.getElementById('totalClasses').textContent = classesData.size;
        }

        function updateClassFilter() {
            const select = document.getElementById('studentClassFilter');
            const classes = Array.from(classesData).sort();
            
            select.innerHTML = '<option value="">Semua Kelas</option>' + 
                classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function filterStudents() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const classFilter = document.getElementById('studentClassFilter').value;
            
            const filtered = studentsData.filter(student => {
                const matchSearch = student.name.toLowerCase().includes(search) || 
                                   (student.nisn && student.nisn.includes(search));
                const matchClass = !classFilter || `${student.class}${student.rombel || ''}` === classFilter;
                return matchSearch && matchClass;
            });
            
            renderStudentsTable(filtered);
        }

        function addStudent() {
            const content = `
                <form id="studentForm" class="space-y-4">
                    <input type="hidden" id="studentId" value="">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                        <input type="text" id="studentNISN" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                        <input type="text" id="studentName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">L/P *</label>
                            <select id="studentGender" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="L">L</option>
                                <option value="P">P</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas *</label>
                            <input type="text" id="studentClass" required placeholder="1-6" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rombel</label>
                            <input type="text" id="studentRombel" placeholder="A/B/C" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                        Simpan Siswa
                    </button>
                </form>
            `;
            
            showModal(content, { title: 'ğŸ‘¨â€ğŸ“ Tambah Siswa', size: 'lg' });
            document.getElementById('studentForm').addEventListener('submit', saveStudent);
        }

        async function saveStudent(e) {
            e.preventDefault();
            
            const id = document.getElementById('studentId').value || db.collection('temp').doc().id;
            
            const data = {
                nisn: document.getElementById('studentNISN').value,
                name: document.getElementById('studentName').value,
                gender: document.getElementById('studentGender').value,
                class: document.getElementById('studentClass').value,
                rombel: document.getElementById('studentRombel').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('students').doc(id).set(data, { merge: true });
                
                closeModal(document.querySelector('.modal-overlay button'));
                showToast('Data siswa berhasil disimpan!', 'success');
                loadStudentsData();
            } catch (error) {
                console.error('Error saving student:', error);
                showToast('Gagal menyimpan data siswa', 'error');
            }
        }

        function editStudent(id) {
            const student = studentsData.find(s => s.id === id);
            if (!student) return;
            
            addStudent();
            
            setTimeout(() => {
                document.getElementById('studentId').value = student.id;
                document.getElementById('studentNISN').value = student.nisn || '';
                document.getElementById('studentName').value = student.name;
                document.getElementById('studentGender').value = student.gender;
                document.getElementById('studentClass').value = student.class;
                document.getElementById('studentRombel').value = student.rombel || '';
            }, 100);
        }

        async function deleteStudent(id) {
            if (!confirm('Yakin ingin menghapus data siswa ini?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('students').doc(id).delete();
                
                showToast('Data siswa berhasil dihapus', 'success');
                loadStudentsData();
            } catch (error) {
                console.error('Error deleting student:', error);
                showToast('Gagal menghapus data siswa', 'error');
            }
        }

        function importStudentsCSV() {
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-600">Import data siswa dari Google Spreadsheet yang sudah dipublikasi.</p>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL Google Spreadsheet (Published CSV)</label>
                        <input type="url" id="studentsCsvUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <h4 class="font-medium text-blue-800 mb-2">Format Kolom CSV:</h4>
                        <code class="text-sm text-blue-600 block">nisn,nama,jenis_kelamin,kelas,rombel</code>
                        <p class="text-xs text-blue-600 mt-2">Contoh: 1234567890,Ahmad Fauzi,L,4,A</p>
                        <p class="text-xs text-blue-600 mt-1">jenis_kelamin: L untuk Laki-laki, P untuk Perempuan</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="processStudentsCSV()" class="flex-1 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                            Import Data
                        </button>
                        <button onclick="downloadStudentsTemplate()" class="px-4 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50">
                            ğŸ“„ Template
                        </button>
                    </div>
                </div>
            `;
            
            showModal(content, { title: 'ğŸ“¥ Import Data Siswa', size: 'lg' });
        }

        async function processStudentsCSV() {
            const url = document.getElementById('studentsCsvUrl').value;
            if (!url) {
                showToast('Masukkan URL Google Spreadsheet', 'warning');
                return;
            }
            
            try {
                showToast('Mengambil data...', 'info');
                
                // For CORS, we need to use a proxy or the direct published CSV link
                const response = await fetch(url);
                const csvText = await response.text();
                
                const lines = csvText.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                
                let imported = 0;
                const batch = db.batch();
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    const student = {};
                    
                    headers.forEach((header, index) => {
                        if (header === 'nisn') student.nisn = values[index];
                        else if (header === 'nama' || header === 'name') student.name = values[index];
                        else if (header === 'jenis_kelamin' || header === 'gender') student.gender = values[index].toUpperCase();
                        else if (header === 'kelas' || header === 'class') student.class = values[index];
                        else if (header === 'rombel') student.rombel = values[index];
                    });
                    
                    if (student.name) {
                        const docRef = db.collection('users').doc(currentUser.uid)
                            .collection('students').doc();
                        student.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        batch.set(docRef, student);
                        imported++;
                    }
                }
                
                await batch.commit();
                
                closeModal(document.querySelector('.modal-overlay button'));
                showToast(`${imported} siswa berhasil diimport!`, 'success');
                loadStudentsData();
                
            } catch (error) {
                console.error('Error importing CSV:', error);
                showToast('Gagal mengimport data. Pastikan URL sudah benar dan spreadsheet sudah dipublikasi.', 'error');
            }
        }

        function downloadStudentsTemplate() {
            const csv = 'nisn,nama,jenis_kelamin,kelas,rombel\n1234567890,Contoh Nama Siswa,L,4,A';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_siswa.csv';
            a.click();
        }
    </script>

    <!-- CP (Capaian Pembelajaran) Page -->
    <script src="cp-data.js"></script>
    <script>
        let cpData = [];

        function renderCP() {
            const content = document.getElementById('contentArea');
            const subjects = userProfile?.subjects || [];
            const isPAI = subjects.some(s => s.name.toLowerCase().includes('pai') || s.name.toLowerCase().includes('agama islam'));
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ¯ Capaian Pembelajaran</h1>
                            <p class="text-gray-500">Kelola CP dan Tujuan Pembelajaran</p>
                        </div>
                        <div class="flex gap-3">
                            ${isPAI ? `
                                <button onclick="loadDefaultPAICP()" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                                    <span>ğŸ“š</span> Muat CP PAI Default
                                </button>
                            ` : ''}
                            <button onclick="addCP()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>â•</span> Tambah CP
                            </button>
                        </div>
                    </div>
                    
                    ${!isPAI ? `
                        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                            <h3 class="font-medium text-amber-800 mb-2">â„¹ï¸ Panduan Input CP</h3>
                            <p class="text-sm text-amber-700 mb-2">Untuk mata pelajaran selain
<!-- Continuing CP Page -->
<script>
        // Continuing from renderCP function...
        // Previous code ended at: <p class="text-sm text-amber-700 mb-2">Untuk mata pelajaran selain

        function renderCP() {
            const content = document.getElementById('contentArea');
            const subjects = userProfile?.subjects || [];
            const isPAI = subjects.some(s => s.name.toLowerCase().includes('pai') || s.name.toLowerCase().includes('agama islam'));
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ¯ Capaian Pembelajaran</h1>
                            <p class="text-gray-500">Kelola CP dan Tujuan Pembelajaran</p>
                        </div>
                        <div class="flex gap-3">
                            ${isPAI ? `
                                <button onclick="loadDefaultPAICP()" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                                    <span>ğŸ“š</span> Muat CP PAI Default
                                </button>
                            ` : ''}
                            <button onclick="addCP()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>â•</span> Tambah CP
                            </button>
                        </div>
                    </div>
                    
                    ${!isPAI ? `
                        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                            <h3 class="font-medium text-amber-800 mb-2">â„¹ï¸ Panduan Input CP untuk Mata Pelajaran Lain</h3>
                            <p class="text-sm text-amber-700 mb-2">Untuk mata pelajaran selain PAI, Anda perlu menginput CP secara manual sesuai dengan dokumen kurikulum yang berlaku.</p>
                            <ol class="text-sm text-amber-700 list-decimal ml-4 space-y-1">
                                <li>Tentukan Fase pembelajaran (A/B/C untuk SD, D untuk SMP, E/F untuk SMA)</li>
                                <li>Salin Capaian Pembelajaran dari dokumen BSKAP</li>
                                <li>Breakdown menjadi Tujuan Pembelajaran (TP)</li>
                                <li>Gunakan AI Assistant untuk membantu generate TP dari CP</li>
                            </ol>
                            <button onclick="navigateTo('ai')" class="mt-3 text-sm text-amber-800 font-medium hover:underline">ğŸ¤– Buka AI Assistant â†’</button>
                        </div>
                    ` : ''}
                    
                    <!-- Filter -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div>
                            <select id="cpSubjectFilter" onchange="filterCP()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Mapel</option>
                                ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <select id="cpClassFilter" onchange="filterCP()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Kelas</option>
                                <option value="1">Kelas 1</option>
                                <option value="2">Kelas 2</option>
                                <option value="3">Kelas 3</option>
                                <option value="4">Kelas 4</option>
                                <option value="5">Kelas 5</option>
                                <option value="6">Kelas 6</option>
                            </select>
                        </div>
                        <div>
                            <select id="cpSemesterFilter" onchange="filterCP()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Semester</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- CP List -->
                    <div id="cpList" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">Memuat data...</div>
                    </div>
                </div>
            `;
            
            loadCPData();
        }

        async function loadCPData() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('cp').orderBy('class').orderBy('semester').get();
                
                cpData = [];
                snapshot.forEach(doc => {
                    cpData.push({ id: doc.id, ...doc.data() });
                });
                
                renderCPList(cpData);
            } catch (error) {
                console.error('Error loading CP:', error);
                document.getElementById('cpList').innerHTML = `
                    <div class="text-center py-8 text-red-500">Gagal memuat data CP</div>
                `;
            }
        }

        function renderCPList(data) {
            const container = document.getElementById('cpList');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 text-center">
                        <div class="text-6xl mb-4">ğŸ“š</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Belum Ada Data CP</h3>
                        <p class="text-gray-500 mb-4">Tambahkan Capaian Pembelajaran untuk mulai membuat ATP, Prota, dan Promes.</p>
                        <button onclick="addCP()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                            + Tambah CP Pertama
                        </button>
                    </div>
                `;
                return;
            }
            
            // Group by class and semester
            const grouped = {};
            data.forEach(cp => {
                const key = `Kelas ${cp.class} - Semester ${cp.semester}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(cp);
            });
            
            container.innerHTML = Object.entries(grouped).map(([key, cps]) => `
                <div class="bg-white rounded-2xl overflow-hidden">
                    <div class="bg-gradient-to-r from-primary-500 to-purple-500 px-6 py-4 text-white">
                        <h3 class="font-bold">${key}</h3>
                        <p class="text-sm text-purple-100">${cps.length} Capaian Pembelajaran</p>
                    </div>
                    <div class="p-4 space-y-3">
                        ${cps.map((cp, index) => `
                            <div class="border border-gray-200 rounded-xl p-4 hover:border-primary-300 transition-colors">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="px-2 py-1 text-xs font-medium bg-primary-100 text-primary-700 rounded">${cp.elemen || 'Umum'}</span>
                                            <span class="text-xs text-gray-500">Bab ${cp.bab || index + 1}</span>
                                        </div>
                                        <h4 class="font-medium text-gray-800 mb-2">${cp.judul || cp.title || 'Tanpa Judul'}</h4>
                                        <p class="text-sm text-gray-600 line-clamp-2">${cp.tujuan || cp.description || ''}</p>
                                        ${cp.tp && cp.tp.length > 0 ? `
                                            <div class="mt-3">
                                                <p class="text-xs font-medium text-gray-500 mb-1">Tujuan Pembelajaran:</p>
                                                <ul class="text-xs text-gray-600 space-y-1">
                                                    ${cp.tp.slice(0, 3).map((t, i) => `<li>TP ${i + 1}: ${t.substring(0, 100)}${t.length > 100 ? '...' : ''}</li>`).join('')}
                                                    ${cp.tp.length > 3 ? `<li class="text-primary-600">+${cp.tp.length - 3} TP lainnya</li>` : ''}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="editCP('${cp.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg" title="Edit">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                            </svg>
                                        </button>
                                        <button onclick="deleteCP('${cp.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Hapus">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function filterCP() {
            const subject = document.getElementById('cpSubjectFilter').value;
            const classFilter = document.getElementById('cpClassFilter').value;
            const semester = document.getElementById('cpSemesterFilter').value;
            
            const filtered = cpData.filter(cp => {
                const matchSubject = !subject || cp.subject === subject;
                const matchClass = !classFilter || cp.class === classFilter;
                const matchSemester = !semester || cp.semester === semester;
                return matchSubject && matchClass && matchSemester;
            });
            
            renderCPList(filtered);
        }

        function addCP() {
            const subjects = userProfile?.subjects || [{ name: 'PAI dan Budi Pekerti' }];
            const elemenPAI = ['Al-Qur\'an dan Hadis', 'Akidah', 'Akhlak', 'Fikih', 'Sejarah Peradaban Islam'];
            
            const content = `
                <form id="cpForm" class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="cpId" value="">
                    
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran *</label>
                            <select id="cpSubject" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas *</label>
                            <select id="cpClass" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="1">Kelas 1</option>
                                <option value="2">Kelas 2</option>
                                <option value="3">Kelas 3</option>
                                <option value="4">Kelas 4</option>
                                <option value="5">Kelas 5</option>
                                <option value="6">Kelas 6</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Semester *</label>
                            <select id="cpSemester" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Elemen</label>
                            <select id="cpElemen" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="">Pilih Elemen</option>
                                ${elemenPAI.map(e => `<option value="${e}">${e}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bab</label>
                            <input type="number" id="cpBab" min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Judul/Topik *</label>
                        <input type="text" id="cpJudul" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Capaian Pembelajaran</label>
                        <textarea id="cpCapaian" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran (TP)</label>
                        <p class="text-xs text-gray-500 mb-2">Pisahkan setiap TP dengan baris baru</p>
                        <textarea id="cpTP" rows="5" placeholder="TP 1: Peserta didik dapat...&#10;TP 2: Peserta didik mampu..." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Pertemuan</label>
                        <input type="number" id="cpPertemuan" min="1" value="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                        Simpan CP
                    </button>
                </form>
            `;
            
            showModal(content, { title: 'ğŸ¯ Tambah Capaian Pembelajaran', size: 'xl' });
            document.getElementById('cpForm').addEventListener('submit', saveCP);
        }

        async function saveCP(e) {
            e.preventDefault();
            
            const id = document.getElementById('cpId').value || db.collection('temp').doc().id;
            const tpText = document.getElementById('cpTP').value;
            const tpArray = tpText.split('\n').filter(t => t.trim()).map(t => t.replace(/^TP \d+:\s*/i, '').trim());
            
            const data = {
                subject: document.getElementById('cpSubject').value,
                class: document.getElementById('cpClass').value,
                semester: document.getElementById('cpSemester').value,
                elemen: document.getElementById('cpElemen').value,
                bab: document.getElementById('cpBab').value,
                judul: document.getElementById('cpJudul').value,
                tujuan: document.getElementById('cpCapaian').value,
                tp: tpArray,
                pertemuan: parseInt(document.getElementById('cpPertemuan').value) || 2,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('cp').doc(id).set(data, { merge: true });
                
                closeModal(document.querySelector('.modal-overlay button'));
                showToast('CP berhasil disimpan!', 'success');
                loadCPData();
            } catch (error) {
                console.error('Error saving CP:', error);
                showToast('Gagal menyimpan CP', 'error');
            }
        }

        function editCP(id) {
            const cp = cpData.find(c => c.id === id);
            if (!cp) return;
            
            addCP();
            
            setTimeout(() => {
                document.getElementById('cpId').value = cp.id;
                document.getElementById('cpSubject').value = cp.subject || '';
                document.getElementById('cpClass').value = cp.class || '';
                document.getElementById('cpSemester').value = cp.semester || '';
                document.getElementById('cpElemen').value = cp.elemen || '';
                document.getElementById('cpBab').value = cp.bab || '';
                document.getElementById('cpJudul').value = cp.judul || '';
                document.getElementById('cpCapaian').value = cp.tujuan || '';
                document.getElementById('cpTP').value = (cp.tp || []).map((t, i) => `TP ${i + 1}: ${t}`).join('\n');
                document.getElementById('cpPertemuan').value = cp.pertemuan || 2;
            }, 100);
        }

        async function deleteCP(id) {
            if (!confirm('Yakin ingin menghapus CP ini?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('cp').doc(id).delete();
                
                showToast('CP berhasil dihapus', 'success');
                loadCPData();
            } catch (error) {
                console.error('Error deleting CP:', error);
                showToast('Gagal menghapus CP', 'error');
            }
        }

        async function loadDefaultPAICP() {
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-600">Pilih kelas untuk memuat data CP PAI default dari kurikulum merdeka.</p>
                    
                    <div class="grid grid-cols-3 gap-3">
                        ${[1, 2, 3, 4, 5, 6].map(k => `
                            <button onclick="importPAICPForClass(${k})" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-300 border-2 border-transparent transition-colors text-center">
                                <div class="text-2xl mb-1">ğŸ“š</div>
                                <div class="font-medium">Kelas ${k}</div>
                            </button>
                        `).join('')}
                    </div>
                    
                    <button onclick="importPAICPAll()" class="w-full py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">
                        ğŸ“¦ Import Semua Kelas (1-6)
                    </button>
                </div>
            `;
            
            showModal(content, { title: 'ğŸ“š Muat CP PAI Default', size: 'lg' });
        }

        async function importPAICPForClass(classNum) {
            showToast('Mengimport data CP PAI Kelas ' + classNum + '...', 'info');
            
            // Get data from the dataBuku object (defined in the requirement)
            const kelasKey = `kelas${classNum}`;
            if (typeof dataBuku !== 'undefined' && dataBuku[kelasKey]) {
                const bukuData = dataBuku[kelasKey];
                const batch = db.batch();
                let count = 0;
                
                // Process semester 1
                bukuData.semester1.forEach(bab => {
                    const docRef = db.collection('users').doc(currentUser.uid).collection('cp').doc();
                    batch.set(docRef, {
                        subject: 'PAI dan Budi Pekerti',
                        class: String(classNum),
                        semester: '1',
                        elemen: bab.elemen,
                        bab: bab.bab,
                        judul: bab.judul,
                        tujuan: bab.tujuan,
                        tp: bab.materi.map(m => m.sub),
                        materi: bab.materi,
                        aktivitas: bab.aktivitas,
                        refleksi: bab.refleksi,
                        karakter: bab.karakter,
                        pertemuan: 2,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    count++;
                });
                
                // Process semester 2
                bukuData.semester2.forEach(bab => {
                    const docRef = db.collection('users').doc(currentUser.uid).collection('cp').doc();
                    batch.set(docRef, {
                        subject: 'PAI dan Budi Pekerti',
                        class: String(classNum),
                        semester: '2',
                        elemen: bab.elemen,
                        bab: bab.bab,
                        judul: bab.judul,
                        tujuan: bab.tujuan,
                        tp: bab.materi.map(m => m.sub),
                        materi: bab.materi,
                        aktivitas: bab.aktivitas,
                        refleksi: bab.refleksi,
                        karakter: bab.karakter,
                        pertemuan: 2,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    count++;
                });
                
                try {
                    await batch.commit();
                    showToast(`${count} CP berhasil diimport untuk Kelas ${classNum}!`, 'success');
                    loadCPData();
                } catch (error) {
                    console.error('Error importing CP:', error);
                    showToast('Gagal mengimport CP', 'error');
                }
            } else {
                showToast('Data CP tidak tersedia', 'error');
            }
            
            closeModal(document.querySelector('.modal-overlay button'));
        }

        async function importPAICPAll() {
            showToast('Mengimport semua data CP PAI...', 'info');
            
            for (let i = 1; i <= 6; i++) {
                await importPAICPForClass(i);
            }
            
            showToast('Semua CP berhasil diimport!', 'success');
        }
    </script>

    <!-- ATP Page -->
    <script>
        function renderATP() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ“‹ Alur Tujuan Pembelajaran (ATP)</h1>
                            <p class="text-gray-500">ATP dihasilkan otomatis dari data CP/TP</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="generateATP()" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                                <span>âš¡</span> Generate ATP
                            </button>
                            <button onclick="printATP()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>ğŸ–¨ï¸</span> Cetak
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div>
                            <select id="atpClassFilter" onchange="loadATPData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Pilih Kelas</option>
                                ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <select id="atpSemesterFilter" onchange="loadATPData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Pilih Semester</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ATP Preview -->
                    <div id="atpContent" class="bg-white rounded-2xl p-6">
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-5xl mb-4">ğŸ“‹</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Pilih Kelas dan Semester</h3>
                            <p>Pilih kelas dan semester untuk melihat atau generate ATP</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadATPData() {
            const classFilter = document.getElementById('atpClassFilter').value;
            const semesterFilter = document.getElementById('atpSemesterFilter').value;
            
            if (!classFilter || !semesterFilter) {
                return;
            }
            
            const container = document.getElementById('atpContent');
            container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-500">Memuat data...</p></div>';
            
            try {
                // Load CP data for selected class and semester
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('cp')
                    .where('class', '==', classFilter)
                    .where('semester', '==', semesterFilter)
                    .orderBy('bab')
                    .get();
                
                const cpList = [];
                snapshot.forEach(doc => cpList.push({ id: doc.id, ...doc.data() }));
                
                if (cpList.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-5xl mb-4">ğŸ“­</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Belum Ada Data CP</h3>
                            <p class="text-gray-500 mb-4">Tambahkan CP terlebih dahulu untuk generate ATP</p>
                            <button onclick="navigateTo('cp')" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium">
                                Tambah CP â†’
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Render ATP
                renderATPContent(cpList, classFilter, semesterFilter);
                
            } catch (error) {
                console.error('Error loading ATP:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data ATP</div>';
            }
        }

        function renderATPContent(cpList, classNum, semester) {
            const container = document.getElementById('atpContent');
            const school = userProfile?.school || {};
            const teacher = userProfile?.name || 'Guru';
            const years = getAcademicYears();
            
            container.innerHTML = `
                <div id="atpPrintArea">
                    <!-- Header -->
                    <div class="text-center mb-8 border-b-2 border-gray-800 pb-4">
                        <h2 class="text-lg font-bold">ALUR TUJUAN PEMBELAJARAN (ATP)</h2>
                        <p class="text-sm">Tahun Pelajaran ${years[0]}</p>
                    </div>
                    
                    <!-- Info -->
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                        <div>
                            <table class="w-full">
                                <tr><td class="py-1 w-32">Satuan Pendidikan</td><td>: ${school.name || '-'}</td></tr>
                                <tr><td class="py-1">Mata Pelajaran</td><td>: PAI dan Budi Pekerti</td></tr>
                                <tr><td class="py-1">Fase</td><td>: ${classNum <= 2 ? 'A' : classNum <= 4 ? 'B' : 'C'}</td></tr>
                            </table>
                        </div>
                        <div>
                            <table class="w-full">
                                <tr><td class="py-1 w-32">Kelas</td><td>: ${classNum}</td></tr>
                                <tr><td class="py-1">Semester</td><td>: ${semester}</td></tr>
                                <tr><td class="py-1">Tahun Pelajaran</td><td>: ${years[0]}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-400 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-400 px-3 py-2 text-center w-12">No</th>
                                    <th class="border border-gray-400 px-3 py-2 text-center">Elemen</th>
                                    <th class="border border-gray-400 px-3 py-2 text-center w-20">Bab</th>
                                    <th class="border border-gray-400 px-3 py-2">Capaian Pembelajaran</th>
                                    <th class="border border-gray-400 px-3 py-2">Tujuan Pembelajaran</th>
                                    <th class="border border-gray-400 px-3 py-2 text-center w-20">JP</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cpList.map((cp, index) => `
                                    <tr>
                                        <td class="border border-gray-400 px-3 py-2 text-center align-top">${index + 1}</td>
                                        <td class="border border-gray-400 px-3 py-2 align-top">${cp.elemen || '-'}</td>
                                        <td class="border border-gray-400 px-3 py-2 text-center align-top">${cp.bab || index + 1}</td>
                                        <td class="border border-gray-400 px-3 py-2 align-top">
                                            <strong>${cp.judul}</strong><br>
                                            <span class="text-gray-600">${cp.tujuan || ''}</span>
                                        </td>
                                        <td class="border border-gray-400 px-3 py-2 align-top">
                                            <ol class="list-decimal ml-4">
                                                ${(cp.tp || []).map(t => `<li>${t}</li>`).join('')}
                                            </ol>
                                        </td>
                                        <td class="border border-gray-400 px-3 py-2 text-center align-top">${(cp.pertemuan || 2) * 2}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Signature -->
                    <div class="mt-12 flex justify-between text-sm">
                        <div class="text-center">
                            <p>Mengetahui,</p>
                            <p>Kepala ${school.name || 'Sekolah'}</p>
                            <br><br><br><br>
                            <p class="font-bold border-b border-black inline-block">${school.principalName || '.............................'}</p>
                            <p>NIP. ................................</p>
                        </div>
                        <div class="text-center">
                            <p>${school.location || '.....................'}, ........................</p>
                            <p>Guru Mata Pelajaran</p>
                            <br><br><br><br>
                            <p class="font-bold border-b border-black inline-block">${teacher}</p>
                            <p>NIP. ${userProfile?.nip || '................................'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function generateATP() {
            const classFilter = document.getElementById('atpClassFilter').value;
            const semesterFilter = document.getElementById('atpSemesterFilter').value;
            
            if (!classFilter || !semesterFilter) {
                showToast('Pilih kelas dan semester terlebih dahulu', 'warning');
                return;
            }
            
            await loadATPData();
            showToast('ATP berhasil di-generate!', 'success');
        }

        function printATP() {
            const printArea = document.getElementById('atpPrintArea');
            if (!printArea) {
                showToast('Generate ATP terlebih dahulu', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ATP - Print</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #000; padding: 8px; }
                        th { background-color: #f0f0f0; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    ${printArea.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

    <!-- Prota Page -->
    <script>
        function renderProta() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ“† Program Tahunan (Prota)</h1>
                            <p class="text-gray-500">Prota dihasilkan otomatis dari ATP dan Kalender</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="generateProta()" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                                <span>âš¡</span> Generate Prota
                            </button>
                            <button onclick="printProta()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>ğŸ–¨ï¸</span> Cetak
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div>
                            <select id="protaClassFilter" onchange="loadProtaData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Pilih Kelas</option>
                                ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Prota Preview -->
                    <div id="protaContent" class="bg-white rounded-2xl p-6">
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-5xl mb-4">ğŸ“†</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Pilih Kelas</h3>
                            <p>Pilih kelas untuk melihat atau generate Prota</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadProtaData() {
            const classFilter = document.getElementById('protaClassFilter').value;
            
            if (!classFilter) return;
            
            const container = document.getElementById('protaContent');
            container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
            
            try {
                // Load CP for both semesters
                const sem1Snap = await db.collection('users').doc(currentUser.uid)
                    .collection('cp')
                    .where('class', '==', classFilter)
                    .where('semester', '==', '1')
                    .orderBy('bab')
                    .get();
                
                const sem2Snap = await db.collection('users').doc(currentUser.uid)
                    .collection('cp')
                    .where('class', '==', classFilter)
                    .where('semester', '==', '2')
                    .orderBy('bab')
                    .get();
                
                const sem1CP = [];
                sem1Snap.forEach(doc => sem1CP.push({ id: doc.id, ...doc.data() }));
                
                const sem2CP = [];
                sem2Snap.forEach(doc => sem2CP.push({ id: doc.id, ...doc.data() }));
                
                // Load calendar
                const calendarDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('settings').doc('calendar').get();
                
                const calendar = calendarDoc.exists ? calendarDoc.data() : null;
                
                renderProtaContent(sem1CP, sem2CP, classFilter, calendar);
                
            } catch (error) {
                console.error('Error loading Prota:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data</div>';
            }
        }

        function renderProtaContent(sem1CP, sem2CP, classNum, calendar) {
            const container = document.getElementById('protaContent');
            const school = userProfile?.school || {};
            const years = getAcademicYears();
            
            // Calculate weeks
            let sem1Weeks = 18;
            let sem2Weeks = 18;
            
            if (calendar) {
                if (calendar.semester1?.start && calendar.semester1?.end) {
                    const s1 = new Date(calendar.semester1.start);
                    const e1 = new Date(calendar.semester1.end);
                    sem1Weeks = Math.floor((e1 - s1) / (7 * 24 * 60 * 60 * 1000));
                }
                if (calendar.semester2?.start && calendar.semester2?.end) {
                    const s2 = new Date(calendar.semester2.start);
                    const e2 = new Date(calendar.semester2.end);
                    sem2Weeks = Math.floor((e2 - s2) / (7 * 24 * 60 * 60 * 1000));
                }
            }
            
            container.innerHTML = `
                <div id="protaPrintArea">
                    <!-- Header -->
                    <div class="text-center mb-8 border-b-2 border-gray-800 pb-4">
                        <h2 class="text-lg font-bold">PROGRAM TAHUNAN (PROTA)</h2>
                        <p class="text-sm">Tahun Pelajaran ${years[0]}</p>
                    </div>
                    
                    <!-- Info -->
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                        <div>
                            <table class="w-full">
                                <tr><td class="py-1 w-32">Satuan Pendidikan</td><td>: ${school.name || '-'}</td></tr>
                                <tr><td class="py-1">Mata Pelajaran</td><td>: PAI dan Budi Pekerti</td></tr>
                            </table>
                        </div>
                        <div>
                            <table class="w-full">
                                <tr><td class="py-1 w-32">Kelas</td><td>: ${classNum}</td></tr>
                                <tr><td class="py-1">Tahun Pelajaran</td><td>: ${years[0]}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Semester 1 -->
                    <h3 class="font-bold text-lg mb-3">SEMESTER 1 (Ganjil)</h3>
                    <div class="overflow-x-auto mb-8">
                        <table class="w-full border-collapse border border-gray-400 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-400 px-3 py-2 w-12">No</th>
                                    <th class="border border-gray-400 px-3 py-2">Bab/Materi</th>
                                    <th class="border border-gray-400 px-3 py-2 w-20">JP</th>
                                    <th class="border border-gray-400 px-3 py-2">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sem1CP.map((cp, i) => `
                                    <tr>
                                        <td class="border border-gray-400 px-3 py-2 text-center">${i + 1}</td>
                                        <td class="border border-gray-400 px-3 py-2">
                                            <strong>Bab ${cp.bab || i + 1}: ${cp.judul}</strong>
                                        </td>
                                        <td class="border border-gray-400 px-3 py-2 text-center">${(cp.pertemuan || 2) * 2}</td>
                                        <td class="border border-gray-400 px-3 py-2">${cp.elemen || ''}</td>
                                    </tr>
                                `).join('')}
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="2" class="border border-gray-400 px-3 py-2 text-right">Total JP Semester 1</td>
                                    <td class="border border-gray-400 px-3 py-2 text-center">${sem1CP.reduce((sum, cp) => sum + ((cp.pertemuan || 2) * 2), 0)}</td>
                                    <td class="border border-gray-400 px-3 py-2">Minggu Efektif: ${sem1Weeks}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Semester 2 -->
                    <h3 class="font-bold text-lg mb-3">SEMESTER 2 (Genap)</h3>
                    <div class="overflow-x-auto mb-8">
                        <table class="w-full border-collapse border border-gray-400 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-400 px-3 py-2 w-12">No</th>
                                    <th class="border border-gray-400 px-3 py-2">Bab/Materi</th>
                                    <th class="border border-gray-400 px-3 py-2 w-20">JP</th>
                                    <th class="border border-gray-400 px-3 py-2">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sem2CP.map((cp, i) => `
                                    <tr>
                                        <td class="border border-gray-400 px-3 py-2 text-center">${i + 1}</td>
                                        <td class="border border-gray-400 px-3 py-2">
                                            <strong>Bab ${cp.bab || i + 1}: ${cp.judul}</strong>
                                        </td>
                                        <td class="border border-gray-400 px-3 py-2 text-center">${(cp.pertemuan || 2) * 2}</td>
                                        <td class="border border-gray-400 px-3 py-2">${cp.elemen || ''}</td>
                                    </tr>
                                `).join('')}
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="2" class="border border-gray-400 px-3 py-2 text-right">Total JP Semester 2</td>
                                    <td class="border border-gray-400 px-3 py-2 text-center">${sem2CP.reduce((sum, cp) => sum + ((cp.pertemuan || 2) * 2), 0)}</td>
                                    <td class="border border-gray-400 px-3 py-2">Minggu Efektif: ${sem2Weeks}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Signature -->
                    <div class="mt-12 flex justify-between text-sm">
                        <div class="text-center">
                            <p>Mengetahui,</p>
                            <p>Kepala ${school.name || 'Sekolah'}</p>
                            <br><br><br><br>
                            <p class="font-bold border-b border-black inline-block">${school.principalName || '.............................'}</p>
                            <p>NIP. ................................</p>
                        </div>
                        <div class="text-center">
                            <p>${school.location || '.....................'}, ........................</p>
                            <p>Guru Mata Pelajaran</p>
                            <br><br><br><br>
                            <p class="font-bold border-b border-black inline-block">${userProfile?.name || ''}</p>
                            <p>NIP. ${userProfile?.nip || '................................'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateProta() {
            const classFilter = document.getElementById('protaClassFilter').value;
            if (!classFilter) {
                showToast('Pilih kelas terlebih dahulu', 'warning');
                return;
            }
            loadProtaData();
            showToast('Prota berhasil di-generate!', 'success');
        }

        function printProta() {
            const printArea = document.getElementById('protaPrintArea');
            if (!printArea) {
                showToast('Generate Prota terlebih dahulu', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Prota - Print</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #000; padding: 8px; }
                        th { background-color: #f0f0f0; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    ${printArea.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

    <!-- Promes Page -->
    <script>
        function renderPromes() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ“‘ Program Semester (Promes)</h1>
                            <p class="text-gray-500">Promes sinkron dengan Prota, Jadwal, dan Kalender</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="generatePromes()" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors flex items-center gap-2">
                                <span>âš¡</span> Generate Promes
                            </button>
                            <button onclick="printPromes()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>ğŸ–¨ï¸</span> Cetak
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div>
                            <select id="promesClassFilter" onchange="loadPromesData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Pilih Kelas</option>
                                ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <select id="promesSemesterFilter" onchange="loadPromesData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Pilih Semester</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Promes Preview -->
                    <div id="promesContent" class="bg-white rounded-2xl p-6">
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-5xl mb-4">ğŸ“‘</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Pilih Kelas dan Semester</h3>
                            <p>Pilih kelas dan semester untuk melihat atau generate Promes</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadPromesData() {
            const classFilter = document.getElementById('promesClassFilter').value;
            const semesterFilter = document.getElementById('promesSemesterFilter').value;
            
            if (!classFilter || !semesterFilter) return;
            
            const container = document.getElementById('promesContent');
            container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
            
            try {
                // Load CP, Calendar, and Schedule
                const [cpSnap, calendarDoc, scheduleSnap] = await Promise.all([
                    db.collection('users').doc(currentUser.uid)
                        .collection('cp')
                        .where('class', '==', classFilter)
                        .where('semester', '==', semesterFilter)
                        .orderBy('bab')
                        .get(),
                    db.collection('users').doc(currentUser.uid)
                        .collection('settings').doc('calendar').get(),
                    db.collection('users').doc(currentUser.uid)
                        .collection('schedules')
                        .where('class', '==', classFilter)
                        .get()
                ]);
                
                const cpList = [];
                cpSnap.forEach(doc => cpList.push({ id: doc.id, ...doc.data() }));
                
                const calendar = calendarDoc.exists ? calendarDoc.data() : null;
                
                const schedules = [];
                scheduleSnap.forEach(doc => schedules.push(doc.data()));
                
                renderPromesContent(cpList, classFilter, semesterFilter, calendar, schedules);
                
            } catch (error) {
                console.error('Error loading Promes:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data</div>';
            }
        }

        function renderPromesContent(cpList, classNum, semester, calendar, schedules) {
            const container = document.getElementById('promesContent');
            const school = userProfile?.school || {};
            const years = getAcademicYears();
            
            // Generate meeting dates based on calendar and schedule
            const semesterKey = semester === '1' ? 'semester1' : 'semester2';
            const semesterData = calendar?.[semesterKey] || {};
            
            let startDate = semesterData.start ? new Date(semesterData.start) : new Date();
            let endDate = semesterData.end ? new Date(semesterData.end) : new Date();
            
            // Get months in semester
            const months = [];
            let currentMonth = new Date(startDate);
            while (currentMonth <= endDate) {
                months.push(new Date(currentMonth));
                currentMonth.setMonth(currentMonth.getMonth() + 1);
            }
            
            // Calculate meeting dates for each CP
            const cpWithDates = [];
            let currentDate = new Date(startDate);
            
            cpList.forEach(cp => {
                const meetings = [];
                const numMeetings = cp.pertemuan || 2;
                
                for (let i = 0; i < numMeetings; i++) {
                    // Skip weekends and holidays
                    while (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    if (currentDate <= endDate) {
                        meetings.push(new Date(currentDate));
                        currentDate.setDate(currentDate.getDate() + 7); // Weekly
                    }
                }
                
                cpWithDates.push({ ...cp, meetings });
            });
            
            container.innerHTML = `
                <div id="promesPrintArea">
                    <!-- Header -->
                    <div class="text-center mb-8 border-b-2 border-gray-800 pb-4">
                        <h2 class="text-lg font-bold">PROGRAM SEMESTER (PROMES)</h2>
                        <p class="text-sm">Tahun Pelajaran ${years[0]} - Semester ${semester}</p>
                    </div>
                    
                    <!-- Info -->
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                        <div>
                            <table class="w-full">
                                <tr><td class="py-1 w-32">Satuan Pendidikan</td><td>: ${school.name || '-'}</td></tr>
                                <tr><td class="py-1">Mata Pelajaran</td><td>: PAI dan Budi Pekerti</td></tr>
                                <tr><td class="py-1">Kelas</td><td>: ${classNum}</td></tr>
                            </table>
                        </div>
                        <div>
                            <table class="w-full">
                                <tr><td class="py-1 w-32">Semester</td><td>: ${semester}</td></tr>
                                <tr><td class="py-1">Tahun Pelajaran</td><td>: ${years[0]}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-400 text-xs">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-400 px-2 py-2 w-10" rowspan="2">No</th>
                                    <th class="border border-gray-400 px-2 py-2" rowspan="2">Materi/Bab</th>
                                    <th class="border border-gray-400 px-2 py-2" rowspan="2">Tujuan Pembelajaran</th>
                                    <th class="border border-gray-400 px-2 py-2 w-12" rowspan="2">JP</th>
                                    <th class="border border-gray-400 px-2 py-2" colspan="${months.length}">Bulan</th>
                                    <th class="border border-gray-400 px-2 py-2" rowspan="2">Ket</th>
                                </tr>
                                <tr class="bg-gray-100">
                                    ${months.map(m => `
                                        <th class="border border-gray-400 px-2 py-2 w-16">
                                            ${m.toLocaleDateString('id-ID', { month: 'short' })}
                                        </th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${cpWithDates.map((cp, index) => `
                                    <tr>
                                        <td class="border border-gray-400 px-2 py-2 text-center align-top">${index + 1}</td>
                                        <td class="border border-gray-400 px-2 py-2 align-top">
                                            <strong>Bab ${cp.bab || index + 1}</strong><br>
                                            ${cp.judul}
                                        </td>
                                        <td class="border border-gray-400 px-2 py-2 align-top">
                                            <ol class="list-decimal ml-3">
                                                ${(cp.tp || []).slice(0, 3).map(t => `<li>${t.substring(0, 50)}...</li>`).join('')}
                                            </ol>
                                        </td>
                                        <td class="border border-gray-400 px-2 py-2 text-center align-top">${(cp.pertemuan || 2) * 2}</td>
                                        ${months.map(m => {
                                            const meetingsInMonth = cp.meetings.filter(d => 
                                                d.getMonth() === m.getMonth() && d.getFullYear() === m.getFullYear()
                                            );
                                            return `
                                                <td class="border border-gray-400 px-2 py-2 text-center align-top">
                                                    ${meetingsInMonth.length > 0 ? 
                                                        meetingsInMonth.map(d => d.getDate()).join(', ') : 
                                                        ''
                                                    }
                                                </td>
                                            `;
                                        }).join('')}
                                        <td class="border border-gray-400 px-2 py-2 align-top">${cp.elemen || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Meeting Details -->
                    <div class="mt-6 text-sm">
                        <h4 class="font-bold mb-2">Detail Tanggal Pertemuan:</h4>
                        <div class="grid md:grid-cols-2 gap-4">
                            ${cpWithDates.map((cp, index) => `
                                <div class="border border-gray-200 rounded-lg p-3">
                                    <p class="font-medium">Bab ${cp.bab || index + 1}: ${cp.judul}</p>
                                    <ul class="text-gray-600 mt-1">
                                        ${cp.meetings.map((d, i) => `
                                            <li>Pertemuan ${i + 1}: ${d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Signature -->
                    <div class="mt-12 flex justify-between text-sm">
                        <div class="text-center">
                            <p>Mengetahui,</p>
                            <p>Kepala ${school.name || 'Sekolah'}</p>
                            <br><br><br><br>
                            <p class="font-bold border-b border-black inline-block">${school.principalName || '.............................'}</p>
                            <p>NIP. ................................</p>
                        </div>
                        <div class="text-center">
                            <p>${school.location || '.....................'}, ........................</p>
                            <p>Guru Mata Pelajaran</p>
                            <br><br><br><br>
                            <p class="font-bold border-b border-black inline-block">${userProfile?.name || ''}</p>
                            <p>NIP. ${userProfile?.nip || '................................'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function generatePromes() {
            const classFilter = document.getElementById('promesClassFilter').value;
            const semesterFilter = document.getElementById('promesSemesterFilter').value;
            
            if (!classFilter || !semesterFilter) {
                showToast('Pilih kelas dan semester terlebih dahulu', 'warning');
                return;
            }
            
            loadPromesData();
            showToast('Promes berhasil di-generate!', 'success');
        }

        function printPromes() {
            const printArea = document.getElementById('promesPrintArea');
            if (!printArea) {
                showToast('Generate Promes terlebih dahulu', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Promes - Print</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; font-size: 11px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #000; padding: 4px; }
                        th { background-color: #f0f0f0; }
                        @media print { body { padding: 0; } }
                        @page { size: landscape; }
                    </style>
                </head>
                <body>
                    ${printArea.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

    <!-- Journal Page -->
    <script>
        function renderJournal() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ““ Jurnal Pembelajaran</h1>
                            <p class="text-gray-500">Jurnal sinkron dengan Promes dan Absensi</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="addJournalEntry()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <span>â•</span> Tambah Jurnal
                            </button>
                            <button onclick="printJournal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors flex items-center gap-2">
                                <span>ğŸ–¨ï¸</span> Cetak
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div>
                            <select id="journalClassFilter" onchange="loadJournalData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Kelas</option>
                                ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <select id="journalSemesterFilter" onchange="loadJournalData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Semester</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                        <div>
                            <input type="month" id="journalMonthFilter" onchange="loadJournalData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                        </div>
                    </div>
                    
                    <!-- Journal Table -->
                    <div id="journalContent" class="bg-white rounded-2xl overflow-hidden">
                        <div class="text-center py-8 text-gray-500">Memuat data...</div>
                    </div>
                </div>
            `;
            
            loadJournalData();
        }

        async function loadJournalData() {
            const container = document.getElementById('journalContent');
            
            try {
                let query = db.collection('users').doc(currentUser.uid)
                    .collection('journals')
                    .orderBy('date', 'desc');
                
                const classFilter = document.getElementById('journalClassFilter').value;
                const semesterFilter = document.getElementById('journalSemesterFilter').value;
                
                if (classFilter) {
                    query = query.where('class', '==', classFilter);
                }
                
                const snapshot = await query.limit(50).get();
                
                const journals = [];
                snapshot.forEach(doc => journals.push({ id: doc.id, ...doc.data() }));
                
                if (journals.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-5xl mb-4">ğŸ““</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Belum Ada Jurnal</h3>
                            <p class="text-gray-500 mb-4">Mulai tambahkan jurnal pembelajaran</p>
                            <button onclick="addJournalEntry()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium">
                                + Tambah Jurnal
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="overflow-x-auto" id="journalPrintArea">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Materi</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tujuan Pembelajaran</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kehadiran</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Hari/Tanggal</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Hasil</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 no-print">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${journals.map((j, index) => `
                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="px-4 py-3 text-sm">${index + 1}</td>
                                        <td class="px-4 py-3 text-sm">${j.class}${j.rombel || ''}</td>
                                        <td class="px-4 py-3 text-sm">${j.materi || '-'}</td>
                                        <td class="px-4 py-3 text-sm">${j.tujuanPembelajaran || '-'}</td>
                                        <td class="px-4 py-3 text-center text-sm">
                                            <span class="text-green-600">H:${j.hadir || 0}</span>
                                            <span class="text-red-600 ml-1">S:${j.sakit || 0}</span>
                                            <span class="text-amber-600 ml-1">I:${j.izin || 0}</span>
                                            <span class="text-gray-600 ml-1">A:${j.alpa || 0}</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm">${j.date ? formatDate(j.date) : '-'}</td>
                                        <td class="px-4 py-3 text-sm">${j.hasil || '-'}</td>
                                        <td class="px-4 py-3 text-center no-print">
                                            <button onclick="editJournal('${j.id}')" class="p-1 text-primary-600 hover:bg-primary-50 rounded">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </button>
                                            <button onclick="deleteJournal('${j.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading journals:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data jurnal</div>';
            }
        }

        async function addJournalEntry() {
            // Load CP data for dropdown
            let cpOptions = '<option value="">Pilih dari Promes</option>';
            try {
                const cpSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('cp').orderBy('class').orderBy('bab').get();
                
                cpSnap.forEach(doc => {
                    const cp = doc.data();
                    cpOptions += `<option value="${doc.id}" data-materi="${cp.judul}" data-tp="${(cp.tp || []).join('; ')}">
                        Kelas ${cp.class} - Bab ${cp.bab}: ${cp.judul}
                    </option>`;
                });
            } catch (e) {
                console.error('Error loading CP for journal:', e);
            }
            
            const content = `
                <form id="journalForm" class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <input type="hidden" id="journalId" value="">
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas *</label>
                            <input type="text" id="journalClass" required placeholder="Contoh: 4A" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal *</label>
                            <input type="date" id="journalDate" required value="${new Date().toISOString().split('T')[0]}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ambil dari Promes (Opsional)</label>
                        <select id="journalCP" onchange="fillFromCP()" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            ${cpOptions}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Materi *</label>
                        <input type="text" id="journalMateri" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran</label>
                        <textarea id="journalTP" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hadir</label>
                            <input type="number" id="journalHadir" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sakit</label>
                            <input type="number" id="journalSakit" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Izin</label>
                            <input type="number" id="journalIzin" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alpa</label>
                            <input type="number" id="journalAlpa" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hasil Pembelajaran</label>
                        <textarea id="journalHasil" rows="3" placeholder="Catatan hasil pembelajaran..." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                        Simpan Jurnal
                    </button>
                </form>
            `;
            
            showModal(content, { title: 'ğŸ““ Tambah Jurnal Pembelajaran', size: 'xl' });
            document.getElementById('journalForm').addEventListener('submit', saveJournal);
        }

        function fillFromCP() {
            const select = document.getElementById('journalCP');
            const selected = select.options[select.selectedIndex];
            
            if (selected.value) {
                document.getElementById('journalMateri').value = selected.dataset.materi || '';
                document.getElementById('journalTP').value = selected.dataset.tp || '';
            }
        }

        async function saveJournal(e) {
            e.preventDefault();
            
            const id = document.getElementById('journalId').value || db.collection('temp').doc().id;
            const classVal = document.getElementById('journalClass').value;
            
            const data = {
                class: classVal.replace(/[A-Za-z]/g, ''),
                rombel: classVal.replace(/[0-9]/g, ''),
                date: document.getElementById('journalDate').value,
                materi: document.getElementById('journalMateri').value,
                tujuanPembelajaran: document.getElementById('journalTP').value,
                hadir: parseInt(document.getElementById('journalHadir').value) || 0,
                sakit: parseInt(document.getElementById('journalSakit').value) || 0,
                izin: parseInt(document.getElementById('journalIzin').value) || 0,
                alpa: parseInt(document.getElementById('journalAlpa').value) || 0,
                hasil: document.getElementById('journalHasil').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('journals').doc(id).set(data, { merge: true });
                
                closeModal(document.querySelector('.modal-overlay button'));
                showToast('Jurnal berhasil disimpan!', 'success');
                loadJournalData();
            } catch (error) {
                console.error('Error saving journal:', error);
                showToast('Gagal menyimpan jurnal', 'error');
            }
        }

        async function deleteJournal(id) {
            if (!confirm('Yakin ingin menghapus jurnal ini?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('journals').doc(id).delete();
                showToast('Jurnal berhasil dihapus', 'success');
                loadJournalData();
            } catch (error) {
                console.error('Error deleting journal:', error);
                showToast('Gagal menghapus jurnal', 'error');
            }
        }

        function printJournal() {
            const printArea = document.getElementById('journalPrintArea');
            if (!printArea) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Jurnal Pembelajaran</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        .no-print { display: none; }
                        h2 { text-align: center; }
                    </style>
                </head>
                <body>
                    <h2>JURNAL PEMBELAJARAN</h2>
                    <p>Mata Pelajaran: PAI dan Budi Pekerti</p>
                    <p>Tahun Pelajaran: ${getAcademicYears()[0]}</p>
                    ${printArea.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

    <!-- Attendance Page -->
    <script>
        function renderAttendance() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">âœ… Absensi Siswa</h1>
                            <p class="text-gray-500">Input absensi manual yang otomatis sinkron dengan Jurnal</p>
                        </div>
                    </div>
                    
                    <!-- Select Class and Date -->
                    <div class="bg-white rounded-2xl p-6 mb-6">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                                <select id="attendanceClass" onchange="loadStudentsForAttendance()" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="">-- Pilih Kelas --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="attendanceDate" value="${new Date().toISOString().split('T')[0]}" onchange="loadStudentsForAttendance()" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div class="flex items-end">
                                <button onclick="saveAttendance()" class="w-full px-4 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                                    ğŸ’¾ Simpan Absensi
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attendance Table -->
                    <div id="attendanceContent" class="bg-white rounded-2xl p-6">
                        <div class="text-center py-8 text-gray-500">
                            Pilih kelas untuk menampilkan daftar siswa
                        </div>
                    </div>
                </div>
            `;
            
            loadClassesForAttendance();
        }

        async function loadClassesForAttendance() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('students').get();
                
                const classes = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    classes.add(`${data.class}${data.rombel || ''}`);
                });
                
                const select = document.getElementById('attendanceClass');
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadStudentsForAttendance() {
            const classFilter = document.getElementById('attendanceClass').value;
            const date = document.getElementById('attendanceDate').value;
            const container = document.getElementById('attendanceContent');
            
            if (!classFilter) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Pilih kelas untuk menampilkan daftar siswa</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
            
            try {
                // Get students
                const classNum = classFilter.replace(/[A-Za-z]/g, '');
                const rombel = classFilter.replace(/[0-9]/g, '');
                
                let query = db.collection('users').doc(currentUser.uid)
                    .collection('students')
                    .where('class', '==', classNum);
                
                const snapshot = await query.orderBy('name').get();
                
                const students = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!rombel || data.rombel === rombel) {
                        students.push({ id: doc.id, ...data });
                    }
                });
                
                // Get existing attendance for this date
                const attendanceDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('attendance')
                    .doc(`${classFilter}_${date}`)
                    .get();
                
                const existingAttendance = attendanceDoc.exists ? attendanceDoc.data().records || {} : {};
                
                container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-12">No</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 w-20">L/P</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Hadir</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Sakit</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Izin</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Alpa</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody">
                                ${students.map((s, i) => {
                                    const status = existingAttendance[s.id] || 'H';
                                    return `
                                        <tr class="border-b border-gray-100">
                                            <td class="px-4 py-3 text-sm">${i + 1}</td>
                                            <td class="px-4 py-3 text-sm font-medium">${s.name}</td>
                                            <td class="px-4 py-3 text-center text-sm">${s.gender}</td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="attendance_${s.id}" value="H" ${status === 'H' ? 'checked' : ''} class="w-5 h-5 text-green-600">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="attendance_${s.id}" value="S" ${status === 'S' ? 'checked' : ''} class="w-5 h-5 text-amber-600">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="attendance_${s.id}" value="I" ${status === 'I' ? 'checked' : ''} class="w-5 h-5 text-blue-600">
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <input type="radio" name="attendance_${s.id}" value="A" ${status === 'A' ? 'checked' : ''} class="w-5 h-5 text-red-600">
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Summary -->
                    <div class="mt-4 p-4 bg-gray-50 rounded-xl flex flex-wrap gap-4">
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-green-500"></span>
                            <span>Hadir (H)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-amber-500"></span>
                            <span>Sakit (S)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-blue-500"></span>
                            <span>Izin (I)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-red-500"></span>
                            <span>Alpa (A)</span>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading students:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data siswa</div>';
            }
        }

        async function saveAttendance() {
            const classFilter = document.getElementById('attendanceClass').value;
            const date = document.getElementById('attendanceDate').value;
            
            if (!classFilter) {
                showToast('Pilih kelas terlebih dahulu', 'warning');
                return;
            }
            
            const records = {};
            const summary = { H: 0, S: 0, I: 0, A: 0 };
            
            document.querySelectorAll('#attendanceTableBody input[type="radio"]:checked').forEach(input => {
                const studentId = input.name.replace('attendance_', '');
                records[studentId] = input.value;
                summary[input.value]++;
            });
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('attendance')
                    .doc(`${classFilter}_${date}`)
                    .set({
                        class: classFilter,
                        date: date,
                        records: records,
                        summary: summary,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                showToast('Absensi berhasil disimpan!', 'success');
                
            } catch (error) {
                console.error('Error saving attendance:', error);
                showToast('Gagal menyimpan absensi', 'error');
            }
        }
    </script>

    <!-- Grades Page -->
    <script>
        function renderGrades() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š Daftar Nilai</h1>
                            <p class="text-gray-500">Kelola nilai PH, PTS, PAS, dan Nilai Rapor</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="manageGradeTypes()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                                âš™ï¸ Atur Jenis Nilai
                            </button>
                            <button onclick="printGrades()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700 transition-colors">
                                ğŸ–¨ï¸ Cetak
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div>
                            <select id="gradesClass" onchange="loadGradesData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Pilih Kelas</option>
                            </select>
                        </div>
                        <div>
                            <select id="gradesSemester" onchange="loadGradesData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Grades Table -->
                    <div id="gradesContent" class="bg-white rounded-2xl p-6">
                        <div class="text-center py-8 text-gray-500">
                            Pilih kelas untuk menampilkan daftar nilai
                        </div>
                    </div>
                </div>
            `;
            
            loadClassesForGrades();
        }

        async function loadClassesForGrades() {
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('students').get();
                
                const classes = new Set();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    classes.add(`${data.class}${data.rombel || ''}`);
                });
                
                const select = document.getElementById('gradesClass');
                select.innerHTML = '<option value="">Pilih Kelas</option>' + 
                    Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`).join('');
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadGradesData() {
            const classFilter = document.getElementById('gradesClass').value;
            const semester = document.getElementById('gradesSemester').value;
            const container = document.getElementById('gradesContent');
            
            if (!classFilter) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">Pilih kelas untuk menampilkan daftar nilai</div>';
                return;
            }
            
            container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
            
            try {
                const classNum = classFilter.replace(/[A-Za-z]/g, '');
                const rombel = classFilter.replace(/[0-9]/g, '');
                
                // Get students
                let query = db.collection('users').doc(currentUser.uid)
                    .collection('students')
                    .where('class', '==', classNum);
                
                const snapshot = await query.orderBy('name').get();
                
                const students = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!rombel || data.rombel === rombel) {
                        students.push({ id: doc.id, ...data });
                    }
                });
                
                // Get grades
                const gradesDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('grades')
                    .doc(`${classFilter}_${semester}`)
                    .get();
                
                const gradesData = gradesDoc.exists ? gradesDoc.data() : { types: ['PH1', 'PH2', 'PTS', 'PAS'], scores: {} };
                const gradeTypes = gradesData.types || ['PH1', 'PH2', 'PTS', 'PAS'];
                
                container.innerHTML = `
                    <div class="overflow-x-auto" id="gradesPrintArea">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-3 py-2 text-left font-semibold text-gray-700 w-10">No</th>
                                    <th class="px-3 py-2 text-left font-semibold text-gray-700">Nama Siswa</th>
                                    ${gradeTypes.map(t => `<th class="px-3 py-2 text-center font-semibold text-gray-700 w-16">${t}</th>`).join('')}
                                    <th class="px-3 py-2 text-center font-semibold text-gray-700 w-16 bg-green-50">NR</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map((s, i) => {
                                    const scores = gradesData.scores?.[s.id] || {};
                                    return `
                                        <tr class="border-b border-gray-100">
                                            <td class="px-3 py-2">${i + 1}</td>
                                            <td class="px-3 py-2 font-medium">${s.name}</td>
                                            ${gradeTypes.map(t => `
                                                <td class="px-3 py-2 text-center">
                                                    <input type="number" 
                                                           class="grade-input w-14 px-2 py-1 border border-gray-200 rounded text-center" 
                                                           data-student="${s.id}" 
                                                           data-type="${t}" 
                                                           value="${scores[t] || ''}" 
                                                           min="0" 
                                                           max="100"
                                                           onchange="calculateNR('${s.id}')">
                                                </td>
                                            `).join('')}
                                            <td class="px-3 py-2 text-center bg-green-50">
                                                <span id="nr_${s.id}" class="font-bold text-green-600">${calculateStudentNR(scores, gradeTypes)}</span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button onclick="saveGrades()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                            ğŸ’¾ Simpan Nilai
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading grades:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data nilai</div>';
            }
        }

        function calculateStudentNR(scores, types) {
            const values = types.map(t => parseFloat(scores[t]) || 0).filter(v => v > 0);
            if (values.length === 0) return '-';
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            return Math.round(avg);
        }

        function calculateNR(studentId) {
            const inputs = document.querySelectorAll(`input[data-student="${studentId}"]`);
            const values = [];
            inputs.forEach(input => {
                const val = parseFloat(input.value);
                if (val > 0) values.push(val);
            });
            
            const nrElement = document.getElementById(`nr_${studentId}`);
            if (values.length === 0) {
                nrElement.textContent = '-';
            } else {
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                nrElement.textContent = Math.round(avg);
            }
        }

        async function saveGrades() {
            const classFilter = document.getElementById('gradesClass').value;
            const semester = document.getElementById('gradesSemester').value;
            
            if (!classFilter) {
                showToast('Pilih kelas terlebih dahulu', 'warning');
                return;
            }
            
            const scores = {};
            document.querySelectorAll('.grade-input').forEach(input => {
                const studentId = input.dataset.student;
                const type = input.dataset.type;
                const value = parseFloat(input.value) || 0;
                
                if (!scores[studentId]) scores[studentId] = {};
                scores[studentId][type] = value;
            });
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('grades')
                    .doc(`${classFilter}_${semester}`)
                    .set({
                        class: classFilter,
                        semester: semester,
                        types: ['PH1', 'PH2', 'PTS', 'PAS'],
                        scores: scores,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                
                showToast('Nilai berhasil disimpan!', 'success');
                
            } catch (error) {
                console.error('Error saving grades:', error);
                showToast('Gagal menyimpan nilai', 'error');
            }
        }

        function manageGradeTypes() {
            const content = `
                <div class="space-y-4">
                    <p class="text-gray-600">Atur jenis penilaian yang digunakan.</p>
                    
                    <div id="gradeTypesList" class="space-y-2">
                        <div class="flex items-center gap-2">
                            <input type="text" value="PH1" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            <button onclick="this.parentElement.remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Ã—</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="text" value="PH2" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            <button onclick="this.parentElement.remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Ã—</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="text" value="PTS" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            <button onclick="this.parentElement.remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Ã—</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="text" value="PAS" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            <button onclick="this.parentElement.remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Ã—</button>
                        </div>
                    </div>
                    
                    <button onclick="addGradeType()" class="text-primary-600 font-medium hover:underline">+ Tambah Jenis Nilai</button>
                    
                    <button onclick="saveGradeTypes()" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                        Simpan Pengaturan
                    </button>
                </div>
            `;
            
            showModal(content, { title: 'âš™ï¸ Atur Jenis Nilai', size: 'md' });
        }

        function addGradeType() {
            const list = document.getElementById('gradeTypesList');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="text" value="PH" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                <button onclick="this.parentElement.remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">Ã—</button>
            `;
            list.appendChild(div);
        }

        function printGrades() {
            const printArea = document.getElementById('gradesPrintArea');
            if (!printArea) return;
            
            const classFilter = document.getElementById('gradesClass').value;
            const semester = document.getElementById('gradesSemester').value;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daftar Nilai</title>
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: center; }
                        th { background-color: #f0f0f0; }
                        input { border: none; text-align: center; }
                        h2 { text-align: center; }
                    </style>
                </head>
                <body>
                    <h2>DAFTAR NILAI</h2>
                    <p>Mata Pelajaran: PAI dan Budi Pekerti</p>
                    <p>Kelas: ${classFilter} | Semester: ${semester} | Tahun Pelajaran: ${getAcademicYears()[0]}</p>
                    ${printArea.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

    <!-- AI Assistant Page -->
    <script>
        function renderAIAssistant() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ¤– AI Assistant</h1>
                            <p class="text-gray-500">Dapatkan prompt AI untuk membantu persiapan data</p>
                        </div>
                    </div>
                    
                    <!-- Prompt Templates -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ Template Prompt</h2>
                            <p class="text-gray-600 mb-4">Pilih jenis bantuan yang Anda butuhkan:</p>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <button onclick="showPrompt('cp')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-300 border-2 border-transparent transition-colors text-left">
                                    <div class="text-2xl mb-2">ğŸ¯</div>
                                    <h3 class="font-bold text-gray-800">Generate TP dari CP</h3>
                                    <p class="text-sm text-gray-500">Breakdown Capaian Pembelajaran menjadi Tujuan Pembelajaran</p>
                                </button>
                                
                                <button onclick="showPrompt('materi')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-300 border-2 border-transparent transition-colors text-left">
                                    <div class="text-2xl mb-2">ğŸ“š</div>
                                    <h3 class="font-bold text-gray-800">Generate Materi</h3>
                                    <p class="text-sm text-gray-500">Buat materi pembelajaran dari TP</p>
                                </button>
                                
                                <button onclick="showPrompt('soal')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-300 border-2 border-transparent transition-colors text-left">
                                    <div class="text-2xl mb-2">â“</div>
                                    <h3 class="font-bold text-gray-800">Generate Soal</h3>
                                    <p class="text-sm text-gray-500">Buat soal penilaian dari materi</p>
                                </button>
                                
                                <button onclick="showPrompt('csv')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-300 border-2 border-transparent transition-colors text-left">
                                    <div class="text-2xl mb-2">ğŸ“Š</div>
                                    <h3 class="font-bold text-gray-800">Format ke CSV</h3>
                                    <p class="text-sm text-gray-500">Konversi data mentah ke format CSV</p>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Prompt Output -->
                        <div id="promptOutput" class="hidden bg-white rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold text-gray-800">ğŸ“‹ Prompt untuk AI</h2>
                                <button onclick="copyPrompt()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">
                                    ğŸ“‹ Copy Prompt
                                </button>
                            </div>
                            <div id="promptText" class="bg-gray-50 rounded-xl p-4 text-sm text-gray-700 whitespace-pre-wrap"></div>
                            
                            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                                <h4 class="font-medium text-blue-800 mb-2">ğŸ’¡ Cara Penggunaan:</h4>
                                <ol class="text-sm text-blue-700 list-decimal ml-4 space-y-1">
                                    <li>Copy prompt di atas</li>
                                    <li>Buka ChatGPT, Claude, atau AI assistant lainnya</li>
                                    <li>Paste prompt dan sesuaikan bagian yang perlu diisi</li>
                                    <li>Hasil dari AI bisa langsung di-copy ke aplikasi ini</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showPrompt(type) {
            const prompts = {
                cp: `Saya adalah guru PAI SD/MI. Tolong bantu saya breakdown Capaian Pembelajaran berikut menjadi beberapa Tujuan Pembelajaran (TP) yang SMART (Specific, Measurable, Achievable, Relevant, Time-bound).

CAPAIAN PEMBELAJARAN:
[Paste CP di sini]

KELAS: [Isi kelas]
SEMESTER: [Isi semester]

Tolong buatkan 3-5 Tujuan Pembelajaran yang:
1. Menggunakan kata kerja operasional yang terukur
2. Sesuai dengan tingkat perkembangan siswa
3. Dapat dicapai dalam 2-4 pertemuan
4. Format: "Peserta didik dapat [kata kerja operasional] [objek] [kondisi]"`,
                
                materi: `Saya adalah guru PAI SD/MI. Tolong bantu saya membuat materi pembelajaran berdasarkan Tujuan Pembelajaran berikut:

TUJUAN PEMBELAJARAN:
[Paste TP di sini]

KELAS: [Isi kelas]
DURASI: [Isi durasi, misal: 2 x 35 menit]

Tolong buatkan materi yang:
1. Sesuai dengan tingkat pemahaman siswa SD
2. Menggunakan bahasa sederhana
3. Dilengkapi contoh-contoh konkret
4. Terdapat kegiatan interaktif
5. Jika ada teks Arab, sertakan juga transliterasi latinnya`,
                
                soal: `Saya adalah guru PAI SD/MI. Tolong bantu saya membuat soal penilaian berdasarkan materi berikut:

MATERI/TOPIK:
[Paste materi di sini]

KELAS: [Isi kelas]
JUMLAH SOAL: [Isi jumlah]
JENIS SOAL: [Pilihan ganda / Isian / Uraian]

Tolong buatkan soal yang:
1. Sesuai dengan tingkat kognitif siswa SD
2. Memiliki kunci jawaban
3. Terdistribusi dari mudah ke sulit
4. Untuk pilihan ganda: 4 opsi (A, B, C, D)`,
                
                csv: `Tolong bantu saya mengkonversi data berikut ke format CSV yang bisa diimport ke aplikasi.

DATA MENTAH:
[Paste data mentah di sini]

FORMAT CSV YANG DIBUTUHKAN:
[Sebutkan format kolom, contoh: nisn,nama,jenis_kelamin,kelas,rombel]

Tolong:
1. Konversi data ke format CSV
2. Pastikan setiap kolom terpisah dengan koma
3. Baris pertama adalah header
4. Hapus karakter khusus yang tidak diperlukan`
            };
            
            document.getElementById('promptOutput').classList.remove('hidden');
            document.getElementById('promptText').textContent = prompts[type];
        }

        function copyPrompt() {
            const promptText = document.getElementById('promptText').textContent;
            navigator.clipboard.writeText(promptText).then(() => {
                showToast('Prompt berhasil di-copy!', 'success');
            }).catch(() => {
                showToast('Gagal meng-copy prompt', 'error');
            });
        }
    </script>

    <!-- Guide Page -->
    <script>
        function renderGuide() {
            const content = document.getElementById('contentArea');
            
            content.innerHTML = `
                <div class="animate-fade-in max-w-4xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-gray-800">ğŸ“š Panduan Penggunaan</h1>
                        <p class="text-gray-500">Pelajari cara menggunakan Admin Guru Super App</p>
                    </div>
                    
                    <!-- Table of Contents -->
                    <div class="bg-white rounded-2xl p-6 mb-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“‘ Daftar Isi</h2>
                        <ul class="space-y-2">
                            <li><a href="#guide-intro" class="text-primary-600 hover:underline">1. Pengenalan Aplikasi</a></li>
                            <li><a href="#guide-start" class="text-primary-600 hover:underline">2. Memulai Penggunaan</a></li>
                            <li><a href="#guide-data" class="text-primary-600 hover:underline">3. Input Data Dasar</a></li>
                            <li><a href="#guide-docs" class="text-primary-600 hover:underline">4. Generate Dokumen</a></li>
                            <li><a href="#guide-daily" class="text-primary-600 hover:underline">5. Penggunaan Harian</a></li>
                            <li><a href="#guide-faq" class="text-primary-600 hover:underline">6. FAQ</a></li>
                        </ul>
                    </div>
                    
                    <!-- Content -->
                    <div class="space-y-6">
                        <!-- Introduction -->
                        <div id="guide-intro" class="bg-white rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">1. Pengenalan Aplikasi</h2>
                            <p class="text-gray-600 mb-4">
                                Admin Guru Super App adalah aplikasi yang membantu guru mengotomatisasi administrasi mengajar dengan konsep 
                                <strong>Single Input - Multi Output</strong>. Artinya, Anda cukup memasukkan data dasar sekali, dan sistem akan 
                                menghasilkan berbagai dokumen yang saling sinkron.
                            </p>
                            
                            <div class="bg-primary-50 rounded-xl p-4 mb-4">
                                <h3 class="font-bold text-primary-800 mb-2">ğŸ¯ Konsep Single Input - Multi Output:</h3>
                                <ul class="text-sm text-primary-700 space-y-1">
                                    <li>âœ… Input: Kalender Pendidikan, Jadwal, CP/TP</li>
                                    <li>âœ… Output: ATP, Prota, Promes, Modul Ajar, Jurnal, LKPD</li>
                                </ul>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="border border-gray-200 rounded-xl p-4">
                                    <h4 class="font-bold text-gray-800 mb-2">ğŸ†“ Fitur Gratis</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>â€¢ Kalender Pendidikan</li>
                                        <li>â€¢ Jadwal Pelajaran</li>
                                        <li>â€¢ Data Siswa</li>
                                        <li>â€¢ ATP, Prota, Promes</li>
                                        <li>â€¢ Jurnal & Absensi</li>
                                        <li>â€¢ Daftar Nilai</li>
                                    </ul>
                                </div>
                                <div class="border border-amber-200 bg-amber-50 rounded-xl p-4">
                                    <h4 class="font-bold text-amber-800 mb-2">â­ Fitur Premium</h4>
                                    <ul class="text-sm text-amber-700 space-y-1">
                                        <li>â€¢ Modul Ajar Lengkap</li>
                                        <li>â€¢ LKPD Generator</li>
                                        <li>â€¢ Bank Soal</li>
                                        <li>â€¢ Support Teks Arab</li>
                                        <li>â€¢ Export PDF</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Getting Started -->
                        <div id="guide-start" class="bg-white rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">2. Memulai Penggunaan</h2>
                            
                            <div class="space-y-4">
                                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl">
                                    <div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">1</div>
                                    <div>
                                        <h4 class="font-bold text-gray-800">Lengkapi Profil</h4>
                                        <p class="text-sm text-gray-600">Isi data diri, sekolah, dan mata pelajaran yang diampu di menu Profil.</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl">
                                    <div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">2</div>
                                    <div>
                                        <h4 class="font-bold text-gray-800">Atur Kalender</h4>
                                        <p class="text-sm text-gray-600">Tentukan tanggal awal dan akhir semester, serta hari libur khusus.</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl">
                                    <div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">3</div>
                                    <div>
                                        <h4 class="font-bold text-gray-800">Buat Jadwal</h4>
                                        <p class="text-sm text-gray-600">Isi jadwal mengajar mingguan dengan kelas dan jam pelajaran.</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl">
                                    <div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">4</div>
                                    <div>
                                        <h4 class="font-bold text-gray-800">Import Data Siswa</h4>
                                        <p class="text-sm text-gray-600">Import data siswa dari file CSV atau tambah manual satu per satu.</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl">
                                    <div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0">5</div>
                                    <div>
                                        <h4 class="font-bold text-gray-800">Input CP/TP</h4>
                                        <p class="text-sm text-gray-600">Untuk PAI, gunakan CP default. Untuk mapel lain, input CP secara manual.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Input Data -->
                        <div id="guide-data" class="bg-white rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">3. Input Data Dasar</h2>
                            
                            <h3 class="font-bold text-gray-800 mb-2">ğŸ“Š Import Data via CSV</h3>
                            <p class="text-gray-600 mb-4">
                                Aplikasi mendukung import data dari Google Spreadsheet yang dipublikasi sebagai CSV. 
                                Caranya:
                            </p>
                            <ol class="list-decimal ml-6 text-gray-600 space-y-2 mb-4">
                                <li>Buat spreadsheet di Google Sheets</li>
                                <li>Isi data sesuai format yang ditentukan</li>
                                <li>Klik File â†’ Share â†’ Publish to Web</li>
                                <li>Pilih format CSV dan copy link</li>
                                <li>Paste link di fitur import aplikasi</li>
                            </ol>
                            
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h4 class="font-bold text-gray-700 mb-2">Format CSV Data Siswa:</h4>
                                <code class="text-sm text-primary-600">nisn,nama,jenis_kelamin,kelas,rombel</code>
                                <p class="text-xs text-gray-500 mt-1">Contoh: 1234567890,Ahmad Fauzi,L,4,A</p>
                            </div>
                        </div>
                        
                        <!-- Generate Documents -->
                        <div id="guide-docs" class="bg-white rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">4. Generate Dokumen</h2>
                            
                            <p class="text-gray-600 mb-4">
                                Setelah data dasar lengkap, Anda dapat generate berbagai dokumen secara otomatis:
                            </p>
                            
                            <div class="space-y-3">
                                <div class="border border-gray-200 rounded-xl p-4">
                                    <h4 class="font-bold text-gray-800">ğŸ“‹ ATP (Alur Tujuan Pembelajaran)</h4>
                                    <p class="text-sm text-gray-600">Dihasilkan dari data CP/TP yang sudah diinput. Pilih kelas dan semester, lalu klik Generate.</p>
                                </div>
                                
                                <div class="border border-gray-200 rounded-xl p-4">
                                    <h4 class="font-bold text-gray-800">ğŸ“† Prota (Program Tahunan)</h4>
                                    <p class="text-sm text-gray-600">Menampilkan ringkasan materi untuk semester 1 dan 2 beserta alokasi JP.</p>
                                </div>
                                
                                <div class="border border-gray-200 rounded-xl p-4">
                                    <h4 class="font-bold text-gray-800">ğŸ“‘ Promes (Program Semester)</h4>
                                    <p class="text-sm text-gray-600">Detail jadwal pertemuan per materi berdasarkan kalender dan jadwal yang sudah diatur.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Daily Usage -->
                        <div id="guide-daily" class="bg-white rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">5. Penggunaan Harian</h2>
                            
                            <div class="space-y-3">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">âœ…</span>
                                    <div>
                                        <h4 class="font-bold text-gray-800">Absensi</h4>
                                        <p class="text-sm text-gray-600">Lakukan absensi setiap pertemuan. Data otomatis terhubung ke jurnal.</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">ğŸ““</span>
                                    <div>
                                        <h4 class="font-bold text-gray-800">Jurnal</h4>
                                        <p class="text-sm text-gray-600">Isi jurnal pembelajaran. Materi dan TP bisa diambil otomatis dari Promes.</p>
                                    </div>
                                </div>
                                
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">ğŸ“Š</span>
                                    <div>
                                        <h4 class="font-bold text-gray-800">Penilaian</h4>
                                        <p class="text-sm text-gray-600">Input nilai PH, PTS, PAS. Nilai Rapor dihitung otomatis.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- FAQ -->
                        <div id="guide-faq" class="bg-white rounded-2xl p-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">6. FAQ (Pertanyaan Umum)</h2>
                            
                            <div class="space-y-4">
                                <div class="border-b border-gray-100 pb-4">
                                    <h4 class="font-bold text-gray-800 mb-2">Bagaimana cara upgrade ke Premium?</h4>
                                    <p class="text-sm text-gray-600">Klik tombol "Upgrade Premium" di sidebar, lalu hubungi admin melalui WhatsApp.</p>
                                </div>
                                
                                <div class="border-b border-gray-100 pb-4">
                                    <h4 class="font-bold text-gray-800 mb-2">Apakah data saya aman?</h4>
                                    <p class="text-sm text-gray-600">Ya, data disimpan di Firebase dan hanya bisa diakses oleh akun Anda.</p>
                                </div>
                                
                                <div class="border-b border-gray-100 pb-4">
                                    <h4 class="font-bold text-gray-800 mb-2">Bagaimana jika jadwal bentrok?</h4>
                                    <p class="text-sm text-gray-600">Sistem akan memberikan peringatan jika ada jadwal yang konflik.</p>
                                </div>
                                
                                <div>
                                    <h4 class="font-bold text-gray-800 mb-2">Apakah bisa diakses dari HP?</h4>
                                    <p class="text-sm text-gray-600">Ya, aplikasi ini responsif dan bisa diakses dari smartphone maupun tablet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>

       <!-- Continuing Modul Ajar, LKPD, Bank Soal (Premium) -->
    <script>
        function renderModul() {
            if (!isPremiumUser()) {
                showUpgradeModal();
                return;
            }
            
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ“– Modul Ajar</h1>
                            <p class="text-gray-500">Modul Ajar terintegrasi dengan Promes, Jurnal, dan LKPD</p>
                        </div>
                        <button onclick="createModul()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                            â• Buat Modul
                        </button>
                    </div>
                    
                    <!-- Filter -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div>
                            <select id="modulClassFilter" onchange="loadModulData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Kelas</option>
                                ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <select id="modulSemesterFilter" onchange="loadModulData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Semester</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="modulList" class="space-y-4">
                        <div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>
                    </div>
                </div>
            `;
            
            loadModulData();
        }

        async function loadModulData() {
            const container = document.getElementById('modulList');
            const classFilter = document.getElementById('modulClassFilter')?.value;
            const semesterFilter = document.getElementById('modulSemesterFilter')?.value;
            
            try {
                let query = db.collection('users').doc(currentUser.uid)
                    .collection('modules')
                    .orderBy('createdAt', 'desc');
                
                const snapshot = await query.get();
                
                let modules = [];
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if ((!classFilter || data.class === classFilter) && 
                        (!semesterFilter || data.semester === semesterFilter)) {
                        modules.push(data);
                    }
                });
                
                if (modules.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-2xl p-8 text-center">
                            <div class="text-6xl mb-4">ğŸ“–</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Belum Ada Modul Ajar</h3>
                            <p class="text-gray-500 mb-4">Buat modul ajar pertama Anda yang terintegrasi dengan dokumen lainnya.</p>
                            <button onclick="createModul()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                                + Buat Modul Ajar
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = modules.map(modul => `
                    <div class="bg-white rounded-2xl p-6 card-hover">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-1 text-xs font-medium bg-primary-100 text-primary-700 rounded">Kelas ${modul.class}</span>
                                    <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded">Semester ${modul.semester}</span>
                                    <span class="px-2 py-1 text-xs font-medium bg-amber-100 text-amber-700 rounded">${modul.elemen || 'Umum'}</span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800 mb-2">${modul.judul}</h3>
                                <p class="text-sm text-gray-600 mb-3">${modul.tujuanPembelajaran || ''}</p>
                                <div class="flex items-center gap-4 text-sm text-gray-500">
                                    <span>ğŸ“… ${modul.pertemuan || 1} Pertemuan</span>
                                    <span>â±ï¸ ${modul.alokasi || '2 x 35'} menit</span>
                                    ${modul.hasLKPD ? '<span class="text-green-600">ğŸ“ LKPD Tersedia</span>' : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="viewModul('${modul.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg" title="Lihat">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </button>
                                <button onclick="editModul('${modul.id}')" class="p-2 text-gray-600 hover:bg-gray-50 rounded-lg" title="Edit">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button onclick="printModul('${modul.id}')" class="p-2 text-gray-600 hover:bg-gray-50 rounded-lg" title="Cetak">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                    </svg>
                                </button>
                                <button onclick="deleteModul('${modul.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg" title="Hapus">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading modules:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data modul</div>';
            }
        }

        async function createModul() {
            // Load CP data for selection
            let cpOptions = '<option value="">-- Pilih dari CP/TP --</option>';
            try {
                const cpSnap = await db.collection('users').doc(currentUser.uid)
                    .collection('cp').orderBy('class').orderBy('bab').get();
                
                cpSnap.forEach(doc => {
                    const cp = doc.data();
                    cpOptions += `<option value="${doc.id}" 
                        data-class="${cp.class}" 
                        data-semester="${cp.semester}" 
                        data-elemen="${cp.elemen || ''}"
                        data-judul="${cp.judul || ''}"
                        data-tp="${JSON.stringify(cp.tp || []).replace(/"/g, '&quot;')}"
                        data-materi="${JSON.stringify(cp.materi || []).replace(/"/g, '&quot;')}"
                        data-aktivitas="${JSON.stringify(cp.aktivitas || []).replace(/"/g, '&quot;')}"
                        data-karakter="${JSON.stringify(cp.karakter || []).replace(/"/g, '&quot;')}">
                        Kelas ${cp.class} - Bab ${cp.bab}: ${cp.judul}
                    </option>`;
                });
            } catch (e) {
                console.error('Error loading CP:', e);
            }
            
            const content = `
                <form id="modulForm" class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <input type="hidden" id="modulId" value="">
                    
                    <!-- CP Selection -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <label class="block text-sm font-medium text-blue-800 mb-2">ğŸ“š Ambil Data dari CP (Opsional)</label>
                        <select id="modulCP" onchange="fillModulFromCP()" class="w-full px-4 py-3 border border-blue-200 rounded-xl bg-white">
                            ${cpOptions}
                        </select>
                        <p class="text-xs text-blue-600 mt-1">Pilih CP untuk mengisi data modul secara otomatis</p>
                    </div>
                    
                    <!-- Basic Info -->
                    <div class="grid md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas *</label>
                            <select id="modulClass" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Semester *</label>
                            <select id="modulSemester" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pertemuan</label>
                            <input type="number" id="modulPertemuan" value="1" min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alokasi Waktu</label>
                            <input type="text" id="modulAlokasi" value="2 x 35 menit" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Elemen</label>
                            <select id="modulElemen" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="">Pilih Elemen</option>
                                <option value="Al-Qur'an dan Hadis">Al-Qur'an dan Hadis</option>
                                <option value="Akidah">Akidah</option>
                                <option value="Akhlak">Akhlak</option>
                                <option value="Fikih">Fikih</option>
                                <option value="Sejarah Peradaban Islam">Sejarah Peradaban Islam</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fase</label>
                            <select id="modulFase" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="A">Fase A (Kelas 1-2)</option>
                                <option value="B">Fase B (Kelas 3-4)</option>
                                <option value="C">Fase C (Kelas 5-6)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Judul/Topik *</label>
                        <input type="text" id="modulJudul" required class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran</label>
                        <textarea id="modulTP" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <!-- Profil Pelajar Pancasila / 8 Dimensi -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Profil Lulusan (8 Dimensi)</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            ${['Keimanan', 'Kewargaan', 'Penalaran Kritis', 'Kreativitas', 'Kolaborasi', 'Kemandirian', 'Kesehatan', 'Komunikasi'].map(d => `
                                <label class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" name="modulDimensi" value="${d}" class="w-4 h-4 rounded text-primary-600">
                                    <span class="text-sm">${d}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sarana dan Prasarana</label>
                        <textarea id="modulSarana" rows="2" placeholder="Al-Qur'an, buku teks, papan tulis, proyektor, dll." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <!-- Kegiatan Pembelajaran -->
                    <div class="border border-gray-200 rounded-xl p-4">
                        <h4 class="font-bold text-gray-800 mb-3">ğŸ¯ Kegiatan Pembelajaran</h4>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pendahuluan</label>
                                <textarea id="modulPendahuluan" rows="3" placeholder="Kegiatan pembuka: salam, doa, apersepsi, motivasi..." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan Inti</label>
                                <textarea id="modulInti" rows="5" placeholder="Kegiatan inti pembelajaran..." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Penutup</label>
                                <textarea id="modulPenutup" rows="3" placeholder="Kesimpulan, refleksi, doa penutup..." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Materi (Support Arabic) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Materi Pembelajaran</label>
                        <p class="text-xs text-gray-500 mb-2">Mendukung teks Arab (otomatis RTL untuk teks Arab)</p>
                        <textarea id="modulMateri" rows="5" placeholder="Isi materi pembelajaran di sini. Untuk teks Arab, ketik langsung dan akan ditampilkan dari kanan ke kiri." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <!-- Penilaian -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asesmen/Penilaian</label>
                        <textarea id="modulAsesmen" rows="3" placeholder="Jenis penilaian: formatif, sumatif, teknik, instrumen..." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <!-- LKPD Option -->
                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="modulHasLKPD" class="w-5 h-5 rounded text-amber-600">
                            <div>
                                <span class="font-medium text-amber-800">Buat LKPD untuk Modul Ini</span>
                                <p class="text-xs text-amber-600">LKPD akan dibuat terpisah dengan bahasa siswa</p>
                            </div>
                        </label>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                            ğŸ’¾ Simpan Modul
                        </button>
                        <button type="button" onclick="closeModal(this.closest('.fixed'))" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50">
                            Batal
                        </button>
                    </div>
                </form>
            `;
            
            showModal(content, { title: 'ğŸ“– Buat Modul Ajar', size: '2xl' });
            document.getElementById('modulForm').addEventListener('submit', saveModul);
        }

        function fillModulFromCP() {
            const select = document.getElementById('modulCP');
            const selected = select.options[select.selectedIndex];
            
            if (!selected.value) return;
            
            document.getElementById('modulClass').value = selected.dataset.class || '';
            document.getElementById('modulSemester').value = selected.dataset.semester || '';
            document.getElementById('modulElemen').value = selected.dataset.elemen || '';
            document.getElementById('modulJudul').value = selected.dataset.judul || '';
            
            try {
                const tp = JSON.parse(selected.dataset.tp || '[]');
                document.getElementById('modulTP').value = tp.map((t, i) => `${i + 1}. ${t}`).join('\n');
                
                const materi = JSON.parse(selected.dataset.materi || '[]');
                if (materi.length > 0) {
                    document.getElementById('modulMateri').value = materi.map(m => `${m.sub}:\n${m.isi}`).join('\n\n');
                }
                
                const aktivitas = JSON.parse(selected.dataset.aktivitas || '[]');
                if (aktivitas.length > 0) {
                    document.getElementById('modulInti').value = aktivitas.map((a, i) => `${i + 1}. ${a}`).join('\n');
                }
            } catch (e) {
                console.error('Error parsing CP data:', e);
            }
            
            // Auto-select fase based on class
            const classNum = parseInt(selected.dataset.class);
            if (classNum <= 2) document.getElementById('modulFase').value = 'A';
            else if (classNum <= 4) document.getElementById('modulFase').value = 'B';
            else document.getElementById('modulFase').value = 'C';
        }

        async function saveModul(e) {
            e.preventDefault();
            
            const id = document.getElementById('modulId').value || db.collection('temp').doc().id;
            
            // Get selected dimensi
            const dimensiElements = document.querySelectorAll('input[name="modulDimensi"]:checked');
            const dimensi = Array.from(dimensiElements).map(el => el.value);
            
            const data = {
                class: document.getElementById('modulClass').value,
                semester: document.getElementById('modulSemester').value,
                pertemuan: parseInt(document.getElementById('modulPertemuan').value) || 1,
                alokasi: document.getElementById('modulAlokasi').value,
                elemen: document.getElementById('modulElemen').value,
                fase: document.getElementById('modulFase').value,
                judul: document.getElementById('modulJudul').value,
                tujuanPembelajaran: document.getElementById('modulTP').value,
                dimensiProfil: dimensi,
                sarana: document.getElementById('modulSarana').value,
                pendahuluan: document.getElementById('modulPendahuluan').value,
                kegiatanInti: document.getElementById('modulInti').value,
                penutup: document.getElementById('modulPenutup').value,
                materi: document.getElementById('modulMateri').value,
                asesmen: document.getElementById('modulAsesmen').value,
                hasLKPD: document.getElementById('modulHasLKPD').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (!document.getElementById('modulId').value) {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('modules').doc(id).set(data, { merge: true });
                
                // If LKPD is enabled, create LKPD entry
                if (data.hasLKPD) {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('lkpd').doc(id).set({
                            modulId: id,
                            judul: data.judul,
                            class: data.class,
                            semester: data.semester,
                            tujuanPembelajaran: data.tujuanPembelajaran,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                }
                
                closeModal(document.querySelector('.modal-overlay button'));
                showToast('Modul Ajar berhasil disimpan!', 'success');
                loadModulData();
            } catch (error) {
                console.error('Error saving modul:', error);
                showToast('Gagal menyimpan modul', 'error');
            }
        }

        async function viewModul(id) {
            try {
                const doc = await db.collection('users').doc(currentUser.uid)
                    .collection('modules').doc(id).get();
                
                if (!doc.exists) {
                    showToast('Modul tidak ditemukan', 'error');
                    return;
                }
                
                const modul = doc.data();
                const school = userProfile?.school || {};
                
                const content = `
                    <div id="modulPrintArea" class="max-h-[70vh] overflow-y-auto">
                        <!-- Header -->
                        <div class="text-center mb-6 border-b-2 border-gray-800 pb-4">
                            <h2 class="text-lg font-bold">MODUL AJAR</h2>
                            <p class="text-sm">${school.name || 'Sekolah'}</p>
                        </div>
                        
                        <!-- Info Grid -->
                        <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                            <div>
                                <table class="w-full">
                                    <tr><td class="py-1 w-40">Mata Pelajaran</td><td>: PAI dan Budi Pekerti</td></tr>
                                    <tr><td class="py-1">Kelas / Semester</td><td>: ${modul.class} / ${modul.semester}</td></tr>
                                    <tr><td class="py-1">Fase</td><td>: ${modul.fase}</td></tr>
                                    <tr><td class="py-1">Elemen</td><td>: ${modul.elemen || '-'}</td></tr>
                                </table>
                            </div>
                            <div>
                                <table class="w-full">
                                    <tr><td class="py-1 w-40">Topik</td><td>: ${modul.judul}</td></tr>
                                    <tr><td class="py-1">Pertemuan Ke</td><td>: ${modul.pertemuan}</td></tr>
                                    <tr><td class="py-1">Alokasi Waktu</td><td>: ${modul.alokasi}</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Tujuan Pembelajaran -->
                        <div class="mb-4">
                            <h3 class="font-bold text-gray-800 mb-2 bg-gray-100 px-3 py-2">A. TUJUAN PEMBELAJARAN</h3>
                            <div class="px-3 whitespace-pre-wrap">${modul.tujuanPembelajaran || '-'}</div>
                        </div>
                        
                        <!-- Profil Pelajar -->
                        ${modul.dimensiProfil && modul.dimensiProfil.length > 0 ? `
                            <div class="mb-4">
                                <h3 class="font-bold text-gray-800 mb-2 bg-gray-100 px-3 py-2">B. PROFIL LULUSAN</h3>
                                <div class="px-3 flex flex-wrap gap-2">
                                    ${modul.dimensiProfil.map(d => `<span class="px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-sm">${d}</span>`).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Sarana -->
                        ${modul.sarana ? `
                            <div class="mb-4">
                                <h3 class="font-bold text-gray-800 mb-2 bg-gray-100 px-3 py-2">C. SARANA DAN PRASARANA</h3>
                                <div class="px-3">${modul.sarana}</div>
                            </div>
                        ` : ''}
                        
                        <!-- Kegiatan Pembelajaran -->
                        <div class="mb-4">
                            <h3 class="font-bold text-gray-800 mb-2 bg-gray-100 px-3 py-2">D. KEGIATAN PEMBELAJARAN</h3>
                            
                            <div class="px-3 space-y-4">
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-1">1. Pendahuluan</h4>
                                    <div class="pl-4 whitespace-pre-wrap text-gray-600">${modul.pendahuluan || '-'}</div>
                                </div>
                                
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-1">2. Kegiatan Inti</h4>
                                    <div class="pl-4 whitespace-pre-wrap text-gray-600">${modul.kegiatanInti || '-'}</div>
                                </div>
                                
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-1">3. Penutup</h4>
                                    <div class="pl-4 whitespace-pre-wrap text-gray-600">${modul.penutup || '-'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Materi -->
                        ${modul.materi ? `
                            <div class="mb-4">
                                <h3 class="font-bold text-gray-800 mb-2 bg-gray-100 px-3 py-2">E. MATERI PEMBELAJARAN</h3>
                                <div class="px-3 whitespace-pre-wrap">${formatArabicText(modul.materi)}</div>
                            </div>
                        ` : ''}
                        
                        <!-- Asesmen -->
                        ${modul.asesmen ? `
                            <div class="mb-4">
                                <h3 class="font-bold text-gray-800 mb-2 bg-gray-100 px-3 py-2">F. ASESMEN</h3>
                                <div class="px-3 whitespace-pre-wrap">${modul.asesmen}</div>
                            </div>
                        ` : ''}
                        
                        <!-- Signature -->
                        <div class="mt-8 flex justify-between text-sm">
                            <div class="text-center">
                                <p>Mengetahui,</p>
                                <p>Kepala ${school.name || 'Sekolah'}</p>
                                <br><br><br>
                                <p class="font-bold border-b border-black inline-block">${school.principalName || '...........................'}</p>
                                <p>NIP. ........................</p>
                            </div>
                            <div class="text-center">
                                <p>${school.location || '...............'}, ..................</p>
                                <p>Guru Mata Pelajaran</p>
                                <br><br><br>
                                <p class="font-bold border-b border-black inline-block">${userProfile?.name || ''}</p>
                                <p>NIP. ${userProfile?.nip || '........................'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex gap-3 no-print">
                        <button onclick="printModulContent()" class="flex-1 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                            ğŸ–¨ï¸ Cetak Modul
                        </button>
                        ${modul.hasLKPD ? `
                            <button onclick="closeModal(this.closest('.fixed')); viewLKPD('${id}')" class="px-4 py-2 bg-amber-600 text-white rounded-xl font-medium hover:bg-amber-700">
                                ğŸ“ Lihat LKPD
                            </button>
                        ` : ''}
                    </div>
                `;
                
                showModal(content, { title: `ğŸ“– ${modul.judul}`, size: '3xl' });
                
            } catch (error) {
                console.error('Error viewing modul:', error);
                showToast('Gagal memuat modul', 'error');
            }
        }

        function formatArabicText(text) {
            // Simple detection for Arabic characters and wrap them with RTL class
            return text.replace(/([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF]+)/g, '<span class="arabic-text text-xl">$1</span>');
        }

        function printModulContent() {
            const printArea = document.getElementById('modulPrintArea');
            if (!printArea) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Modul Ajar</title>
                    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Times New Roman', serif; padding: 20px; font-size: 12pt; }
                        .arabic-text { font-family: 'Amiri', serif; direction: rtl; display: inline-block; }
                        h2, h3 { margin: 0; }
                        table { border-collapse: collapse; }
                        .bg-gray-100 { background-color: #f3f4f6; }
                        @media print { body { padding: 0; } .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    ${printArea.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function editModul(id) {
            try {
                const doc = await db.collection('users').doc(currentUser.uid)
                    .collection('modules').doc(id).get();
                
                if (!doc.exists) {
                    showToast('Modul tidak ditemukan', 'error');
                    return;
                }
                
                await createModul();
                
                const modul = doc.data();
                
                setTimeout(() => {
                    document.getElementById('modulId').value = id;
                    document.getElementById('modulClass').value = modul.class || '';
                    document.getElementById('modulSemester').value = modul.semester || '';
                    document.getElementById('modulPertemuan').value = modul.pertemuan || 1;
                    document.getElementById('modulAlokasi').value = modul.alokasi || '';
                    document.getElementById('modulElemen').value = modul.elemen || '';
                    document.getElementById('modulFase').value = modul.fase || '';
                    document.getElementById('modulJudul').value = modul.judul || '';
                    document.getElementById('modulTP').value = modul.tujuanPembelajaran || '';
                    document.getElementById('modulSarana').value = modul.sarana || '';
                    document.getElementById('modulPendahuluan').value = modul.pendahuluan || '';
                    document.getElementById('modulInti').value = modul.kegiatanInti || '';
                    document.getElementById('modulPenutup').value = modul.penutup || '';
                    document.getElementById('modulMateri').value = modul.materi || '';
                    document.getElementById('modulAsesmen').value = modul.asesmen || '';
                    document.getElementById('modulHasLKPD').checked = modul.hasLKPD || false;
                    
                    // Set dimensi checkboxes
                    if (modul.dimensiProfil) {
                        modul.dimensiProfil.forEach(d => {
                            const checkbox = document.querySelector(`input[name="modulDimensi"][value="${d}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }, 200);
                
            } catch (error) {
                console.error('Error loading modul for edit:', error);
                showToast('Gagal memuat modul', 'error');
            }
        }

        async function deleteModul(id) {
            if (!confirm('Yakin ingin menghapus modul ini?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('modules').doc(id).delete();
                
                // Also delete associated LKPD
                await db.collection('users').doc(currentUser.uid)
                    .collection('lkpd').doc(id).delete().catch(() => {});
                
                showToast('Modul berhasil dihapus', 'success');
                loadModulData();
            } catch (error) {
                console.error('Error deleting modul:', error);
                showToast('Gagal menghapus modul', 'error');
            }
        }

        // LKPD Functions
        function renderLKPD() {
            if (!isPremiumUser()) {
                showUpgradeModal();
                return;
            }
            
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ“ LKPD (Lembar Kerja Peserta Didik)</h1>
                            <p class="text-gray-500">LKPD terintegrasi dengan Modul Ajar</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                        <p class="text-sm text-blue-700">
                            ğŸ’¡ LKPD dibuat otomatis saat Anda mencentang opsi "Buat LKPD" di Modul Ajar. 
                            Anda dapat mengedit konten LKPD di sini dengan bahasa yang sesuai untuk siswa.
                        </p>
                    </div>
                    
                    <div id="lkpdList" class="space-y-4">
                        <div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>
                    </div>
                </div>
            `;
            
            loadLKPDData();
        }

        async function loadLKPDData() {
            const container = document.getElementById('lkpdList');
            
            try {
                const snapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('lkpd')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const lkpdItems = [];
                snapshot.forEach(doc => lkpdItems.push({ id: doc.id, ...doc.data() }));
                
                if (lkpdItems.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-2xl p-8 text-center">
                            <div class="text-6xl mb-4">ğŸ“</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Belum Ada LKPD</h3>
                            <p class="text-gray-500 mb-4">LKPD akan muncul di sini saat Anda membuat Modul Ajar dengan opsi LKPD diaktifkan.</p>
                            <button onclick="navigateTo('modul')" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                                Buat Modul Ajar â†’
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = lkpdItems.map(lkpd => `
                    <div class="bg-white rounded-2xl p-6 card-hover">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-1 text-xs font-medium bg-primary-100 text-primary-700 rounded">Kelas ${lkpd.class}</span>
                                    <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded">Semester ${lkpd.semester}</span>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">${lkpd.judul}</h3>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editLKPD('${lkpd.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button onclick="printLKPD('${lkpd.id}')" class="p-2 text-gray-600 hover:bg-gray-50 rounded-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading LKPD:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data LKPD</div>';
            }
        }

        async function editLKPD(id) {
            try {
                const doc = await db.collection('users').doc(currentUser.uid)
                    .collection('lkpd').doc(id).get();
                
                if (!doc.exists) {
                    showToast('LKPD tidak ditemukan', 'error');
                    return;
                }
                
                const lkpd = doc.data();
                
                const content = `
                    <form id="lkpdForm" class="space-y-4 max-h-[70vh] overflow-y-auto">
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <p class="text-sm text-blue-700">
                                âœï¸ Edit LKPD dengan bahasa yang mudah dipahami siswa. Gunakan instruksi yang jelas dan sederhana.
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Judul LKPD</label>
                            <input type="text" id="lkpdJudul" value="${lkpd.judul || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran</label>
                            <textarea id="lkpdTP" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl">${lkpd.tujuanPembelajaran || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Petunjuk untuk Siswa</label>
                            <textarea id="lkpdPetunjuk" rows="3" placeholder="1. Baca materi dengan teliti&#10;2. Kerjakan soal-soal berikut&#10;3. Diskusikan dengan teman jika kesulitan" class="w-full px-4 py-3 border border-gray-200 rounded-xl">${lkpd.petunjuk || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ringkasan Materi</label>
                            <textarea id="lkpdMateri" rows="4" class="w-full px-4 py-3 border border-gray-200 rounded-xl">${lkpd.materi || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan/Soal Latihan</label>
                            <textarea id="lkpdKegiatan" rows="6" placeholder="Tulis kegiatan atau soal-soal untuk siswa..." class="w-full px-4 py-3 border border-gray-200 rounded-xl">${lkpd.kegiatan || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Refleksi</label>
                            <textarea id="lkpdRefleksi" rows="2" placeholder="Apa yang sudah kamu pelajari hari ini?" class="w-full px-4 py-3 border border-gray-200 rounded-xl">${lkpd.refleksi || ''}</textarea>
                        </div>
                        
                        <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                            ğŸ’¾ Simpan LKPD
                        </button>
                    </form>
                `;
                
                showModal(content, { title: 'ğŸ“ Edit LKPD', size: 'xl' });
                
                document.getElementById('lkpdForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        await db.collection('users').doc(currentUser.uid)
                            .collection('lkpd').doc(id).update({
                                judul: document.getElementById('lkpdJudul').value,
                                tujuanPembelajaran: document.getElementById('lkpdTP').value,
                                petunjuk: document.getElementById('lkpdPetunjuk').value,
                                materi: document.getElementById('lkpdMateri').value,
                                kegiatan: document.getElementById('lkpdKegiatan').value,
                                refleksi: document.getElementById('lkpdRefleksi').value,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        
                        closeModal(document.querySelector('.modal-overlay button'));
                        showToast('LKPD berhasil disimpan!', 'success');
                        loadLKPDData();
                    } catch (error) {
                        console.error('Error saving LKPD:', error);
                        showToast('Gagal menyimpan LKPD', 'error');
                    }
                });
                
            } catch (error) {
                console.error('Error loading LKPD:', error);
                showToast('Gagal memuat LKPD', 'error');
            }
        }

        // Bank Soal
        function renderBankSoal() {
            if (!isPremiumUser()) {
                showUpgradeModal();
                return;
            }
            
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">ğŸ¦ Bank Soal</h1>
                            <p class="text-gray-500">Kumpulan soal terintegrasi dengan ATP</p>
                        </div>
                        <button onclick="addSoal()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                            â• Tambah Soal
                        </button>
                    </div>
                    
                    <!-- Filter -->
                    <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                        <div>
                            <select id="soalClassFilter" onchange="loadSoalData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Kelas</option>
                                ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <select id="soalTypeFilter" onchange="loadSoalData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                                <option value="">Semua Jenis</option>
                                <option value="pg">Pilihan Ganda</option>
                                <option value="isian">Isian</option>
                                <option value="uraian">Uraian</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <input type="text" id="soalSearch" onkeyup="loadSoalData()" placeholder="Cari soal..." class="w-full px-4 py-2 border border-gray-200 rounded-xl">
                        </div>
                    </div>
                    
                    <div id="soalList" class="space-y-4">
                        <div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>
                    </div>
                </div>
            `;
            
            loadSoalData();
        }

        async function loadSoalData() {
            const container = document.getElementById('soalList');
            const classFilter = document.getElementById('soalClassFilter')?.value;
            const typeFilter = document.getElementById('soalTypeFilter')?.value;
            const search = document.getElementById('soalSearch')?.value.toLowerCase();
            
            try {
                let query = db.collection('users').doc(currentUser.uid)
                    .collection('banksoal')
                    .orderBy('createdAt', 'desc');
                
                const snapshot = await query.get();
                
                let soalItems = [];
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    
                    // Apply filters
                    if (classFilter && data.class !== classFilter) return;
                    if (typeFilter && data.type !== typeFilter) return;
                    if (search && !data.soal.toLowerCase().includes(search)) return;
                    
                    soalItems.push(data);
                });
                
                if (soalItems.length === 0) {
                    container.innerHTML = `
                        <div class="bg-white rounded-2xl p-8 text-center">
                            <div class="text-6xl mb-4">ğŸ¦</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Bank Soal Kosong</h3>
                            <p class="text-gray-500 mb-4">Mulai tambahkan soal-soal untuk membangun bank soal Anda.</p>
                            <button onclick="addSoal()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                                + Tambah Soal
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = soalItems.map((soal, index) => `
                    <div class="bg-white rounded-2xl p-6">
                        <div class="flex items-start gap-4">
                            <div class="w-10 h-10 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold flex-shrink-0">
                                ${index + 1}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded">Kelas ${soal.class}</span>
                                    <span class="px-2 py-1 text-xs font-medium ${
                                        soal.type === 'pg' ? 'bg-blue-100 text-blue-700' :
                                        soal.type === 'isian' ? 'bg-green-100 text-green-700' :
                                        'bg-purple-100 text-purple-700'
                                    } rounded">${
                                        soal.type === 'pg' ? 'Pilihan Ganda' :
                                        soal.type === 'isian' ? 'Isian' : 'Uraian'
                                    }</span>
                                    ${soal.elemen ? `<span class="px-2 py-1 text-xs font-medium bg-amber-100 text-amber-700 rounded">${soal.elemen}</span>` : ''}
                                </div>
                                <p class="text-gray-800 mb-2">${formatArabicText(soal.soal)}</p>
                                
                                ${soal.type === 'pg' && soal.pilihan ? `
                                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-2">
                                        ${soal.pilihan.map((p, i) => `
                                            <div class="${soal.jawaban === String.fromCharCode(65 + i) ? 'text-green-600 font-medium' : ''}">
                                                ${String.fromCharCode(65 + i)}. ${p}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                <div class="text-sm text-green-600">
                                    <span class="font-medium">Jawaban:</span> ${soal.jawaban || '-'}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editSoal('${soal.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button onclick="deleteSoal('${soal.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading soal:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data soal</div>';
            }
        }

        function addSoal() {
            const content = `
                <form id="soalForm" class="space-y-4">
                    <input type="hidden" id="soalId" value="">
                    
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="soalClass" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Soal</label>
                            <select id="soalType" onchange="togglePilihanGanda()" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="pg">Pilihan Ganda</option>
                                <option value="isian">Isian</option>
                                <option value="uraian">Uraian</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Elemen</label>
                            <select id="soalElemen" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="">Pilih Elemen</option>
                                <option value="Al-Qur'an dan Hadis">Al-Qur'an dan Hadis</option>
                                <option value="Akidah">Akidah</option>
                                <option value="Akhlak">Akhlak</option>
                                <option value="Fikih">Fikih</option>
                                <option value="Sejarah Peradaban Islam">Sejarah Peradaban Islam</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan *</label>
                        <p class="text-xs text-gray-500 mb-1">Mendukung teks Arab</p>
                        <textarea id="soalPertanyaan" rows="3" required class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea>
                    </div>
                    
                    <div id="pilihanGandaSection">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="w-8 text-center font-medium">A.</span>
                                <input type="text" id="soalPilihanA" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-8 text-center font-medium">B.</span>
                                <input type="text" id="soalPilihanB" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-8 text-center font-medium">C.</span>
                                <input type="text" id="soalPilihanC" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-8 text-center font-medium">D.</span>
                                <input type="text" id="soalPilihanD" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kunci Jawaban *</label>
                        <input type="text" id="soalJawaban" required placeholder="A / B / C / D atau jawaban isian" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                    </div>
                    
                    <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">
                        ğŸ’¾ Simpan Soal
                    </button>
                </form>
            `;
            
            showModal(content, { title: 'â• Tambah Soal', size: 'xl' });
            document.getElementById('soalForm').addEventListener('submit', saveSoal);
        }

        function togglePilihanGanda() {
            const type = document.getElementById('soalType').value;
            const section = document.getElementById('pilihanGandaSection');
            section.style.display = type === 'pg' ? 'block' : 'none';
        }

        async function saveSoal(e) {
            e.preventDefault();
            
            const id = document.getElementById('soalId').value || db.collection('temp').doc().id;
            const type = document.getElementById('soalType').value;
            
            const data = {
                class: document.getElementById('soalClass').value,
                type: type,
                elemen: document.getElementById('soalElemen').value,
                soal: document.getElementById('soalPertanyaan').value,
                jawaban: document.getElementById('soalJawaban').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (type === 'pg') {
                data.pilihan = [
                    document.getElementById('soalPilihanA').value,
                    document.getElementById('soalPilihanB').value,
                    document.getElementById('soalPilihanC').value,
                    document.getElementById('soalPilihanD').value
                ];
            }
            
            if (!document.getElementById('soalId').value) {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('banksoal').doc(id).set(data, { merge: true });
                
                closeModal(document.querySelector('.modal-overlay button'));
                showToast('Soal berhasil disimpan!', 'success');
                loadSoalData();
            } catch (error) {
                console.error('Error saving soal:', error);
                showToast('Gagal menyimpan soal', 'error');
            }
        }

        async function deleteSoal(id) {
            if (!confirm('Yakin ingin menghapus soal ini?')) return;
            
            try {
                await db.collection('users').doc(currentUser.uid)
                    .collection('banksoal').doc(id).delete();
                
                showToast('Soal berhasil dihapus', 'success');
                loadSoalData();
            } catch (error) {
                console.error('Error deleting soal:', error);
                showToast('Gagal menghapus soal', 'error');
            }
        }
    </script>

    <!-- Admin Panel (Super Admin Only) -->
    <script>
        function renderAdmin() {
            if (currentUser.email !== SUPER_ADMIN_EMAIL) {
                showToast('Akses ditolak', 'error');
                navigateTo('dashboard');
                return;
            }
            
            const content = document.getElementById('contentArea');
            content.innerHTML = `
                <div class="animate-fade-in">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-gray-800">âš™ï¸ Panel Admin</h1>
                        <p class="text-gray-500">Kelola pengaturan aplikasi dan pengguna</p>
                    </div>
                    
                    <!-- Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white rounded-2xl p-6">
                            <p class="text-3xl font-bold text-primary-600" id="adminTotalUsers">--</p>
                            <p class="text-sm text-gray-500">Total Pengguna</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6">
                            <p class="text-3xl font-bold text-green-600" id="adminPremiumUsers">--</p>
                            <p class="text-sm text-gray-500">Pengguna Premium</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6">
                            <p class="text-3xl font-bold text-amber-600" id="adminFreeUsers">--</p>
                            <p class="text-sm text-gray-500">Pengguna Free</p>
                        </div>
                        <div class="bg-white rounded-2xl p-6">
                            <p class="text-3xl font-bold text-blue-600" id="adminTodayUsers">--</p>
                            <p class="text-sm text-gray-500">Login Hari Ini</p>
                        </div>
                    </div>
                    
                    <!-- Settings -->
                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-2xl p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“± Pengaturan WhatsApp</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nomor WhatsApp Admin</label>
                                    <input type="text" id="adminWhatsapp" value="${APP_CONFIG.whatsappNumber}" placeholder="628xxxxxxxxxx" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <p class="text-xs text-gray-500 mt-1">Format: 628xxx (tanpa + atau 0)</p>
                                </div>
                                <button onclick="saveAdminSettings()" class="w-full py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">
                                    ğŸ’¾ Simpan
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6">
                            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ’° Pengaturan Harga</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Harga Perorangan (per tahun)</label>
                                    <input type="number" id="adminPriceIndividual" value="${APP_CONFIG.individualPrice}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Harga Paket Sekolah (per tahun)</label>
                                    <input type="number" id="adminPriceSchool" value="${APP_CONFIG.schoolPackagePrice}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                </div>
                                <button onclick="saveAdminSettings()" class="w-full py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">
                                    ğŸ’¾ Simpan
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Management -->
                    <div class="bg-white rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-gray-800">ğŸ‘¥ Kelola Pengguna</h2>
                            <div class="flex gap-2">
                                <input type="text" id="adminUserSearch" placeholder="Cari email..." class="px-4 py-2 border border-gray-200 rounded-xl" onkeyup="searchAdminUsers()">
                            </div>
                        </div>
                        
                        <div id="adminUserList" class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Email</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="adminUserTableBody">
                                    <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            loadAdminData();
        }

        async function loadAdminData() {
            try {
                const usersSnap = await db.collection('users').get();
                
                let total = 0;
                let premium = 0;
                let free = 0;
                const users = [];
                
                usersSnap.forEach(doc => {
                    const data = doc.data();
                    total++;
                    if (data.subscription === 'premium') premium++;
                    else free++;
                    users.push({ id: doc.id, ...data });
                });
                
                document.getElementById('adminTotalUsers').textContent = total;
                document.getElementById('adminPremiumUsers').textContent = premium;
                document.getElementById('adminFreeUsers').textContent = free;
                document.getElementById('adminTodayUsers').textContent = '--';
                
                renderAdminUsers(users);
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        function renderAdminUsers(users) {
            const tbody = document.getElementById('adminUserTableBody');
            
            tbody.innerHTML = users.map(user => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${user.email}</td>
                    <td class="px-4 py-3 text-sm">${user.name || '-'}</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${
                            user.subscription === 'premium' ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-600'
                        }">
                            ${user.subscription === 'premium' ? 'Premium' : 'Free'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${user.subscription === 'premium' ? `
                            <button onclick="setUserSubscription('${user.id}', 'free')" class="px-3 py-1 text-xs bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
                                Cabut Premium
                            </button>
                        ` : `
                            <button onclick="setUserSubscription('${user.id}', 'premium')" class="px-3 py-1 text-xs bg-green-100 text-green-600 rounded-lg hover:bg-green-200">
                                Set Premium
                            </button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        async function setUserSubscription(userId, subscription) {
            try {
                await db.collection('users').doc(userId).update({
                    subscription: subscription,
                    subscriptionExpiry: subscription === 'premium' ? 
                        new Date(Date.now() + 365 * 24 * 60 * 60 * 1000) : null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast(`Status berhasil diubah ke ${subscription}`, 'success');
                loadAdminData();
            } catch (error) {
                console.error('Error updating subscription:', error);
                showToast('Gagal mengubah status', 'error');
            }
        }

        async function saveAdminSettings() {
            try {
                APP_CONFIG.whatsappNumber = document.getElementById('adminWhatsapp').value;
                APP_CONFIG.individualPrice = parseInt(document.getElementById('adminPriceIndividual').value);
                APP_CONFIG.schoolPackagePrice = parseInt(document.getElementById('adminPriceSchool').value);
                
                await db.collection('settings').doc('app').set({
                    whatsappNumber: APP_CONFIG.whatsappNumber,
                    individualPrice: APP_CONFIG.individualPrice,
                    schoolPackagePrice: APP_CONFIG.schoolPackagePrice,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showToast('Pengaturan berhasil disimpan!', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Gagal menyimpan pengaturan', 'error');
            }
        }

        function searchAdminUsers() {
            const search = document.getElementById('adminUserSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#adminUserTableBody tr');
            
            rows.forEach(row => {
                const email = row.cells[0]?.textContent.toLowerCase() || '';
                const name = row.cells[1]?.textContent.toLowerCase() || '';
                row.style.display = (email.includes(search) || name.includes(search)) ? '' : 'none';
            });
        }

        // Load app settings on init
        async function loadAppSettings() {
            try {
                const doc = await db.collection('settings').doc('app').get();
                if (doc.exists) {
                    const data = doc.data();
                    APP_CONFIG.whatsappNumber = data.whatsappNumber || APP_CONFIG.whatsappNumber;
                    APP_CONFIG.individualPrice = data.individualPrice || APP_CONFIG.individualPrice;
                    APP_CONFIG.schoolPackagePrice = data.schoolPackagePrice || APP_CONFIG.schoolPackagePrice;
                }
            } catch (error) {
                console.error('Error loading app settings:', error);
            }
        }

        // Call on app init
        loadAppSettings();
    </script>

    <!-- CP PAI Default Data -->
    <script>
        // Data Buku PAI (from requirement)
        const dataBuku = {
            kelas1: {
                judul: "PAI dan Budi Pekerti Kelas 1",
                fase: "A",
                semester1: [
                    { bab: 1, elemen: "Al-Qur'an dan Hadis", judul: "Aku Belajar Huruf Hijaiyah", tujuan: "Peserta didik dapat mengenal dan melafalkan huruf hijaiyah dengan benar", materi: [{ sub: "Mengenal Huruf Hijaiyah", isi: "Huruf hijaiyah ada 28 huruf." }], aktivitas: ["Menyanyikan lagu huruf hijaiyah"], refleksi: "Aku sudah bisa melafalkan huruf apa saja?", karakter: ["Tekun belajar"] },
                    { bab: 2, elemen: "Akidah", judul: "Allah Tuhanku", tujuan: "Peserta didik dapat meyakini Allah SWT sebagai Tuhan Yang Maha Esa", materi: [{ sub: "Allah Maha Esa", isi: "Allah itu satu." }], aktivitas: ["Menyebutkan ciptaan Allah"], refleksi: "Apa saja ciptaan Allah?", karakter: ["Beriman"] },
                    { bab: 3, elemen: "Akhlak", judul: "Aku Anak Saleh", tujuan: "Peserta didik dapat menunjukkan perilaku terpuji", materi: [{ sub: "Berkata Jujur", isi: "Jujur artinya berkata sesuai kenyataan." }], aktivitas: ["Bermain peran anak jujur"], refleksi: "Hari ini aku sudah berbuat baik?", karakter: ["Jujur"] },
                    { bab: 4, elemen: "Fikih", judul: "Aku Belajar Bersuci", tujuan: "Peserta didik dapat memahami tata cara bersuci", materi: [{ sub: "Mengenal Najis", isi: "Najis adalah kotoran." }], aktivitas: ["Praktik mencuci tangan"], refleksi: "Apakah aku sudah menjaga kebersihan?", karakter: ["Bersih"] },
                    { bab: 5, elemen: "Sejarah Peradaban Islam", judul: "Nabi Muhammad SAW Panutanku", tujuan: "Peserta didik dapat mengenal Nabi Muhammad SAW", materi: [{ sub: "Kelahiran Nabi Muhammad SAW", isi: "Nabi Muhammad lahir di Mekah." }], aktivitas: ["Mendengarkan kisah Nabi"], refleksi: "Apa yang bisa aku contoh?", karakter: ["Meneladani Nabi"] }
                ],
                semester2: [
                    { bab: 6, elemen: "Al-Qur'an dan Hadis", judul: "Aku Menghafal Surah Pendek", tujuan: "Peserta didik dapat melafalkan dan menghafal surah Al-Fatihah dan An-Nas", materi: [{ sub: "Surah Al-Fatihah", isi: "Al-Fatihah artinya pembuka." }], aktivitas: ["Menghafal bersama"], refleksi: "Sudah berapa ayat yang aku hafal?", karakter: ["Cinta Al-Qur'an"] },
                    { bab: 7, elemen: "Akidah", judul: "Malaikat Allah", tujuan: "Peserta didik dapat mengenal malaikat", materi: [{ sub: "Malaikat Ciptaan Allah", isi: "Malaikat diciptakan dari cahaya." }], aktivitas: ["Menyebutkan nama malaikat"], refleksi: "Apa yang aku ketahui tentang malaikat?", karakter: ["Beriman kepada malaikat"] },
                    { bab: 8, elemen: "Akhlak", judul: "Aku Sayang Temanku", tujuan: "Peserta didik dapat menunjukkan sikap persahabatan", materi: [{ sub: "Berteman dengan Baik", isi: "Teman itu penting." }], aktivitas: ["Bermain bersama teman"], refleksi: "Hari ini aku sudah membantu teman?", karakter: ["Tolong-menolong"] },
                    { bab: 9, elemen: "Fikih", judul: "Aku Belajar Wudhu", tujuan: "Peserta didik dapat mengetahui tata cara wudhu", materi: [{ sub: "Apa itu Wudhu?", isi: "Wudhu adalah membersihkan anggota tubuh dengan air." }], aktivitas: ["Praktik wudhu bersama"], refleksi: "Apakah wudhuku sudah benar?", karakter: ["Tertib"] },
                    { bab: 10, elemen: "Sejarah Peradaban Islam", judul: "Kisah Nabi Adam AS", tujuan: "Peserta didik dapat mengenal kisah Nabi Adam AS", materi: [{ sub: "Nabi Adam Manusia Pertama", isi: "Nabi Adam adalah manusia pertama." }], aktivitas: ["Mendengarkan kisah Nabi Adam"], refleksi: "Apa pelajaran dari kisah Nabi Adam?", karakter: ["Bertaubat"] }
                ]
            },
            // Add more classes (kelas2-6) following the same structure...
            kelas2: { judul: "PAI dan Budi Pekerti Kelas 2", fase: "A", semester1: [], semester2: [] },
            kelas3: { judul: "PAI dan Budi Pekerti Kelas 3", fase: "B", semester1: [], semester2: [] },
            kelas4: { judul: "PAI dan Budi Pekerti Kelas 4", fase: "B", semester1: [], semester2: [] },
            kelas5: { judul: "PAI dan Budi Pekerti Kelas 5", fase: "C", semester1: [], semester2: [] },
            kelas6: { judul: "PAI dan Budi Pekerti Kelas 6", fase: "C", semester1: [], semester2: [] }
        };
        
        // Note: Full data would be populated based on the extensive dataBuku provided in requirements
    </script>

</body>
</html>
