<!DOCTYPE html>
<html lang="id" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN GURU SUPER APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#1e40af',
                        accent: '#3b82f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: '#1f2937',
                        light: '#f3f4f6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        arabic: ['Amiri', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .arabic-text {
            font-family: 'Amiri', serif;
            direction: rtl;
            font-size: 1.25em;
            line-height: 2;
        }
        
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        @media (min-width: 1024px) {
            .sidebar.collapsed {
                transform: translateX(0);
            }
        }
        
        .menu-item {
            transition: all 0.2s ease;
        }
        
        .menu-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .menu-item.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-right: 3px solid #3b82f6;
        }
        
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-in-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Notifications */
        .toast {
            animation: toastIn 0.3s ease-out;
        }
        
        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Modal */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            body {
                font-size: 12pt;
            }
        }
        
        /* Form Styles */
        .form-input {
            @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200;
        }
        
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        
        .btn-primary {
            @apply bg-primary hover:bg-secondary text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2;
        }
        
        .btn-secondary {
            @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2;
        }
        
        .btn-success {
            @apply bg-success hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2;
        }
        
        .btn-danger {
            @apply bg-danger hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Auth Screen -->
    <div id="authScreen" class="hidden min-h-screen bg-gradient-to-br from-primary to-secondary flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <!-- Auth Header -->
            <div class="bg-gradient-to-r from-primary to-accent p-6 text-white text-center">
                <div class="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center">
                    <i class="fas fa-chalkboard-teacher text-4xl text-primary"></i>
                </div>
                <h1 class="text-2xl font-bold">ADMIN GURU</h1>
                <p class="text-blue-100">Super App</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" class="p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Masuk ke Akun Anda</h2>
                <form id="loginFormElement" class="space-y-4">
                    <div>
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="email@contoh.com" required>
                    </div>
                    <div>
                        <label class="form-label">Password</label>
                        <div class="relative">
                            <input type="password" id="loginPassword" class="form-input pr-10" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                            <button type="button" onclick="togglePassword('loginPassword')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary w-full py-3">
                        <i class="fas fa-sign-in-alt"></i>
                        Masuk
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">Belum punya akun? 
                        <button onclick="showRegister()" class="text-primary font-medium hover:underline">Daftar</button>
                    </p>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="p-6 hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Buat Akun Baru</h2>
                <form id="registerFormElement" class="space-y-4">
                    <div>
                        <label class="form-label">Nama Lengkap</label>
                        <input type="text" id="regName" class="form-input" placeholder="Nama lengkap Anda" required>
                    </div>
                    <div>
                        <label class="form-label">Email</label>
                        <input type="email" id="regEmail" class="form-input" placeholder="email@contoh.com" required>
                    </div>
                    <div>
                        <label class="form-label">Password</label>
                        <div class="relative">
                            <input type="password" id="regPassword" class="form-input pr-10" placeholder="Min. 6 karakter" required minlength="6">
                            <button type="button" onclick="togglePassword('regPassword')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Konfirmasi Password</label>
                        <input type="password" id="regPasswordConfirm" class="form-input" placeholder="Ulangi password" required>
                    </div>
                    <button type="submit" class="btn-primary w-full py-3">
                        <i class="fas fa-user-plus"></i>
                        Daftar
                    </button>
                </form>
                <div class="mt-4 text-center">
                    <p class="text-gray-600">Sudah punya akun? 
                        <button onclick="showLogin()" class="text-primary font-medium hover:underline">Masuk</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Mobile Header -->
        <header class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-md z-40 px-4 py-3">
            <div class="flex items-center justify-between">
                <button onclick="toggleSidebar()" class="text-gray-600 p-2">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-lg font-bold text-primary">ADMIN GURU</h1>
                <button onclick="showProfile()" class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center">
                    <span id="headerUserInitial">U</span>
                </button>
            </div>
        </header>

        <!-- Sidebar Overlay -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-72 bg-white shadow-xl z-50 overflow-y-auto collapsed lg:translate-x-0">
            <!-- Sidebar Header -->
            <div class="bg-gradient-to-r from-primary to-accent p-6 text-white">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center">
                        <i class="fas fa-chalkboard-teacher text-2xl text-primary"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">ADMIN GURU</h1>
                        <p class="text-sm text-blue-100">Super App</p>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-white bg-opacity-20 rounded-lg">
                    <p class="text-sm" id="sidebarUserName">Memuat...</p>
                    <p class="text-xs text-blue-100" id="sidebarUserEmail">...</p>
                    <span id="subscriptionBadge" class="inline-block mt-2 px-2 py-1 bg-yellow-400 text-yellow-900 text-xs font-medium rounded-full">FREE</span>
                </div>
            </div>

            <!-- Year Selector -->
            <div class="p-4 border-b">
                <label class="form-label">Tahun Pelajaran</label>
                <select id="academicYearSelect" class="form-input text-sm" onchange="changeAcademicYear()">
                    <!-- Will be populated dynamically -->
                </select>
            </div>

            <!-- Navigation Menu -->
            <nav class="p-4">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">Menu Utama</p>
                
                <div class="space-y-1">
                    <button onclick="navigateTo('dashboard')" class="menu-item active w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="dashboard">
                        <i class="fas fa-home w-5"></i>
                        <span>Dashboard</span>
                    </button>
                    
                    <button onclick="navigateTo('profile')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="profile">
                        <i class="fas fa-user w-5"></i>
                        <span>Profil & Sekolah</span>
                    </button>
                </div>

                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-6">Pengaturan Dasar</p>
                
                <div class="space-y-1">
                    <button onclick="navigateTo('calendar')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="calendar">
                        <i class="fas fa-calendar-alt w-5"></i>
                        <span>Kalender Pendidikan</span>
                    </button>
                    
                    <button onclick="navigateTo('schedule')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="schedule">
                        <i class="fas fa-clock w-5"></i>
                        <span>Jadwal Pelajaran</span>
                    </button>
                    
                    <button onclick="navigateTo('curriculum')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="curriculum">
                        <i class="fas fa-book w-5"></i>
                        <span>CP & TP</span>
                    </button>
                </div>

                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-6">Dokumen Mengajar</p>
                
                <div class="space-y-1">
                    <button onclick="navigateTo('atp')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="atp">
                        <i class="fas fa-route w-5"></i>
                        <span>ATP</span>
                    </button>
                    
                    <button onclick="navigateTo('prota')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="prota">
                        <i class="fas fa-calendar-check w-5"></i>
                        <span>Prota</span>
                    </button>
                    
                    <button onclick="navigateTo('promes')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="promes">
                        <i class="fas fa-tasks w-5"></i>
                        <span>Promes</span>
                    </button>
                    
                    <button onclick="navigateTo('modul')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 premium-feature" data-menu="modul">
                        <i class="fas fa-file-alt w-5"></i>
                        <span>Modul Ajar</span>
                        <span class="premium-badge ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">PRO</span>
                    </button>
                </div>

                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-6">Akademik</p>
                
                <div class="space-y-1">
                    <button onclick="navigateTo('students')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="students">
                        <i class="fas fa-users w-5"></i>
                        <span>Data Siswa</span>
                    </button>
                    
                    <button onclick="navigateTo('attendance')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="attendance">
                        <i class="fas fa-clipboard-check w-5"></i>
                        <span>Absensi</span>
                    </button>
                    
                    <button onclick="navigateTo('journal')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="journal">
                        <i class="fas fa-journal-whills w-5"></i>
                        <span>Jurnal Pembelajaran</span>
                    </button>
                    
                    <button onclick="navigateTo('grades')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="grades">
                        <i class="fas fa-chart-bar w-5"></i>
                        <span>Daftar Nilai</span>
                    </button>
                </div>

                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-6">Sumber Belajar</p>
                
                <div class="space-y-1">
                    <button onclick="navigateTo('lkpd')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 premium-feature" data-menu="lkpd">
                        <i class="fas fa-file-signature w-5"></i>
                        <span>LKPD</span>
                        <span class="premium-badge ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">PRO</span>
                    </button>
                    
                    <button onclick="navigateTo('questionBank')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 premium-feature" data-menu="questionBank">
                        <i class="fas fa-question-circle w-5"></i>
                        <span>Bank Soal</span>
                        <span class="premium-badge ml-auto px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded-full">PRO</span>
                    </button>
                </div>

                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-6">Alat Bantu</p>
                
                <div class="space-y-1">
                    <button onclick="navigateTo('aiAssistant')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="aiAssistant">
                        <i class="fas fa-robot w-5"></i>
                        <span>AI Assistant</span>
                    </button>
                    
                    <button onclick="navigateTo('help')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="help">
                        <i class="fas fa-question w-5"></i>
                        <span>Bantuan</span>
                    </button>
                </div>

                <!-- Admin Menu (Super Admin Only) -->
                <div id="adminMenu" class="hidden">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 mt-6">Admin</p>
                    
                    <div class="space-y-1">
                        <button onclick="navigateTo('adminUsers')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="adminUsers">
                            <i class="fas fa-users-cog w-5"></i>
                            <span>Kelola Pengguna</span>
                        </button>
                        
                        <button onclick="navigateTo('adminSettings')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700" data-menu="adminSettings">
                            <i class="fas fa-cogs w-5"></i>
                            <span>Pengaturan Sistem</span>
                        </button>
                    </div>
                </div>

                <!-- Logout -->
                <div class="mt-8 pt-4 border-t">
                    <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 transition-colors">
                        <i class="fas fa-sign-out-alt w-5"></i>
                        <span>Keluar</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="mainContent" class="lg:ml-72 pt-16 lg:pt-0 min-h-screen">
            <!-- Content will be loaded dynamically -->
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modalContainer" class="hidden fixed inset-0 z-50">
        <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <div id="modalContent" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative z-10">
                <!-- Modal content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <!-- Application Scripts -->
    <script>
// ============================================
// CONFIGURATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDpiK4F4ilnDDNEwO0djGY-ClwgwBl1eFk",
    authDomain: "asap-1d653.firebaseapp.com",
    projectId: "asap-1d653",
    storageBucket: "asap-1d653.firebasestorage.app",
    messagingSenderId: "143263188364",
    appId: "1:143263188364:web:47b4c003972b3503e882a9",
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// App Constants
const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';
const APP_VERSION = '1.0.0';

// Default WhatsApp for upgrade (can be changed by admin)
let UPGRADE_WHATSAPP = '6281234567890';

// ============================================
// GLOBAL STATE
// ============================================
let currentUser = null;
let userData = null;
let currentAcademicYear = null;
let selectedSemester = 1;
let isLoading = false;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function showLoading() {
    document.getElementById('loadingScreen').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingScreen').classList.add('hidden');
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
    };
    
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-times-circle',
        warning: 'fa-exclamation-circle',
        info: 'fa-info-circle'
    };
    
    toast.className = `toast ${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]`;
    toast.innerHTML = `
        <i class="fas ${icons[type]}"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-auto">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function formatDate(date, format = 'full') {
    const d = date instanceof Date ? date : new Date(date);
    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    if (format === 'full') {
        return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    } else if (format === 'short') {
        return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
    } else if (format === 'iso') {
        return d.toISOString().split('T')[0];
    }
    return d.toLocaleDateString('id-ID');
}

function getAcademicYears() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    
    let years = [];
    
    // If we're in June or later, include next academic year
    if (currentMonth >= 6) {
        years.push(`${currentYear}/${currentYear + 1}`);
        years.push(`${currentYear - 1}/${currentYear}`);
    } else {
        years.push(`${currentYear - 1}/${currentYear}`);
        years.push(`${currentYear - 2}/${currentYear - 1}`);
    }
    
    return years;
}

function getCurrentAcademicYear() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    
    if (currentMonth >= 7) {
        return `${currentYear}/${currentYear + 1}`;
    } else {
        return `${currentYear - 1}/${currentYear}`;
    }
}

// ============================================
// AUTHENTICATION
// ============================================
function showLogin() {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
}

function showRegister() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.remove('hidden');
}

document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    showLoading();
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
        showToast('Login berhasil!', 'success');
    } catch (error) {
        console.error('Login error:', error);
        let message = 'Gagal login. Silakan coba lagi.';
        if (error.code === 'auth/user-not-found') {
            message = 'Email tidak terdaftar.';
        } else if (error.code === 'auth/wrong-password') {
            message = 'Password salah.';
        } else if (error.code === 'auth/invalid-email') {
            message = 'Format email tidak valid.';
        }
        showToast(message, 'error');
    } finally {
        hideLoading();
    }
});

document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('regName').value;
    const email = document.getElementById('regEmail').value;
    const password = document.getElementById('regPassword').value;
    const passwordConfirm = document.getElementById('regPasswordConfirm').value;
    
    if (password !== passwordConfirm) {
        showToast('Password tidak cocok!', 'error');
        return;
    }
    
    showLoading();
    
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        // Create user document in Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            subscription: 'free',
            subscriptionExpiry: null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            profile: {
                nip: '',
                nuptk: '',
                phone: '',
                subjects: []
            },
            school: {
                name: '',
                npsn: '',
                address: '',
                principalName: '',
                level: 'SD' // SD, SMP, SMA, SMK
            }
        });
        
        showToast('Registrasi berhasil! Selamat datang.', 'success');
    } catch (error) {
        console.error('Register error:', error);
        let message = 'Gagal registrasi. Silakan coba lagi.';
        if (error.code === 'auth/email-already-in-use') {
            message = 'Email sudah terdaftar.';
        } else if (error.code === 'auth/weak-password') {
            message = 'Password terlalu lemah. Minimal 6 karakter.';
        }
        showToast(message, 'error');
    } finally {
        hideLoading();
    }
});

async function logout() {
    if (confirm('Apakah Anda yakin ingin keluar?')) {
        showLoading();
        try {
            await auth.signOut();
            showToast('Logout berhasil!', 'success');
        } catch (error) {
            showToast('Gagal logout.', 'error');
        } finally {
            hideLoading();
        }
    }
}

// Auth state observer
auth.onAuthStateChanged(async (user) => {
    hideLoading();
    
    if (user) {
        currentUser = user;
        
        // Load user data
        try {
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists) {
                userData = doc.data();
            } else {
                // Create default user data if not exists
                userData = {
                    name: user.displayName || 'Pengguna',
                    email: user.email,
                    subscription: 'free',
                    profile: { subjects: [] },
                    school: { level: 'SD' }
                };
                await db.collection('users').doc(user.uid).set(userData);
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
        
        // Check if super admin
        if (user.email === SUPER_ADMIN_EMAIL) {
            userData.isAdmin = true;
            document.getElementById('adminMenu').classList.remove('hidden');
        }
        
        // Update UI
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        // Set user info
        document.getElementById('headerUserInitial').textContent = (userData.name || 'U').charAt(0).toUpperCase();
        document.getElementById('sidebarUserName').textContent = userData.name || 'Pengguna';
        document.getElementById('sidebarUserEmail').textContent = userData.email;
        
        // Update subscription badge
        const badge = document.getElementById('subscriptionBadge');
        if (userData.subscription === 'premium') {
            badge.textContent = 'PREMIUM';
            badge.className = 'inline-block mt-2 px-2 py-1 bg-green-400 text-green-900 text-xs font-medium rounded-full';
        } else {
            badge.textContent = 'FREE';
            badge.className = 'inline-block mt-2 px-2 py-1 bg-yellow-400 text-yellow-900 text-xs font-medium rounded-full';
        }
        
        // Initialize academic year selector
        initAcademicYearSelector();
        
        // Load dashboard
        navigateTo('dashboard');
    } else {
        currentUser = null;
        userData = null;
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }
});

// ============================================
// NAVIGATION
// ============================================
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    sidebar.classList.toggle('collapsed');
    overlay.classList.toggle('hidden');
}

function navigateTo(page) {
    // Check premium features
    const premiumPages = ['modul', 'lkpd', 'questionBank'];
    if (premiumPages.includes(page) && userData?.subscription !== 'premium' && !userData?.isAdmin) {
        showUpgradeModal();
        return;
    }
    
    // Update active menu
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const activeItem = document.querySelector(`[data-menu="${page}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
    
    // Close sidebar on mobile
    if (window.innerWidth < 1024) {
        toggleSidebar();
    }
    
    // Load page content
    loadPage(page);
}

function initAcademicYearSelector() {
    const select = document.getElementById('academicYearSelect');
    const years = getAcademicYears();
    
    select.innerHTML = years.map(year => `
        <option value="${year}">${year}</option>
    `).join('');
    
    currentAcademicYear = years[0];
    select.value = currentAcademicYear;
}

function changeAcademicYear() {
    currentAcademicYear = document.getElementById('academicYearSelect').value;
    // Reload current page with new academic year
    const currentPage = document.querySelector('.menu-item.active')?.dataset.menu || 'dashboard';
    loadPage(currentPage);
}

// ============================================
// PAGE LOADER
// ============================================
async function loadPage(page) {
    const mainContent = document.getElementById('mainContent');
    mainContent.innerHTML = '<div class="flex items-center justify-center h-64"><div class="spinner"></div></div>';
    
    try {
        switch(page) {
            case 'dashboard':
                mainContent.innerHTML = getDashboardHTML();
                initDashboard();
                break;
            case 'profile':
                mainContent.innerHTML = getProfileHTML();
                initProfile();
                break;
            case 'calendar':
                mainContent.innerHTML = getCalendarHTML();
                initCalendar();
                break;
            case 'schedule':
                mainContent.innerHTML = getScheduleHTML();
                initSchedule();
                break;
            case 'curriculum':
                mainContent.innerHTML = getCurriculumHTML();
                initCurriculum();
                break;
            case 'atp':
                mainContent.innerHTML = getATPHTML();
                initATP();
                break;
            case 'prota':
                mainContent.innerHTML = getProtaHTML();
                initProta();
                break;
            case 'promes':
                mainContent.innerHTML = getPromesHTML();
                initPromes();
                break;
            case 'modul':
                mainContent.innerHTML = getModulHTML();
                initModul();
                break;
            case 'students':
                mainContent.innerHTML = getStudentsHTML();
                initStudents();
                break;
            case 'attendance':
                mainContent.innerHTML = getAttendanceHTML();
                initAttendance();
                break;
            case 'journal':
                mainContent.innerHTML = getJournalHTML();
                initJournal();
                break;
            case 'grades':
                mainContent.innerHTML = getGradesHTML();
                initGrades();
                break;
            case 'lkpd':
                mainContent.innerHTML = getLKPDHTML();
                initLKPD();
                break;
            case 'questionBank':
                mainContent.innerHTML = getQuestionBankHTML();
                initQuestionBank();
                break;
            case 'aiAssistant':
                mainContent.innerHTML = getAIAssistantHTML();
                initAIAssistant();
                break;
            case 'help':
                mainContent.innerHTML = getHelpHTML();
                break;
            case 'adminUsers':
                mainContent.innerHTML = getAdminUsersHTML();
                initAdminUsers();
                break;
            case 'adminSettings':
                mainContent.innerHTML = getAdminSettingsHTML();
                initAdminSettings();
                break;
            default:
                mainContent.innerHTML = getDashboardHTML();
                initDashboard();
        }
    } catch (error) {
        console.error('Error loading page:', error);
        mainContent.innerHTML = `
            <div class="p-6">
                <div class="bg-red-100 text-red-700 p-4 rounded-lg">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Terjadi kesalahan saat memuat halaman. Silakan coba lagi.
                </div>
            </div>
        `;
    }
}

// ============================================
// DASHBOARD PAGE
// ============================================
function getDashboardHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <!-- Welcome Section -->
            <div class="bg-gradient-to-r from-primary to-accent rounded-2xl p-6 text-white mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold mb-2">Selamat Datang, ${userData?.name || 'Guru'}! ðŸ‘‹</h1>
                        <p class="text-blue-100">Tahun Pelajaran ${currentAcademicYear}</p>
                    </div>
                    <div class="mt-4 lg:mt-0">
                        <p class="text-sm text-blue-100">${formatDate(new Date())}</p>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="card bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Total Siswa</p>
                            <p class="text-xl font-bold text-gray-800" id="statTotalStudents">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chalkboard text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Total Kelas</p>
                            <p class="text-xl font-bold text-gray-800" id="statTotalClasses">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-book text-yellow-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Mata Pelajaran</p>
                            <p class="text-xl font-bold text-gray-800" id="statTotalSubjects">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="card bg-white rounded-xl p-4 shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Modul Ajar</p>
                            <p class="text-xl font-bold text-gray-800" id="statTotalModules">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Aksi Cepat</h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <button onclick="navigateTo('attendance')" class="flex flex-col items-center gap-2 p-4 bg-blue-50 rounded-xl hover:bg-blue-100 transition-colors">
                        <i class="fas fa-clipboard-check text-2xl text-blue-600"></i>
                        <span class="text-sm font-medium text-gray-700">Input Absensi</span>
                    </button>
                    
                    <button onclick="navigateTo('journal')" class="flex flex-col items-center gap-2 p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-colors">
                        <i class="fas fa-journal-whills text-2xl text-green-600"></i>
                        <span class="text-sm font-medium text-gray-700">Jurnal Hari Ini</span>
                    </button>
                    
                    <button onclick="navigateTo('grades')" class="flex flex-col items-center gap-2 p-4 bg-yellow-50 rounded-xl hover:bg-yellow-100 transition-colors">
                        <i class="fas fa-chart-bar text-2xl text-yellow-600"></i>
                        <span class="text-sm font-medium text-gray-700">Input Nilai</span>
                    </button>
                    
                    <button onclick="navigateTo('promes')" class="flex flex-col items-center gap-2 p-4 bg-purple-50 rounded-xl hover:bg-purple-100 transition-colors">
                        <i class="fas fa-tasks text-2xl text-purple-600"></i>
                        <span class="text-sm font-medium text-gray-700">Lihat Promes</span>
                    </button>
                </div>
            </div>
            
            <!-- Today's Schedule -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-calendar-day text-primary mr-2"></i>
                        Jadwal Hari Ini
                    </h2>
                    <div id="todaySchedule">
                        <p class="text-gray-500 text-center py-4">Memuat jadwal...</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-bell text-warning mr-2"></i>
                        Pengingat
                    </h2>
                    <div id="reminders">
                        <div class="space-y-3">
                            <div class="flex items-start gap-3 p-3 bg-yellow-50 rounded-lg">
                                <i class="fas fa-exclamation-circle text-yellow-500 mt-0.5"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">Lengkapi Profil</p>
                                    <p class="text-xs text-gray-500">Isi data profil dan sekolah Anda</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg">
                                <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">Atur Kalender</p>
                                    <p class="text-xs text-gray-500">Set kalender pendidikan tahun ini</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Setup Progress -->
            <div class="bg-white rounded-xl p-6 shadow-sm mt-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-tasks text-primary mr-2"></i>
                    Progress Pengaturan
                </h2>
                <div id="setupProgress" class="space-y-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    `;
}

async function initDashboard() {
    // Load stats
    await loadDashboardStats();
    
    // Load today's schedule
    await loadTodaySchedule();
    
    // Load setup progress
    await loadSetupProgress();
}

async function loadDashboardStats() {
    try {
        // Get students count
        const studentsSnap = await db.collection('users').doc(currentUser.uid)
            .collection('students')
            .where('academicYear', '==', currentAcademicYear)
            .get();
        document.getElementById('statTotalStudents').textContent = studentsSnap.size;
        
        // Get unique classes
        const classes = new Set();
        studentsSnap.forEach(doc => {
            const student = doc.data();
            classes.add(`${student.kelas}-${student.rombel}`);
        });
        document.getElementById('statTotalClasses').textContent = classes.size;
        
        // Get subjects count
        const subjects = userData?.profile?.subjects || [];
        document.getElementById('statTotalSubjects').textContent = subjects.length;
        
        // Get modules count
        const modulesSnap = await db.collection('users').doc(currentUser.uid)
            .collection('modules')
            .where('academicYear', '==', currentAcademicYear)
            .get();
        document.getElementById('statTotalModules').textContent = modulesSnap.size;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadTodaySchedule() {
    const container = document.getElementById('todaySchedule');
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 = Sunday
    
    const dayNames = ['minggu', 'senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
    const todayName = dayNames[dayOfWeek];
    
    try {
        const scheduleSnap = await db.collection('users').doc(currentUser.uid)
            .collection('schedules')
            .where('academicYear', '==', currentAcademicYear)
            .where('day', '==', todayName)
            .orderBy('startTime')
            .get();
        
        if (scheduleSnap.empty) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-calendar-times text-4xl mb-2"></i>
                    <p>Tidak ada jadwal hari ini</p>
                </div>
            `;
            return;
        }
        
        let html = '<div class="space-y-3">';
        scheduleSnap.forEach(doc => {
            const schedule = doc.data();
            html += `
                <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                    <div class="text-center">
                        <p class="text-sm font-bold text-primary">${schedule.startTime}</p>
                        <p class="text-xs text-gray-500">${schedule.endTime}</p>
                    </div>
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${schedule.subject}</p>
                        <p class="text-sm text-gray-500">Kelas ${schedule.className} - ${schedule.rombel}</p>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading schedule:', error);
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Gagal memuat jadwal</p>';
    }
}

async function loadSetupProgress() {
    const container = document.getElementById('setupProgress');
    
    const checks = [
        { id: 'profile', name: 'Profil Lengkap', check: () => userData?.profile?.nip && userData?.school?.name },
        { id: 'calendar', name: 'Kalender Pendidikan', check: async () => {
            const cal = await db.collection('users').doc(currentUser.uid).collection('calendar').doc(currentAcademicYear).get();
            return cal.exists;
        }},
        { id: 'schedule', name: 'Jadwal Pelajaran', check: async () => {
            const sch = await db.collection('users').doc(currentUser.uid).collection('schedules').where('academicYear', '==', currentAcademicYear).limit(1).get();
            return !sch.empty;
        }},
        { id: 'curriculum', name: 'CP & TP', check: async () => {
            const cp = await db.collection('users').doc(currentUser.uid).collection('curriculum').where('academicYear', '==', currentAcademicYear).limit(1).get();
            return !cp.empty;
        }},
        { id: 'students', name: 'Data Siswa', check: async () => {
            const st = await db.collection('users').doc(currentUser.uid).collection('students').where('academicYear', '==', currentAcademicYear).limit(1).get();
            return !st.empty;
        }}
    ];
    
    let html = '';
    let completed = 0;
    
    for (const item of checks) {
        let isComplete = false;
        try {
            isComplete = typeof item.check === 'function' ? await item.check() : item.check;
        } catch (e) {
            isComplete = false;
        }
        
        if (isComplete) completed++;
        
        html += `
            <div class="flex items-center gap-3 p-3 ${isComplete ? 'bg-green-50' : 'bg-gray-50'} rounded-lg cursor-pointer hover:bg-opacity-80" onclick="navigateTo('${item.id}')">
                <div class="w-8 h-8 rounded-full flex items-center justify-center ${isComplete ? 'bg-green-500' : 'bg-gray-300'}">
                    <i class="fas ${isComplete ? 'fa-check' : 'fa-circle'} text-white text-sm"></i>
                </div>
                <span class="${isComplete ? 'text-green-700' : 'text-gray-600'} font-medium">${item.name}</span>
                <i class="fas fa-chevron-right ml-auto text-gray-400"></i>
            </div>
        `;
    }
    
    // Add progress bar
    const percentage = (completed / checks.length) * 100;
    container.innerHTML = `
        <div class="mb-4">
            <div class="flex justify-between text-sm mb-2">
                <span class="text-gray-600">Progress Pengaturan</span>
                <span class="font-medium text-primary">${completed}/${checks.length}</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-primary h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
        </div>
        ${html}
    `;
}

// ============================================
// PROFILE PAGE
// ============================================
function getProfileHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Profil & Sekolah</h1>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Personal Profile -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-user text-primary mr-2"></i>
                        Data Pribadi
                    </h2>
                    <form id="profileForm" class="space-y-4">
                        <div>
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" id="profileName" class="form-input" placeholder="Nama lengkap Anda" required>
                        </div>
                        
                        <div>
                            <label class="form-label">Email</label>
                            <input type="email" id="profileEmail" class="form-input bg-gray-100" readonly>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">NIP</label>
                                <input type="text" id="profileNIP" class="form-input" placeholder="NIP">
                            </div>
                            <div>
                                <label class="form-label">NUPTK</label>
                                <input type="text" id="profileNUPTK" class="form-input" placeholder="NUPTK">
                            </div>
                        </div>
                        
                        <div>
                            <label class="form-label">No. Telepon/WA</label>
                            <input type="tel" id="profilePhone" class="form-input" placeholder="08xxxxxxxxxx">
                        </div>
                        
                        <button type="submit" class="btn-primary w-full">
                            <i class="fas fa-save"></i>
                            Simpan Data Pribadi
                        </button>
                    </form>
                </div>
                
                <!-- School Info -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-school text-primary mr-2"></i>
                        Data Sekolah
                    </h2>
                    <form id="schoolForm" class="space-y-4">
                        <div>
                            <label class="form-label">Nama Sekolah</label>
                            <input type="text" id="schoolName" class="form-input" placeholder="Nama sekolah" required>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">NPSN</label>
                                <input type="text" id="schoolNPSN" class="form-input" placeholder="NPSN">
                            </div>
                            <div>
                                <label class="form-label">Jenjang</label>
                                <select id="schoolLevel" class="form-input">
                                    <option value="SD">SD/MI</option>
                                    <option value="SMP">SMP/MTs</option>
                                    <option value="SMA">SMA/MA</option>
                                    <option value="SMK">SMK</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="form-label">Alamat Sekolah</label>
                            <textarea id="schoolAddress" class="form-input" rows="2" placeholder="Alamat lengkap sekolah"></textarea>
                        </div>
                        
                        <div>
                            <label class="form-label">Nama Kepala Sekolah</label>
                            <input type="text" id="schoolPrincipal" class="form-input" placeholder="Nama kepala sekolah">
                        </div>
                        
                        <div>
                            <label class="form-label">NIP Kepala Sekolah</label>
                            <input type="text" id="schoolPrincipalNIP" class="form-input" placeholder="NIP kepala sekolah">
                        </div>
                        
                        <button type="submit" class="btn-primary w-full">
                            <i class="fas fa-save"></i>
                            Simpan Data Sekolah
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Subjects Section -->
            <div class="bg-white rounded-xl p-6 shadow-sm mt-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-book text-primary mr-2"></i>
                        Mata Pelajaran yang Diampu
                    </h2>
                    <button onclick="showAddSubjectModal()" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        Tambah Mapel
                    </button>
                </div>
                
                <div id="subjectsList" class="space-y-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    `;
}

async function initProfile() {
    // Fill profile form
    document.getElementById('profileName').value = userData?.name || '';
    document.getElementById('profileEmail').value = userData?.email || '';
    document.getElementById('profileNIP').value = userData?.profile?.nip || '';
    document.getElementById('profileNUPTK').value = userData?.profile?.nuptk || '';
    document.getElementById('profilePhone').value = userData?.profile?.phone || '';
    
    // Fill school form
    document.getElementById('schoolName').value = userData?.school?.name || '';
    document.getElementById('schoolNPSN').value = userData?.school?.npsn || '';
    document.getElementById('schoolLevel').value = userData?.school?.level || 'SD';
    document.getElementById('schoolAddress').value = userData?.school?.address || '';
    document.getElementById('schoolPrincipal').value = userData?.school?.principalName || '';
    document.getElementById('schoolPrincipalNIP').value = userData?.school?.principalNIP || '';
    
    // Load subjects
    loadSubjects();
    
    // Form handlers
    document.getElementById('profileForm').addEventListener('submit', saveProfile);
    document.getElementById('schoolForm').addEventListener('submit', saveSchool);
}

async function saveProfile(e) {
    e.preventDefault();
    showLoading();
    
    try {
        const data = {
            name: document.getElementById('profileName').value,
            'profile.nip': document.getElementById('profileNIP').value,
            'profile.nuptk': document.getElementById('profileNUPTK').value,
            'profile.phone': document.getElementById('profilePhone').value,
        };
        
        await db.collection('users').doc(currentUser.uid).update(data);
        
        // Update local data
        userData.name = data.name;
        userData.profile = userData.profile || {};
        userData.profile.nip = data['profile.nip'];
        userData.profile.nuptk = data['profile.nuptk'];
        userData.profile.phone = data['profile.phone'];
        
        // Update sidebar
        document.getElementById('sidebarUserName').textContent = data.name;
        document.getElementById('headerUserInitial').textContent = data.name.charAt(0).toUpperCase();
        
        showToast('Data pribadi berhasil disimpan!', 'success');
    } catch (error) {
        console.error('Error saving profile:', error);
        showToast('Gagal menyimpan data pribadi.', 'error');
    } finally {
        hideLoading();
    }
}

async function saveSchool(e) {
    e.preventDefault();
    showLoading();
    
    try {
        const data = {
            'school.name': document.getElementById('schoolName').value,
            'school.npsn': document.getElementById('schoolNPSN').value,
            'school.level': document.getElementById('schoolLevel').value,
            'school.address': document.getElementById('schoolAddress').value,
            'school.principalName': document.getElementById('schoolPrincipal').value,
            'school.principalNIP': document.getElementById('schoolPrincipalNIP').value,
        };
        
        await db.collection('users').doc(currentUser.uid).update(data);
        
        // Update local data
        userData.school = userData.school || {};
        userData.school.name = data['school.name'];
        userData.school.npsn = data['school.npsn'];
        userData.school.level = data['school.level'];
        userData.school.address = data['school.address'];
        userData.school.principalName = data['school.principalName'];
        userData.school.principalNIP = data['school.principalNIP'];
        
        showToast('Data sekolah berhasil disimpan!', 'success');
    } catch (error) {
        console.error('Error saving school:', error);
        showToast('Gagal menyimpan data sekolah.', 'error');
    } finally {
        hideLoading();
    }
}

function loadSubjects() {
    const subjects = userData?.profile?.subjects || [];
    const container = document.getElementById('subjectsList');
    
    if (subjects.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-book text-4xl mb-2"></i>
                <p>Belum ada mata pelajaran</p>
                <p class="text-sm">Klik tombol "Tambah Mapel" untuk menambahkan</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = subjects.map((subject, index) => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
                <p class="font-medium text-gray-800">${subject.name}</p>
                <p class="text-sm text-gray-500">${subject.hoursPerWeek} JP/minggu per pertemuan</p>
            </div>
            <div class="flex gap-2">
                <button onclick="editSubject(${index})" class="text-blue-600 hover:text-blue-800 p-2">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteSubject(${index})" class="text-red-600 hover:text-red-800 p-2">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function showAddSubjectModal(editIndex = null) {
    const isEdit = editIndex !== null;
    const subject = isEdit ? userData.profile.subjects[editIndex] : null;
    
    // Get predefined subjects based on school level
    const predefinedSubjects = getPredefinedSubjects(userData?.school?.level || 'SD');
    
    const modalContent = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">${isEdit ? 'Edit' : 'Tambah'} Mata Pelajaran</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="subjectForm" class="space-y-4">
                <input type="hidden" id="subjectEditIndex" value="${editIndex ?? ''}">
                
                <div>
                    <label class="form-label">Pilih Mata Pelajaran</label>
                    <select id="subjectSelect" class="form-input" onchange="onSubjectSelect()">
                        <option value="">-- Pilih atau ketik sendiri --</option>
                        ${predefinedSubjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                        <option value="other">Lainnya (ketik sendiri)</option>
                    </select>
                </div>
                
                <div id="customSubjectInput" class="hidden">
                    <label class="form-label">Nama Mata Pelajaran</label>
                    <input type="text" id="subjectName" class="form-input" placeholder="Contoh: Bahasa Indonesia" value="${subject?.name || ''}">
                </div>
                
                <div>
                    <label class="form-label">Jumlah JP per Pertemuan per Minggu</label>
                    <input type="number" id="subjectHours" class="form-input" min="1" max="10" value="${subject?.hoursPerWeek || 2}" required>
                    <p class="text-xs text-gray-500 mt-1">Jumlah jam pelajaran dalam setiap pertemuan</p>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fas fa-save"></i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    `;
    
    showModal(modalContent);
    
    // If editing, set the select value
    if (isEdit && subject) {
        const select = document.getElementById('subjectSelect');
        const options = Array.from(select.options);
        const match = options.find(o => o.value === subject.name);
        if (match) {
            select.value = subject.name;
        } else {
            select.value = 'other';
            document.getElementById('customSubjectInput').classList.remove('hidden');
            document.getElementById('subjectName').value = subject.name;
        }
    }
    
    document.getElementById('subjectForm').addEventListener('submit', saveSubject);
}

function getPredefinedSubjects(level) {
    const common = [
        'Pendidikan Agama Islam dan Budi Pekerti',
        'Pendidikan Agama Kristen',
        'Pendidikan Agama Katolik',
        'Pendidikan Agama Hindu',
        'Pendidikan Agama Buddha',
        'Pendidikan Agama Khonghucu',
        'Pendidikan Pancasila',
        'Bahasa Indonesia',
        'Matematika',
        'Bahasa Inggris',
        'Pendidikan Jasmani, Olahraga dan Kesehatan',
        'Seni Budaya'
    ];
    
    const sd = [...common, 'IPAS'];
    const smp = [...common, 'IPA', 'IPS', 'Informatika', 'Prakarya'];
    const sma = [...common, 'Fisika', 'Kimia', 'Biologi', 'Ekonomi', 'Sosiologi', 'Geografi', 'Sejarah', 'Informatika'];
    
    switch(level) {
        case 'SD': return sd;
        case 'SMP': return smp;
        case 'SMA': case 'SMK': return sma;
        default: return common;
    }
}

function onSubjectSelect() {
    const select = document.getElementById('subjectSelect');
    const customInput = document.getElementById('customSubjectInput');
    
    if (select.value === 'other') {
        customInput.classList.remove('hidden');
        document.getElementById('subjectName').required = true;
    } else {
        customInput.classList.add('hidden');
        document.getElementById('subjectName').required = false;
    }
}

async function saveSubject(e) {
    e.preventDefault();
    
    const select = document.getElementById('subjectSelect');
    const subjectName = select.value === 'other' 
        ? document.getElementById('subjectName').value 
        : select.value;
    
    if (!subjectName) {
        showToast('Pilih atau masukkan nama mata pelajaran', 'warning');
        return;
    }
    
    const hours = parseInt(document.getElementById('subjectHours').value);
    const editIndex = document.getElementById('subjectEditIndex').value;
    
    showLoading();
    
    try {
        const subjects = userData.profile?.subjects || [];
        
        const newSubject = {
            name: subjectName,
            hoursPerWeek: hours
        };
        
        if (editIndex !== '') {
            subjects[parseInt(editIndex)] = newSubject;
        } else {
            // Check duplicate
            if (subjects.some(s => s.name === subjectName)) {
                showToast('Mata pelajaran ini sudah ada!', 'warning');
                hideLoading();
                return;
            }
            subjects.push(newSubject);
        }
        
        await db.collection('users').doc(currentUser.uid).update({
            'profile.subjects': subjects
        });
        
        userData.profile.subjects = subjects;
        
        closeModal();
        loadSubjects();
        showToast('Mata pelajaran berhasil disimpan!', 'success');
    } catch (error) {
        console.error('Error saving subject:', error);
        showToast('Gagal menyimpan mata pelajaran.', 'error');
    } finally {
        hideLoading();
    }
}

function editSubject(index) {
    showAddSubjectModal(index);
}

async function deleteSubject(index) {
    if (!confirm('Hapus mata pelajaran ini?')) return;
    
    showLoading();
    
    try {
        const subjects = userData.profile?.subjects || [];
        subjects.splice(index, 1);
        
        await db.collection('users').doc(currentUser.uid).update({
            'profile.subjects': subjects
        });
        
        userData.profile.subjects = subjects;
        loadSubjects();
        showToast('Mata pelajaran berhasil dihapus!', 'success');
    } catch (error) {
        console.error('Error deleting subject:', error);
        showToast('Gagal menghapus mata pelajaran.', 'error');
    } finally {
        hideLoading();
    }
}

// ============================================
// CALENDAR PAGE
// ============================================
function getCalendarHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Kalender Pendidikan</h1>
                <div class="flex gap-2">
                    <button onclick="saveCalendar()" class="btn-primary">
                        <i class="fas fa-save"></i>
                        Simpan Kalender
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-calendar text-primary mr-2"></i>
                    Tahun Pelajaran ${currentAcademicYear}
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Semester 1 -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700 pb-2 border-b">Semester 1 (Ganjil)</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Awal Semester 1</label>
                                <input type="date" id="sem1Start" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Akhir Semester 1</label>
                                <input type="date" id="sem1End" class="form-input">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Awal PTS 1</label>
                                <input type="date" id="pts1Start" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Akhir PTS 1</label>
                                <input type="date" id="pts1End" class="form-input">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Awal PAS</label>
                                <input type="date" id="pas1Start" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Akhir PAS</label>
                                <input type="date" id="pas1End" class="form-input">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Semester 2 -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-700 pb-2 border-b">Semester 2 (Genap)</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Awal Semester 2</label>
                                <input type="date" id="sem2Start" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Akhir Semester 2</label>
                                <input type="date" id="sem2End" class="form-input">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Awal PTS 2</label>
                                <input type="date" id="pts2Start" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Akhir PTS 2</label>
                                <input type="date" id="pts2End" class="form-input">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">Awal PAT</label>
                                <input type="date" id="pat2Start" class="form-input">
                            </div>
                            <div>
                                <label class="form-label">Akhir PAT</label>
                                <input type="date" id="pat2End" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Holidays Section -->
            <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-umbrella-beach text-primary mr-2"></i>
                        Libur & Kegiatan Khusus
                    </h2>
                    <button onclick="addHoliday()" class="btn-secondary">
                        <i class="fas fa-plus"></i>
                        Tambah
                    </button>
                </div>
                
                <div id="holidaysList" class="space-y-3">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <!-- Calendar Preview -->
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-eye text-primary mr-2"></i>
                    Preview Kalender
                </h2>
                <div id="calendarPreview" class="overflow-x-auto">
                    <!-- Calendar preview will be rendered here -->
                </div>
            </div>
        </div>
    `;
}

let holidays = [];

async function initCalendar() {
    // Load existing calendar data
    try {
        const calDoc = await db.collection('users').doc(currentUser.uid)
            .collection('calendar').doc(currentAcademicYear).get();
        
        if (calDoc.exists) {
            const data = calDoc.data();
            
            // Fill semester dates
            document.getElementById('sem1Start').value = data.semester1?.start || '';
            document.getElementById('sem1End').value = data.semester1?.end || '';
            document.getElementById('pts1Start').value = data.pts1?.start || '';
            document.getElementById('pts1End').value = data.pts1?.end || '';
            document.getElementById('pas1Start').value = data.pas?.start || '';
            document.getElementById('pas1End').value = data.pas?.end || '';
            
            document.getElementById('sem2Start').value = data.semester2?.start || '';
            document.getElementById('sem2End').value = data.semester2?.end || '';
            document.getElementById('pts2Start').value = data.pts2?.start || '';
            document.getElementById('pts2End').value = data.pts2?.end || '';
            document.getElementById('pat2Start').value = data.pat?.start || '';
            document.getElementById('pat2End').value = data.pat?.end || '';
            
            holidays = data.holidays || [];
        } else {
            // Set default dates based on academic year
            const [startYear, endYear] = currentAcademicYear.split('/').map(Number);
            
            document.getElementById('sem1Start').value = `${startYear}-07-15`;
            document.getElementById('sem1End').value = `${startYear}-12-20`;
            document.getElementById('pts1Start').value = `${startYear}-09-25`;
            document.getElementById('pts1End').value = `${startYear}-09-30`;
            document.getElementById('pas1Start').value = `${startYear}-12-05`;
            document.getElementById('pas1End').value = `${startYear}-12-15`;
            
            document.getElementById('sem2Start').value = `${endYear}-01-05`;
            document.getElementById('sem2End').value = `${endYear}-06-15`;
            document.getElementById('pts2Start').value = `${endYear}-03-10`;
            document.getElementById('pts2End').value = `${endYear}-03-15`;
            document.getElementById('pat2Start').value = `${endYear}-05-25`;
            document.getElementById('pat2End').value = `${endYear}-06-05`;
            
            holidays = [];
        }
        
        renderHolidays();
        renderCalendarPreview();
    } catch (error) {
        console.error('Error loading calendar:', error);
        showToast('Gagal memuat kalender.', 'error');
    }
}

function renderHolidays() {
    const container = document.getElementById('holidaysList');
    
    if (holidays.length === 0) {
        container.innerHTML = `
            <div class="text-center py-6 text-gray-500">
                <i class="fas fa-calendar-times text-3xl mb-2"></i>
                <p>Belum ada libur atau kegiatan khusus</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = holidays.map((h, index) => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center ${h.type === 'holiday' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}">
                    <i class="fas ${h.type === 'holiday' ? 'fa-umbrella-beach' : 'fa-calendar-check'}"></i>
                </div>
                <div>
                    <p class="font-medium text-gray-800">${h.name}</p>
                    <p class="text-sm text-gray-500">${formatDate(h.startDate, 'short')} - ${formatDate(h.endDate, 'short')}</p>
                </div>
            </div>
            <button onclick="deleteHoliday(${index})" class="text-red-600 hover:text-red-800 p-2">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

function addHoliday() {
    const modalContent = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Tambah Libur/Kegiatan</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="holidayForm" class="space-y-4">
                <div>
                    <label class="form-label">Nama</label>
                    <input type="text" id="holidayName" class="form-input" placeholder="Contoh: Libur Hari Raya" required>
                </div>
                
                <div>
                    <label class="form-label">Tipe</label>
                    <select id="holidayType" class="form-input">
                        <option value="holiday">Libur</option>
                        <option value="activity">Kegiatan Khusus</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Tanggal Mulai</label>
                        <input type="date" id="holidayStart" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Tanggal Akhir</label>
                        <input type="date" id="holidayEnd" class="form-input" required>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fas fa-save"></i>
                        Tambah
                    </button>
                </div>
            </form>
        </div>
    `;
    
    showModal(modalContent);
    
    document.getElementById('holidayForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        holidays.push({
            name: document.getElementById('holidayName').value,
            type: document.getElementById('holidayType').value,
            startDate: document.getElementById('holidayStart').value,
            endDate: document.getElementById('holidayEnd').value
        });
        
        closeModal();
        renderHolidays();
        renderCalendarPreview();
        showToast('Libur/kegiatan berhasil ditambahkan!', 'success');
    });
}

function deleteHoliday(index) {
    if (!confirm('Hapus item ini?')) return;
    holidays.splice(index, 1);
    renderHolidays();
    renderCalendarPreview();
}

async function saveCalendar() {
    showLoading();
    
    try {
        const calendarData = {
            academicYear: currentAcademicYear,
            semester1: {
                start: document.getElementById('sem1Start').value,
                end: document.getElementById('sem1End').value
            },
            semester2: {
                start: document.getElementById('sem2Start').value,
                end: document.getElementById('sem2End').value
            },
            pts1: {
                start: document.getElementById('pts1Start').value,
                end: document.getElementById('pts1End').value
            },
            pas: {
                start: document.getElementById('pas1Start').value,
                end: document.getElementById('pas1End').value
            },
            pts2: {
                start: document.getElementById('pts2Start').value,
                end: document.getElementById('pts2End').value
            },
            pat: {
                start: document.getElementById('pat2Start').value,
                end: document.getElementById('pat2End').value
            },
            holidays: holidays,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('users').doc(currentUser.uid)
            .collection('calendar').doc(currentAcademicYear).set(calendarData);
        
        showToast('Kalender berhasil disimpan!', 'success');
    } catch (error) {
        console.error('Error saving calendar:', error);
        showToast('Gagal menyimpan kalender.', 'error');
    } finally {
        hideLoading();
    }
}

function renderCalendarPreview() {
    const container = document.getElementById('calendarPreview');
    const months = ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
    const [startYear, endYear] = currentAcademicYear.split('/').map(Number);
    
    let html = '<div class="grid grid-cols-2 lg:grid-cols-4 gap-4">';
    
    months.forEach((month, idx) => {
        const year = idx < 6 ? startYear : endYear;
        const monthNum = idx < 6 ? idx + 7 : idx - 5;
        
        html += `
            <div class="border rounded-lg p-3">
                <h4 class="font-semibold text-center text-gray-800 mb-2">${month} ${year}</h4>
                <div class="grid grid-cols-7 gap-1 text-xs text-center">
                    <span class="text-red-500 font-medium">M</span>
                    <span class="font-medium">S</span>
                    <span class="font-medium">S</span>
                    <span class="font-medium">R</span>
                    <span class="font-medium">K</span>
                    <span class="font-medium">J</span>
                    <span class="font-medium">S</span>
        `;
        
        // Get first day of month
        const firstDay = new Date(year, monthNum - 1, 1);
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        const startDay = firstDay.getDay();
        
        // Empty cells for days before first day
        for (let i = 0; i < startDay; i++) {
            html += '<span></span>';
        }
        
        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isHoliday = isDateInHoliday(dateStr);
            const isExam = isDateInExam(dateStr);
            const isSunday = (startDay + day - 1) % 7 === 0;
            
            let bgColor = '';
            if (isHoliday) bgColor = 'bg-red-100 text-red-600';
            else if (isExam) bgColor = 'bg-yellow-100 text-yellow-600';
            else if (isSunday) bgColor = 'text-red-500';
            
            html += `<span class="${bgColor} rounded p-1">${day}</span>`;
        }
        
        html += `
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Legend
    html += `
        <div class="mt-4 flex flex-wrap gap-4 justify-center text-sm">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-red-100 rounded"></div>
                <span>Libur</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-yellow-100 rounded"></div>
                <span>Ujian</span>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function isDateInHoliday(dateStr) {
    return holidays.some(h => {
        return h.type === 'holiday' && dateStr >= h.startDate && dateStr <= h.endDate;
    });
}

function isDateInExam(dateStr) {
    const pts1Start = document.getElementById('pts1Start')?.value;
    const pts1End = document.getElementById('pts1End')?.value;
    const pas1Start = document.getElementById('pas1Start')?.value;
    const pas1End = document.getElementById('pas1End')?.value;
    const pts2Start = document.getElementById('pts2Start')?.value;
    const pts2End = document.getElementById('pts2End')?.value;
    const pat2Start = document.getElementById('pat2Start')?.value;
    const pat2End = document.getElementById('pat2End')?.value;
    
    return (dateStr >= pts1Start && dateStr <= pts1End) ||
           (dateStr >= pas1Start && dateStr <= pas1End) ||
           (dateStr >= pts2Start && dateStr <= pts2End) ||
           (dateStr >= pat2Start && dateStr <= pat2End);
}

// ============================================
// SCHEDULE PAGE
// ============================================
function getScheduleHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Jadwal Pelajaran</h1>
                <div class="flex flex-wrap gap-2">
                    <button onclick="showTimeSettingsModal()" class="btn-secondary">
                        <i class="fas fa-clock"></i>
                        Atur Waktu
                    </button>
                    <button onclick="showAddScheduleModal()" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        Tambah Jadwal
                    </button>
                </div>
            </div>
            
            <!-- Time Slots Display -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">Jam Pelajaran</h3>
                <div id="timeSlotsDisplay" class="flex flex-wrap gap-2">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <!-- Schedule Table -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-20">Jam</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Senin</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Selasa</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rabu</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kamis</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Jumat</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Sabtu</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

let timeSlots = [];
let scheduleData = [];

async function initSchedule() {
    // Load time slots
    try {
        const timeSlotsDoc = await db.collection('users').doc(currentUser.uid)
            .collection('settings').doc('timeSlots').get();
        
        if (timeSlotsDoc.exists) {
            timeSlots = timeSlotsDoc.data().slots || [];
        } else {
            // Default time slots based on school level
            timeSlots = getDefaultTimeSlots(userData?.school?.level || 'SD');
        }
        
        // Load schedules
        const schedulesSnap = await db.collection('users').doc(currentUser.uid)
            .collection('schedules')
            .where('academicYear', '==', currentAcademicYear)
            .get();
        
        scheduleData = [];
        schedulesSnap.forEach(doc => {
            scheduleData.push({ id: doc.id, ...doc.data() });
        });
        
        renderTimeSlots();
        renderScheduleTable();
    } catch (error) {
        console.error('Error loading schedule:', error);
        showToast('Gagal memuat jadwal.', 'error');
    }
}

function getDefaultTimeSlots(level) {
    const durations = {
        'SD': 35,
        'SMP': 40,
        'SMA': 45,
        'SMK': 45
    };
    
    const duration = durations[level] || 40;
    const slots = [];
    let startTime = 7 * 60; // 07:00 in minutes
    
    for (let i = 1; i <= 8; i++) {
        const startHour = Math.floor(startTime / 60);
        const startMin = startTime % 60;
        const endTime = startTime + duration;
        const endHour = Math.floor(endTime / 60);
        const endMin = endTime % 60;
        
        slots.push({
            slot: i,
            start: `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`,
            end: `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`,
            duration: duration
        });
        
        // Add 5 min break between slots, 15 min for break time
        startTime = endTime + (i === 3 ? 15 : 5);
    }
    
    return slots;
}

function renderTimeSlots() {
    const container = document.getElementById('timeSlotsDisplay');
    
    if (timeSlots.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Belum ada jam pelajaran. Klik "Atur Waktu" untuk menambah.</p>';
        return;
    }
    
    container.innerHTML = timeSlots.map(slot => `
        <div class="px-3 py-2 bg-blue-50 rounded-lg text-sm">
            <span class="font-medium text-blue-800">JP ${slot.slot}</span>
            <span class="text-blue-600">${slot.start} - ${slot.end}</span>
        </div>
    `).join('');
}

function renderScheduleTable() {
    const tbody = document.getElementById('scheduleTableBody');
    const days = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
    
    if (timeSlots.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    Atur jam pelajaran terlebih dahulu
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    timeSlots.forEach(slot => {
        html += `
            <tr class="border-t">
                <td class="px-4 py-3 text-sm">
                    <div class="font-medium">JP ${slot.slot}</div>
                    <div class="text-xs text-gray-500">${slot.start}-${slot.end}</div>
                </td>
        `;
        
        days.forEach(day => {
            const schedules = scheduleData.filter(s => 
                s.day === day && s.timeSlot === slot.slot
            );
            
            html += '<td class="px-2 py-2 text-center border-l">';
            
            if (schedules.length > 0) {
                schedules.forEach(sch => {
                    html += `
                        <div class="bg-primary bg-opacity-10 rounded-lg p-2 mb-1 text-xs cursor-pointer hover:bg-opacity-20" onclick="editSchedule('${sch.id}')">
                            <p class="font-medium text-primary truncate">${sch.subject}</p>
                            <p class="text-gray-600">${sch.className}-${sch.rombel}</p>
                        </div>
                    `;
                });
            } else {
                html += `
                    <button onclick="quickAddSchedule('${day}', ${slot.slot})" class="w-full h-full min-h-[60px] text-gray-300 hover:text-gray-400 hover:bg-gray-50 rounded-lg transition-colors">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
            }
            
            html += '</td>';
        });
        
        html += '</tr>';
    });
    
    tbody.innerHTML = html;
}

function showTimeSettingsModal() {
    let slotsHtml = timeSlots.map((slot, idx) => `
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg" data-slot-index="${idx}">
            <span class="font-medium text-gray-700 w-16">JP ${slot.slot}</span>
            <input type="time" value="${slot.start}" class="form-input w-32 slot-start">
            <span class="text-gray-500">-</span>
            <input type="time" value="${slot.end}" class="form-input w-32 slot-end">
            <button onclick="removeTimeSlot(${idx})" class="text-red-500 hover:text-red-700 p-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
    
    const modalContent = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Pengaturan Jam Pelajaran</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="form-label">Durasi Default (menit)</label>
                <input type="number" id="defaultDuration" class="form-input w-32" value="${timeSlots[0]?.duration || 40}" min="20" max="60">
            </div>
            
            <div id="timeSlotsEditor" class="space-y-2 mb-4 max-h-96 overflow-y-auto">
                ${slotsHtml}
            </div>
            
            <button onclick="addTimeSlot()" class="btn-secondary w-full mb-4">
                <i class="fas fa-plus"></i>
                Tambah Jam Pelajaran
            </button>
            
            <div class="flex gap-3">
                <button onclick="resetTimeSlots()" class="btn-secondary flex-1">
                    <i class="fas fa-undo"></i>
                    Reset Default
                </button>
                <button onclick="saveTimeSlots()" class="btn-primary flex-1">
                    <i class="fas fa-save"></i>
                    Simpan
                </button>
            </div>
        </div>
    `;
    
    showModal(modalContent);
}

function addTimeSlot() {
    const editor = document.getElementById('timeSlotsEditor');
    const newSlot = timeSlots.length + 1;
    const lastSlot = timeSlots[timeSlots.length - 1];
    const duration = parseInt(document.getElementById('defaultDuration').value) || 40;
    
    let startTime = 7 * 60;
    if (lastSlot) {
        const [h, m] = lastSlot.end.split(':').map(Number);
        startTime = h * 60 + m + 5;
    }
    
    const startHour = Math.floor(startTime / 60);
    const startMin = startTime % 60;
    const endTime = startTime + duration;
    const endHour = Math.floor(endTime / 60);
    const endMin = endTime % 60;
    
    const newSlotData = {
        slot: newSlot,
        start: `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`,
        end: `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`,
        duration: duration
    };
    
    timeSlots.push(newSlotData);
    
    editor.innerHTML += `
        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg" data-slot-index="${timeSlots.length - 1}">
            <span class="font-medium text-gray-700 w-16">JP ${newSlot}</span>
            <input type="time" value="${newSlotData.start}" class="form-input w-32 slot-start">
            <span class="text-gray-500">-</span>
            <input type="time" value="${newSlotData.end}" class="form-input w-32 slot-end">
            <button onclick="removeTimeSlot(${timeSlots.length - 1})" class="text-red-500 hover:text-red-700 p-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
}

function removeTimeSlot(index) {
    timeSlots.splice(index, 1);
    // Re-number slots
    timeSlots = timeSlots.map((slot, idx) => ({ ...slot, slot: idx + 1 }));
    showTimeSettingsModal();
}

function resetTimeSlots() {
    timeSlots = getDefaultTimeSlots(userData?.school?.level || 'SD');
    showTimeSettingsModal();
}

async function saveTimeSlots() {
    // Get values from inputs
    const editor = document.getElementById('timeSlotsEditor');
    const rows = editor.querySelectorAll('[data-slot-index]');
    const duration = parseInt(document.getElementById('defaultDuration').value) || 40;
    
    timeSlots = [];
    rows.forEach((row, idx) => {
        const start = row.querySelector('.slot-start').value;
        const end = row.querySelector('.slot-end').value;
        timeSlots.push({
            slot: idx + 1,
            start,
            end,
            duration
        });
    });
    
    showLoading();
    
    try {
        await db.collection('users').doc(currentUser.uid)
            .collection('settings').doc('timeSlots').set({
                slots: timeSlots,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        closeModal();
        renderTimeSlots();
        renderScheduleTable();
        showToast('Jam pelajaran berhasil disimpan!', 'success');
    } catch (error) {
        console.error('Error saving time slots:', error);
        showToast('Gagal menyimpan jam pelajaran.', 'error');
    } finally {
        hideLoading();
    }
}

function quickAddSchedule(day, slot) {
    showAddScheduleModal(day, slot);
}

function showAddScheduleModal(defaultDay = '', defaultSlot = '') {
    const subjects = userData?.profile?.subjects || [];
    const dayNames = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
    
    const modalContent = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Tambah Jadwal</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="scheduleForm" class="space-y-4">
                <div>
                    <label class="form-label">Mata Pelajaran</label>
                    <select id="scheduleSubject" class="form-input" required>
                        <option value="">-- Pilih Mata Pelajaran --</option>
                        ${subjects.map(s => `<option value="${s.name}" data-hours="${s.hoursPerWeek}">${s.name}</option>`).join('')}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Hari</label>
                        <select id="scheduleDay" class="form-input" required>
                            ${dayNames.map(d => `<option value="${d}" ${d === defaultDay ? 'selected' : ''}>${d.charAt(0).toUpperCase() + d.slice(1)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Jam Pelajaran</label>
                        <select id="scheduleSlot" class="form-input" required>
                            ${timeSlots.map(slot => `<option value="${slot.slot}" ${slot.slot === defaultSlot ? 'selected' : ''}>JP ${slot.slot} (${slot.start})</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Kelas</label>
                        <select id="scheduleClass" class="form-input" required>
                            ${getClassOptions()}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Rombel</label>
                        <input type="text" id="scheduleRombel" class="form-input" placeholder="A, B, C, ..." value="A" required>
                    </div>
                </div>
                
                <div id="scheduleConflict" class="hidden p-3 bg-red-50 text-red-700 rounded-lg text-sm">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="conflictMessage"></span>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fas fa-save"></i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    `;
    
    showModal(modalContent);
    
    // Add conflict check on change
    ['scheduleDay', 'scheduleSlot', 'scheduleClass', 'scheduleRombel'].forEach(id => {
        document.getElementById(id).addEventListener('change', checkScheduleConflict);
    });
    
    document.getElementById('scheduleForm').addEventListener('submit', saveSchedule);
}

function getClassOptions() {
    const level = userData?.school?.level || 'SD';
    let classes = [];
    
    switch(level) {
        case 'SD':
            classes = [1, 2, 3, 4, 5, 6];
            break;
        case 'SMP':
            classes = [7, 8, 9];
            break;
        case 'SMA':
        case 'SMK':
            classes = [10, 11, 12];
            break;
    }
    
    return classes.map(c => `<option value="${c}">Kelas ${c}</option>`).join('');
}

function checkScheduleConflict() {
    const day = document.getElementById('scheduleDay').value;
    const slot = parseInt(document.getElementById('scheduleSlot').value);
    const className = document.getElementById('scheduleClass').value;
    const rombel = document.getElementById('scheduleRombel').value;
    
    const conflictDiv = document.getElementById('scheduleConflict');
    const conflictMsg = document.getElementById('conflictMessage');
    
    // Check for conflicts
    const conflicts = scheduleData.filter(s => 
        s.day === day && 
        s.timeSlot === slot && 
        (s.className === className && s.rombel === rombel)
    );
    
    if (conflicts.length > 0) {
        conflictDiv.classList.remove('hidden');
        conflictMsg.textContent = `Kelas ${className}-${rombel} sudah ada jadwal di waktu ini (${conflicts[0].subject})`;
        return true;
    }
    
    // Check if teacher is teaching at same time
    const teacherConflict = scheduleData.filter(s => 
        s.day === day && 
        s.timeSlot === slot
    );
    
    if (teacherConflict.length > 0) {
        conflictDiv.classList.remove('hidden');
        conflictMsg.textContent = `Anda sudah mengajar di kelas ${teacherConflict[0].className}-${teacherConflict[0].rombel} pada waktu ini`;
        return true;
    }
    
    conflictDiv.classList.add('hidden');
    return false;
}

async function saveSchedule(e) {
    e.preventDefault();
    
    if (checkScheduleConflict()) {
        showToast('Perbaiki konflik jadwal terlebih dahulu!', 'warning');
        return;
    }
    
    const slot = parseInt(document.getElementById('scheduleSlot').value);
    const timeSlot = timeSlots.find(t => t.slot === slot);
    
    const scheduleItem = {
        academicYear: currentAcademicYear,
        subject: document.getElementById('scheduleSubject').value,
        day: document.getElementById('scheduleDay').value,
        timeSlot: slot,
        startTime: timeSlot.start,
        endTime: timeSlot.end,
        className: document.getElementById('scheduleClass').value,
        rombel: document.getElementById('scheduleRombel').value.toUpperCase(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    showLoading();
    
    try {
        const docRef = await db.collection('users').doc(currentUser.uid)
            .collection('schedules').add(scheduleItem);
        
        scheduleData.push({ id: docRef.id, ...scheduleItem });
        
        closeModal();
        renderScheduleTable();
        showToast('Jadwal berhasil ditambahkan!', 'success');
    } catch (error) {
        console.error('Error saving schedule:', error);
        showToast('Gagal menyimpan jadwal.', 'error');
    } finally {
        hideLoading();
    }
}

async function editSchedule(scheduleId) {
    const schedule = scheduleData.find(s => s.id === scheduleId);
    if (!schedule) return;
    
    const subjects = userData?.profile?.subjects || [];
    const dayNames = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
    
    const modalContent = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Edit Jadwal</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editScheduleForm" class="space-y-4">
                <input type="hidden" id="editScheduleId" value="${scheduleId}">
                
                <div>
                    <label class="form-label">Mata Pelajaran</label>
                    <select id="editScheduleSubject" class="form-input" required>
                        ${subjects.map(s => `<option value="${s.name}" ${s.name === schedule.subject ? 'selected' : ''}>${s.name}</option>`).join('')}
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Hari</label>
                        <select id="editScheduleDay" class="form-input" required>
                            ${dayNames.map(d => `<option value="${d}" ${d === schedule.day ? 'selected' : ''}>${d.charAt(0).toUpperCase() + d.slice(1)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Jam Pelajaran</label>
                        <select id="editScheduleSlot" class="form-input" required>
                            ${timeSlots.map(slot => `<option value="${slot.slot}" ${slot.slot === schedule.timeSlot ? 'selected' : ''}>JP ${slot.slot} (${slot.start})</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Kelas</label>
                        <select id="editScheduleClass" class="form-input" required>
                            ${getClassOptions().replace(`value="${schedule.className}"`, `value="${schedule.className}" selected`)}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Rombel</label>
                        <input type="text" id="editScheduleRombel" class="form-input" value="${schedule.rombel}" required>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="deleteSchedule('${scheduleId}')" class="btn-danger flex-1">
                        <i class="fas fa-trash"></i>
                        Hapus
                    </button>
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fas fa-save"></i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    `;
    
    showModal(modalContent);
    
    document.getElementById('editScheduleForm').addEventListener('submit', updateSchedule);
}

async function updateSchedule(e) {
    e.preventDefault();
    
    const scheduleId = document.getElementById('editScheduleId').value;
    const slot = parseInt(document.getElementById('editScheduleSlot').value);
    const timeSlot = timeSlots.find(t => t.slot === slot);
    
    const updates = {
        subject: document.getElementById('editScheduleSubject').value,
        day: document.getElementById('editScheduleDay').value,
        timeSlot: slot,
        startTime: timeSlot.start,
        endTime: timeSlot.end,
        className: document.getElementById('editScheduleClass').value,
        rombel: document.getElementById('editScheduleRombel').value.toUpperCase(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    showLoading();
    
    try {
        await db.collection('users').doc(currentUser.uid)
            .collection('schedules').doc(scheduleId).update(updates);
        
        // Update local data
        const index = scheduleData.findIndex(s => s.id === scheduleId);
        if (index !== -1) {
            scheduleData[index] = { ...scheduleData[index], ...updates };
        }
        
        closeModal();
        renderScheduleTable();
        showToast('Jadwal berhasil diupdate!', 'success');
    } catch (error) {
        console.error('Error updating schedule:', error);
        showToast('Gagal mengupdate jadwal.', 'error');
    } finally {
        hideLoading();
    }
}

async function deleteSchedule(scheduleId) {
    if (!confirm('Hapus jadwal ini?')) return;
    
    showLoading();
    
    try {
        await db.collection('users').doc(currentUser.uid)
            .collection('schedules').doc(scheduleId).delete();
        
        scheduleData = scheduleData.filter(s => s.id !== scheduleId);
        
        closeModal();
        renderScheduleTable();
        showToast('Jadwal berhasil dihapus!', 'success');
    } catch (error) {
        console.error('Error deleting schedule:', error);
        showToast('Gagal menghapus jadwal.', 'error');
    } finally {
        hideLoading();
    }
}

// ============================================
// CURRICULUM (CP & TP) PAGE
// ============================================
function getCurriculumHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Capaian Pembelajaran & Tujuan Pembelajaran</h1>
                    <p class="text-gray-600 text-sm mt-1">Kelola CP dan TP untuk setiap mata pelajaran</p>
                </div>
                <button onclick="showAddCurriculumModal()" class="btn-primary">
                    <i class="fas fa-plus"></i>
                    Tambah CP/TP
                </button>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Mata Pelajaran</label>
                        <select id="filterSubject" class="form-input" onchange="filterCurriculum()">
                            <option value="">Semua Mata Pelajaran</option>
                            ${(userData?.profile?.subjects || []).map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Fase/Kelas</label>
                        <select id="filterPhase" class="form-input" onchange="filterCurriculum()">
                            <option value="">Semua Fase</option>
                            ${getPhaseOptions()}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Semester</label>
                        <select id="filterSemester" class="form-input" onchange="filterCurriculum()">
                            <option value="">Semua Semester</option>
                            <option value="1">Semester 1 (Ganjil)</option>
                            <option value="2">Semester 2 (Genap)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- PAI Default CP Notice -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                <div class="flex items-start gap-3">
                    <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                    <div>
                        <p class="font-medium text-blue-800">Data CP PAI Default Tersedia</p>
                        <p class="text-sm text-blue-600 mt-1">
                            CP PAI dan Budi Pekerti berdasarkan Kepka BSKAP No. 046/H/KR/2025 telah tersedia. 
                            <button onclick="loadDefaultPAI()" class="underline font-medium">Klik untuk memuat data PAI</button>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Curriculum List -->
            <div id="curriculumList" class="space-y-4">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    `;
}

function getPhaseOptions() {
    const level = userData?.school?.level || 'SD';
    let phases = [];
    
    switch(level) {
        case 'SD':
            phases = [
                { value: 'A', label: 'Fase A (Kelas 1-2)' },
                { value: 'B', label: 'Fase B (Kelas 3-4)' },
                { value: 'C', label: 'Fase C (Kelas 5-6)' }
            ];
            break;
        case 'SMP':
            phases = [
                { value: 'D', label: 'Fase D (Kelas 7-9)' }
            ];
            break;
        case 'SMA':
        case 'SMK':
            phases = [
                { value: 'E', label: 'Fase E (Kelas 10)' },
                { value: 'F', label: 'Fase F (Kelas 11-12)' }
            ];
            break;
    }
    
    return phases.map(p => `<option value="${p.value}">${p.label}</option>`).join('');
}

let curriculumData = [];

async function initCurriculum() {
    try {
        const snap = await db.collection('users').doc(currentUser.uid)
            .collection('curriculum')
            .where('academicYear', '==', currentAcademicYear)
            .get();
        
        curriculumData = [];
        snap.forEach(doc => {
            curriculumData.push({ id: doc.id, ...doc.data() });
        });
        
        renderCurriculum();
    } catch (error) {
        console.error('Error loading curriculum:', error);
        showToast('Gagal memuat data kurikulum.', 'error');
    }
}

function filterCurriculum() {
    renderCurriculum();
}

function renderCurriculum() {
    const container = document.getElementById('curriculumList');
    const subjectFilter = document.getElementById('filterSubject').value;
    const phaseFilter = document.getElementById('filterPhase').value;
    const semesterFilter = document.getElementById('filterSemester').value;
    
    let filtered = curriculumData;
    
    if (subjectFilter) {
        filtered = filtered.filter(c => c.subject === subjectFilter);
    }
    if (phaseFilter) {
        filtered = filtered.filter(c => c.phase === phaseFilter);
    }
    if (semesterFilter) {
        filtered = filtered.filter(c => c.semester === parseInt(semesterFilter));
    }
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="bg-white rounded-xl p-8 shadow-sm text-center">
                <i class="fas fa-book-open text-4xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">Belum ada data CP/TP</p>
                <p class="text-sm text-gray-400 mt-1">Klik tombol "Tambah CP/TP" untuk menambahkan</p>
            </div>
        `;
        return;
    }
    
    // Group by subject
    const grouped = filtered.reduce((acc, item) => {
        if (!acc[item.subject]) {
            acc[item.subject] = [];
        }
        acc[item.subject].push(item);
        return acc;
    }, {});
    
    let html = '';
    
    for (const [subject, items] of Object.entries(grouped)) {
        html += `
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-gradient-to-r from-primary to-accent p-4 text-white">
                    <h3 class="font-semibold">${subject}</h3>
                </div>
                <div class="divide-y">
        `;
        
        items.forEach(item => {
            html += `
                <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="viewCurriculumDetail('${item.id}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Fase ${item.phase}</span>
                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">Semester ${item.semester}</span>
                            </div>
                            <p class="font-medium text-gray-800 mb-1">Elemen: ${item.element || '-'}</p>
                            <p class="text-sm text-gray-600 line-clamp-2">${item.cp}</p>
                            <p class="text-xs text-gray-400 mt-2">${item.tps?.length || 0} Tujuan Pembelajaran</p>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="event.stopPropagation(); editCurriculum('${item.id}')" class="text-blue-600 hover:text-blue-800 p-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteCurriculum('${item.id}')" class="text-red-600 hover:text-red-800 p-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function showAddCurriculumModal(editData = null) {
    const isEdit = !!editData;
    const subjects = userData?.profile?.subjects || [];
    
    const modalContent = `
                        <div class="p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">${isEdit ? 'Edit' : 'Tambah'} CP & TP</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="curriculumForm" class="space-y-4">
                <input type="hidden" id="curriculumId" value="${editData?.id || ''}">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Mata Pelajaran</label>
                        <select id="currSubject" class="form-input" required>
                            <option value="">-- Pilih --</option>
                            ${subjects.map(s => `<option value="${s.name}" ${editData?.subject === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Fase</label>
                        <select id="currPhase" class="form-input" required>
                            ${getPhaseOptions().replace(`value="${editData?.phase}"`, `value="${editData?.phase}" selected`)}
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Semester</label>
                        <select id="currSemester" class="form-input" required>
                            <option value="1" ${editData?.semester === 1 ? 'selected' : ''}>Semester 1 (Ganjil)</option>
                            <option value="2" ${editData?.semester === 2 ? 'selected' : ''}>Semester 2 (Genap)</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Elemen</label>
                        <input type="text" id="currElement" class="form-input" placeholder="Contoh: Al-Quran Hadis" value="${editData?.element || ''}">
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Capaian Pembelajaran (CP)</label>
                    <textarea id="currCP" class="form-input" rows="4" placeholder="Masukkan capaian pembelajaran..." required>${editData?.cp || ''}</textarea>
                </div>
                
                <div>
                    <label class="form-label">Tujuan Pembelajaran (TP)</label>
                    <div id="tpContainer" class="space-y-2">
                        ${(editData?.tps || ['']).map((tp, idx) => `
                            <div class="flex gap-2 tp-item">
                                <span class="flex items-center justify-center w-8 h-10 bg-gray-100 rounded text-sm font-medium">${idx + 1}</span>
                                <textarea class="form-input flex-1 tp-input" rows="2" placeholder="Tujuan Pembelajaran ${idx + 1}">${tp}</textarea>
                                <button type="button" onclick="removeTP(this)" class="text-red-500 hover:text-red-700 p-2 ${idx === 0 ? 'invisible' : ''}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" onclick="addTP()" class="mt-2 text-primary hover:text-secondary text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i> Tambah TP
                    </button>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fas fa-save"></i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    `;
    
    showModal(modalContent);
    
    document.getElementById('curriculumForm').addEventListener('submit', saveCurriculum);
}

function addTP() {
    const container = document.getElementById('tpContainer');
    const tpItems = container.querySelectorAll('.tp-item');
    const newIndex = tpItems.length + 1;
    
    const newTP = document.createElement('div');
    newTP.className = 'flex gap-2 tp-item';
    newTP.innerHTML = `
        <span class="flex items-center justify-center w-8 h-10 bg-gray-100 rounded text-sm font-medium">${newIndex}</span>
        <textarea class="form-input flex-1 tp-input" rows="2" placeholder="Tujuan Pembelajaran ${newIndex}"></textarea>
        <button type="button" onclick="removeTP(this)" class="text-red-500 hover:text-red-700 p-2">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(newTP);
}

function removeTP(btn) {
    btn.closest('.tp-item').remove();
    // Renumber TPs
    document.querySelectorAll('.tp-item').forEach((item, idx) => {
        item.querySelector('span').textContent = idx + 1;
        item.querySelector('textarea').placeholder = `Tujuan Pembelajaran ${idx + 1}`;
    });
}

async function saveCurriculum(e) {
    e.preventDefault();
    
    const tpInputs = document.querySelectorAll('.tp-input');
    const tps = Array.from(tpInputs).map(input => input.value.trim()).filter(tp => tp);
    
    if (tps.length === 0) {
        showToast('Minimal harus ada 1 Tujuan Pembelajaran!', 'warning');
        return;
    }
    
    const curriculumItem = {
        academicYear: currentAcademicYear,
        subject: document.getElementById('currSubject').value,
        phase: document.getElementById('currPhase').value,
        semester: parseInt(document.getElementById('currSemester').value),
        element: document.getElementById('currElement').value,
        cp: document.getElementById('currCP').value,
        tps: tps,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    const currId = document.getElementById('curriculumId').value;
    
    showLoading();
    
    try {
        if (currId) {
            await db.collection('users').doc(currentUser.uid)
                .collection('curriculum').doc(currId).update(curriculumItem);
            
            const index = curriculumData.findIndex(c => c.id === currId);
            if (index !== -1) {
                curriculumData[index] = { ...curriculumData[index], ...curriculumItem };
            }
        } else {
            curriculumItem.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            const docRef = await db.collection('users').doc(currentUser.uid)
                .collection('curriculum').add(curriculumItem);
            
            curriculumData.push({ id: docRef.id, ...curriculumItem });
        }
        
        closeModal();
        renderCurriculum();
        showToast('Data CP/TP berhasil disimpan!', 'success');
    } catch (error) {
        console.error('Error saving curriculum:', error);
        showToast('Gagal menyimpan data CP/TP.', 'error');
    } finally {
        hideLoading();
    }
}

function editCurriculum(id) {
    const item = curriculumData.find(c => c.id === id);
    if (item) {
        showAddCurriculumModal(item);
    }
}

async function deleteCurriculum(id) {
    if (!confirm('Hapus data CP/TP ini?')) return;
    
    showLoading();
    
    try {
        await db.collection('users').doc(currentUser.uid)
            .collection('curriculum').doc(id).delete();
        
        curriculumData = curriculumData.filter(c => c.id !== id);
        renderCurriculum();
        showToast('Data CP/TP berhasil dihapus!', 'success');
    } catch (error) {
        console.error('Error deleting curriculum:', error);
        showToast('Gagal menghapus data CP/TP.', 'error');
    } finally {
        hideLoading();
    }
}

function viewCurriculumDetail(id) {
    const item = curriculumData.find(c => c.id === id);
    if (!item) return;
    
    const modalContent = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Detail CP & TP</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex gap-2 flex-wrap">
                    <span class="px-3 py-1 bg-primary text-white text-sm rounded-full">${item.subject}</span>
                    <span class="px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded-full">Fase ${item.phase}</span>
                    <span class="px-3 py-1 bg-green-100 text-green-700 text-sm rounded-full">Semester ${item.semester}</span>
                </div>
                
                ${item.element ? `<p class="text-gray-600"><strong>Elemen:</strong> ${item.element}</p>` : ''}
                
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">Capaian Pembelajaran (CP)</h4>
                    <p class="text-gray-700 whitespace-pre-wrap">${item.cp}</p>
                </div>
                
                <div class="bg-green-50 rounded-lg p-4">
                    <h4 class="font-semibold text-green-800 mb-2">Tujuan Pembelajaran (TP)</h4>
                    <ol class="list-decimal list-inside space-y-2">
                        ${item.tps.map(tp => `<li class="text-gray-700">${tp}</li>`).join('')}
                    </ol>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal(); editCurriculum('${id}')" class="btn-primary flex-1">
                    <i class="fas fa-edit"></i>
                    Edit
                </button>
            </div>
        </div>
    `;
    
    showModal(modalContent);
}

// Default PAI Curriculum Data based on Kepka BSKAP No. 046/H/KR/2025
const DEFAULT_PAI_CURRICULUM = {
    'A': {
        elements: [
            {
                name: 'Al-Quran dan Hadis',
                cp: 'Peserta didik mampu membaca huruf hijaiyah, mengenal harakat, dan membaca surah-surah pendek dalam Al-Quran dengan baik dan benar.',
                tps: [
                    'Peserta didik mampu mengenal dan menyebutkan huruf hijaiyah dengan benar',
                    'Peserta didik mampu membedakan huruf hijaiyah yang bentuknya mirip',
                    'Peserta didik mampu membaca huruf hijaiyah berharakat fathah, kasrah, dan dhammah',
                    'Peserta didik mampu membaca surah Al-Fatihah dengan baik dan benar'
                ]
            },
            {
                name: 'Akidah',
                cp: 'Peserta didik mampu mengenal rukun iman dan meyakini keberadaan Allah Swt. sebagai Tuhan Yang Maha Esa.',
                tps: [
                    'Peserta didik mampu menyebutkan rukun iman dengan benar',
                    'Peserta didik mampu menjelaskan makna beriman kepada Allah Swt.',
                    'Peserta didik mampu menyebutkan ciptaan Allah Swt. di lingkungan sekitar',
                    'Peserta didik mampu menunjukkan sikap bersyukur atas nikmat Allah Swt.'
                ]
            },
            {
                name: 'Akhlak',
                cp: 'Peserta didik mampu membiasakan akhlak terpuji dalam kehidupan sehari-hari seperti jujur, disiplin, dan tanggung jawab.',
                tps: [
                    'Peserta didik mampu menjelaskan pengertian jujur dan contohnya',
                    'Peserta didik mampu menunjukkan perilaku jujur dalam kehidupan sehari-hari',
                    'Peserta didik mampu membiasakan sikap disiplin di rumah dan sekolah',
                    'Peserta didik mampu menunjukkan sikap tanggung jawab terhadap tugas-tugasnya'
                ]
            },
            {
                name: 'Fikih',
                cp: 'Peserta didik mampu mengenal rukun Islam dan membiasakan bersuci serta salat dengan bimbingan.',
                tps: [
                    'Peserta didik mampu menyebutkan rukun Islam dengan benar',
                    'Peserta didik mampu menjelaskan tata cara bersuci (wudu)',
                    'Peserta didik mampu mempraktikkan gerakan salat dengan bimbingan',
                    'Peserta didik mampu melafalkan bacaan salat dengan benar'
                ]
            },
            {
                name: 'Sejarah Peradaban Islam',
                cp: 'Peserta didik mampu mengenal kisah keteladanan Nabi Muhammad Saw. dan para nabi lainnya.',
                tps: [
                    'Peserta didik mampu menceritakan kisah kelahiran Nabi Muhammad Saw.',
                    'Peserta didik mampu menyebutkan sifat-sifat terpuji Nabi Muhammad Saw.',
                    'Peserta didik mampu meneladani akhlak Nabi Muhammad Saw.',
                    'Peserta didik mampu mengenal kisah Nabi Adam, Nuh, dan Ibrahim a.s.'
                ]
            }
        ]
    },
    'B': {
        elements: [
            {
                name: 'Al-Quran dan Hadis',
                cp: 'Peserta didik mampu membaca Al-Quran dengan tajwid dasar dan memahami kandungan ayat-ayat tentang salat.',
                tps: [
                    'Peserta didik mampu membaca Al-Quran dengan menerapkan hukum nun sukun dan tanwin',
                    'Peserta didik mampu membaca surah-surah pendek dengan tajwid yang benar',
                    'Peserta didik mampu mengidentifikasi ayat-ayat tentang perintah salat',
                    'Peserta didik mampu menjelaskan kandungan ayat tentang keutamaan salat'
                ]
            },
            {
                name: 'Akidah',
                cp: 'Peserta didik mampu memahami sifat-sifat Allah Swt. (Asmaul Husna) dan meyakini keberadaan malaikat.',
                tps: [
                    'Peserta didik mampu menyebutkan 10 Asmaul Husna dan artinya',
                    'Peserta didik mampu menjelaskan makna sifat-sifat Allah dalam Asmaul Husna',
                    'Peserta didik mampu menyebutkan nama-nama malaikat dan tugasnya',
                    'Peserta didik mampu menunjukkan perilaku yang mencerminkan iman kepada malaikat'
                ]
            },
            {
                name: 'Akhlak',
                cp: 'Peserta didik mampu menerapkan adab terhadap orang tua, guru, dan teman dalam kehidupan sehari-hari.',
                tps: [
                    'Peserta didik mampu menjelaskan adab terhadap orang tua',
                    'Peserta didik mampu menunjukkan sikap hormat kepada guru',
                    'Peserta didik mampu menerapkan adab bergaul dengan teman',
                    'Peserta didik mampu menghindari perilaku tercela seperti sombong dan iri hati'
                ]
            },
            {
                name: 'Fikih',
                cp: 'Peserta didik mampu melaksanakan salat fardu dengan benar dan memahami kewajiban puasa Ramadan.',
                tps: [
                    'Peserta didik mampu menjelaskan syarat dan rukun salat',
                    'Peserta didik mampu mempraktikkan salat fardu dengan benar',
                    'Peserta didik mampu menjelaskan pengertian dan hikmah puasa Ramadan',
                    'Peserta didik mampu memahami hal-hal yang membatalkan puasa'
                ]
            },
            {
                name: 'Sejarah Peradaban Islam',
                cp: 'Peserta didik mampu memahami sejarah dakwah Nabi Muhammad Saw. periode Makkah.',
                tps: [
                    'Peserta didik mampu menceritakan kondisi masyarakat Arab sebelum Islam',
                    'Peserta didik mampu menjelaskan awal mula turunnya wahyu',
                    'Peserta didik mampu mengidentifikasi tantangan dakwah di Makkah',
                    'Peserta didik mampu meneladani kesabaran Nabi dalam berdakwah'
                ]
            }
        ]
    },
    'C': {
        elements: [
            {
                name: 'Al-Quran dan Hadis',
                cp: 'Peserta didik mampu membaca Al-Quran dengan tajwid yang baik dan memahami ayat-ayat tentang toleransi dan keragaman.',
                tps: [
                    'Peserta didik mampu menerapkan hukum mad dalam bacaan Al-Quran',
                    'Peserta didik mampu membaca surah Al-Hujurat ayat 13 dengan baik',
                    'Peserta didik mampu menjelaskan kandungan ayat tentang keragaman',
                    'Peserta didik mampu mengamalkan nilai toleransi dalam kehidupan sehari-hari'
                ]
            },
            {
                name: 'Akidah',
                cp: 'Peserta didik mampu memahami iman kepada hari akhir dan qada qadar Allah Swt.',
                tps: [
                    'Peserta didik mampu menjelaskan pengertian iman kepada hari akhir',
                    'Peserta didik mampu menyebutkan tanda-tanda hari kiamat',
                    'Peserta didik mampu menjelaskan pengertian qada dan qadar',
                    'Peserta didik mampu menunjukkan sikap optimis dan tawakal'
                ]
            },
            {
                name: 'Akhlak',
                cp: 'Peserta didik mampu menerapkan adab sosial dan menghargai keragaman dalam masyarakat.',
                tps: [
                    'Peserta didik mampu menjelaskan adab bertetangga dalam Islam',
                    'Peserta didik mampu menunjukkan sikap menghargai perbedaan',
                    'Peserta didik mampu menerapkan adab di tempat umum',
                    'Peserta didik mampu berinteraksi dengan baik dalam masyarakat plural'
                ]
            },
            {
                name: 'Fikih',
                cp: 'Peserta didik mampu memahami zakat, infak, dan sedekah serta mengamalkannya.',
                tps: [
                    'Peserta didik mampu menjelaskan pengertian dan jenis-jenis zakat',
                    'Peserta didik mampu menghitung zakat fitrah',
                    'Peserta didik mampu membedakan infak dan sedekah',
                    'Peserta didik mampu membiasakan berinfak dan bersedekah'
                ]
            },
            {
                name: 'Sejarah Peradaban Islam',
                cp: 'Peserta didik mampu memahami sejarah dakwah Nabi Muhammad Saw. periode Madinah dan Khulafaur Rasyidin.',
                tps: [
                    'Peserta didik mampu menjelaskan peristiwa hijrah ke Madinah',
                    'Peserta didik mampu mengidentifikasi perjuangan membangun Madinah',
                    'Peserta didik mampu menceritakan peristiwa Fathu Makkah',
                    'Peserta didik mampu mengenal Khulafaur Rasyidin dan keteladanannya'
                ]
            }
        ]
    },
    'D': {
        elements: [
            {
                name: 'Al-Quran dan Hadis',
                cp: 'Peserta didik mampu membaca Al-Quran dengan tajwid yang benar, memahami kandungan ayat tentang toleransi, kompetisi dalam kebaikan, dan ilmu pengetahuan.',
                tps: [
                    'Peserta didik mampu menerapkan hukum tajwid secara komprehensif',
                    'Peserta didik mampu menganalisis kandungan Q.S. Al-Kafirun tentang toleransi',
                    'Peserta didik mampu menjelaskan kandungan ayat tentang fastabiqul khairat',
                    'Peserta didik mampu mengkaji ayat tentang keutamaan menuntut ilmu'
                ]
            },
            {
                name: 'Akidah',
                cp: 'Peserta didik mampu memahami rukun iman secara mendalam dan menganalisis dalil-dalilnya.',
                tps: [
                    'Peserta didik mampu menganalisis dalil iman kepada Allah dan sifat-sifat-Nya',
                    'Peserta didik mampu menjelaskan fungsi iman kepada kitab-kitab Allah',
                    'Peserta didik mampu menganalisis hikmah iman kepada rasul-rasul Allah',
                    'Peserta didik mampu menerapkan nilai-nilai iman dalam kehidupan'
                ]
            },
            {
                name: 'Akhlak',
                cp: 'Peserta didik mampu menganalisis dan membiasakan akhlak terpuji serta menjauhi akhlak tercela.',
                tps: [
                    'Peserta didik mampu menganalisis makna dan penerapan sujud syukur dan tilawah',
                    'Peserta didik mampu membiasakan sikap optimis, ikhtiar, dan tawakal',
                    'Peserta didik mampu mengidentifikasi dan menjauhi akhlak tercela',
                    'Peserta didik mampu menerapkan etika dalam bermedia sosial'
                ]
            },
            {
                name: 'Fikih',
                cp: 'Peserta didik mampu memahami dan mengamalkan salat sunnah, puasa sunnah, dan ibadah haji.',
                tps: [
                    'Peserta didik mampu menjelaskan jenis dan tata cara salat sunnah',
                    'Peserta didik mampu mempraktikkan puasa sunnah',
                    'Peserta didik mampu menjelaskan rukun, wajib, dan sunnah haji',
                    'Peserta didik mampu memahami manasik haji dan umrah'
                ]
            },
            {
                name: 'Sejarah Peradaban Islam',
                cp: 'Peserta didik mampu menganalisis perkembangan peradaban Islam pada masa Bani Umayyah hingga Mughal.',
                tps: [
                    'Peserta didik mampu menganalisis perkembangan ilmu pada masa Bani Umayyah',
                    'Peserta didik mampu menjelaskan kemajuan peradaban Bani Abbasiyah',
                    'Peserta didik mampu mengidentifikasi kontribusi peradaban Islam di berbagai bidang',
                    'Peserta didik mampu meneladani semangat ilmuwan Muslim'
                ]
            }
        ]
    },
    'E': {
        elements: [
            {
                name: 'Al-Quran dan Hadis',
                cp: 'Peserta didik mampu menganalisis ayat Al-Quran dan hadis tentang kompetisi dalam kebaikan dan pengembangan IPTEK.',
                tps: [
                    'Peserta didik mampu menganalisis Q.S. Al-Maidah ayat 48 tentang fastabiqul khairat',
                    'Peserta didik mampu mengkaji ayat-ayat kauniyah dalam Al-Quran',
                    'Peserta didik mampu menghubungkan nilai-nilai Al-Quran dengan pengembangan IPTEK',
                    'Peserta didik mampu menerapkan semangat kompetisi dalam kebaikan'
                ]
            },
            {
                name: 'Akidah',
                cp: "Peserta didik mampu menganalisis konsep syu'ab al-iman (cabang-cabang iman) dan penerapannya.",
                tps: [
                    "Peserta didik mampu menjelaskan pengertian dan klasifikasi syu'ab al-iman",
                    'Peserta didik mampu menganalisis cabang iman yang berkaitan dengan hati',
                    'Peserta didik mampu menganalisis cabang iman yang berkaitan dengan lisan dan perbuatan',
                    "Peserta didik mampu mengamalkan nilai-nilai syu'ab al-iman"
                ]
            },
            {
                name: 'Akhlak',
                cp: 'Peserta didik mampu menganalisis dan menerapkan akhlak terpuji dalam konteks kehidupan modern.',
                tps: [
                    'Peserta didik mampu menganalisis konsep husnuzan dan penerapannya',
                    'Peserta didik mampu menerapkan etika berkomunikasi di era digital',
                    'Peserta didik mampu mengidentifikasi dampak negatif akhlak tercela di media sosial',
                    'Peserta didik mampu menjadi teladan akhlak mulia di lingkungannya'
                ]
            },
            {
                name: 'Fikih',
                cp: 'Peserta didik mampu menganalisis sumber hukum Islam dan penerapannya dalam kehidupan kontemporer.',
                tps: [
                    'Peserta didik mampu menganalisis Al-Quran sebagai sumber hukum utama',
                    'Peserta didik mampu menjelaskan kedudukan hadis sebagai sumber hukum',
                    'Peserta didik mampu memahami ijtihad dan penerapannya',
                    'Peserta didik mampu menganalisis hukum Islam kontemporer'
                ]
            },
            {
                name: 'Sejarah Peradaban Islam',
                cp: 'Peserta didik mampu menganalisis sejarah perkembangan Islam di Indonesia.',
                tps: [
                    'Peserta didik mampu menganalisis proses masuknya Islam ke Indonesia',
                    'Peserta didik mampu menjelaskan peran kerajaan Islam di Nusantara',
                    'Peserta didik mampu mengidentifikasi tokoh penyebar Islam di Indonesia',
                    'Peserta didik mampu mengapresiasi kearifan lokal dalam penyebaran Islam'
                ]
            }
        ]
    },
    'F': {
        elements: [
            {
                name: 'Al-Quran dan Hadis',
                cp: 'Peserta didik mampu menganalisis secara kritis ayat-ayat Al-Quran dan hadis tentang isu-isu kontemporer.',
                tps: [
                    'Peserta didik mampu menganalisis ayat tentang keadilan dan HAM',
                    'Peserta didik mampu mengkaji hadis tentang pelestarian lingkungan',
                    'Peserta didik mampu menghubungkan nilai Al-Quran dengan isu global',
                    'Peserta didik mampu menyajikan tafsir kontemporer secara kritis'
                ]
            },
            {
                name: 'Akidah',
                cp: 'Peserta didik mampu berpikir kritis tentang fenomena keagamaan dan mempertahankan akidah yang benar.',
                tps: [
                    'Peserta didik mampu mengidentifikasi aliran-aliran dalam Islam',
                    'Peserta didik mampu menganalisis fenomena radikalisme dan ekstremisme',
                    'Peserta didik mampu mempertahankan akidah Ahlussunnah wal Jamaah',
                    'Peserta didik mampu bersikap moderat dalam beragama'
                ]
            },
            {
                name: 'Akhlak',
                cp: 'Peserta didik mampu menganalisis etika profesi dan tanggung jawab sosial dalam perspektif Islam.',
                tps: [
                    'Peserta didik mampu menganalisis etika profesi dalam Islam',
                    'Peserta didik mampu menerapkan akhlak dalam dunia kerja',
                    'Peserta didik mampu memahami tanggung jawab sosial Muslim',
                    'Peserta didik mampu berkontribusi positif dalam masyarakat'
                ]
            },
            {
                name: 'Fikih',
                cp: 'Peserta didik mampu menganalisis hukum waris (mawaris) dan muamalah kontemporer.',
                tps: [
                    'Peserta didik mampu menjelaskan dasar hukum dan hikmah waris',
                    'Peserta didik mampu menghitung pembagian waris',
                    'Peserta didik mampu menganalisis ekonomi syariah',
                    'Peserta didik mampu memahami hukum transaksi digital'
                ]
            },
            {
                name: 'Sejarah Peradaban Islam',
                cp: 'Peserta didik mampu menganalisis perkembangan organisasi dan gerakan Islam di dunia.',
                tps: [
                    'Peserta didik mampu mengidentifikasi organisasi Islam internasional',
                    'Peserta didik mampu menganalisis peran organisasi Islam di Indonesia',
                    'Peserta didik mampu memahami dinamika umat Islam kontemporer',
                    'Peserta didik mampu mengambil hikmah dari sejarah untuk masa depan'
                ]
            }
        ]
    }
};

async function loadDefaultPAI() {
    const level = userData?.school?.level || 'SD';
    let phases = [];
    
    switch(level) {
        case 'SD': phases = ['A', 'B', 'C']; break;
        case 'SMP': phases = ['D']; break;
        case 'SMA': case 'SMK': phases = ['E', 'F']; break;
    }
    
    // Check if user has PAI subject
    const hasPAI = userData?.profile?.subjects?.some(s => 
        s.name.toLowerCase().includes('agama islam') || 
        s.name.toLowerCase().includes('pai')
    );
    
    if (!hasPAI) {
        showToast('Tambahkan mata pelajaran PAI di Profil terlebih dahulu!', 'warning');
        return;
    }
    
    if (!confirm('Ini akan menambahkan data CP & TP PAI default sesuai jenjang sekolah Anda. Lanjutkan?')) {
        return;
    }
    
    showLoading();
    
    try {
        const batch = db.batch();
        const paiSubjectName = userData.profile.subjects.find(s => 
            s.name.toLowerCase().includes('agama islam') || 
            s.name.toLowerCase().includes('pai')
        ).name;
        
        for (const phase of phases) {
            const phaseData = DEFAULT_PAI_CURRICULUM[phase];
            if (!phaseData) continue;
            
            for (const element of phaseData.elements) {
                // Semester 1
                const doc1Ref = db.collection('users').doc(currentUser.uid)
                    .collection('curriculum').doc();
                
                batch.set(doc1Ref, {
                    academicYear: currentAcademicYear,
                    subject: paiSubjectName,
                    phase: phase,
                    semester: 1,
                    element: element.name,
                    cp: element.cp,
                    tps: element.tps.slice(0, Math.ceil(element.tps.length / 2)),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Semester 2
                const doc2Ref = db.collection('users').doc(currentUser.uid)
                    .collection('curriculum').doc();
                
                batch.set(doc2Ref, {
                    academicYear: currentAcademicYear,
                    subject: paiSubjectName,
                    phase: phase,
                    semester: 2,
                    element: element.name,
                    cp: element.cp,
                    tps: element.tps.slice(Math.ceil(element.tps.length / 2)),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
        
        await batch.commit();
        
        // Reload curriculum
        await initCurriculum();
        showToast('Data CP & TP PAI berhasil dimuat!', 'success');
    } catch (error) {
        console.error('Error loading default PAI:', error);
        showToast('Gagal memuat data PAI.', 'error');
    } finally {
        hideLoading();
    }
}

// ============================================
// ATP (Alur Tujuan Pembelajaran) PAGE
// ============================================
function getATPHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Alur Tujuan Pembelajaran (ATP)</h1>
                    <p class="text-gray-600 text-sm mt-1">ATP dihasilkan otomatis dari data CP & TP</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="printATP()" class="btn-secondary">
                        <i class="fas fa-print"></i>
                        Cetak
                    </button>
                    <button onclick="exportATP()" class="btn-primary">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Mata Pelajaran</label>
                        <select id="atpFilterSubject" class="form-input" onchange="renderATP()">
                            <option value="">-- Pilih Mata Pelajaran --</option>
                            ${(userData?.profile?.subjects || []).map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Fase/Kelas</label>
                        <select id="atpFilterPhase" class="form-input" onchange="renderATP()">
                            <option value="">-- Pilih Fase --</option>
                            ${getPhaseOptions()}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Semester</label>
                        <select id="atpFilterSemester" class="form-input" onchange="renderATP()">
                            <option value="1">Semester 1 (Ganjil)</option>
                            <option value="2">Semester 2 (Genap)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ATP Content -->
            <div id="atpContent" class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-8 text-center text-gray-500">
                    <i class="fas fa-filter text-4xl mb-4"></i>
                    <p>Pilih mata pelajaran dan fase untuk melihat ATP</p>
                </div>
            </div>
        </div>
    `;
}

async function initATP() {
    // Load curriculum data if not loaded
    if (curriculumData.length === 0) {
        try {
            const snap = await db.collection('users').doc(currentUser.uid)
                .collection('curriculum')
                .where('academicYear', '==', currentAcademicYear)
                .get();
            
            curriculumData = [];
            snap.forEach(doc => {
                curriculumData.push({ id: doc.id, ...doc.data() });
            });
        } catch (error) {
            console.error('Error loading curriculum:', error);
        }
    }
}

function renderATP() {
    const container = document.getElementById('atpContent');
    const subject = document.getElementById('atpFilterSubject').value;
    const phase = document.getElementById('atpFilterPhase').value;
    const semester = parseInt(document.getElementById('atpFilterSemester').value);
    
    if (!subject || !phase) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-filter text-4xl mb-4"></i>
                <p>Pilih mata pelajaran dan fase untuk melihat ATP</p>
            </div>
        `;
        return;
    }
    
    const filtered = curriculumData.filter(c => 
        c.subject === subject && c.phase === phase && c.semester === semester
    );
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                <p>Belum ada data CP/TP untuk filter yang dipilih</p>
                <button onclick="navigateTo('curriculum')" class="mt-4 text-primary font-medium hover:underline">
                    Tambah data CP/TP
                </button>
            </div>
        `;
        return;
    }
    
    // Generate ATP
    let html = `
        <div class="p-6" id="atpPrintArea">
            <!-- Header -->
            <div class="text-center mb-6 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800">ALUR TUJUAN PEMBELAJARAN (ATP)</h2>
                <p class="text-gray-600 mt-1">${userData?.school?.name || 'Nama Sekolah'}</p>
            </div>
            
            <!-- Info -->
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div>
                    <p><strong>Mata Pelajaran:</strong> ${subject}</p>
                    <p><strong>Fase:</strong> ${phase}</p>
                </div>
                <div>
                    <p><strong>Tahun Pelajaran:</strong> ${currentAcademicYear}</p>
                    <p><strong>Semester:</strong> ${semester === 1 ? 'Ganjil' : 'Genap'}</p>
                </div>
            </div>
            
            <!-- ATP Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-3 py-2 w-12">No</th>
                            <th class="border border-gray-300 px-3 py-2">Elemen</th>
                            <th class="border border-gray-300 px-3 py-2">Capaian Pembelajaran</th>
                            <th class="border border-gray-300 px-3 py-2">Tujuan Pembelajaran</th>
                            <th class="border border-gray-300 px-3 py-2 w-20">Alokasi Waktu</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let tpNumber = 1;
    filtered.forEach((item, idx) => {
        const rowspan = item.tps.length || 1;
        
        item.tps.forEach((tp, tpIdx) => {
            html += '<tr>';
            
            if (tpIdx === 0) {
                html += `
                    <td class="border border-gray-300 px-3 py-2 text-center align-top" rowspan="${rowspan}">${idx + 1}</td>
                    <td class="border border-gray-300 px-3 py-2 align-top" rowspan="${rowspan}">${item.element || '-'}</td>
                    <td class="border border-gray-300 px-3 py-2 align-top" rowspan="${rowspan}">${item.cp}</td>
                `;
            }
            
            html += `
                <td class="border border-gray-300 px-3 py-2">
                    <strong>TP ${tpNumber}:</strong> ${tp}
                </td>
                <td class="border border-gray-300 px-3 py-2 text-center">2 JP</td>
            </tr>
            `;
            tpNumber++;
        });
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <!-- Signatures -->
            <div class="mt-8 flex justify-between text-sm">
                <div class="text-center">
                    <p>Mengetahui,</p>
                    <p>Kepala Sekolah</p>
                    <div class="h-20"></div>
                    <p class="font-medium border-t border-black pt-1">${userData?.school?.principalName || '.........................'}</p>
                    <p>NIP. ${userData?.school?.principalNIP || '.........................'}</p>
                </div>
                <div class="text-center">
                    <p>..................., .................... 20.....</p>
                    <p>Guru Mata Pelajaran</p>
                    <div class="h-20"></div>
                    <p class="font-medium border-t border-black pt-1">${userData?.name || '.........................'}</p>
                    <p>NIP. ${userData?.profile?.nip || '.........................'}</p>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function printATP() {
    const content = document.getElementById('atpPrintArea');
    if (!content) {
        showToast('Pilih filter terlebih dahulu!', 'warning');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>ATP - ${document.getElementById('atpFilterSubject').value}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #333; padding: 8px; }
                th { background: #f0f0f0; }
                @media print { body { padding: 0; } }
            </style>
        </head>
        <body>
            ${content.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function exportATP() {
    showToast('Fitur export akan segera tersedia!', 'info');
}

// ============================================
// PROTA PAGE
// ============================================
function getProtaHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Program Tahunan (Prota)</h1>
                    <p class="text-gray-600 text-sm mt-1">Prota dihasilkan otomatis dari Kalender & ATP</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="printProta()" class="btn-secondary">
                        <i class="fas fa-print"></i>
                        Cetak
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Mata Pelajaran</label>
                        <select id="protaFilterSubject" class="form-input" onchange="renderProta()">
                            <option value="">-- Pilih Mata Pelajaran --</option>
                            ${(userData?.profile?.subjects || []).map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Kelas</label>
                        <select id="protaFilterClass" class="form-input" onchange="renderProta()">
                            <option value="">-- Pilih Kelas --</option>
                            ${getClassOptions()}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Prota Content -->
            <div id="protaContent" class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-8 text-center text-gray-500">
                    <i class="fas fa-filter text-4xl mb-4"></i>
                    <p>Pilih mata pelajaran dan kelas untuk melihat Prota</p>
                </div>
            </div>
        </div>
    `;
}

let calendarData = null;

async function initProta() {
    // Load calendar
    try {
        const calDoc = await db.collection('users').doc(currentUser.uid)
            .collection('calendar').doc(currentAcademicYear).get();
        
        if (calDoc.exists) {
            calendarData = calDoc.data();
        }
    } catch (error) {
        console.error('Error loading calendar:', error);
    }
    
    // Load curriculum if needed
    if (curriculumData.length === 0) {
        await initCurriculum();
    }
}

async function renderProta() {
    const container = document.getElementById('protaContent');
    const subject = document.getElementById('protaFilterSubject').value;
    const classNum = document.getElementById('protaFilterClass').value;
    
    if (!subject || !classNum) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-filter text-4xl mb-4"></i>
                <p>Pilih mata pelajaran dan kelas untuk melihat Prota</p>
            </div>
        `;
        return;
    }
    
    // Determine phase based on class
    const phase = getPhaseFromClass(classNum);
    
    // Get curriculum for both semesters
    const sem1Data = curriculumData.filter(c => c.subject === subject && c.phase === phase && c.semester === 1);
    const sem2Data = curriculumData.filter(c => c.subject === subject && c.phase === phase && c.semester === 2);
    
    if (sem1Data.length === 0 && sem2Data.length === 0) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                <p>Belum ada data CP/TP untuk kelas ${classNum}</p>
                <button onclick="navigateTo('curriculum')" class="mt-4 text-primary font-medium hover:underline">
                    Tambah data CP/TP
                </button>
            </div>
        `;
        return;
    }
    
    // Calculate effective weeks
    const sem1Weeks = calculateEffectiveWeeks(1);
    const sem2Weeks = calculateEffectiveWeeks(2);
    
    // Get JP per week from subject
    const subjectData = userData?.profile?.subjects?.find(s => s.name === subject);
    const jpPerWeek = subjectData?.hoursPerWeek || 2;
    
    let html = `
        <div class="p-6" id="protaPrintArea">
            <!-- Header -->
            <div class="text-center mb-6 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800">PROGRAM TAHUNAN</h2>
                <p class="text-gray-600 mt-1">${userData?.school?.name || 'Nama Sekolah'}</p>
            </div>
            
            <!-- Info -->
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div>
                    <p><strong>Mata Pelajaran:</strong> ${subject}</p>
                    <p><strong>Kelas:</strong> ${classNum}</p>
                </div>
                <div>
                    <p><strong>Tahun Pelajaran:</strong> ${currentAcademicYear}</p>
                    <p><strong>Guru:</strong> ${userData?.name || '-'}</p>
                </div>
            </div>
            
            <!-- Semester 1 -->
            <h3 class="font-bold text-gray-800 mb-3 bg-blue-50 p-2 rounded">SEMESTER 1 (GANJIL)</h3>
            <div class="mb-4 text-sm">
                <p>Minggu Efektif: ${sem1Weeks} minggu | JP/Minggu: ${jpPerWeek} | Total JP: ${sem1Weeks * jpPerWeek}</p>
            </div>
            <div class="overflow-x-auto mb-8">
                <table class="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-3 py-2 w-12">No</th>
                            <th class="border border-gray-300 px-3 py-2">Elemen/Materi</th>
                            <th class="border border-gray-300 px-3 py-2">Tujuan Pembelajaran</th>
                            <th class="border border-gray-300 px-3 py-2 w-24">Alokasi Waktu</th>
                            <th class="border border-gray-300 px-3 py-2 w-32">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    let num = 1;
    sem1Data.forEach(item => {
        item.tps.forEach((tp, idx) => {
            html += `
                <tr>
                    <td class="border border-gray-300 px-3 py-2 text-center">${num++}</td>
                    <td class="border border-gray-300 px-3 py-2">${idx === 0 ? item.element : ''}</td>
                    <td class="border border-gray-300 px-3 py-2">${tp}</td>
                    <td class="border border-gray-300 px-3 py-2 text-center">${jpPerWeek} JP</td>
                    <td class="border border-gray-300 px-3 py-2"></td>
                </tr>
            `;
        });
    });
    
    if (sem1Data.length === 0) {
        html += `
            <tr>
                <td colspan="5" class="border border-gray-300 px-3 py-4 text-center text-gray-500">
                    Belum ada data TP untuk Semester 1
                </td>
            </tr>
        `;
    }
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <!-- Semester 2 -->
            <h3 class="font-bold text-gray-800 mb-3 bg-green-50 p-2 rounded">SEMESTER 2 (GENAP)</h3>
            <div class="mb-4 text-sm">
                <p>Minggu Efektif: ${sem2Weeks} minggu | JP/Minggu: ${jpPerWeek} | Total JP: ${sem2Weeks * jpPerWeek}</p>
            </div>
            <div class="overflow-x-auto mb-8">
                <table class="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-3 py-2 w-12">No</th>
                            <th class="border border-gray-300 px-3 py-2">Elemen/Materi</th>
                            <th class="border border-gray-300 px-3 py-2">Tujuan Pembelajaran</th>
                            <th class="border border-gray-300 px-3 py-2 w-24">Alokasi Waktu</th>
                            <th class="border border-gray-300 px-3 py-2 w-32">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    num = 1;
    sem2Data.forEach(item => {
        item.tps.forEach((tp, idx) => {
            html += `
                <tr>
                    <td class="border border-gray-300 px-3 py-2 text-center">${num++}</td>
                    <td class="border border-gray-300 px-3 py-2">${idx === 0 ? item.element : ''}</td>
                    <td class="border border-gray-300 px-3 py-2">${tp}</td>
                    <td class="border border-gray-300 px-3 py-2 text-center">${jpPerWeek} JP</td>
                    <td class="border border-gray-300 px-3 py-2"></td>
                </tr>
            `;
        });
    });
    
    if (sem2Data.length === 0) {
        html += `
            <tr>
                <td colspan="5" class="border border-gray-300 px-3 py-4 text-center text-gray-500">
                    Belum ada data TP untuk Semester 2
                </td>
            </tr>
        `;
    }
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <!-- Signatures -->
            <div class="mt-8 flex justify-between text-sm">
                <div class="text-center">
                    <p>Mengetahui,</p>
                    <p>Kepala Sekolah</p>
                    <div class="h-20"></div>
                    <p class="font-medium border-t border-black pt-1">${userData?.school?.principalName || '.........................'}</p>
                    <p>NIP. ${userData?.school?.principalNIP || '.........................'}</p>
                </div>
                <div class="text-center">
                    <p>..................., .................... 20.....</p>
                    <p>Guru Mata Pelajaran</p>
                    <div class="h-20"></div>
                    <p class="font-medium border-t border-black pt-1">${userData?.name || '.........................'}</p>
                    <p>NIP. ${userData?.profile?.nip || '.........................'}</p>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function getPhaseFromClass(classNum) {
    const num = parseInt(classNum);
    if (num <= 2) return 'A';
    if (num <= 4) return 'B';
    if (num <= 6) return 'C';
    if (num <= 9) return 'D';
    if (num === 10) return 'E';
    return 'F';
}

function calculateEffectiveWeeks(semester) {
    if (!calendarData) return 16; // Default
    
    const semData = semester === 1 ? calendarData.semester1 : calendarData.semester2;
    if (!semData?.start || !semData?.end) return 16;
    
    const start = new Date(semData.start);
    const end = new Date(semData.end);
    
    // Calculate total weeks
    const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    let totalWeeks = Math.floor(totalDays / 7);
    
    // Subtract exam weeks
    const examWeeks = 2; // PTS + PAS/PAT
    
    // Subtract holiday weeks (rough estimate)
    const holidayWeeks = 2;
    
    return Math.max(totalWeeks - examWeeks - holidayWeeks, 12);
}

function printProta() {
    const content = document.getElementById('protaPrintArea');
    if (!content) {
        showToast('Pilih filter terlebih dahulu!', 'warning');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Prota - ${document.getElementById('protaFilterSubject').value}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; font-size: 12pt; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { border: 1px solid #333; padding: 6px; }
                th { background: #f0f0f0; }
                h3 { margin-top: 20px; }
                @media print { body { padding: 0; } }
            </style>
        </head>
        <body>
            ${content.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// ============================================
// PROMES PAGE
// ============================================
function getPromesHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Program Semester (Promes)</h1>
                    <p class="text-gray-600 text-sm mt-1">Detail pembelajaran per minggu berdasarkan jadwal</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="printPromes()" class="btn-secondary">
                        <i class="fas fa-print"></i>
                        Cetak
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="form-label">Mata Pelajaran</label>
                        <select id="promesFilterSubject" class="form-input" onchange="renderPromes()">
                            <option value="">-- Pilih Mata Pelajaran --</option>
                            ${(userData?.profile?.subjects || []).map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Kelas</label>
                        <select id="promesFilterClass" class="form-input" onchange="renderPromes()">
                            <option value="">-- Pilih Kelas --</option>
                            ${getClassOptions()}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Rombel</label>
                        <select id="promesFilterRombel" class="form-input" onchange="renderPromes()">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Semester</label>
                        <select id="promesFilterSemester" class="form-input" onchange="renderPromes()">
                            <option value="1">Semester 1 (Ganjil)</option>
                            <option value="2">Semester 2 (Genap)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Promes Content -->
            <div id="promesContent" class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="p-8 text-center text-gray-500">
                    <i class="fas fa-filter text-4xl mb-4"></i>
                    <p>Pilih filter untuk melihat Promes</p>
                </div>
            </div>
        </div>
    `;
}

async function initPromes() {
    // Load required data
    if (!calendarData) {
        try {
            const calDoc = await db.collection('users').doc(currentUser.uid)
                .collection('calendar').doc(currentAcademicYear).get();
            if (calDoc.exists) {
                calendarData = calDoc.data();
            }
        } catch (error) {
            console.error('Error loading calendar:', error);
        }
    }
    
    if (scheduleData.length === 0) {
        try {
            const schedulesSnap = await db.collection('users').doc(currentUser.uid)
                .collection('schedules')
                .where('academicYear', '==', currentAcademicYear)
                .get();
            
            scheduleData = [];
            schedulesSnap.forEach(doc => {
                scheduleData.push({ id: doc.id, ...doc.data() });
            });
        } catch (error) {
            console.error('Error loading schedules:', error);
        }
    }
    
    if (curriculumData.length === 0) {
        await initCurriculum();
    }
}

async function renderPromes() {
    const container = document.getElementById('promesContent');
    const subject = document.getElementById('promesFilterSubject').value;
    const classNum = document.getElementById('promesFilterClass').value;
    const rombel = document.getElementById('promesFilterRombel').value;
    const semester = parseInt(document.getElementById('promesFilterSemester').value);
    
    if (!subject || !classNum) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-filter text-4xl mb-4"></i>
                <p>Pilih mata pelajaran dan kelas untuk melihat Promes</p>
            </div>
        `;
        return;
    }
    
    // Get schedule for this subject and class
    const classSchedules = scheduleData.filter(s => 
        s.subject === subject && 
        s.className === classNum && 
        s.rombel === rombel
    );
    
    if (classSchedules.length === 0) {
        container.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-calendar-times text-4xl mb-4"></i>
                <p>Tidak ada jadwal untuk kelas ${classNum}-${rombel} pada ${subject}</p>
                <button onclick="navigateTo('schedule')" class="mt-4 text-primary font-medium hover:underline">
                    Atur jadwal pelajaran
                </button>
            </div>
        `;
        return;
    }
    
    // Get curriculum
    const phase = getPhaseFromClass(classNum);
    const currData = curriculumData.filter(c => 
        c.subject === subject && c.phase === phase && c.semester === semester
    );
    
    // Generate weekly schedule
    const weeks = generateWeeklySchedule(semester, classSchedules, currData);
    
    // Get month names for the semester
    const [startYear, endYear] = currentAcademicYear.split('/').map(Number);
    const months = semester === 1 
        ? ['Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember']
        : ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni'];
    
    let html = `
        <div class="p-6" id="promesPrintArea">
            <!-- Header -->
            <div class="text-center mb-6 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-800">PROGRAM SEMESTER</h2>
                <p class="text-gray-600 mt-1">${userData?.school?.name || 'Nama Sekolah'}</p>
            </div>
            
            <!-- Info -->
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div>
                    <p><strong>Mata Pelajaran:</strong> ${subject}</p>
                    <p><strong>Kelas/Rombel:</strong> ${classNum}/${rombel}</p>
                </div>
                <div>
                    <p><strong>Tahun Pelajaran:</strong> ${currentAcademicYear}</p>
                    <p><strong>Semester:</strong> ${semester === 1 ? 'Ganjil' : 'Genap'}</p>
                </div>
            </div>
            
            <!-- Schedule Info -->
            <div class="mb-4 p-3 bg-blue-50 rounded-lg text-sm">
                <p><strong>Jadwal:</strong> ${classSchedules.map(s => `${s.day.charAt(0).toUpperCase() + s.day.slice(1)} (${s.startTime} - ${s.endTime})`).join(', ')}</p>
            </div>
            
            <!-- Promes Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 text-xs">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-2 py-2 w-10" rowspan="2">No</th>
                            <th class="border border-gray-300 px-2 py-2" rowspan="2">Tujuan Pembelajaran</th>
                            <th class="border border-gray-300 px-2 py-2 w-12" rowspan="2">JP</th>
                            ${months.map(m => `<th class="border border-gray-300 px-1 py-2" colspan="4">${m}</th>`).join('')}
                            <th class="border border-gray-300 px-2 py-2 w-20" rowspan="2">Ket</th>
                        </tr>
                        <tr class="bg-gray-50">
                            ${months.map(() => `
                                <th class="border border-gray-300 px-1 py-1 w-6">1</th>
                                <th class="border border-gray-300 px-1 py-1 w-6">2</th>
                                <th class="border border-gray-300 px-1 py-1 w-6">3</th>
                                <th class="border border-gray-300 px-1 py-1 w-6">4</th>
                            `).join('')}
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Get all TPs
    let allTPs = [];
    currData.forEach(item => {
        item.tps.forEach(tp => {
            allTPs.push({ element: item.element, tp: tp });
        });
    });
    
    // Distribute TPs across weeks
    const totalWeeks = weeks.length;
    const tpsPerWeek = Math.ceil(allTPs.length / totalWeeks);
    
    allTPs.forEach((tpItem, idx) => {
        const weekIndex = Math.floor(idx / tpsPerWeek);
        const week = weeks[weekIndex] || weeks[weeks.length - 1];
        
        html += `<tr>`;
        html += `<td class="border border-gray-300 px-2 py-1 text-center">${idx + 1}</td>`;
        html += `<td class="border border-gray-300 px-2 py-1">${tpItem.tp}</td>`;
        html += `<td class="border border-gray-300 px-2 py-1 text-center">2</td>`;
        
        // Month/Week cells
        let cellIdx = 0;
        months.forEach((m, monthIdx) => {
            for (let w = 1; w <= 4; w++) {
                const isActive = week && week.monthIndex === monthIdx && week.weekOfMonth === w;
                html += `<td class="border border-gray-300 px-1 py-1 text-center ${isActive ? 'bg-blue-200' : ''}">${isActive ? 'âœ“' : ''}</td>`;
                cellIdx++;
            }
        });
        
        html += `<td class="border border-gray-300 px-2 py-1"></td>`;
        html += `</tr>`;
    });
    
    if (allTPs.length === 0) {
        html += `
            <tr>
                <td colspan="${4 + months.length * 4}" class="border border-gray-300 px-3 py-4 text-center text-gray-500">
                    Belum ada data TP untuk semester ini
                </td>
            </tr>
        `;
    }
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <!-- Detail Schedule -->
            <h3 class="font-bold text-gray-800 mt-8 mb-4">Detail Pertemuan</h3>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 px-3 py-2">Pertemuan</th>
                            <th class="border border-gray-300 px-3 py-2">Hari/Tanggal</th>
                            <th class="border border-gray-300 px-3 py-2">Jam</th>
                            <th class="border border-gray-300 px-3 py-2">Tujuan Pembelajaran</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    weeks.forEach((week, idx) => {
        const tp = allTPs[idx] || { tp: '-' };
        html += `
            <tr>
                <td class="border border-gray-300 px-3 py-2 text-center">${idx + 1}</td>
                <td class="border border-gray-300 px-3 py-2">${week.dayName}, ${formatDate(week.date, 'short')}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${week.time}</td>
                <td class="border border-gray-300 px-3 py-2">${tp.tp}</td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <!-- Signatures -->
            <div class="mt-8 flex justify-between text-sm">
                <div class="text-center">
                    <p>Mengetahui,</p>
                    <p>Kepala Sekolah</p>
                    <div class="h-20"></div>
                    <p class="font-medium border-t border-black pt-1">${userData?.school?.principalName || '.........................'}</p>
                    <p>NIP. ${userData?.school?.principalNIP || '.........................'}</p>
                </div>
                <div class="text-center">
                    <p>..................., .................... 20.....</p>
                    <p>Guru Mata Pelajaran</p>
                    <div class="h-20"></div>
                    <p class="font-medium border-t border-black pt-1">${userData?.name || '.........................'}</p>
                    <p>NIP. ${userData?.profile?.nip || '.........................'}</p>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function generateWeeklySchedule(semester, classSchedules, currData) {
    if (!calendarData) return [];
    
    const semData = semester === 1 ? calendarData.semester1 : calendarData.semester2;
    if (!semData?.start || !semData?.end) return [];
    
    const startDate = new Date(semData.start);
    const endDate = new Date(semData.end);
    const weeks = [];
    
    const dayNames = ['minggu', 'senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu'];
    const dayNamesCapital = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    
    // Get teaching days from schedule
    const teachingDays = classSchedules.map(s => dayNames.indexOf(s.day));
    
    let currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        const dayOfWeek = currentDate.getDay();
        
        if (teachingDays.includes(dayOfWeek)) {
            const schedule = classSchedules.find(s => dayNames.indexOf(s.day) === dayOfWeek);
            
            // Check if it's not a holiday or exam week
            const dateStr = formatDate(currentDate, 'iso');
            const isHoliday = calendarData.holidays?.some(h => dateStr >= h.startDate && dateStr <= h.endDate);
            const isExam = isDateInExam(dateStr);
            
            if (!isHoliday && !isExam) {
                const monthIndex = semester === 1 
                    ? currentDate.getMonth() - 6 // July = 0
                    : currentDate.getMonth(); // January = 0
                
                weeks.push({
                    date: new Date(currentDate),
                    dayName: dayNamesCapital[dayOfWeek],
                    time: `${schedule.startTime} - ${schedule.endTime}`,
                    monthIndex: Math.max(0, monthIndex),
                    weekOfMonth: Math.ceil(currentDate.getDate() / 7)
                });
            }
        }
        
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return weeks;
}

function printPromes() {
    const content = document.getElementById('promesPrintArea');
    if (!content) {
        showToast('Pilih filter terlebih dahulu!', 'warning');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Promes - ${document.getElementById('promesFilterSubject').value}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 10px; font-size: 10pt; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
                th, td { border: 1px solid #333; padding: 4px; }
                th { background: #f0f0f0; }
                @media print { 
                    body { padding: 0; }
                    @page { size: landscape; }
                }
            </style>
        </head>
        <body>
            ${content.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// ============================================
// STUDENTS PAGE
// ============================================
function getStudentsHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Data Siswa</h1>
                <div class="flex gap-2">
                    <button onclick="showImportStudentsModal()" class="btn-secondary">
                        <i class="fas fa-file-import"></i>
                        Import CSV
                    </button>
                    <button onclick="showAddStudentModal()" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        Tambah Siswa
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="bg-white rounded-xl p-4 shadow-sm mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Kelas</label>
                        <select id="studentFilterClass" class="form-input" onchange="filterStudents()">
                            <option value="">Semua Kelas</option>
                            ${getClassOptions()}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Rombel</label>
                        <select id="studentFilterRombel" class="form-input" onchange="filterStudents()">
                            <option value="">Semua Rombel</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Cari</label>
                        <input type="text" id="studentSearch" class="form-input" placeholder="Nama atau NISN..." oninput="filterStudents()">
                    </div>
                </div>
            </div>
            
            <!-- Students List -->
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">NISN</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">L/P</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kelas</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Rombel</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

let studentsData = [];

async function initStudents() {
    try {
        const snap = await db.collection('users').doc(currentUser.uid)
            .collection('students')
            .where('academicYear', '==', currentAcademicYear)
            .orderBy('kelas')
            .orderBy('nama')
            .get();
        
        studentsData = [];
        snap.forEach(doc => {
            studentsData.push({ id: doc.id, ...doc.data() });
        });
        
        filterStudents();
    } catch (error) {
        console.error('Error loading students:', error);
        showToast('Gagal memuat data siswa.', 'error');
    }
}

function filterStudents() {
    const tbody = document.getElementById('studentsTableBody');
    const classFilter = document.getElementById('studentFilterClass').value;
    const rombelFilter = document.getElementById('studentFilterRombel').value;
    const search = document.getElementById('studentSearch').value.toLowerCase();
    
    let filtered = studentsData;
    
    if (classFilter) {
        filtered = filtered.filter(s => s.kelas === classFilter);
    }
    if (rombelFilter) {
        filtered = filtered.filter(s => s.rombel === rombelFilter);
    }
    if (search) {
        filtered = filtered.filter(s => 
            s.nama.toLowerCase().includes(search) || 
            s.nisn.includes(search)
        );
    }
    
    if (filtered.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                    Tidak ada data siswa
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filtered.map((student, idx) => `
        <tr class="border-t hover:bg-gray-50">
            <td class="px-4 py-3 text-sm">${idx + 1}</td>
            <td class="px-4 py-3 text-sm">${student.nisn}</td>
            <td class="px-4 py-3 text-sm font-medium">${student.nama}</td>
            <td class="px-4 py-3 text-sm text-center">
                <span class="px-2 py-1 rounded-full text-xs ${student.jenisKelamin === 'L' ? 'bg-blue-100 text-blue-700' : 'bg-pink-100 text-pink-700'}">
                    ${student.jenisKelamin}
                </span>
            </td>
            <td class="px-4 py-3 text-sm text-center">${student.kelas}</td>
            <td class="px-4 py-3 text-sm text-center">${student.rombel}</td>
            <td class="px-4 py-3 text-sm text-center">
                <button onclick="editStudent('${student.id}')" class="text-blue-600 hover:text-blue-800 p-1">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteStudent('${student.id}')" class="text-red-600 hover:text-red-800 p-1 ml-2">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function showAddStudentModal(editData = null) {
    const isEdit = !!editData;
    
    const modalContent = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">${isEdit ? 'Edit' : 'Tambah'} Siswa</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="studentForm" class="space-y-4">
                <input type="hidden" id="studentId" value="${editData?.id || ''}">
                
                <div>
                    <label class="form-label">NISN</label>
                    <input type="text" id="studentNISN" class="form-input" placeholder="10 digit NISN" value="${editData?.nisn || ''}" required>
                </div>
                
                <div>
                    <label class="form-label">Nama Lengkap</label>
                    <input type="text" id="studentNama" class="form-input" placeholder="Nama lengkap siswa" value="${editData?.nama || ''}" required>
                </div>
                
                <div>
                    <label class="form-label">Jenis Kelamin</label>
                    <select id="studentJK" class="form-input" required>
                        <option value="L" ${editData?.jenisKelamin === 'L' ? 'selected' : ''}>Laki-laki</option>
                        <option value="P" ${editData?.jenisKelamin === 'P' ? 'selected' : ''}>Perempuan</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Kelas</label>
                        <select id="studentKelas" class="form-input" required>
                            ${getClassOptions().replace(`value="${editData?.kelas}"`, `value="${editData?.kelas}" selected`)}
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Rombel</label>
                        <input type="text" id="studentRombel" class="form-input" placeholder="A, B, C, ..." value="${editData?.rombel || 'A'}" required>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">Batal</button>
                    <button type="submit" class="btn-primary flex-1">
                        <i class="fas fa-save"></i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    `;
    
    showModal(modalContent);
    
    document.getElementById('studentForm').addEventListener('submit', saveStudent);
}

async function saveStudent(e) {
    e.preventDefault();
    
    const studentId = document.getElementById('studentId').value;
    const studentData = {
        academicYear: currentAcademicYear,
        nisn: document.getElementById('studentNISN').value,
        nama: document.getElementById('studentNama').value,
        jenisKelamin: document.getElementById('studentJK').value,
        kelas: document.getElementById('studentKelas').value,
        rombel: document.getElementById('studentRombel').value.toUpperCase(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    showLoading();
    
    try {
        if (studentId) {
            await db.collection('users').doc(currentUser.uid)
                .collection('students').doc(studentId).update(studentData);
            
            const index = studentsData.findIndex(s => s.id === studentId);
            if (index !== -1) {
                studentsData[index] = { ...studentsData[index], ...studentData };
            }
        } else {
            studentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            const docRef = await db.collection('users').doc(currentUser.uid)
                .collection('students').add(studentData);
            
            studentsData.push({ id: docRef.id, ...studentData });
        }
        
        closeModal();
        filterStudents();
        showToast('Data siswa berhasil disimpan!', 'success');
    } catch (error) {
        console.error('Error saving student:', error);
        showToast('Gagal menyimpan data siswa.', 'error');
    } finally {
        hideLoading();
    }
}

function editStudent(id) {
    const student = studentsData.find(s => s.id === id);
    if (student) {
        showAddStudentModal(student);
    }
}

async function deleteStudent(id) {
    if (!confirm('Hapus data siswa ini?')) return;
    
    showLoading();
    
    try {
        await db.collection('users').doc(currentUser.uid)
            .collection('students').doc(id).delete();
        
        studentsData = studentsData.filter(s => s.id !== id);
        filterStudents();
        showToast('Data siswa berhasil dihapus!', 'success');
    } catch (error) {
        console.error('Error deleting student:', error);
        showToast('Gagal menghapus data siswa.', 'error');
    } finally {
        hideLoading();
    }
}

function showImportStudentsModal() {
    const modalContent = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Import Data Siswa</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-medium text-blue-800 mb-2">Format CSV</h4>
                    <p class="text-sm text-blue-700">Kolom: nisn, nama, jenisKelamin (L/P), kelas, rombel</p>
                    <p class="text-xs text-blue-600 mt-1">Contoh: 0012345678, Ahmad Fauzi, L, 7, A</p>
                </div>
                
                <div>
                    <label class="form-label">URL Google Spreadsheet (Published as CSV)</label>
                    <input type="url" id="csvUrl" class="form-input" placeholder="https://docs.google.com/spreadsheets/...">
                    <p class="text-xs text-gray-500 mt-1">Publish spreadsheet sebagai CSV: File > Share > Publish to web > CSV</p>
                </div>
                
                <div class="text-center">
                    <span class="text-gray-500">atau</span>
                </div>
                
                <div>
                    <label class="form-label">Upload File CSV</label>
                    <input type="file" id="csvFile" accept=".csv" class="form-input">
                </div>
                
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal()" class="btn-secondary flex-1">Batal</button>
                    <button onclick="importStudents()" class="btn-primary flex-1">
                        <i class="fas fa-file-import"></i>
                        Import
                    </button>
                </div>
            </div>
        </div>
    `;
    
    showModal(modalContent);
}

async function importStudents() {
    const csvUrl = document.getElementById('csvUrl').value;
    const csvFile = document.getElementById('csvFile').files[0];
    
    if (!csvUrl && !csvFile) {
        showToast('Masukkan URL atau pilih file CSV!', 'warning');
        return;
    }
    
    showLoading();
    
    try {
        let csvText = '';
        
        if (csvFile) {
            csvText = await csvFile.text();
        } else {
            const response = await fetch(csvUrl);
            csvText = await response.text();
        }
        
        // Parse CSV
        const lines = csvText.split('\n').filter(line => line.trim());
        const students = [];
        
        // Skip header row
        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
            
            if (cols.length >= 5) {
                students.push({
                    academicYear: currentAcademicYear,
                    nisn: cols[0],
                    nama: cols[1],
                    jenisKelamin: cols[2].toUpperCase(),
                    kelas: cols[3],
                    rombel: cols[4].toUpperCase(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
        
        if (students.length === 0) {
            showToast('Tidak ada data valid dalam file CSV!', 'warning');
            hideLoading();
            return;
        }
        
        // Batch write
        const batch = db.batch();
        students.forEach(student => {
            const docRef = db.collection('users').doc(currentUser.uid)
                .collection('students').doc();
            batch.set(docRef, student);
        });
        
        await batch.commit();
        
        closeModal();
        await initStudents();
        showToast(`${students.length} siswa berhasil diimport!`, 'success');
    } catch (error) {
        console.error('Error importing students:', error);
        showToast('Gagal mengimport data siswa.', 'error');
    } finally {
        hideLoading();
    }
}

// ============================================
// MODAL & UPGRADE FUNCTIONS
// ============================================
function showModal(content) {
    const container = document.getElementById('modalContainer');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.innerHTML = content;
    container.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    const container = document.getElementById('modalContainer');
    container.classList.add('hidden');
    document.body.style.overflow = '';
}

function showUpgradeModal() {
    const modalContent = `
        <div class="p-6 text-center">
            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-crown text-4xl text-yellow-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Fitur Premium</h2>
            <p class="text-gray-600 mb-6">Upgrade ke Premium untuk mengakses semua fitur lengkap!</p>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                <h4 class="font-semibold text-gray-800 mb-3">Fitur Premium:</h4>
                <ul class="space-y-2 text-sm text-gray-600">
                    <li><i class="fas fa-check text-green-500 mr-2"></i>Modul Ajar lengkap</li>
                    <li><i class="fas fa-check text-green-500 mr-2"></i>LKPD (Lembar Kerja Peserta Didik)</li>
                    <li><i class="fas fa-check text-green-500 mr-2"></i>Bank Soal dengan dukungan teks Arab</li>
                    <li><i class="fas fa-check text-green-500 mr-2"></i>Export semua dokumen</li>
                    <li><i class="fas fa-check text-green-500 mr-2"></i>Support prioritas</li>
                </ul>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closeModal()" class="btn-secondary flex-1">Nanti Saja</button>
                <a href="https://wa.me/${UPGRADE_WHATSAPP}?text=Halo,%20saya%20ingin%20upgrade%20ke%20Premium%20ADMIN%20GURU%20SUPER%20APP" target="_blank" class="btn-primary flex-1">
                    <i class="fab fa-whatsapp"></i>
                    Hubungi Admin
                </a>
            </div>
        </div>
    `;
    
    showModal(modalContent);
}

// ============================================
// REMAINING PAGES (Simplified for space)
// ============================================

function getAttendanceHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Absensi Siswa</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <p class="text-gray-600">Fitur absensi akan segera tersedia dengan integrasi jurnal pembelajaran.</p>
            </div>
        </div>
    `;
}

function initAttendance() {
    // Initialize attendance
}

function getJournalHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Jurnal Pembelajaran</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <p class="text-gray-600">Jurnal pembelajaran sinkron dengan Promes.</p>
            </div>
        </div>
    `;
}

function initJournal() {
    // Initialize journal
}

function getGradesHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Daftar Nilai</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <p class="text-gray-600">Kelola nilai PH, PTS, PAS, dan Nilai Rapor.</p>
            </div>
        </div>
    `;
}

function initGrades() {
    // Initialize grades
}

function getModulHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Modul Ajar</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <p class="text-gray-600">Buat dan kelola modul ajar dengan dukungan teks Arab.</p>
            </div>
        </div>
    `;
}

function initModul() {
    // Initialize modul ajar
}

function getLKPDHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">LKPD</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <p class="text-gray-600">Lembar Kerja Peserta Didik terintegrasi dengan Modul Ajar.</p>
            </div>
        </div>
    `;
}

function initLKPD() {
    // Initialize LKPD
}

function getQuestionBankHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Bank Soal</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <p class="text-gray-600">Bank soal terintegrasi dengan ATP dan support teks Arab.</p>
            </div>
        </div>
    `;
}

function initQuestionBank() {
    // Initialize question bank
}

function getAIAssistantHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">AI Assistant</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <div class="mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">Prompt untuk Mengubah Materi ke CSV</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-3">Gunakan prompt berikut di ChatGPT/Claude untuk mengubah materi menjadi format CSV:</p>
                        <textarea class="form-input text-sm" rows="6" readonly>Tolong bantu saya mengubah data berikut menjadi format CSV dengan kolom: nisn, nama, jenisKelamin (L/P), kelas, rombel

Data:
[Paste data siswa di sini]

Format output yang diinginkan:
nisn,nama,jenisKelamin,kelas,rombel
0012345678,Ahmad Fauzi,L,7,A</textarea>
                        <button onclick="copyPrompt(this)" class="mt-2 text-primary text-sm font-medium hover:underline">
                            <i class="fas fa-copy mr-1"></i> Copy Prompt
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function initAIAssistant() {
    // Initialize AI assistant
}

function copyPrompt(btn) {
    const textarea = btn.previousElementSibling;
    textarea.select();
    document.execCommand('copy');
    showToast('Prompt berhasil dicopy!', 'success');
}

function getHelpHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Panduan Penggunaan</h1>
            
            <div class="space-y-6">
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-rocket text-primary mr-2"></i>
                        Langkah Awal
                    </h2>
                    <ol class="list-decimal list-inside space-y-3 text-gray-600">
                        <li><strong>Lengkapi Profil:</strong> Isi data pribadi dan data sekolah di menu Profil</li>
                        <li><strong>Tambah Mata Pelajaran:</strong> Tambahkan mata pelajaran yang Anda ampu</li>
                        <li><strong>Atur Kalender:</strong> Set kalender pendidikan (awal-akhir semester, ujian, libur)</li>
                        <li><strong>Buat Jadwal:</strong> Atur jadwal mengajar di setiap kelas</li>
                        <li><strong>Input CP & TP:</strong> Masukkan Capaian Pembelajaran dan Tujuan Pembelajaran</li>
                        <li><strong>Import Siswa:</strong> Import data siswa dari CSV atau tambah manual</li>
                    </ol>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-sync text-primary mr-2"></i>
                        Konsep Single Input - Multi Output
                    </h2>
                    <p class="text-gray-600 mb-4">
                        Aplikasi ini dirancang agar Anda cukup input data dasar (Kalender, Jadwal, CP/TP) satu kali, 
                        lalu sistem akan menghasilkan berbagai dokumen secara otomatis:
                    </p>
                    <ul class="list-disc list-inside space-y-2 text-gray-600">
                        <li><strong>ATP:</strong> Dihasilkan otomatis dari data CP & TP</li>
                        <li><strong>Prota:</strong> Sinkron dengan Kalender dan ATP</li>
                        <li><strong>Promes:</strong> Detail per minggu berdasarkan Jadwal dan Kalender</li>
                        <li><strong>Jurnal:</strong> Sinkron dengan Promes dan Absensi</li>
                    </ul>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-question-circle text-primary mr-2"></i>
                        FAQ
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <p class="font-medium text-gray-800">Bagaimana cara upgrade ke Premium?</p>
                            <p class="text-gray-600 text-sm mt-1">Hubungi admin melalui WhatsApp yang tersedia di menu upgrade.</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">Apakah data saya aman?</p>
                            <p class="text-gray-600 text-sm mt-1">Ya, data Anda disimpan di Firebase dengan enkripsi dan hanya dapat diakses oleh Anda.</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">Bagaimana format import CSV siswa?</p>
                            <p class="text-gray-600 text-sm mt-1">Kolom: nisn, nama, jenisKelamin (L/P), kelas, rombel. Gunakan AI Assistant untuk mengubah data ke format ini.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Admin Pages
function getAdminUsersHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Kelola Pengguna</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <p class="text-gray-600">Panel administrasi pengguna.</p>
            </div>
        </div>
    `;
}

function initAdminUsers() {
    // Initialize admin users
}

function getAdminSettingsHTML() {
    return `
        <div class="p-4 lg:p-6 fade-in">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Pengaturan Sistem</h1>
            <div class="bg-white rounded-xl p-6 shadow-sm">
                <form id="adminSettingsForm" class="space-y-4">
                    <div>
                        <label class="form-label">Nomor WhatsApp untuk Upgrade</label>
                        <input type="text" id="adminWhatsApp" class="form-input" placeholder="628xxx" value="${UPGRADE_WHATSAPP}">
                        <p class="text-xs text-gray-500 mt-1">Format: 628xxx (tanpa + atau spasi)</p>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i>
                        Simpan Pengaturan
                    </button>
                </form>
            </div>
        </div>
    `;
}

function initAdminSettings() {
    document.getElementById('adminSettingsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const wa = document.getElementById('adminWhatsApp').value;
        
        showLoading();
        
        try {
            await db.collection('settings').doc('global').set({
                upgradeWhatsApp: wa,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            
            UPGRADE_WHATSAPP = wa;
            showToast('Pengaturan berhasil disimpan!', 'success');
        } catch (error) {
            console.error('Error saving settings:', error);
            showToast('Gagal menyimpan pengaturan.', 'error');
        } finally {
            hideLoading();
        }
    });
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    // App is initialized by Firebase auth observer
    console.log('Admin Guru Super App v' + APP_VERSION);
});
    </script>
</body>
</html>