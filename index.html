<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .arabic-text { font-family: 'Amiri', serif; direction: rtl; font-size: 1.25rem; }
        .sidebar-item { transition: all 0.2s ease; }
        .sidebar-item:hover { transform: translateX(4px); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .gradient-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .gradient-warning { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#667eea', 600: '#5b21b6', 700: '#4c1d95', 800: '#3c1361', 900: '#2e1065' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-700">Admin Guru Super App</h2>
            <p class="text-gray-500">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="hidden min-h-screen">
        <div class="min-h-screen flex">
            <!-- Left Panel -->
            <div class="hidden lg:flex lg:w-1/2 gradient-primary items-center justify-center p-12">
                <div class="text-white max-w-lg text-center">
                    <div class="text-6xl mb-6">ğŸ“š</div>
                    <h1 class="text-4xl font-bold mb-4">Admin Guru Super App</h1>
                    <p class="text-xl text-purple-100 mb-8">Single Input - Multi Output</p>
                    <div class="space-y-4 text-left bg-white/10 rounded-2xl p-6">
                        <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“…</span><span>Kalender & Jadwal Otomatis</span></div>
                        <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“</span><span>ATP, Prota, Promes Sinkron</span></div>
                        <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“–</span><span>Modul Ajar & LKPD Lengkap</span></div>
                        <div class="flex items-center gap-3"><span class="text-2xl">ğŸ“Š</span><span>Jurnal & Penilaian Terintegrasi</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel -->
            <div class="w-full lg:w-1/2 flex items-center justify-center p-8">
                <div class="w-full max-w-md">
                    <div class="lg:hidden text-center mb-8">
                        <div class="text-5xl mb-4">ğŸ“š</div>
                        <h1 class="text-2xl font-bold text-gray-800">Admin Guru Super App</h1>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-xl p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang!</h2>
                        <p class="text-gray-500 mb-6">Masuk dengan akun Google untuk melanjutkan</p>
                        
                        <div id="authError" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-4"></div>
                        
                        <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all mb-6">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            <span class="font-medium">Masuk dengan Google</span>
                        </button>
                        
                        <p class="text-center text-sm text-gray-500">Hanya akun Gmail yang dapat digunakan</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Mobile Header -->
        <header class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-40 px-4 py-3">
            <div class="flex items-center justify-between">
                <button onclick="toggleMobileSidebar()" class="p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h1 class="font-bold text-gray-800">Admin Guru Super App</h1>
                <img id="mobileUserAvatar" src="" alt="User" class="w-8 h-8 rounded-full">
            </div>
        </header>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobileSidebarOverlay" class="hidden fixed inset-0 bg-black/50 z-40 lg:hidden" onclick="toggleMobileSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-white shadow-xl z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 overflow-y-auto">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center text-white text-2xl">ğŸ“š</div>
                        <div>
                            <h1 class="font-bold text-gray-800">Admin Guru</h1>
                            <p class="text-xs text-gray-500">Super App v1.0</p>
                        </div>
                    </div>
                </div>

                <!-- User Info -->
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <img id="sidebarUserAvatar" src="" alt="User" class="w-10 h-10 rounded-full">
                        <div class="flex-1 min-w-0">
                            <p id="sidebarUserName" class="font-medium text-gray-800 truncate"></p>
                            <p id="sidebarUserEmail" class="text-xs text-gray-500 truncate"></p>
                        </div>
                        <span id="subscriptionBadge" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Free</span>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 p-4 space-y-1">
                    <button onclick="navigateTo('dashboard')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="dashboard">
                        <span class="text-xl">ğŸ </span><span>Dashboard</span>
                    </button>
                    
                    <div class="pt-4 pb-2"><p class="px-4 text-xs font-semibold text-gray-400 uppercase">Data Dasar</p></div>
                    <button onclick="navigateTo('profile')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="profile">
                        <span class="text-xl">ğŸ‘¤</span><span>Profil</span>
                    </button>
                    <button onclick="navigateTo('calendar')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="calendar">
                        <span class="text-xl">ğŸ“…</span><span>Kalender Pendidikan</span>
                    </button>
                    <button onclick="navigateTo('schedule')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="schedule">
                        <span class="text-xl">ğŸ•</span><span>Jadwal Pelajaran</span>
                    </button>
                    <button onclick="navigateTo('students')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="students">
                        <span class="text-xl">ğŸ‘¨â€ğŸ“</span><span>Data Siswa</span>
                    </button>
                    
                    <div class="pt-4 pb-2"><p class="px-4 text-xs font-semibold text-gray-400 uppercase">Perangkat Ajar</p></div>
                    <button onclick="navigateTo('cp')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="cp">
                        <span class="text-xl">ğŸ¯</span><span>Capaian Pembelajaran</span>
                    </button>
                    <button onclick="navigateTo('atp')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="atp">
                        <span class="text-xl">ğŸ“‹</span><span>ATP</span>
                    </button>
                    <button onclick="navigateTo('prota')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="prota">
                        <span class="text-xl">ğŸ“†</span><span>Prota</span>
                    </button>
                    <button onclick="navigateTo('promes')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="promes">
                        <span class="text-xl">ğŸ“‘</span><span>Promes</span>
                    </button>
                    <button onclick="navigateTo('modul')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="modul">
                        <span class="text-xl">ğŸ“–</span><span>Modul Ajar</span>
                        <span class="ml-auto text-xs bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">Premium</span>
                    </button>
                    
                    <div class="pt-4 pb-2"><p class="px-4 text-xs font-semibold text-gray-400 uppercase">Pembelajaran</p></div>
                    <button onclick="navigateTo('journal')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="journal">
                        <span class="text-xl">ğŸ““</span><span>Jurnal</span>
                    </button>
                    <button onclick="navigateTo('attendance')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="attendance">
                        <span class="text-xl">âœ…</span><span>Absensi</span>
                    </button>
                    <button onclick="navigateTo('grades')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="grades">
                        <span class="text-xl">ğŸ“Š</span><span>Daftar Nilai</span>
                    </button>
                    <button onclick="navigateTo('lkpd')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="lkpd">
                        <span class="text-xl">ğŸ“</span><span>LKPD</span>
                        <span class="ml-auto text-xs bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">Premium</span>
                    </button>
                    <button onclick="navigateTo('banksoal')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="banksoal">
                        <span class="text-xl">ğŸ¦</span><span>Bank Soal</span>
                        <span class="ml-auto text-xs bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">Premium</span>
                    </button>
                    
                    <div class="pt-4 pb-2"><p class="px-4 text-xs font-semibold text-gray-400 uppercase">Bantuan</p></div>
                    <button onclick="navigateTo('ai')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="ai">
                        <span class="text-xl">ğŸ¤–</span><span>AI Assistant</span>
                    </button>
                    <button onclick="navigateTo('guide')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100" data-nav="guide">
                        <span class="text-xl">ğŸ“š</span><span>Panduan</span>
                    </button>
                    
                    <!-- Admin Menu -->
                    <div id="adminMenu" class="hidden">
                        <div class="pt-4 pb-2"><p class="px-4 text-xs font-semibold text-red-400 uppercase">Admin</p></div>
                        <button onclick="navigateTo('admin')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-600 hover:bg-red-50" data-nav="admin">
                            <span class="text-xl">âš™ï¸</span><span>Panel Admin</span>
                        </button>
                    </div>
                </nav>

                <!-- Bottom Actions -->
                <div class="p-4 border-t border-gray-100 space-y-2">
                    <button id="upgradeBtn" onclick="showUpgradeModal()" class="w-full gradient-secondary text-white px-4 py-3 rounded-xl font-medium hover:opacity-90">
                        â­ Upgrade Premium
                    </button>
                    <button onclick="signOut()" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-xl">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Keluar</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="lg:ml-72 min-h-screen pt-16 lg:pt-0">
            <div id="contentArea" class="p-4 lg:p-8"></div>
        </main>
    </div>

    <!-- Modals Container -->
    <div id="modalsContainer"></div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
        apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
        authDomain: "agsa-e5b08.firebaseapp.com",
        projectId: "agsa-e5b08",
        storageBucket: "agsa-e5b08.firebasestorage.app",
        messagingSenderId: "916052746331",
        appId: "1:916052746331:web:357cbadbfd8658f1689f7e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ==================== GLOBAL STATE ====================
    let currentUser = null;
    let userProfile = null;
    let currentPage = 'dashboard';
    const SUPER_ADMIN_EMAIL = 'afifaro@gmail.com';
    let APP_CONFIG = {
        whatsappNumber: '6281234567890',
        schoolPackagePrice: 500000,
        individualPrice: 100000
    };

    // ==================== DATA BUKU PAI ====================
    const dataBuku = {
        kelas1: {
            judul: "PAI dan Budi Pekerti Kelas 1",
            fase: "A",
            semester1: [
                { bab: 1, elemen: "Al-Qur'an dan Hadis", judul: "Aku Belajar Huruf Hijaiyah", tujuan: "Peserta didik dapat mengenal dan melafalkan huruf hijaiyah dengan benar", materi: [{ sub: "Mengenal Huruf Hijaiyah", isi: "Huruf hijaiyah ada 28 huruf. Huruf pertama adalah Alif (Ø§)." }, { sub: "Cara Melafalkan", isi: "Setiap huruf punya cara baca sendiri." }], aktivitas: ["Menyanyikan lagu huruf hijaiyah", "Mencocokkan huruf dengan gambar"], refleksi: "Aku sudah bisa melafalkan huruf apa saja hari ini?", karakter: ["Tekun belajar", "Sabar berlatih"] },
                { bab: 2, elemen: "Akidah", judul: "Allah Tuhanku", tujuan: "Peserta didik dapat meyakini Allah SWT sebagai Tuhan Yang Maha Esa", materi: [{ sub: "Allah Maha Esa", isi: "Allah itu satu. Allah tidak beranak dan tidak diperanakkan." }, { sub: "Allah Maha Pencipta", isi: "Allah menciptakan langit dan bumi." }], aktivitas: ["Menyebutkan ciptaan Allah", "Menggambar ciptaan Allah"], refleksi: "Apa saja ciptaan Allah yang aku lihat hari ini?", karakter: ["Beriman", "Bersyukur"] },
                { bab: 3, elemen: "Akhlak", judul: "Aku Anak Saleh", tujuan: "Peserta didik dapat menunjukkan perilaku terpuji dalam kehidupan sehari-hari", materi: [{ sub: "Berkata Jujur", isi: "Jujur artinya berkata sesuai kenyataan." }, { sub: "Saling Menyayangi", isi: "Sesama teman harus saling sayang." }], aktivitas: ["Bermain peran anak jujur", "Membuat kartu ucapan untuk orang tua"], refleksi: "Hari ini aku sudah berbuat baik kepada siapa?", karakter: ["Jujur", "Penyayang"] },
                { bab: 4, elemen: "Fikih", judul: "Aku Belajar Bersuci", tujuan: "Peserta didik dapat memahami dan mempraktikkan tata cara bersuci sederhana", materi: [{ sub: "Mengenal Najis", isi: "Najis adalah kotoran yang harus dibersihkan." }, { sub: "Istinja", isi: "Setelah buang air, harus cebok dengan air bersih." }], aktivitas: ["Praktik mencuci tangan yang benar", "Mengurutkan gambar cara cebok"], refleksi: "Apakah aku sudah menjaga kebersihan hari ini?", karakter: ["Bersih", "Mandiri"] },
                { bab: 5, elemen: "Sejarah Peradaban Islam", judul: "Nabi Muhammad SAW Panutanku", tujuan: "Peserta didik dapat mengenal Nabi Muhammad SAW sebagai teladan", materi: [{ sub: "Kelahiran Nabi Muhammad SAW", isi: "Nabi Muhammad lahir di Mekah pada tanggal 12 Rabiul Awal." }, { sub: "Nabi Muhammad Anak yang Baik", isi: "Sejak kecil Nabi Muhammad sudah baik dan jujur." }], aktivitas: ["Mendengarkan kisah Nabi Muhammad", "Menyanyikan shalawat"], refleksi: "Apa yang bisa aku contoh dari Nabi Muhammad?", karakter: ["Meneladani Nabi", "Mencintai Nabi"] }
            ],
            semester2: [
                { bab: 6, elemen: "Al-Qur'an dan Hadis", judul: "Aku Menghafal Surah Pendek", tujuan: "Peserta didik dapat melafalkan dan menghafal surah Al-Fatihah dan An-Nas", materi: [{ sub: "Surah Al-Fatihah", isi: "Al-Fatihah artinya pembuka, terdiri dari 7 ayat." }, { sub: "Surah An-Nas", isi: "An-Nas artinya manusia, mengajarkan meminta perlindungan kepada Allah." }], aktivitas: ["Menghafal bersama", "Lomba hafalan"], refleksi: "Sudah berapa ayat yang aku hafal hari ini?", karakter: ["Cinta Al-Qur'an", "Tekun menghafal"] },
                { bab: 7, elemen: "Akidah", judul: "Malaikat Allah", tujuan: "Peserta didik dapat mengenal malaikat sebagai makhluk Allah", materi: [{ sub: "Malaikat Ciptaan Allah", isi: "Malaikat diciptakan Allah dari cahaya." }, { sub: "Nama-nama Malaikat", isi: "Ada 10 malaikat yang wajib kita ketahui." }], aktivitas: ["Menyebutkan nama malaikat", "Mencocokkan malaikat dengan tugasnya"], refleksi: "Apa yang aku ketahui tentang malaikat?", karakter: ["Beriman kepada malaikat"] },
                { bab: 8, elemen: "Akhlak", judul: "Aku Sayang Temanku", tujuan: "Peserta didik dapat menunjukkan sikap persahabatan dan tolong-menolong", materi: [{ sub: "Berteman dengan Baik", isi: "Teman itu penting untuk bermain dan belajar." }, { sub: "Tolong-Menolong", isi: "Kalau teman kesusahan, kita bantu." }], aktivitas: ["Bermain bersama teman", "Membuat gelang persahabatan"], refleksi: "Hari ini aku sudah membantu teman apa?", karakter: ["Tolong-menolong", "Pemaaf"] },
                { bab: 9, elemen: "Fikih", judul: "Aku Belajar Wudhu", tujuan: "Peserta didik dapat mengetahui tata cara wudhu yang benar", materi: [{ sub: "Apa itu Wudhu?", isi: "Wudhu adalah membersihkan anggota tubuh dengan air sebelum shalat." }, { sub: "Cara Berwudhu", isi: "1. Niat 2. Cuci tangan 3. Kumur 4. Basuh hidung 5. Basuh muka..." }], aktivitas: ["Praktik wudhu bersama", "Mengurutkan gambar tata cara wudhu"], refleksi: "Apakah wudhuku sudah benar?", karakter: ["Bersih", "Tertib"] },
                { bab: 10, elemen: "Sejarah Peradaban Islam", judul: "Kisah Nabi Adam AS", tujuan: "Peserta didik dapat mengenal kisah Nabi Adam AS sebagai manusia pertama", materi: [{ sub: "Nabi Adam Manusia Pertama", isi: "Nabi Adam adalah manusia pertama yang diciptakan dari tanah." }, { sub: "Pelajaran dari Kisah Nabi Adam", isi: "Kita harus patuh kepada Allah dan segera bertaubat jika salah." }], aktivitas: ["Mendengarkan kisah Nabi Adam", "Bermain peran"], refleksi: "Apa pelajaran dari kisah Nabi Adam?", karakter: ["Bertaubat", "Patuh kepada Allah"] }
            ]
        },
        kelas2: { judul: "PAI dan Budi Pekerti Kelas 2", fase: "A", semester1: [
            { bab: 1, elemen: "Al-Qur'an dan Hadis", judul: "Mengenal Harakat dan Tajwid Dasar", tujuan: "Peserta didik dapat membaca huruf hijaiyah berharakat dengan lancar", materi: [{ sub: "Harakat Fathah, Kasrah, Dhammah", isi: "Harakat adalah tanda baca dalam Al-Qur'an." }], aktivitas: ["Membaca kartu huruf berharakat"], refleksi: "Harakat apa yang masih sulit aku baca?", karakter: ["Teliti"] },
            { bab: 2, elemen: "Akidah", judul: "Asmaul Husna", tujuan: "Peserta didik dapat mengenal beberapa Asmaul Husna", materi: [{ sub: "Ar-Rahman dan Ar-Rahim", isi: "Ar-Rahman artinya Maha Pengasih." }], aktivitas: ["Menghafal Asmaul Husna"], refleksi: "Asmaul Husna apa yang paling aku ingat?", karakter: ["Mengenal Allah"] },
            { bab: 3, elemen: "Akhlak", judul: "Hidup Bersih dan Sehat", tujuan: "Peserta didik dapat menerapkan pola hidup bersih", materi: [{ sub: "Kebersihan Sebagian dari Iman", isi: "Nabi bersabda: Kebersihan sebagian dari iman." }], aktivitas: ["Praktik mencuci tangan 6 langkah"], refleksi: "Apa yang sudah aku lakukan untuk menjaga kebersihan?", karakter: ["Bersih", "Sehat"] },
            { bab: 4, elemen: "Fikih", judul: "Gerakan dan Bacaan Shalat", tujuan: "Peserta didik dapat mengetahui gerakan dan bacaan shalat", materi: [{ sub: "Rukun Shalat", isi: "Rukun shalat ada 13." }], aktivitas: ["Praktik gerakan shalat"], refleksi: "Bacaan shalat apa yang sudah aku hafal?", karakter: ["Taat beribadah"] },
            { bab: 5, elemen: "Sejarah Peradaban Islam", judul: "Kisah Nabi Nuh AS", tujuan: "Peserta didik dapat menceritakan kisah Nabi Nuh AS", materi: [{ sub: "Dakwah Nabi Nuh", isi: "Nabi Nuh berdakwah selama 950 tahun." }], aktivitas: ["Mendengarkan kisah Nabi Nuh"], refleksi: "Apa pelajaran dari kisah Nabi Nuh?", karakter: ["Sabar"] }
        ], semester2: [
            { bab: 6, elemen: "Al-Qur'an dan Hadis", judul: "Menghafal Surah Al-Ikhlas dan Al-Falaq", tujuan: "Peserta didik dapat menghafal surah Al-Ikhlas dan Al-Falaq", materi: [{ sub: "Surah Al-Ikhlas", isi: "Al-Ikhlas artinya keikhlasan." }], aktivitas: ["Menghafal bersama"], refleksi: "Sudahkah aku lancar membaca surah Al-Ikhlas?", karakter: ["Cinta Al-Qur'an"] },
            { bab: 7, elemen: "Akidah", judul: "Beriman kepada Kitab Allah", tujuan: "Peserta didik dapat mengenal kitab-kitab Allah", materi: [{ sub: "Kitab-kitab Allah", isi: "Allah menurunkan 4 kitab suci." }], aktivitas: ["Melihat mushaf Al-Qur'an"], refleksi: "Apa yang aku ketahui tentang Al-Qur'an?", karakter: ["Beriman kepada kitab Allah"] },
            { bab: 8, elemen: "Akhlak", judul: "Rendah Hati dan Tidak Sombong", tujuan: "Peserta didik dapat menunjukkan sikap rendah hati", materi: [{ sub: "Apa itu Rendah Hati?", isi: "Rendah hati artinya tidak merasa lebih dari orang lain." }], aktivitas: ["Bermain peran anak rendah hati"], refleksi: "Apakah aku sudah rendah hati hari ini?", karakter: ["Rendah hati"] },
            { bab: 9, elemen: "Fikih", judul: "Shalat Lima Waktu", tujuan: "Peserta didik dapat mengenal waktu-waktu shalat wajib", materi: [{ sub: "Lima Waktu Shalat", isi: "Shalat wajib ada 5 waktu." }], aktivitas: ["Membuat jadwal shalat"], refleksi: "Apakah aku sudah shalat 5 waktu hari ini?", karakter: ["Disiplin shalat"] },
            { bab: 10, elemen: "Sejarah Peradaban Islam", judul: "Kisah Nabi Ibrahim AS", tujuan: "Peserta didik dapat menceritakan kisah Nabi Ibrahim AS", materi: [{ sub: "Nabi Ibrahim Mencari Tuhan", isi: "Nabi Ibrahim mencari Tuhan yang benar." }], aktivitas: ["Mendengarkan kisah Nabi Ibrahim"], refleksi: "Apa yang bisa aku teladani dari Nabi Ibrahim?", karakter: ["Beriman teguh"] }
        ]},
        kelas3: { judul: "PAI dan Budi Pekerti Kelas 3", fase: "B", semester1: [], semester2: [] },
        kelas4: { judul: "PAI dan Budi Pekerti Kelas 4", fase: "B", semester1: [], semester2: [] },
        kelas5: { judul: "PAI dan Budi Pekerti Kelas 5", fase: "C", semester1: [], semester2: [] },
        kelas6: { judul: "PAI dan Budi Pekerti Kelas 6", fase: "C", semester1: [], semester2: [] }
    };

    // ==================== UTILITY FUNCTIONS ====================
    function getAcademicYears() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        if (currentMonth >= 5) {
            return [`${currentYear}/${currentYear + 1}`, `${currentYear + 1}/${currentYear + 2}`];
        } else {
            return [`${currentYear - 1}/${currentYear}`, `${currentYear}/${currentYear + 1}`];
        }
    }

    function getCurrentAcademicYear() {
        return getAcademicYears()[0];
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-amber-500', info: 'bg-blue-500' };
        toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg animate-fade-in flex items-center gap-2`;
        toast.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()" class="ml-2 hover:opacity-70">Ã—</button>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function showModal(content, options = {}) {
        const container = document.getElementById('modalsContainer');
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center modal-overlay animate-fade-in p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-${options.size || 'lg'} max-h-[90vh] overflow-hidden flex flex-col">
                ${options.title ? `
                    <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-100 flex-shrink-0">
                        <h3 class="text-lg md:text-xl font-bold text-gray-800">${options.title}</h3>
                        <button onclick="closeModal(this)" class="p-2 hover:bg-gray-100 rounded-lg">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                ` : ''}
                <div class="p-4 md:p-6 overflow-y-auto">${content}</div>
            </div>
        `;
        if (!options.persistent) {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
        }
        container.appendChild(modal);
        return modal;
    }

    function closeModal(btn) {
        const modal = btn.closest('.fixed');
        if (modal) modal.remove();
    }

    function formatDate(date, format = 'long') {
        const d = new Date(date);
        const options = format === 'long' 
            ? { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
            : { year: 'numeric', month: '2-digit', day: '2-digit' };
        return d.toLocaleDateString('id-ID', options);
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    }

    // ==================== AUTHENTICATION ====================
    async function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        try {
            const result = await auth.signInWithPopup(provider);
            if (!result.user.email.endsWith('@gmail.com')) {
                await auth.signOut();
                document.getElementById('authError').textContent = 'Hanya akun Gmail yang dapat digunakan!';
                document.getElementById('authError').classList.remove('hidden');
                return;
            }
            showToast('Berhasil masuk!', 'success');
        } catch (error) {
            console.error('Auth error:', error);
            document.getElementById('authError').textContent = error.message;
            document.getElementById('authError').classList.remove('hidden');
        }
    }

    async function signOut() {
        try {
            await auth.signOut();
            showToast('Berhasil keluar', 'info');
        } catch (error) {
            console.error('Sign out error:', error);
        }
    }

    // ==================== USER PROFILE ====================
    async function loadUserProfile() {
        if (!currentUser) return;
        try {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            if (doc.exists) {
                userProfile = doc.data();
            } else {
                userProfile = {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: currentUser.displayName || '',
                    photoURL: currentUser.photoURL || '',
                    subscription: 'free',
                    subjects: [],
                    school: { name: '', npsn: '', level: 'SD', location: '', principalName: '' },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(currentUser.uid).set(userProfile);
            }
            updateUIWithUserData();
        } catch (error) {
            console.error('Error loading profile:', error);
        }
    }

    function updateUIWithUserData() {
        const avatar = currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.displayName || currentUser.email);
        document.getElementById('sidebarUserAvatar').src = avatar;
        document.getElementById('mobileUserAvatar').src = avatar;
        document.getElementById('sidebarUserName').textContent = userProfile?.name || currentUser.displayName || 'User';
        document.getElementById('sidebarUserEmail').textContent = currentUser.email;
        
        const badge = document.getElementById('subscriptionBadge');
        if (userProfile?.subscription === 'premium' || currentUser.email === SUPER_ADMIN_EMAIL) {
            badge.textContent = 'Premium';
            badge.className = 'px-2 py-1 text-xs font-medium rounded-full bg-amber-100 text-amber-600';
            document.getElementById('upgradeBtn').classList.add('hidden');
        } else {
            badge.textContent = 'Free';
            badge.className = 'px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600';
            document.getElementById('upgradeBtn').classList.remove('hidden');
        }
        
        if (currentUser.email === SUPER_ADMIN_EMAIL) {
            document.getElementById('adminMenu').classList.remove('hidden');
        }
    }

    function isPremiumUser() {
        return userProfile?.subscription === 'premium' || currentUser?.email === SUPER_ADMIN_EMAIL;
    }

    // ==================== NAVIGATION ====================
    function toggleMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobileSidebarOverlay');
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('hidden');
    }

    function navigateTo(page) {
        const premiumPages = ['modul', 'lkpd', 'banksoal'];
        if (premiumPages.includes(page) && !isPremiumUser()) {
            showUpgradeModal();
            return;
        }
        
        currentPage = page;
        document.querySelectorAll('[data-nav]').forEach(btn => {
            if (btn.dataset.nav === page) {
                btn.classList.add('bg-primary-50', 'text-primary-600');
                btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
            } else {
                btn.classList.remove('bg-primary-50', 'text-primary-600');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            }
        });
        
        if (window.innerWidth < 1024) {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar.classList.contains('-translate-x-full')) {
                toggleMobileSidebar();
            }
        }
        
        loadPageContent(page);
    }

    function loadPageContent(page) {
        const content = document.getElementById('contentArea');
        content.innerHTML = '<div class="flex justify-center py-20"><div class="loading-spinner"></div></div>';
        
        setTimeout(() => {
            switch (page) {
                case 'dashboard': renderDashboard(); break;
                case 'profile': renderProfile(); break;
                case 'calendar': renderCalendar(); break;
                case 'schedule': renderSchedule(); break;
                case 'students': renderStudents(); break;
                case 'cp': renderCP(); break;
                case 'atp': renderATP(); break;
                case 'prota': renderProta(); break;
                case 'promes': renderPromes(); break;
                case 'modul': renderModul(); break;
                case 'journal': renderJournal(); break;
                case 'attendance': renderAttendance(); break;
                case 'grades': renderGrades(); break;
                case 'lkpd': renderLKPD(); break;
                case 'banksoal': renderBankSoal(); break;
                case 'ai': renderAI(); break;
                case 'guide': renderGuide(); break;
                case 'admin': renderAdmin(); break;
                default: content.innerHTML = '<p class="text-center py-20">Halaman tidak ditemukan</p>';
            }
        }, 100);
    }

    // ==================== UPGRADE MODAL ====================
    function showUpgradeModal() {
        const content = `
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">â­</div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Upgrade ke Premium</h3>
                <p class="text-gray-600">Dapatkan akses penuh ke semua fitur</p>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="border-2 border-gray-200 rounded-xl p-6">
                    <h4 class="font-bold text-gray-800 mb-2">Paket Perorangan</h4>
                    <p class="text-3xl font-bold text-primary-600 mb-4">${formatCurrency(APP_CONFIG.individualPrice)}<span class="text-sm text-gray-500">/tahun</span></p>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li>âœ… Semua fitur Premium</li>
                        <li>âœ… Modul Ajar lengkap</li>
                        <li>âœ… Bank Soal & LKPD</li>
                    </ul>
                </div>
                <div class="border-2 border-primary-500 rounded-xl p-6 bg-primary-50">
                    <div class="text-xs font-medium text-primary-600 mb-2">HEMAT!</div>
                    <h4 class="font-bold text-gray-800 mb-2">Paket Sekolah</h4>
                    <p class="text-3xl font-bold text-primary-600 mb-4">${formatCurrency(APP_CONFIG.schoolPackagePrice)}<span class="text-sm text-gray-500">/tahun</span></p>
                    <ul class="text-sm text-gray-600 space-y-2">
                        <li>âœ… Unlimited guru</li>
                        <li>âœ… Semua fitur Premium</li>
                        <li>âœ… Support prioritas</li>
                    </ul>
                </div>
            </div>
            <a href="https://wa.me/${APP_CONFIG.whatsappNumber}?text=Halo, saya ingin upgrade ke Premium Admin Guru Super App. Email: ${currentUser?.email}" target="_blank" class="block w-full bg-green-500 text-white text-center px-6 py-3 rounded-xl font-medium hover:bg-green-600">
                ğŸ“± Hubungi via WhatsApp
            </a>
        `;
        showModal(content, { title: 'Upgrade Premium', size: 'xl' });
    }

    // ==================== PAGE RENDERERS ====================
    
    // Dashboard
    function renderDashboard() {
        const content = document.getElementById('contentArea');
        const years = getAcademicYears();
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Selamat Datang, ${userProfile?.name || 'Guru'}! ğŸ‘‹</h1>
                        <p class="text-gray-500">Tahun Ajaran: ${years[0]}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white rounded-2xl p-6 card-hover">
                        <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center text-2xl mb-4">ğŸ“…</div>
                        <p class="text-2xl font-bold text-gray-800">18</p>
                        <p class="text-sm text-gray-500">Minggu Efektif</p>
                    </div>
                    <div class="bg-white rounded-2xl p-6 card-hover">
                        <div class="w-12 h-12 gradient-success rounded-xl flex items-center justify-center text-2xl mb-4">ğŸ‘¨â€ğŸ“</div>
                        <p class="text-2xl font-bold text-gray-800" id="dashStudentCount">0</p>
                        <p class="text-sm text-gray-500">Total Siswa</p>
                    </div>
                    <div class="bg-white rounded-2xl p-6 card-hover">
                        <div class="w-12 h-12 gradient-warning rounded-xl flex items-center justify-center text-2xl mb-4">ğŸ“</div>
                        <p class="text-2xl font-bold text-gray-800" id="dashClassCount">0</p>
                        <p class="text-sm text-gray-500">Kelas Diampu</p>
                    </div>
                    <div class="bg-white rounded-2xl p-6 card-hover">
                        <div class="w-12 h-12 gradient-secondary rounded-xl flex items-center justify-center text-2xl mb-4">ğŸ“–</div>
                        <p class="text-2xl font-bold text-gray-800" id="dashModulCount">0</p>
                        <p class="text-sm text-gray-500">Modul Ajar</p>
                    </div>
                </div>
                <div class="grid lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“‹ Status Dokumen</h2>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ğŸ“…</span>
                                    <span class="font-medium">Kalender Pendidikan</span>
                                </div>
                                <span class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-600">Belum diisi</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ğŸ•</span>
                                    <span class="font-medium">Jadwal Pelajaran</span>
                                </div>
                                <span class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-600">Belum diisi</span>
                            </div>
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ğŸ¯</span>
                                    <span class="font-medium">Capaian Pembelajaran</span>
                                </div>
                                <span class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-600">Belum diisi</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-primary-500 to-purple-600 rounded-2xl p-6 text-white">
                        <h2 class="text-lg font-bold mb-2">ğŸ’¡ Tips</h2>
                        <p class="text-sm text-purple-100 mb-4">Lengkapi data Kalender dan Jadwal terlebih dahulu untuk mengaktifkan fitur auto-generate dokumen.</p>
                        <button onclick="navigateTo('guide')" class="w-full bg-white/20 hover:bg-white/30 rounded-xl py-2 text-sm font-medium">
                            Baca Panduan â†’
                        </button>
                    </div>
                </div>
            </div>
        `;
        loadDashboardStats();
    }

    async function loadDashboardStats() {
        try {
            const studentsSnap = await db.collection('users').doc(currentUser.uid).collection('students').get();
            document.getElementById('dashStudentCount').textContent = studentsSnap.size;
            
            const scheduleSnap = await db.collection('users').doc(currentUser.uid).collection('schedules').get();
            const classes = new Set();
            scheduleSnap.forEach(doc => { if (doc.data().className) classes.add(doc.data().className); });
            document.getElementById('dashClassCount').textContent = classes.size;
            
            const modulSnap = await db.collection('users').doc(currentUser.uid).collection('modules').get();
            document.getElementById('dashModulCount').textContent = modulSnap.size;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // Profile
    function renderProfile() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in max-w-4xl mx-auto">
                <h1 class="text-2xl font-bold text-gray-800 mb-8">ğŸ‘¤ Profil Saya</h1>
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Data Pribadi</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="profileName" value="${userProfile?.name || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIP/NIK</label>
                                <input type="text" id="profileNIP" value="${userProfile?.nip || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" value="${currentUser?.email || ''}" readonly class="w-full px-4 py-3 border border-gray-200 rounded-xl bg-gray-50">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">No. HP/WhatsApp</label>
                                <input type="tel" id="profilePhone" value="${userProfile?.phone || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ« Satuan Pendidikan</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Sekolah</label>
                                <input type="text" id="schoolName" value="${userProfile?.school?.name || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NPSN</label>
                                <input type="text" id="schoolNPSN" value="${userProfile?.school?.npsn || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jenjang</label>
                                <select id="schoolLevel" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                    <option value="SD" ${userProfile?.school?.level === 'SD' ? 'selected' : ''}>SD/MI</option>
                                    <option value="SMP" ${userProfile?.school?.level === 'SMP' ? 'selected' : ''}>SMP/MTs</option>
                                    <option value="SMA" ${userProfile?.school?.level === 'SMA' ? 'selected' : ''}>SMA/MA/SMK</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi (Kota/Kabupaten)</label>
                                <input type="text" id="schoolLocation" value="${userProfile?.school?.location || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Kepala Sekolah</label>
                                <input type="text" id="principalName" value="${userProfile?.school?.principalName || ''}" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-gray-800">ğŸ“š Mata Pelajaran yang Diampu</h2>
                            <button onclick="addSubject()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700">+ Tambah Mapel</button>
                        </div>
                        <div id="subjectsList" class="space-y-3">${renderSubjectsList()}</div>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="saveProfile()" class="px-8 py-3 gradient-primary text-white rounded-xl font-medium hover:opacity-90">ğŸ’¾ Simpan Profil</button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderSubjectsList() {
        const subjects = userProfile?.subjects || [];
        if (subjects.length === 0) {
            return '<p class="text-center py-4 text-gray-500">Belum ada mata pelajaran. Klik "Tambah Mapel".</p>';
        }
        return subjects.map((s, i) => `
            <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                <div class="flex-1 grid grid-cols-3 gap-4">
                    <input type="text" value="${s.name}" onchange="updateSubject(${i}, 'name', this.value)" placeholder="Nama Mapel" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <input type="number" value="${s.hoursPerMeeting || 2}" min="1" max="4" onchange="updateSubject(${i}, 'hoursPerMeeting', this.value)" placeholder="JP/Pertemuan" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                    <input type="number" value="${s.meetingsPerWeek || 1}" min="1" max="5" onchange="updateSubject(${i}, 'meetingsPerWeek', this.value)" placeholder="Pertemuan/Minggu" class="px-3 py-2 border border-gray-200 rounded-lg text-sm">
                </div>
                <button onclick="removeSubject(${i})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">âœ•</button>
            </div>
        `).join('');
    }

    function addSubject() {
        if (!userProfile.subjects) userProfile.subjects = [];
        userProfile.subjects.push({ name: 'PAI dan Budi Pekerti', hoursPerMeeting: 2, meetingsPerWeek: 1 });
        document.getElementById('subjectsList').innerHTML = renderSubjectsList();
    }

    function updateSubject(index, field, value) {
        if (userProfile.subjects && userProfile.subjects[index]) {
            userProfile.subjects[index][field] = field === 'name' ? value : parseInt(value);
        }
    }

    function removeSubject(index) {
        if (userProfile.subjects) {
            userProfile.subjects.splice(index, 1);
            document.getElementById('subjectsList').innerHTML = renderSubjectsList();
        }
    }

    async function saveProfile() {
        try {
            const data = {
                name: document.getElementById('profileName').value,
                nip: document.getElementById('profileNIP').value,
                phone: document.getElementById('profilePhone').value,
                school: {
                    name: document.getElementById('schoolName').value,
                    npsn: document.getElementById('schoolNPSN').value,
                    level: document.getElementById('schoolLevel').value,
                    location: document.getElementById('schoolLocation').value,
                    principalName: document.getElementById('principalName').value
                },
                subjects: userProfile.subjects || [],
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('users').doc(currentUser.uid).update(data);
            userProfile = { ...userProfile, ...data };
            updateUIWithUserData();
            showToast('Profil berhasil disimpan!', 'success');
        } catch (error) {
            console.error('Error saving profile:', error);
            showToast('Gagal menyimpan profil', 'error');
        }
    }

    // Calendar
    function renderCalendar() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“… Kalender Pendidikan</h1>
                    <button onclick="saveCalendar()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">ğŸ’¾ Simpan</button>
                </div>
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Semester 1 (Ganjil)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                                <input type="date" id="sem1Start" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai</label>
                                <input type="date" id="sem1End" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Semester 2 (Genap)</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                                <input type="date" id="sem2Start" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai</label>
                                <input type="date" id="sem2End" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ‰ Hari Libur</h2>
                    <p class="text-sm text-gray-500 mb-4">Hari libur nasional baku sudah termasuk. Tambahkan libur khusus sekolah.</p>
                    <div id="holidaysList" class="space-y-3"></div>
                    <button onclick="addHoliday()" class="mt-4 text-primary-600 font-medium hover:underline">+ Tambah Hari Libur</button>
                </div>
            </div>
        `;
        loadCalendarData();
    }

    let calendarData = { holidays: [] };

    async function loadCalendarData() {
        try {
            const doc = await db.collection('users').doc(currentUser.uid).collection('settings').doc('calendar').get();
            if (doc.exists) {
                calendarData = doc.data();
                document.getElementById('sem1Start').value = calendarData.semester1?.start || '';
                document.getElementById('sem1End').value = calendarData.semester1?.end || '';
                document.getElementById('sem2Start').value = calendarData.semester2?.start || '';
                document.getElementById('sem2End').value = calendarData.semester2?.end || '';
                renderHolidaysList();
            }
        } catch (error) {
            console.error('Error loading calendar:', error);
        }
    }

    function renderHolidaysList() {
        const container = document.getElementById('holidaysList');
        if (!container) return;
        container.innerHTML = (calendarData.holidays || []).map((h, i) => `
            <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
                <input type="text" value="${h.name}" onchange="updateHoliday(${i}, 'name', this.value)" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg">
                <input type="date" value="${h.date}" onchange="updateHoliday(${i}, 'date', this.value)" class="px-3 py-2 border border-gray-200 rounded-lg">
                <button onclick="removeHoliday(${i})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">âœ•</button>
            </div>
        `).join('');
    }

    function addHoliday() {
        if (!calendarData.holidays) calendarData.holidays = [];
        calendarData.holidays.push({ name: 'Libur Baru', date: new Date().toISOString().split('T')[0] });
        renderHolidaysList();
    }

    function updateHoliday(index, field, value) {
        if (calendarData.holidays && calendarData.holidays[index]) {
            calendarData.holidays[index][field] = value;
        }
    }

    function removeHoliday(index) {
        if (calendarData.holidays) {
            calendarData.holidays.splice(index, 1);
            renderHolidaysList();
        }
    }

    async function saveCalendar() {
        try {
            const data = {
                semester1: { start: document.getElementById('sem1Start').value, end: document.getElementById('sem1End').value },
                semester2: { start: document.getElementById('sem2Start').value, end: document.getElementById('sem2End').value },
                holidays: calendarData.holidays || [],
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            await db.collection('users').doc(currentUser.uid).collection('settings').doc('calendar').set(data);
            showToast('Kalender berhasil disimpan!', 'success');
        } catch (error) {
            console.error('Error saving calendar:', error);
            showToast('Gagal menyimpan kalender', 'error');
        }
    }

    // Schedule
    const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    let scheduleData = [];

    function renderSchedule() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ• Jadwal Pelajaran</h1>
                    <button onclick="addScheduleEntry()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">â• Tambah Jadwal</button>
                </div>
                <div class="bg-white rounded-2xl p-6 overflow-x-auto">
                    <table class="w-full min-w-[800px]">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Jam</th>
                                ${days.map(d => `<th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">${d}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody"></tbody>
                    </table>
                </div>
                <div class="mt-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <h3 class="font-medium text-amber-800 mb-2">âš ï¸ Validasi Jadwal</h3>
                    <ul class="text-sm text-amber-700 space-y-1">
                        <li>â€¢ Guru tidak dapat mengajar di dua kelas berbeda pada jam yang sama</li>
                        <li>â€¢ Satu rombel tidak dapat memiliki lebih dari satu guru pada jam yang sama</li>
                    </ul>
                </div>
            </div>
        `;
        loadScheduleData();
    }

    async function loadScheduleData() {
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('schedules').get();
            scheduleData = [];
            snapshot.forEach(doc => scheduleData.push({ id: doc.id, ...doc.data() }));
            renderScheduleTable();
        } catch (error) {
            console.error('Error loading schedule:', error);
        }
    }

    function renderScheduleTable() {
        const tbody = document.getElementById('scheduleTableBody');
        const hours = Array.from({ length: 8 }, (_, i) => i + 1);
        tbody.innerHTML = hours.map(h => `
            <tr class="border-b border-gray-100">
                <td class="px-4 py-3 text-sm font-medium text-gray-700">Jam ${h}</td>
                ${days.map(d => {
                    const entry = scheduleData.find(s => s.day === d && s.hour === h);
                    return `<td class="px-2 py-2">
                        ${entry ? `
                            <div class="bg-primary-100 border border-primary-200 rounded-lg p-2 text-xs cursor-pointer hover:bg-primary-200" onclick="editSchedule('${entry.id}')">
                                <div class="font-medium text-primary-800">${entry.subject}</div>
                                <div class="text-primary-600">${entry.className}</div>
                            </div>
                        ` : `
                            <button onclick="addScheduleAt('${d}', ${h})" class="w-full h-12 border-2 border-dashed border-gray-200 rounded-lg hover:border-primary-300 hover:bg-primary-50 text-gray-400 hover:text-primary-500">+</button>
                        `}
                    </td>`;
                }).join('')}
            </tr>
        `).join('');
    }

    function addScheduleEntry() { addScheduleAt(days[0], 1); }

    function addScheduleAt(day, hour) {
        const subjects = userProfile?.subjects || [{ name: 'PAI dan Budi Pekerti' }];
        const content = `
            <form id="scheduleForm" class="space-y-4">
                <input type="hidden" id="scheduleId" value="">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hari</label>
                        <select id="scheduleDay" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            ${days.map(d => `<option value="${d}" ${d === day ? 'selected' : ''}>${d}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jam Ke</label>
                        <select id="scheduleHour" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                            ${Array.from({ length: 8 }, (_, i) => `<option value="${i + 1}" ${i + 1 === hour ? 'selected' : ''}>Jam ${i + 1}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                    <select id="scheduleSubject" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas / Rombel</label>
                    <input type="text" id="scheduleClass" placeholder="Contoh: 4A" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Simpan</button>
                    <button type="button" onclick="deleteScheduleEntry()" id="deleteScheduleBtn" class="hidden px-4 py-3 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700">Hapus</button>
                </div>
            </form>
        `;
        showModal(content, { title: 'ğŸ“… Tambah Jadwal', size: 'md' });
        document.getElementById('scheduleForm').addEventListener('submit', saveScheduleEntry);
    }

    async function saveScheduleEntry(e) {
        e.preventDefault();
        const id = document.getElementById('scheduleId').value || db.collection('temp').doc().id;
        const day = document.getElementById('scheduleDay').value;
        const hour = parseInt(document.getElementById('scheduleHour').value);
        const subject = document.getElementById('scheduleSubject').value;
        const className = document.getElementById('scheduleClass').value;
        
        // Check for conflict
        const conflict = scheduleData.find(s => s.id !== id && s.day === day && s.hour === hour);
        if (conflict) {
            showToast(`Konflik: Sudah ada jadwal di ${day} Jam ${hour}`, 'error');
            return;
        }
        
        try {
            await db.collection('users').doc(currentUser.uid).collection('schedules').doc(id).set({
                day, hour, subject, className, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal(document.querySelector('.modal-overlay button'));
            showToast('Jadwal berhasil disimpan!', 'success');
            loadScheduleData();
        } catch (error) {
            console.error('Error saving schedule:', error);
            showToast('Gagal menyimpan jadwal', 'error');
        }
    }

    function editSchedule(id) {
        const entry = scheduleData.find(s => s.id === id);
        if (!entry) return;
        addScheduleAt(entry.day, entry.hour);
        setTimeout(() => {
            document.getElementById('scheduleId').value = entry.id;
            document.getElementById('scheduleSubject').value = entry.subject;
            document.getElementById('scheduleClass').value = entry.className;
            document.getElementById('deleteScheduleBtn').classList.remove('hidden');
            document.getElementById('deleteScheduleBtn').onclick = () => deleteScheduleById(id);
        }, 100);
    }

    async function deleteScheduleById(id) {
        if (!confirm('Yakin ingin menghapus jadwal ini?')) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('schedules').doc(id).delete();
            closeModal(document.querySelector('.modal-overlay button'));
            showToast('Jadwal berhasil dihapus', 'success');
            loadScheduleData();
        } catch (error) {
            console.error('Error deleting schedule:', error);
            showToast('Gagal menghapus jadwal', 'error');
        }
    }

    // Students
    let studentsData = [];

    function renderStudents() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ‘¨â€ğŸ“ Data Siswa</h1>
                    <div class="flex gap-3">
                        <button onclick="importStudentsCSV()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50">ğŸ“¥ Import CSV</button>
                        <button onclick="addStudent()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">â• Tambah Siswa</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <input type="text" id="studentSearch" placeholder="Cari nama atau NISN..." onkeyup="filterStudents()" class="flex-1 min-w-[200px] px-4 py-2 border border-gray-200 rounded-xl">
                    <select id="studentClassFilter" onchange="filterStudents()" class="px-4 py-2 border border-gray-200 rounded-xl">
                        <option value="">Semua Kelas</option>
                    </select>
                </div>
                <div class="bg-white rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">NISN</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">L/P</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kelas</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody"><tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Memuat data...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        loadStudentsData();
    }

    async function loadStudentsData() {
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('students').orderBy('name').get();
            studentsData = [];
            const classes = new Set();
            snapshot.forEach(doc => {
                const data = { id: doc.id, ...doc.data() };
                studentsData.push(data);
                classes.add(`${data.kelas}${data.rombel || ''}`);
            });
            renderStudentsTable(studentsData);
            updateClassFilter(classes);
        } catch (error) {
            console.error('Error loading students:', error);
        }
    }

    function renderStudentsTable(students) {
        const tbody = document.getElementById('studentsTableBody');
        if (students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Belum ada data siswa.</td></tr>';
            return;
        }
        tbody.innerHTML = students.map((s, i) => `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="px-4 py-3 text-sm">${i + 1}</td>
                <td class="px-4 py-3 text-sm">${s.nisn || '-'}</td>
                <td class="px-4 py-3 text-sm font-medium">${s.name}</td>
                <td class="px-4 py-3 text-center"><span class="px-2 py-1 text-xs font-medium rounded-full ${s.gender === 'L' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'}">${s.gender}</span></td>
                <td class="px-4 py-3 text-center text-sm">${s.kelas}${s.rombel || ''}</td>
                <td class="px-4 py-3 text-center">
                    <button onclick="editStudent('${s.id}')" class="p-1 text-primary-600 hover:bg-primary-50 rounded">âœï¸</button>
                    <button onclick="deleteStudent('${s.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded">ğŸ—‘ï¸</button>
                </td>
            </tr>
        `).join('');
    }

    function updateClassFilter(classes) {
        const select = document.getElementById('studentClassFilter');
        select.innerHTML = '<option value="">Semua Kelas</option>' + Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function filterStudents() {
        const search = document.getElementById('studentSearch').value.toLowerCase();
        const classFilter = document.getElementById('studentClassFilter').value;
        const filtered = studentsData.filter(s => {
            const matchSearch = s.name.toLowerCase().includes(search) || (s.nisn && s.nisn.includes(search));
            const matchClass = !classFilter || `${s.kelas}${s.rombel || ''}` === classFilter;
            return matchSearch && matchClass;
        });
        renderStudentsTable(filtered);
    }

    function addStudent() {
        const content = `
            <form id="studentForm" class="space-y-4">
                <input type="hidden" id="studentId" value="">
                <div><label class="block text-sm font-medium text-gray-700 mb-2">NISN</label><input type="text" id="studentNISN" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label><input type="text" id="studentName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">L/P</label><select id="studentGender" class="w-full px-4 py-3 border border-gray-200 rounded-xl"><option value="L">L</option><option value="P">P</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><input type="text" id="studentKelas" placeholder="1-6" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Rombel</label><input type="text" id="studentRombel" placeholder="A/B" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                </div>
                <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Simpan</button>
            </form>
        `;
        showModal(content, { title: 'ğŸ‘¨â€ğŸ“ Tambah Siswa', size: 'md' });
        document.getElementById('studentForm').addEventListener('submit', saveStudent);
    }

    async function saveStudent(e) {
        e.preventDefault();
        const id = document.getElementById('studentId').value || db.collection('temp').doc().id;
        const data = {
            nisn: document.getElementById('studentNISN').value,
            name: document.getElementById('studentName').value,
            gender: document.getElementById('studentGender').value,
            kelas: document.getElementById('studentKelas').value,
            rombel: document.getElementById('studentRombel').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection('users').doc(currentUser.uid).collection('students').doc(id).set(data, { merge: true });
            closeModal(document.querySelector('.modal-overlay button'));
            showToast('Data siswa berhasil disimpan!', 'success');
            loadStudentsData();
        } catch (error) {
            console.error('Error saving student:', error);
            showToast('Gagal menyimpan data siswa', 'error');
        }
    }

    function editStudent(id) {
        const s = studentsData.find(x => x.id === id);
        if (!s) return;
        addStudent();
        setTimeout(() => {
            document.getElementById('studentId').value = s.id;
            document.getElementById('studentNISN').value = s.nisn || '';
            document.getElementById('studentName').value = s.name;
            document.getElementById('studentGender').value = s.gender;
            document.getElementById('studentKelas').value = s.kelas;
            document.getElementById('studentRombel').value = s.rombel || '';
        }, 100);
    }

    async function deleteStudent(id) {
        if (!confirm('Yakin ingin menghapus data siswa ini?')) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('students').doc(id).delete();
            showToast('Data siswa berhasil dihapus', 'success');
            loadStudentsData();
        } catch (error) {
            console.error('Error deleting student:', error);
            showToast('Gagal menghapus data siswa', 'error');
        }
    }

    function importStudentsCSV() {
        const content = `
            <div class="space-y-4">
                <p class="text-gray-600">Import data siswa dari Google Spreadsheet yang sudah dipublikasi sebagai CSV.</p>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">URL Google Spreadsheet (CSV)</label><input type="url" id="studentsCsvUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <h4 class="font-medium text-blue-800 mb-2">Format Kolom CSV:</h4>
                    <code class="text-sm text-blue-600">nisn,nama,jenis_kelamin,kelas,rombel</code>
                    <p class="text-xs text-blue-600 mt-1">Contoh: 1234567890,Ahmad Fauzi,L,4,A</p>
                </div>
                <button onclick="processStudentsCSV()" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Import Data</button>
            </div>
        `;
        showModal(content, { title: 'ğŸ“¥ Import Data Siswa', size: 'lg' });
    }

    async function processStudentsCSV() {
        const url = document.getElementById('studentsCsvUrl').value;
        if (!url) { showToast('Masukkan URL', 'warning'); return; }
        try {
            showToast('Mengambil data...', 'info');
            const response = await fetch(url);
            const csvText = await response.text();
            const lines = csvText.split('\n').filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const batch = db.batch();
            let count = 0;
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const student = {};
                headers.forEach((h, idx) => {
                    if (h === 'nisn') student.nisn = values[idx];
                    else if (h === 'nama' || h === 'name') student.name = values[idx];
                    else if (h === 'jenis_kelamin' || h === 'gender') student.gender = values[idx]?.toUpperCase();
                    else if (h === 'kelas') student.kelas = values[idx];
                    else if (h === 'rombel') student.rombel = values[idx];
                });
                if (student.name) {
                    const ref = db.collection('users').doc(currentUser.uid).collection('students').doc();
                    student.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    batch.set(ref, student);
                    count++;
                }
            }
            await batch.commit();
            closeModal(document.querySelector('.modal-overlay button'));
            showToast(`${count} siswa berhasil diimport!`, 'success');
            loadStudentsData();
        } catch (error) {
            console.error('Error importing:', error);
            showToast('Gagal mengimport data', 'error');
        }
    }

    // CP (Capaian Pembelajaran)
    let cpData = [];

    function renderCP() {
        const content = document.getElementById('contentArea');
        const isPAI = userProfile?.subjects?.some(s => s.name.toLowerCase().includes('pai')) || true;
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ¯ Capaian Pembelajaran</h1>
                    <div class="flex gap-3">
                        ${isPAI ? `<button onclick="loadDefaultPAI()" class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">ğŸ“š Muat CP PAI Default</button>` : ''}
                        <button onclick="addCP()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">â• Tambah CP</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="cpClassFilter" onchange="filterCPList()" class="px-4 py-2 border border-gray-200 rounded-xl">
                        <option value="">Semua Kelas</option>
                        ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                    </select>
                    <select id="cpSemesterFilter" onchange="filterCPList()" class="px-4 py-2 border border-gray-200 rounded-xl">
                        <option value="">Semua Semester</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                    </select>
                </div>
                <div id="cpList" class="space-y-4"><div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div></div>
            </div>
        `;
        loadCPData();
    }

    async function loadCPData() {
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('cp').orderBy('kelas').orderBy('semester').get();
            cpData = [];
            snapshot.forEach(doc => cpData.push({ id: doc.id, ...doc.data() }));
            renderCPList(cpData);
        } catch (error) {
            console.error('Error loading CP:', error);
        }
    }

    function renderCPList(data) {
        const container = document.getElementById('cpList');
        if (data.length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-2xl p-8 text-center">
                    <div class="text-6xl mb-4">ğŸ“š</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Belum Ada Data CP</h3>
                    <p class="text-gray-500 mb-4">Tambahkan Capaian Pembelajaran untuk mulai membuat ATP, Prota, dan Promes.</p>
                </div>
            `;
            return;
        }
        const grouped = {};
        data.forEach(cp => {
            const key = `Kelas ${cp.kelas} - Semester ${cp.semester}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(cp);
        });
        container.innerHTML = Object.entries(grouped).map(([key, cps]) => `
            <div class="bg-white rounded-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-primary-500 to-purple-500 px-6 py-4 text-white">
                    <h3 class="font-bold">${key}</h3>
                    <p class="text-sm text-purple-100">${cps.length} Capaian Pembelajaran</p>
                </div>
                <div class="p-4 space-y-3">
                    ${cps.map((cp, i) => `
                        <div class="border border-gray-200 rounded-xl p-4 hover:border-primary-300">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 text-xs font-medium bg-primary-100 text-primary-700 rounded">${cp.elemen || 'Umum'}</span>
                                        <span class="text-xs text-gray-500">Bab ${cp.bab || i + 1}</span>
                                    </div>
                                    <h4 class="font-medium text-gray-800 mb-2">${cp.judul || 'Tanpa Judul'}</h4>
                                    <p class="text-sm text-gray-600 line-clamp-2">${cp.tujuan || ''}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editCPItem('${cp.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg">âœï¸</button>
                                    <button onclick="deleteCPItem('${cp.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function filterCPList() {
        const kelas = document.getElementById('cpClassFilter').value;
        const semester = document.getElementById('cpSemesterFilter').value;
        const filtered = cpData.filter(cp => (!kelas || cp.kelas === kelas) && (!semester || cp.semester === semester));
        renderCPList(filtered);
    }

    function addCP() {
        const content = `
            <form id="cpForm" class="space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="cpId" value="">
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="cpKelas" class="w-full px-4 py-3 border border-gray-200 rounded-xl">${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label><select id="cpSemester" class="w-full px-4 py-3 border border-gray-200 rounded-xl"><option value="1">Semester 1</option><option value="2">Semester 2</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Bab</label><input type="number" id="cpBab" min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Elemen</label><select id="cpElemen" class="w-full px-4 py-3 border border-gray-200 rounded-xl"><option value="">Pilih Elemen</option><option>Al-Qur'an dan Hadis</option><option>Akidah</option><option>Akhlak</option><option>Fikih</option><option>Sejarah Peradaban Islam</option></select></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul/Topik *</label><input type="text" id="cpJudul" required class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran</label><textarea id="cpTujuan" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">TP (Tujuan Pembelajaran - pisah dengan baris baru)</label><textarea id="cpTP" rows="4" placeholder="TP 1: Peserta didik dapat...&#10;TP 2: Peserta didik mampu..." class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Pertemuan</label><input type="number" id="cpPertemuan" min="1" value="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Simpan CP</button>
            </form>
        `;
        showModal(content, { title: 'ğŸ¯ Tambah Capaian Pembelajaran', size: 'xl' });
        document.getElementById('cpForm').addEventListener('submit', saveCPItem);
    }

    async function saveCPItem(e) {
        e.preventDefault();
        const id = document.getElementById('cpId').value || db.collection('temp').doc().id;
        const tpText = document.getElementById('cpTP').value;
        const tpArray = tpText.split('\n').filter(t => t.trim()).map(t => t.replace(/^TP \d+:\s*/i, '').trim());
        const data = {
            kelas: document.getElementById('cpKelas').value,
            semester: document.getElementById('cpSemester').value,
            bab: document.getElementById('cpBab').value,
            elemen: document.getElementById('cpElemen').value,
            judul: document.getElementById('cpJudul').value,
            tujuan: document.getElementById('cpTujuan').value,
            tp: tpArray,
            pertemuan: parseInt(document.getElementById('cpPertemuan').value) || 2,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection('users').doc(currentUser.uid).collection('cp').doc(id).set(data, { merge: true });
            closeModal(document.querySelector('.modal-overlay button'));
            showToast('CP berhasil disimpan!', 'success');
            loadCPData();
        } catch (error) {
            console.error('Error saving CP:', error);
            showToast('Gagal menyimpan CP', 'error');
        }
    }

    function editCPItem(id) {
        const cp = cpData.find(c => c.id === id);
        if (!cp) return;
        addCP();
        setTimeout(() => {
            document.getElementById('cpId').value = cp.id;
            document.getElementById('cpKelas').value = cp.kelas;
            document.getElementById('cpSemester').value = cp.semester;
            document.getElementById('cpBab').value = cp.bab || '';
            document.getElementById('cpElemen').value = cp.elemen || '';
            document.getElementById('cpJudul').value = cp.judul || '';
            document.getElementById('cpTujuan').value = cp.tujuan || '';
            document.getElementById('cpTP').value = (cp.tp || []).map((t, i) => `TP ${i + 1}: ${t}`).join('\n');
            document.getElementById('cpPertemuan').value = cp.pertemuan || 2;
        }, 100);
    }

    async function deleteCPItem(id) {
        if (!confirm('Yakin ingin menghapus CP ini?')) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('cp').doc(id).delete();
            showToast('CP berhasil dihapus', 'success');
            loadCPData();
        } catch (error) {
            console.error('Error deleting CP:', error);
            showToast('Gagal menghapus CP', 'error');
        }
    }

    function loadDefaultPAI() {
        const content = `
            <div class="space-y-4">
                <p class="text-gray-600">Pilih kelas untuk memuat CP PAI default:</p>
                <div class="grid grid-cols-3 gap-3">
                    ${[1,2,3,4,5,6].map(k => `<button onclick="importPAIClass(${k})" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 hover:border-primary-300 border-2 border-transparent text-center"><div class="text-2xl mb-1">ğŸ“š</div><div class="font-medium">Kelas ${k}</div></button>`).join('')}
                </div>
                <button onclick="importPAIAll()" class="w-full py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">ğŸ“¦ Import Semua Kelas (1-6)</button>
            </div>
        `;
        showModal(content, { title: 'ğŸ“š Muat CP PAI Default', size: 'lg' });
    }

    async function importPAIClass(kelas) {
        const kelasKey = `kelas${kelas}`;
        const data = dataBuku[kelasKey];
        if (!data || (!data.semester1.length && !data.semester2.length)) {
            showToast('Data CP untuk kelas ini belum tersedia', 'warning');
            return;
        }
        showToast(`Mengimport CP Kelas ${kelas}...`, 'info');
        const batch = db.batch();
        let count = 0;
        const processData = (items, semester) => {
            items.forEach(bab => {
                const ref = db.collection('users').doc(currentUser.uid).collection('cp').doc();
                batch.set(ref, {
                    kelas: String(kelas),
                    semester: String(semester),
                    elemen: bab.elemen,
                    bab: bab.bab,
                    judul: bab.judul,
                    tujuan: bab.tujuan,
                    tp: bab.materi.map(m => m.sub),
                    materi: bab.materi,
                    aktivitas: bab.aktivitas,
                    refleksi: bab.refleksi,
                    karakter: bab.karakter,
                    pertemuan: 2,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                count++;
            });
        };
        processData(data.semester1, 1);
        processData(data.semester2, 2);
        try {
            await batch.commit();
            showToast(`${count} CP berhasil diimport untuk Kelas ${kelas}!`, 'success');
            loadCPData();
        } catch (error) {
            console.error('Error importing CP:', error);
            showToast('Gagal mengimport CP', 'error');
        }
    }

    async function importPAIAll() {
        for (let k = 1; k <= 6; k++) {
            await importPAIClass(k);
        }
        closeModal(document.querySelector('.modal-overlay button'));
    }

    // ATP
    function renderATP() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“‹ Alur Tujuan Pembelajaran (ATP)</h1>
                    <button onclick="printDocument('atpPrintArea')" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">ğŸ–¨ï¸ Cetak</button>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="atpClassFilter" onchange="loadATPPreview()" class="px-4 py-2 border border-gray-200 rounded-xl">
                        <option value="">Pilih Kelas</option>
                        ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                    </select>
                    <select id="atpSemesterFilter" onchange="loadATPPreview()" class="px-4 py-2 border border-gray-200 rounded-xl">
                        <option value="">Pilih Semester</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                    </select>
                </div>
                <div id="atpContent" class="bg-white rounded-2xl p-6">
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-5xl mb-4">ğŸ“‹</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Pilih Kelas dan Semester</h3>
                        <p>Pilih kelas dan semester untuk melihat ATP</p>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadATPPreview() {
        const kelas = document.getElementById('atpClassFilter').value;
        const semester = document.getElementById('atpSemesterFilter').value;
        if (!kelas || !semester) return;
        const container = document.getElementById('atpContent');
        container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('cp')
                .where('kelas', '==', kelas).where('semester', '==', semester).orderBy('bab').get();
            const cpList = [];
            snapshot.forEach(doc => cpList.push(doc.data()));
            if (cpList.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">Belum ada data CP untuk kelas dan semester ini.</div>';
                return;
            }
            const school = userProfile?.school || {};
            container.innerHTML = `
                <div id="atpPrintArea">
                    <div class="text-center mb-8 border-b-2 border-gray-800 pb-4">
                        <h2 class="text-lg font-bold">ALUR TUJUAN PEMBELAJARAN (ATP)</h2>
                        <p class="text-sm">Tahun Pelajaran ${getAcademicYears()[0]}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                        <div><table><tr><td class="py-1 w-32">Satuan Pendidikan</td><td>: ${school.name || '-'}</td></tr><tr><td>Mata Pelajaran</td><td>: PAI dan Budi Pekerti</td></tr><tr><td>Fase</td><td>: ${kelas <= 2 ? 'A' : kelas <= 4 ? 'B' : 'C'}</td></tr></table></div>
                        <div><table><tr><td class="py-1 w-32">Kelas</td><td>: ${kelas}</td></tr><tr><td>Semester</td><td>: ${semester}</td></tr></table></div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-400 text-sm">
                            <thead><tr class="bg-gray-100"><th class="border border-gray-400 px-3 py-2 w-12">No</th><th class="border border-gray-400 px-3 py-2">Elemen</th><th class="border border-gray-400 px-3 py-2 w-16">Bab</th><th class="border border-gray-400 px-3 py-2">Capaian Pembelajaran</th><th class="border border-gray-400 px-3 py-2">Tujuan Pembelajaran</th><th class="border border-gray-400 px-3 py-2 w-16">JP</th></tr></thead>
                            <tbody>
                                ${cpList.map((cp, i) => `<tr><td class="border border-gray-400 px-3 py-2 text-center">${i + 1}</td><td class="border border-gray-400 px-3 py-2">${cp.elemen || '-'}</td><td class="border border-gray-400 px-3 py-2 text-center">${cp.bab || i + 1}</td><td class="border border-gray-400 px-3 py-2"><strong>${cp.judul}</strong><br><span class="text-gray-600">${cp.tujuan || ''}</span></td><td class="border border-gray-400 px-3 py-2"><ol class="list-decimal ml-4">${(cp.tp || []).map(t => `<li>${t}</li>`).join('')}</ol></td><td class="border border-gray-400 px-3 py-2 text-center">${(cp.pertemuan || 2) * 2}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-12 flex justify-between text-sm">
                        <div class="text-center"><p>Mengetahui,</p><p>Kepala ${school.name || 'Sekolah'}</p><br><br><br><p class="font-bold border-b border-black inline-block">${school.principalName || '...........................'}</p><p>NIP. ........................</p></div>
                        <div class="text-center"><p>${school.location || '...............'}, ..................</p><p>Guru Mata Pelajaran</p><br><br><br><p class="font-bold border-b border-black inline-block">${userProfile?.name || ''}</p><p>NIP. ${userProfile?.nip || '........................'}</p></div>
                    </div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading ATP:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data</div>';
        }
    }

    // Prota
    function renderProta() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“† Program Tahunan (Prota)</h1>
                    <button onclick="printDocument('protaPrintArea')" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">ğŸ–¨ï¸ Cetak</button>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6">
                    <select id="protaClassFilter" onchange="loadProtaPreview()" class="px-4 py-2 border border-gray-200 rounded-xl">
                        <option value="">Pilih Kelas</option>
                        ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                    </select>
                </div>
                <div id="protaContent" class="bg-white rounded-2xl p-6">
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-5xl mb-4">ğŸ“†</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Pilih Kelas</h3>
                        <p>Pilih kelas untuk melihat Prota</p>
                    </div>
                </div>
            </div>
        `;
    }

    async function loadProtaPreview() {
        const kelas = document.getElementById('protaClassFilter').value;
        if (!kelas) return;
        const container = document.getElementById('protaContent');
        container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
        try {
            const [sem1Snap, sem2Snap] = await Promise.all([
                db.collection('users').doc(currentUser.uid).collection('cp').where('kelas', '==', kelas).where('semester', '==', '1').orderBy('bab').get(),
                db.collection('users').doc(currentUser.uid).collection('cp').where('kelas', '==', kelas).where('semester', '==', '2').orderBy('bab').get()
            ]);
            const sem1 = [], sem2 = [];
            sem1Snap.forEach(doc => sem1.push(doc.data()));
            sem2Snap.forEach(doc => sem2.push(doc.data()));
            const school = userProfile?.school || {};
            container.innerHTML = `
                <div id="protaPrintArea">
                    <div class="text-center mb-8 border-b-2 border-gray-800 pb-4"><h2 class="text-lg font-bold">PROGRAM TAHUNAN (PROTA)</h2><p class="text-sm">Tahun Pelajaran ${getAcademicYears()[0]}</p></div>
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm"><div><table><tr><td class="py-1 w-32">Satuan Pendidikan</td><td>: ${school.name || '-'}</td></tr><tr><td>Mata Pelajaran</td><td>: PAI dan Budi Pekerti</td></tr></table></div><div><table><tr><td class="py-1 w-32">Kelas</td><td>: ${kelas}</td></tr></table></div></div>
                    <h3 class="font-bold text-lg mb-3">SEMESTER 1 (Ganjil)</h3>
                    <table class="w-full border-collapse border border-gray-400 text-sm mb-8"><thead><tr class="bg-gray-100"><th class="border border-gray-400 px-3 py-2 w-12">No</th><th class="border border-gray-400 px-3 py-2">Bab/Materi</th><th class="border border-gray-400 px-3 py-2 w-16">JP</th><th class="border border-gray-400 px-3 py-2">Keterangan</th></tr></thead><tbody>${sem1.map((cp, i) => `<tr><td class="border border-gray-400 px-3 py-2 text-center">${i + 1}</td><td class="border border-gray-400 px-3 py-2"><strong>Bab ${cp.bab || i + 1}:</strong> ${cp.judul}</td><td class="border border-gray-400 px-3 py-2 text-center">${(cp.pertemuan || 2) * 2}</td><td class="border border-gray-400 px-3 py-2">${cp.elemen || ''}</td></tr>`).join('')}<tr class="bg-gray-50 font-bold"><td colspan="2" class="border border-gray-400 px-3 py-2 text-right">Total JP Semester 1</td><td class="border border-gray-400 px-3 py-2 text-center">${sem1.reduce((s, c) => s + ((c.pertemuan || 2) * 2), 0)}</td><td class="border border-gray-400 px-3 py-2"></td></tr></tbody></table>
                    <h3 class="font-bold text-lg mb-3">SEMESTER 2 (Genap)</h3>
                    <table class="w-full border-collapse border border-gray-400 text-sm"><thead><tr class="bg-gray-100"><th class="border border-gray-400 px-3 py-2 w-12">No</th><th class="border border-gray-400 px-3 py-2">Bab/Materi</th><th class="border border-gray-400 px-3 py-2 w-16">JP</th><th class="border border-gray-400 px-3 py-2">Keterangan</th></tr></thead><tbody>${sem2.map((cp, i) => `<tr><td class="border border-gray-400 px-3 py-2 text-center">${i + 1}</td><td class="border border-gray-400 px-3 py-2"><strong>Bab ${cp.bab || i + 1}:</strong> ${cp.judul}</td><td class="border border-gray-400 px-3 py-2 text-center">${(cp.pertemuan || 2) * 2}</td><td class="border border-gray-400 px-3 py-2">${cp.elemen || ''}</td></tr>`).join('')}<tr class="bg-gray-50 font-bold"><td colspan="2" class="border border-gray-400 px-3 py-2 text-right">Total JP Semester 2</td><td class="border border-gray-400 px-3 py-2 text-center">${sem2.reduce((s, c) => s + ((c.pertemuan || 2) * 2), 0)}</td><td class="border border-gray-400 px-3 py-2"></td></tr></tbody></table>
                    <div class="mt-12 flex justify-between text-sm"><div class="text-center"><p>Mengetahui,</p><p>Kepala ${school.name || 'Sekolah'}</p><br><br><br><p class="font-bold border-b border-black inline-block">${school.principalName || '...........................'}</p><p>NIP. ........................</p></div><div class="text-center"><p>${school.location || '...............'}, ..................</p><p>Guru Mata Pelajaran</p><br><br><br><p class="font-bold border-b border-black inline-block">${userProfile?.name || ''}</p><p>NIP. ${userProfile?.nip || '........................'}</p></div></div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading Prota:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data</div>';
        }
    }

    // Promes
    function renderPromes() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“‘ Program Semester (Promes)</h1>
                    <button onclick="printDocument('promesPrintArea')" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">ğŸ–¨ï¸ Cetak</button>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="promesClassFilter" onchange="loadPromesPreview()" class="px-4 py-2 border border-gray-200 rounded-xl"><option value="">Pilih Kelas</option>${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}</select>
                    <select id="promesSemesterFilter" onchange="loadPromesPreview()" class="px-4 py-2 border border-gray-200 rounded-xl"><option value="">Pilih Semester</option><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                </div>
                <div id="promesContent" class="bg-white rounded-2xl p-6">
                    <div class="text-center py-12 text-gray-500"><div class="text-5xl mb-4">ğŸ“‘</div><h3 class="text-xl font-bold text-gray-800 mb-2">Pilih Kelas dan Semester</h3><p>Pilih kelas dan semester untuk melihat Promes</p></div>
                </div>
            </div>
        `;
    }

    async function loadPromesPreview() {
        const kelas = document.getElementById('promesClassFilter').value;
        const semester = document.getElementById('promesSemesterFilter').value;
        if (!kelas || !semester) return;
        const container = document.getElementById('promesContent');
        container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('cp').where('kelas', '==', kelas).where('semester', '==', semester).orderBy('bab').get();
            const cpList = [];
            snapshot.forEach(doc => cpList.push(doc.data()));
            const school = userProfile?.school || {};
            const months = semester === '1' ? ['Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'] : ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'];
            container.innerHTML = `
                <div id="promesPrintArea">
                    <div class="text-center mb-8 border-b-2 border-gray-800 pb-4"><h2 class="text-lg font-bold">PROGRAM SEMESTER (PROMES)</h2><p class="text-sm">Tahun Pelajaran ${getAcademicYears()[0]} - Semester ${semester}</p></div>
                    <div class="grid grid-cols-2 gap-4 mb-6 text-sm"><div><table><tr><td class="py-1 w-32">Satuan Pendidikan</td><td>: ${school.name || '-'}</td></tr><tr><td>Mata Pelajaran</td><td>: PAI dan Budi Pekerti</td></tr><tr><td>Kelas</td><td>: ${kelas}</td></tr></table></div><div><table><tr><td class="py-1 w-32">Semester</td><td>: ${semester}</td></tr></table></div></div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-400 text-xs">
                            <thead><tr class="bg-gray-100"><th class="border border-gray-400 px-2 py-2 w-10" rowspan="2">No</th><th class="border border-gray-400 px-2 py-2" rowspan="2">Materi/Bab</th><th class="border border-gray-400 px-2 py-2 w-12" rowspan="2">JP</th><th class="border border-gray-400 px-2 py-2" colspan="${months.length}">Bulan</th><th class="border border-gray-400 px-2 py-2" rowspan="2">Ket</th></tr><tr class="bg-gray-100">${months.map(m => `<th class="border border-gray-400 px-2 py-2 w-12">${m}</th>`).join('')}</tr></thead>
                            <tbody>${cpList.map((cp, i) => `<tr><td class="border border-gray-400 px-2 py-2 text-center">${i + 1}</td><td class="border border-gray-400 px-2 py-2"><strong>Bab ${cp.bab || i + 1}</strong><br>${cp.judul}</td><td class="border border-gray-400 px-2 py-2 text-center">${(cp.pertemuan || 2) * 2}</td>${months.map((m, mi) => `<td class="border border-gray-400 px-2 py-2 text-center">${mi === i % months.length ? 'âœ“' : ''}</td>`).join('')}<td class="border border-gray-400 px-2 py-2">${cp.elemen || ''}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                    <div class="mt-12 flex justify-between text-sm"><div class="text-center"><p>Mengetahui,</p><p>Kepala ${school.name || 'Sekolah'}</p><br><br><br><p class="font-bold border-b border-black inline-block">${school.principalName || '...........................'}</p><p>NIP. ........................</p></div><div class="text-center"><p>${school.location || '...............'}, ..................</p><p>Guru Mata Pelajaran</p><br><br><br><p class="font-bold border-b border-black inline-block">${userProfile?.name || ''}</p><p>NIP. ${userProfile?.nip || '........................'}</p></div></div>
                </div>
            `;
        } catch (error) {
            console.error('Error loading Promes:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data</div>';
        }
    }

      // Journal (continued)
    function renderJournal() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ““ Jurnal Pembelajaran</h1>
                    <div class="flex gap-3">
                        <button onclick="addJournal()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">â• Tambah Jurnal</button>
                        <button onclick="printDocument('journalPrintArea')" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50">ğŸ–¨ï¸ Cetak</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="journalClassFilter" onchange="loadJournalData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                        <option value="">Semua Kelas</option>
                        ${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}
                    </select>
                    <input type="month" id="journalMonthFilter" onchange="loadJournalData()" class="px-4 py-2 border border-gray-200 rounded-xl">
                </div>
                <div id="journalContent" class="bg-white rounded-2xl overflow-hidden">
                    <div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>
                </div>
            </div>
        `;
        loadJournalData();
    }

    let journalData = [];

    async function loadJournalData() {
        const container = document.getElementById('journalContent');
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('journals').orderBy('date', 'desc').limit(50).get();
            journalData = [];
            snapshot.forEach(doc => journalData.push({ id: doc.id, ...doc.data() }));
            
            if (journalData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-5xl mb-4">ğŸ““</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Belum Ada Jurnal</h3>
                        <p class="text-gray-500 mb-4">Mulai tambahkan jurnal pembelajaran</p>
                        <button onclick="addJournal()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium">+ Tambah Jurnal</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="overflow-x-auto" id="journalPrintArea">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kelas</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Materi</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tujuan Pembelajaran</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Kehadiran</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tanggal</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 no-print">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${journalData.map((j, i) => `
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="px-4 py-3 text-sm">${i + 1}</td>
                                    <td class="px-4 py-3 text-sm">${j.kelas || ''}${j.rombel || ''}</td>
                                    <td class="px-4 py-3 text-sm">${j.materi || '-'}</td>
                                    <td class="px-4 py-3 text-sm max-w-xs truncate">${j.tp || '-'}</td>
                                    <td class="px-4 py-3 text-center text-sm">
                                        <span class="text-green-600">H:${j.hadir || 0}</span>
                                        <span class="text-amber-600 ml-1">S:${j.sakit || 0}</span>
                                        <span class="text-blue-600 ml-1">I:${j.izin || 0}</span>
                                        <span class="text-red-600 ml-1">A:${j.alpa || 0}</span>
                                    </td>
                                    <td class="px-4 py-3 text-sm">${j.date || '-'}</td>
                                    <td class="px-4 py-3 text-center no-print">
                                        <button onclick="editJournal('${j.id}')" class="p-1 text-primary-600 hover:bg-primary-50 rounded">âœï¸</button>
                                        <button onclick="deleteJournal('${j.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (error) {
            console.error('Error loading journals:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data jurnal</div>';
        }
    }

    function addJournal() {
        const content = `
            <form id="journalForm" class="space-y-4">
                <input type="hidden" id="journalId" value="">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas *</label><input type="text" id="journalKelas" required placeholder="Contoh: 4A" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal *</label><input type="date" id="journalDate" required value="${new Date().toISOString().split('T')[0]}" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Materi *</label><input type="text" id="journalMateri" required class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran</label><textarea id="journalTP" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div class="grid grid-cols-4 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Hadir</label><input type="number" id="journalHadir" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Sakit</label><input type="number" id="journalSakit" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Izin</label><input type="number" id="journalIzin" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Alpa</label><input type="number" id="journalAlpa" min="0" value="0" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Hasil Pembelajaran</label><textarea id="journalHasil" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Simpan Jurnal</button>
            </form>
        `;
        showModal(content, { title: 'ğŸ““ Tambah Jurnal', size: 'xl' });
        document.getElementById('journalForm').addEventListener('submit', saveJournal);
    }

    async function saveJournal(e) {
        e.preventDefault();
        const id = document.getElementById('journalId').value || db.collection('temp').doc().id;
        const kelasVal = document.getElementById('journalKelas').value;
        const data = {
            kelas: kelasVal.replace(/[A-Za-z]/g, ''),
            rombel: kelasVal.replace(/[0-9]/g, ''),
            date: document.getElementById('journalDate').value,
            materi: document.getElementById('journalMateri').value,
            tp: document.getElementById('journalTP').value,
            hadir: parseInt(document.getElementById('journalHadir').value) || 0,
            sakit: parseInt(document.getElementById('journalSakit').value) || 0,
            izin: parseInt(document.getElementById('journalIzin').value) || 0,
            alpa: parseInt(document.getElementById('journalAlpa').value) || 0,
            hasil: document.getElementById('journalHasil').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await db.collection('users').doc(currentUser.uid).collection('journals').doc(id).set(data, { merge: true });
            closeModal(document.querySelector('.modal-overlay button'));
            showToast('Jurnal berhasil disimpan!', 'success');
            loadJournalData();
        } catch (error) {
            console.error('Error saving journal:', error);
            showToast('Gagal menyimpan jurnal', 'error');
        }
    }

    function editJournal(id) {
        const j = journalData.find(x => x.id === id);
        if (!j) return;
        addJournal();
        setTimeout(() => {
            document.getElementById('journalId').value = j.id;
            document.getElementById('journalKelas').value = (j.kelas || '') + (j.rombel || '');
            document.getElementById('journalDate').value = j.date || '';
            document.getElementById('journalMateri').value = j.materi || '';
            document.getElementById('journalTP').value = j.tp || '';
            document.getElementById('journalHadir').value = j.hadir || 0;
            document.getElementById('journalSakit').value = j.sakit || 0;
            document.getElementById('journalIzin').value = j.izin || 0;
            document.getElementById('journalAlpa').value = j.alpa || 0;
            document.getElementById('journalHasil').value = j.hasil || '';
        }, 100);
    }

    async function deleteJournal(id) {
        if (!confirm('Yakin ingin menghapus jurnal ini?')) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('journals').doc(id).delete();
            showToast('Jurnal berhasil dihapus', 'success');
            loadJournalData();
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menghapus jurnal', 'error');
        }
    }

    // Attendance
    function renderAttendance() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">âœ… Absensi Siswa</h1>
                    <p class="text-gray-500">Input absensi yang otomatis sinkron dengan Jurnal</p>
                </div>
                <div class="bg-white rounded-2xl p-6 mb-6">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                            <select id="attendanceClass" onchange="loadAttendanceStudents()" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                                <option value="">-- Pilih Kelas --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                            <input type="date" id="attendanceDate" value="${new Date().toISOString().split('T')[0]}" onchange="loadAttendanceStudents()" class="w-full px-4 py-3 border border-gray-200 rounded-xl">
                        </div>
                        <div class="flex items-end">
                            <button onclick="saveAttendance()" class="w-full px-4 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">ğŸ’¾ Simpan Absensi</button>
                        </div>
                    </div>
                </div>
                <div id="attendanceContent" class="bg-white rounded-2xl p-6">
                    <div class="text-center py-8 text-gray-500">Pilih kelas untuk menampilkan daftar siswa</div>
                </div>
            </div>
        `;
        loadAttendanceClasses();
    }

    async function loadAttendanceClasses() {
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('students').get();
            const classes = new Set();
            snapshot.forEach(doc => {
                const d = doc.data();
                classes.add(`${d.kelas}${d.rombel || ''}`);
            });
            const select = document.getElementById('attendanceClass');
            select.innerHTML = '<option value="">-- Pilih Kelas --</option>' + Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function loadAttendanceStudents() {
        const classFilter = document.getElementById('attendanceClass').value;
        const date = document.getElementById('attendanceDate').value;
        const container = document.getElementById('attendanceContent');
        
        if (!classFilter) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Pilih kelas untuk menampilkan daftar siswa</div>';
            return;
        }
        
        container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
        
        try {
            const kelas = classFilter.replace(/[A-Za-z]/g, '');
            const rombel = classFilter.replace(/[0-9]/g, '');
            
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('students')
                .where('kelas', '==', kelas).orderBy('name').get();
            
            const students = [];
            snapshot.forEach(doc => {
                const d = doc.data();
                if (!rombel || d.rombel === rombel) students.push({ id: doc.id, ...d });
            });
            
            // Get existing attendance
            const attDoc = await db.collection('users').doc(currentUser.uid).collection('attendance').doc(`${classFilter}_${date}`).get();
            const existing = attDoc.exists ? attDoc.data().records || {} : {};
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-12">No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama Siswa</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 w-20">L/P</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Hadir</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Sakit</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Izin</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Alpa</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            ${students.map((s, i) => {
                                const status = existing[s.id] || 'H';
                                return `
                                    <tr class="border-b border-gray-100">
                                        <td class="px-4 py-3 text-sm">${i + 1}</td>
                                        <td class="px-4 py-3 text-sm font-medium">${s.name}</td>
                                        <td class="px-4 py-3 text-center text-sm">${s.gender}</td>
                                        <td class="px-4 py-3 text-center"><input type="radio" name="att_${s.id}" value="H" ${status === 'H' ? 'checked' : ''} class="w-5 h-5 text-green-600"></td>
                                        <td class="px-4 py-3 text-center"><input type="radio" name="att_${s.id}" value="S" ${status === 'S' ? 'checked' : ''} class="w-5 h-5 text-amber-600"></td>
                                        <td class="px-4 py-3 text-center"><input type="radio" name="att_${s.id}" value="I" ${status === 'I' ? 'checked' : ''} class="w-5 h-5 text-blue-600"></td>
                                        <td class="px-4 py-3 text-center"><input type="radio" name="att_${s.id}" value="A" ${status === 'A' ? 'checked' : ''} class="w-5 h-5 text-red-600"></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data siswa</div>';
        }
    }

    async function saveAttendance() {
        const classFilter = document.getElementById('attendanceClass').value;
        const date = document.getElementById('attendanceDate').value;
        if (!classFilter) { showToast('Pilih kelas terlebih dahulu', 'warning'); return; }
        
        const records = {};
        const summary = { H: 0, S: 0, I: 0, A: 0 };
        document.querySelectorAll('#attendanceTableBody input[type="radio"]:checked').forEach(input => {
            const studentId = input.name.replace('att_', '');
            records[studentId] = input.value;
            summary[input.value]++;
        });
        
        try {
            await db.collection('users').doc(currentUser.uid).collection('attendance').doc(`${classFilter}_${date}`).set({
                kelas: classFilter, date, records, summary, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showToast('Absensi berhasil disimpan!', 'success');
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menyimpan absensi', 'error');
        }
    }

    // Grades
    function renderGrades() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“Š Daftar Nilai</h1>
                    <button onclick="printDocument('gradesPrintArea')" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">ğŸ–¨ï¸ Cetak</button>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="gradesClass" onchange="loadGradesData()" class="px-4 py-2 border border-gray-200 rounded-xl"><option value="">Pilih Kelas</option></select>
                    <select id="gradesSemester" onchange="loadGradesData()" class="px-4 py-2 border border-gray-200 rounded-xl"><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                </div>
                <div id="gradesContent" class="bg-white rounded-2xl p-6">
                    <div class="text-center py-8 text-gray-500">Pilih kelas untuk menampilkan daftar nilai</div>
                </div>
            </div>
        `;
        loadGradesClasses();
    }

    async function loadGradesClasses() {
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('students').get();
            const classes = new Set();
            snapshot.forEach(doc => {
                const d = doc.data();
                classes.add(`${d.kelas}${d.rombel || ''}`);
            });
            const select = document.getElementById('gradesClass');
            select.innerHTML = '<option value="">Pilih Kelas</option>' + Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function loadGradesData() {
        const classFilter = document.getElementById('gradesClass').value;
        const semester = document.getElementById('gradesSemester').value;
        const container = document.getElementById('gradesContent');
        
        if (!classFilter) {
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Pilih kelas untuk menampilkan daftar nilai</div>';
            return;
        }
        
        container.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>';
        
        try {
            const kelas = classFilter.replace(/[A-Za-z]/g, '');
            const rombel = classFilter.replace(/[0-9]/g, '');
            
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('students')
                .where('kelas', '==', kelas).orderBy('name').get();
            
            const students = [];
            snapshot.forEach(doc => {
                const d = doc.data();
                if (!rombel || d.rombel === rombel) students.push({ id: doc.id, ...d });
            });
            
            const gradesDoc = await db.collection('users').doc(currentUser.uid).collection('grades').doc(`${classFilter}_${semester}`).get();
            const gradesData = gradesDoc.exists ? gradesDoc.data() : { types: ['PH1', 'PH2', 'PTS', 'PAS'], scores: {} };
            const gradeTypes = gradesData.types || ['PH1', 'PH2', 'PTS', 'PAS'];
            
            container.innerHTML = `
                <div class="overflow-x-auto" id="gradesPrintArea">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left font-semibold text-gray-700 w-10">No</th>
                                <th class="px-3 py-2 text-left font-semibold text-gray-700">Nama Siswa</th>
                                ${gradeTypes.map(t => `<th class="px-3 py-2 text-center font-semibold text-gray-700 w-16">${t}</th>`).join('')}
                                <th class="px-3 py-2 text-center font-semibold text-gray-700 w-16 bg-green-50">NR</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${students.map((s, i) => {
                                const scores = gradesData.scores?.[s.id] || {};
                                const values = gradeTypes.map(t => parseFloat(scores[t]) || 0).filter(v => v > 0);
                                const nr = values.length > 0 ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : '-';
                                return `
                                    <tr class="border-b border-gray-100">
                                        <td class="px-3 py-2">${i + 1}</td>
                                        <td class="px-3 py-2 font-medium">${s.name}</td>
                                        ${gradeTypes.map(t => `
                                            <td class="px-3 py-2 text-center">
                                                <input type="number" class="grade-input w-14 px-2 py-1 border border-gray-200 rounded text-center" data-student="${s.id}" data-type="${t}" value="${scores[t] || ''}" min="0" max="100" onchange="updateNR('${s.id}')">
                                            </td>
                                        `).join('')}
                                        <td class="px-3 py-2 text-center bg-green-50"><span id="nr_${s.id}" class="font-bold text-green-600">${nr}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="saveGrades()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">ğŸ’¾ Simpan Nilai</button>
                </div>
            `;
        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data nilai</div>';
        }
    }

    function updateNR(studentId) {
        const inputs = document.querySelectorAll(`input[data-student="${studentId}"]`);
        const values = [];
        inputs.forEach(input => {
            const val = parseFloat(input.value);
            if (val > 0) values.push(val);
        });
        const nrEl = document.getElementById(`nr_${studentId}`);
        nrEl.textContent = values.length > 0 ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : '-';
    }

    async function saveGrades() {
        const classFilter = document.getElementById('gradesClass').value;
        const semester = document.getElementById('gradesSemester').value;
        if (!classFilter) { showToast('Pilih kelas terlebih dahulu', 'warning'); return; }
        
        const scores = {};
        document.querySelectorAll('.grade-input').forEach(input => {
            const studentId = input.dataset.student;
            const type = input.dataset.type;
            const value = parseFloat(input.value) || 0;
            if (!scores[studentId]) scores[studentId] = {};
            scores[studentId][type] = value;
        });
        
        try {
            await db.collection('users').doc(currentUser.uid).collection('grades').doc(`${classFilter}_${semester}`).set({
                kelas: classFilter, semester, types: ['PH1', 'PH2', 'PTS', 'PAS'], scores, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            showToast('Nilai berhasil disimpan!', 'success');
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menyimpan nilai', 'error');
        }
    }

    // Modul Ajar (Premium)
    function renderModul() {
        if (!isPremiumUser()) { showUpgradeModal(); return; }
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“– Modul Ajar</h1>
                    <button onclick="addModul()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">â• Buat Modul</button>
                </div>
                <div id="modulList" class="space-y-4"><div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div></div>
            </div>
        `;
        loadModulData();
    }

    let modulData = [];

    async function loadModulData() {
        const container = document.getElementById('modulList');
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('modules').orderBy('createdAt', 'desc').get();
            modulData = [];
            snapshot.forEach(doc => modulData.push({ id: doc.id, ...doc.data() }));
            
            if (modulData.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 text-center">
                        <div class="text-6xl mb-4">ğŸ“–</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Belum Ada Modul Ajar</h3>
                        <p class="text-gray-500 mb-4">Buat modul ajar pertama Anda</p>
                        <button onclick="addModul()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium">+ Buat Modul</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = modulData.map(m => `
                <div class="bg-white rounded-2xl p-6 card-hover">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 text-xs font-medium bg-primary-100 text-primary-700 rounded">Kelas ${m.kelas}</span>
                                <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded">Semester ${m.semester}</span>
                            </div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">${m.judul}</h3>
                            <p class="text-sm text-gray-600">${m.tp || ''}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewModul('${m.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg">ğŸ‘ï¸</button>
                            <button onclick="editModul('${m.id}')" class="p-2 text-gray-600 hover:bg-gray-50 rounded-lg">âœï¸</button>
                            <button onclick="deleteModul('${m.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data modul</div>';
        }
    }

    function addModul() {
        const content = `
            <form id="modulForm" class="space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="modulId" value="">
                <div class="grid grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="modulKelas" class="w-full px-4 py-3 border border-gray-200 rounded-xl">${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Semester</label><select id="modulSemester" class="w-full px-4 py-3 border border-gray-200 rounded-xl"><option value="1">Semester 1</option><option value="2">Semester 2</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Pertemuan</label><input type="number" id="modulPertemuan" value="1" min="1" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Judul/Topik *</label><input type="text" id="modulJudul" required class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Tujuan Pembelajaran</label><textarea id="modulTP" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan Pendahuluan</label><textarea id="modulPendahuluan" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan Inti</label><textarea id="modulInti" rows="5" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan Penutup</label><textarea id="modulPenutup" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Materi (Support Teks Arab)</label><textarea id="modulMateri" rows="4" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Asesmen</label><textarea id="modulAsesmen" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Simpan Modul</button>
            </form>
        `;
        showModal(content, { title: 'ğŸ“– Buat Modul Ajar', size: '2xl' });
        document.getElementById('modulForm').addEventListener('submit', saveModul);
    }

    async function saveModul(e) {
        e.preventDefault();
        const id = document.getElementById('modulId').value || db.collection('temp').doc().id;
        const data = {
            kelas: document.getElementById('modulKelas').value,
            semester: document.getElementById('modulSemester').value,
            pertemuan: parseInt(document.getElementById('modulPertemuan').value) || 1,
            judul: document.getElementById('modulJudul').value,
            tp: document.getElementById('modulTP').value,
            pendahuluan: document.getElementById('modulPendahuluan').value,
            inti: document.getElementById('modulInti').value,
            penutup: document.getElementById('modulPenutup').value,
            materi: document.getElementById('modulMateri').value,
            asesmen: document.getElementById('modulAsesmen').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (!document.getElementById('modulId').value) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        try {
            await db.collection('users').doc(currentUser.uid).collection('modules').doc(id).set(data, { merge: true });
            closeModal(document.querySelector('.modal-overlay button'));
            showToast('Modul berhasil disimpan!', 'success');
            loadModulData();
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menyimpan modul', 'error');
        }
    }

    function editModul(id) {
        const m = modulData.find(x => x.id === id);
        if (!m) return;
        addModul();
        setTimeout(() => {
            document.getElementById('modulId').value = m.id;
            document.getElementById('modulKelas').value = m.kelas;
            document.getElementById('modulSemester').value = m.semester;
            document.getElementById('modulPertemuan').value = m.pertemuan || 1;
            document.getElementById('modulJudul').value = m.judul || '';
            document.getElementById('modulTP').value = m.tp || '';
            document.getElementById('modulPendahuluan').value = m.pendahuluan || '';
            document.getElementById('modulInti').value = m.inti || '';
            document.getElementById('modulPenutup').value = m.penutup || '';
            document.getElementById('modulMateri').value = m.materi || '';
            document.getElementById('modulAsesmen').value = m.asesmen || '';
        }, 100);
    }

    async function viewModul(id) {
        const m = modulData.find(x => x.id === id);
        if (!m) return;
        const school = userProfile?.school || {};
        const content = `
            <div class="max-h-[70vh] overflow-y-auto" id="modulPrintArea">
                <div class="text-center mb-6 border-b-2 border-gray-800 pb-4"><h2 class="text-lg font-bold">MODUL AJAR</h2><p class="text-sm">${school.name || 'Sekolah'}</p></div>
                <div class="space-y-4 text-sm">
                    <div class="grid grid-cols-2 gap-4"><div><strong>Mata Pelajaran:</strong> PAI dan Budi Pekerti</div><div><strong>Kelas/Semester:</strong> ${m.kelas}/${m.semester}</div><div><strong>Topik:</strong> ${m.judul}</div><div><strong>Pertemuan:</strong> ${m.pertemuan}</div></div>
                    <div><h4 class="font-bold bg-gray-100 px-3 py-2">A. TUJUAN PEMBELAJARAN</h4><div class="px-3 py-2 whitespace-pre-wrap">${m.tp || '-'}</div></div>
                    <div><h4 class="font-bold bg-gray-100 px-3 py-2">B. KEGIATAN PEMBELAJARAN</h4><div class="px-3 py-2"><strong>1. Pendahuluan</strong><div class="whitespace-pre-wrap">${m.pendahuluan || '-'}</div><strong>2. Kegiatan Inti</strong><div class="whitespace-pre-wrap">${m.inti || '-'}</div><strong>3. Penutup</strong><div class="whitespace-pre-wrap">${m.penutup || '-'}</div></div></div>
                    <div><h4 class="font-bold bg-gray-100 px-3 py-2">C. MATERI</h4><div class="px-3 py-2 whitespace-pre-wrap">${formatArabic(m.materi || '-')}</div></div>
                    <div><h4 class="font-bold bg-gray-100 px-3 py-2">D. ASESMEN</h4><div class="px-3 py-2 whitespace-pre-wrap">${m.asesmen || '-'}</div></div>
                </div>
            </div>
            <div class="mt-4"><button onclick="printDocument('modulPrintArea')" class="w-full py-2 bg-primary-600 text-white rounded-xl font-medium">ğŸ–¨ï¸ Cetak</button></div>
        `;
        showModal(content, { title: `ğŸ“– ${m.judul}`, size: '2xl' });
    }

    async function deleteModul(id) {
        if (!confirm('Yakin ingin menghapus modul ini?')) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('modules').doc(id).delete();
            showToast('Modul berhasil dihapus', 'success');
            loadModulData();
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menghapus modul', 'error');
        }
    }

    function formatArabic(text) {
        return text.replace(/([\u0600-\u06FF\u0750-\u077F]+)/g, '<span class="arabic-text">$1</span>');
    }

    // LKPD (Premium)
    function renderLKPD() {
        if (!isPremiumUser()) { showUpgradeModal(); return; }
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“ LKPD (Lembar Kerja Peserta Didik)</h1>
                    <p class="text-gray-500">LKPD terintegrasi dengan Modul Ajar</p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-sm text-blue-700">ğŸ’¡ LKPD dapat dibuat berdasarkan Modul Ajar yang sudah ada. Buka Modul Ajar dan klik tombol "Buat LKPD".</p>
                </div>
                <div class="bg-white rounded-2xl p-8 text-center">
                    <div class="text-6xl mb-4">ğŸ“</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Fitur LKPD</h3>
                    <p class="text-gray-500 mb-4">Buat LKPD dengan bahasa yang mudah dipahami siswa</p>
                    <button onclick="navigateTo('modul')" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium">Buka Modul Ajar â†’</button>
                </div>
            </div>
        `;
    }

    // Bank Soal (Premium)
    function renderBankSoal() {
        if (!isPremiumUser()) { showUpgradeModal(); return; }
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ¦ Bank Soal</h1>
                    <button onclick="addSoal()" class="px-4 py-2 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">â• Tambah Soal</button>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="soalClassFilter" onchange="loadSoalData()" class="px-4 py-2 border border-gray-200 rounded-xl"><option value="">Semua Kelas</option>${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}</select>
                    <select id="soalTypeFilter" onchange="loadSoalData()" class="px-4 py-2 border border-gray-200 rounded-xl"><option value="">Semua Jenis</option><option value="pg">Pilihan Ganda</option><option value="isian">Isian</option><option value="uraian">Uraian</option></select>
                </div>
                <div id="soalList" class="space-y-4"><div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div></div>
            </div>
        `;
        loadSoalData();
    }

    let soalData = [];

    async function loadSoalData() {
        const container = document.getElementById('soalList');
        const classFilter = document.getElementById('soalClassFilter')?.value;
        const typeFilter = document.getElementById('soalTypeFilter')?.value;
        try {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('banksoal').orderBy('createdAt', 'desc').get();
            soalData = [];
            snapshot.forEach(doc => {
                const d = { id: doc.id, ...doc.data() };
                if ((!classFilter || d.kelas === classFilter) && (!typeFilter || d.type === typeFilter)) soalData.push(d);
            });
            
            if (soalData.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 text-center">
                        <div class="text-6xl mb-4">ğŸ¦</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Bank Soal Kosong</h3>
                        <p class="text-gray-500 mb-4">Mulai tambahkan soal-soal</p>
                        <button onclick="addSoal()" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium">+ Tambah Soal</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = soalData.map((s, i) => `
                <div class="bg-white rounded-2xl p-6">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold flex-shrink-0">${i + 1}</div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-700 rounded">Kelas ${s.kelas}</span>
                                <span class="px-2 py-1 text-xs font-medium ${s.type === 'pg' ? 'bg-blue-100 text-blue-700' : s.type === 'isian' ? 'bg-green-100 text-green-700' : 'bg-purple-100 text-purple-700'} rounded">${s.type === 'pg' ? 'PG' : s.type === 'isian' ? 'Isian' : 'Uraian'}</span>
                            </div>
                            <p class="text-gray-800 mb-2">${formatArabic(s.soal)}</p>
                            ${s.type === 'pg' && s.pilihan ? `<div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-2">${s.pilihan.map((p, pi) => `<div class="${s.jawaban === String.fromCharCode(65 + pi) ? 'text-green-600 font-medium' : ''}">${String.fromCharCode(65 + pi)}. ${p}</div>`).join('')}</div>` : ''}
                            <div class="text-sm text-green-600"><strong>Jawaban:</strong> ${s.jawaban || '-'}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editSoal('${s.id}')" class="p-2 text-primary-600 hover:bg-primary-50 rounded-lg">âœï¸</button>
                            <button onclick="deleteSoal('${s.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error:', error);
            container.innerHTML = '<div class="text-center py-8 text-red-500">Gagal memuat data soal</div>';
        }
    }

    function addSoal() {
        const content = `
            <form id="soalForm" class="space-y-4">
                <input type="hidden" id="soalId" value="">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="soalKelas" class="w-full px-4 py-3 border border-gray-200 rounded-xl">${[1,2,3,4,5,6].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Soal</label><select id="soalType" onchange="togglePG()" class="w-full px-4 py-3 border border-gray-200 rounded-xl"><option value="pg">Pilihan Ganda</option><option value="isian">Isian</option><option value="uraian">Uraian</option></select></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan (Support Teks Arab) *</label><textarea id="soalPertanyaan" rows="3" required class="w-full px-4 py-3 border border-gray-200 rounded-xl"></textarea></div>
                <div id="pgSection">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2"><span class="w-8 text-center font-medium">A.</span><input type="text" id="pilihanA" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg"></div>
                        <div class="flex items-center gap-2"><span class="w-8 text-center font-medium">B.</span><input type="text" id="pilihanB" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg"></div>
                        <div class="flex items-center gap-2"><span class="w-8 text-center font-medium">C.</span><input type="text" id="pilihanC" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg"></div>
                        <div class="flex items-center gap-2"><span class="w-8 text-center font-medium">D.</span><input type="text" id="pilihanD" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg"></div>
                    </div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Kunci Jawaban *</label><input type="text" id="soalJawaban" required placeholder="A / B / C / D atau jawaban isian" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl font-medium hover:bg-primary-700">Simpan Soal</button>
            </form>
        `;
        showModal(content, { title: 'â• Tambah Soal', size: 'xl' });
        document.getElementById('soalForm').addEventListener('submit', saveSoal);
    }

    function togglePG() {
        const type = document.getElementById('soalType').value;
        document.getElementById('pgSection').style.display = type === 'pg' ? 'block' : 'none';
    }

    async function saveSoal(e) {
        e.preventDefault();
        const id = document.getElementById('soalId').value || db.collection('temp').doc().id;
        const type = document.getElementById('soalType').value;
        const data = {
            kelas: document.getElementById('soalKelas').value,
            type,
            soal: document.getElementById('soalPertanyaan').value,
            jawaban: document.getElementById('soalJawaban').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (type === 'pg') {
            data.pilihan = [
                document.getElementById('pilihanA').value,
                document.getElementById('pilihanB').value,
                document.getElementById('pilihanC').value,
                document.getElementById('pilihanD').value
            ];
        }
        if (!document.getElementById('soalId').value) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        try {
            await db.collection('users').doc(currentUser.uid).collection('banksoal').doc(id).set(data, { merge: true });
            closeModal(document.querySelector('.modal-overlay button'));
            showToast('Soal berhasil disimpan!', 'success');
            loadSoalData();
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menyimpan soal', 'error');
        }
    }

    function editSoal(id) {
        const s = soalData.find(x => x.id === id);
        if (!s) return;
        addSoal();
        setTimeout(() => {
            document.getElementById('soalId').value = s.id;
            document.getElementById('soalKelas').value = s.kelas;
            document.getElementById('soalType').value = s.type;
            togglePG();
            document.getElementById('soalPertanyaan').value = s.soal || '';
            document.getElementById('soalJawaban').value = s.jawaban || '';
            if (s.pilihan) {
                document.getElementById('pilihanA').value = s.pilihan[0] || '';
                document.getElementById('pilihanB').value = s.pilihan[1] || '';
                document.getElementById('pilihanC').value = s.pilihan[2] || '';
                document.getElementById('pilihanD').value = s.pilihan[3] || '';
            }
        }, 100);
    }

    async function deleteSoal(id) {
        if (!confirm('Yakin ingin menghapus soal ini?')) return;
        try {
            await db.collection('users').doc(currentUser.uid).collection('banksoal').doc(id).delete();
            showToast('Soal berhasil dihapus', 'success');
            loadSoalData();
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menghapus soal', 'error');
        }
    }

    // AI Assistant
    function renderAI() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in max-w-4xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ¤– AI Assistant</h1>
                    <p class="text-gray-500">Dapatkan prompt AI untuk membantu persiapan data</p>
                </div>
                <div class="bg-white rounded-2xl p-6 mb-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“ Template Prompt</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <button onclick="showPrompt('cp')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 border-2 border-transparent hover:border-primary-300 text-left"><div class="text-2xl mb-2">ğŸ¯</div><h3 class="font-bold text-gray-800">Generate TP dari CP</h3><p class="text-sm text-gray-500">Breakdown CP menjadi TP</p></button>
                        <button onclick="showPrompt('materi')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 border-2 border-transparent hover:border-primary-300 text-left"><div class="text-2xl mb-2">ğŸ“š</div><h3 class="font-bold text-gray-800">Generate Materi</h3><p class="text-sm text-gray-500">Buat materi dari TP</p></button>
                        <button onclick="showPrompt('soal')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 border-2 border-transparent hover:border-primary-300 text-left"><div class="text-2xl mb-2">â“</div><h3 class="font-bold text-gray-800">Generate Soal</h3><p class="text-sm text-gray-500">Buat soal penilaian</p></button>
                        <button onclick="showPrompt('csv')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 border-2 border-transparent hover:border-primary-300 text-left"><div class="text-2xl mb-2">ğŸ“Š</div><h3 class="font-bold text-gray-800">Format ke CSV</h3><p class="text-sm text-gray-500">Konversi data ke CSV</p></button>
                    </div>
                </div>
                <div id="promptOutput" class="hidden bg-white rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-bold text-gray-800">ğŸ“‹ Prompt untuk AI</h2>
                        <button onclick="copyPrompt()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium">ğŸ“‹ Copy</button>
                    </div>
                    <div id="promptText" class="bg-gray-50 rounded-xl p-4 text-sm text-gray-700 whitespace-pre-wrap"></div>
                    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                        <h4 class="font-medium text-blue-800 mb-2">ğŸ’¡ Cara Penggunaan:</h4>
                        <ol class="text-sm text-blue-700 list-decimal ml-4 space-y-1">
                            <li>Copy prompt di atas</li>
                            <li>Buka ChatGPT, Claude, atau AI lainnya</li>
                            <li>Paste dan sesuaikan bagian yang perlu diisi</li>
                            <li>Hasil dari AI bisa digunakan di aplikasi ini</li>
                        </ol>
                    </div>
                </div>
            </div>
        `;
    }

    const prompts = {
        cp: `Saya adalah guru PAI SD/MI. Tolong bantu saya breakdown Capaian Pembelajaran berikut menjadi beberapa Tujuan Pembelajaran (TP) yang SMART.

CAPAIAN PEMBELAJARAN:
[Paste CP di sini]

KELAS: [Isi kelas]
SEMESTER: [Isi semester]

Tolong buatkan 3-5 Tujuan Pembelajaran yang:
1. Menggunakan kata kerja operasional yang terukur
2. Sesuai dengan tingkat perkembangan siswa
3. Dapat dicapai dalam 2-4 pertemuan
4. Format: "Peserta didik dapat [kata kerja operasional] [objek] [kondisi]"`,
        materi: `Saya adalah guru PAI SD/MI. Tolong bantu saya membuat materi pembelajaran berdasarkan Tujuan Pembelajaran berikut:

TUJUAN PEMBELAJARAN:
[Paste TP di sini]

KELAS: [Isi kelas]
DURASI: [Isi durasi, misal: 2 x 35 menit]

Tolong buatkan materi yang:
1. Sesuai dengan tingkat pemahaman siswa SD
2. Menggunakan bahasa sederhana
3. Dilengkapi contoh-contoh konkret
4. Jika ada teks Arab, sertakan transliterasi latinnya`,
        soal: `Saya adalah guru PAI SD/MI. Tolong bantu saya membuat soal penilaian berdasarkan materi berikut:

MATERI/TOPIK:
[Paste materi di sini]

KELAS: [Isi kelas]
JUMLAH SOAL: [Isi jumlah]
JENIS SOAL: [Pilihan ganda / Isian / Uraian]

Tolong buatkan soal yang:
1. Sesuai dengan tingkat kognitif siswa SD
2. Memiliki kunci jawaban
3. Untuk PG: 4 opsi (A, B, C, D)`,
        csv: `Tolong bantu saya mengkonversi data berikut ke format CSV yang bisa diimport ke aplikasi.

DATA MENTAH:
[Paste data mentah di sini]

FORMAT CSV YANG DIBUTUHKAN:
nisn,nama,jenis_kelamin,kelas,rombel

Tolong:
1. Konversi data ke format CSV
2. Setiap kolom dipisah dengan koma
3. Baris pertama adalah header`
    };

    function showPrompt(type) {
        document.getElementById('promptOutput').classList.remove('hidden');
        document.getElementById('promptText').textContent = prompts[type];
    }

    function copyPrompt() {
        const text = document.getElementById('promptText').textContent;
        navigator.clipboard.writeText(text).then(() => showToast('Prompt berhasil di-copy!', 'success')).catch(() => showToast('Gagal meng-copy', 'error'));
    }

    // Guide
    function renderGuide() {
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in max-w-4xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ“š Panduan Penggunaan</h1>
                    <p class="text-gray-500">Pelajari cara menggunakan Admin Guru Super App</p>
                </div>
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">1. Pengenalan Aplikasi</h2>
                        <p class="text-gray-600 mb-4">Admin Guru Super App membantu guru mengotomatisasi administrasi mengajar dengan konsep <strong>Single Input - Multi Output</strong>.</p>
                        <div class="bg-primary-50 rounded-xl p-4">
                            <h3 class="font-bold text-primary-800 mb-2">ğŸ¯ Konsep:</h3>
                            <ul class="text-sm text-primary-700 space-y-1">
                                <li>âœ… Input: Kalender, Jadwal, CP/TP</li>
                                <li>âœ… Output: ATP, Prota, Promes, Modul Ajar, Jurnal, LKPD</li>
                            </ul>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">2. Langkah Memulai</h2>
                        <div class="space-y-4">
                            <div class="flex gap-4 p-4 bg-gray-50 rounded-xl"><div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold">1</div><div><h4 class="font-bold text-gray-800">Lengkapi Profil</h4><p class="text-sm text-gray-600">Isi data diri, sekolah, dan mata pelajaran di menu Profil</p></div></div>
                            <div class="flex gap-4 p-4 bg-gray-50 rounded-xl"><div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold">2</div><div><h4 class="font-bold text-gray-800">Atur Kalender</h4><p class="text-sm text-gray-600">Tentukan tanggal awal/akhir semester dan hari libur</p></div></div>
                            <div class="flex gap-4 p-4 bg-gray-50 rounded-xl"><div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold">3</div><div><h4 class="font-bold text-gray-800">Buat Jadwal</h4><p class="text-sm text-gray-600">Isi jadwal mengajar mingguan</p></div></div>
                            <div class="flex gap-4 p-4 bg-gray-50 rounded-xl"><div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold">4</div><div><h4 class="font-bold text-gray-800">Import Data Siswa</h4><p class="text-sm text-gray-600">Import dari CSV atau tambah manual</p></div></div>
                            <div class="flex gap-4 p-4 bg-gray-50 rounded-xl"><div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold">5</div><div><h4 class="font-bold text-gray-800">Input CP/TP</h4><p class="text-sm text-gray-600">Untuk PAI, gunakan CP default. Mapel lain input manual</p></div></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">3. Import Data via CSV</h2>
                        <p class="text-gray-600 mb-4">Aplikasi mendukung import dari Google Spreadsheet yang dipublikasi sebagai CSV.</p>
                        <div class="bg-gray-50 rounded-xl p-4">
                            <h4 class="font-bold text-gray-700 mb-2">Format CSV Data Siswa:</h4>
                            <code class="text-sm text-primary-600">nisn,nama,jenis_kelamin,kelas,rombel</code>
                            <p class="text-xs text-gray-500 mt-1">Contoh: 1234567890,Ahmad Fauzi,L,4,A</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">4. FAQ</h2>
                        <div class="space-y-4">
                            <div class="border-b border-gray-100 pb-4"><h4 class="font-bold text-gray-800 mb-2">Bagaimana cara upgrade ke Premium?</h4><p class="text-sm text-gray-600">Klik "Upgrade Premium" di sidebar, lalu hubungi admin via WhatsApp.</p></div>
                            <div class="border-b border-gray-100 pb-4"><h4 class="font-bold text-gray-800 mb-2">Apakah data saya aman?</h4><p class="text-sm text-gray-600">Ya, data disimpan di Firebase dan hanya bisa diakses akun Anda.</p></div>
                            <div><h4 class="font-bold text-gray-800 mb-2">Apakah bisa diakses dari HP?</h4><p class="text-sm text-gray-600">Ya, aplikasi ini responsif untuk smartphone dan tablet.</p></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Admin Panel
    function renderAdmin() {
        if (currentUser.email !== SUPER_ADMIN_EMAIL) {
            showToast('Akses ditolak', 'error');
            navigateTo('dashboard');
            return;
        }
        const content = document.getElementById('contentArea');
        content.innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">âš™ï¸ Panel Admin</h1>
                    <p class="text-gray-500">Kelola pengaturan aplikasi dan pengguna</p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white rounded-2xl p-6"><p class="text-3xl font-bold text-primary-600" id="adminTotal">--</p><p class="text-sm text-gray-500">Total Pengguna</p></div>
                    <div class="bg-white rounded-2xl p-6"><p class="text-3xl font-bold text-green-600" id="adminPremium">--</p><p class="text-sm text-gray-500">Premium</p></div>
                    <div class="bg-white rounded-2xl p-6"><p class="text-3xl font-bold text-amber-600" id="adminFree">--</p><p class="text-sm text-gray-500">Free</p></div>
                </div>
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ“± Pengaturan WhatsApp</h2>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Nomor WhatsApp Admin</label><input type="text" id="adminWhatsapp" value="${APP_CONFIG.whatsappNumber}" class="w-full px-4 py-3 border border-gray-200 rounded-xl"><p class="text-xs text-gray-500 mt-1">Format: 628xxx</p></div>
                            <button onclick="saveAdminSettings()" class="w-full py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">ğŸ’¾ Simpan</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ’° Pengaturan Harga</h2>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Harga Perorangan/tahun</label><input type="number" id="adminPriceIndiv" value="${APP_CONFIG.individualPrice}" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Harga Sekolah/tahun</label><input type="number" id="adminPriceSchool" value="${APP_CONFIG.schoolPackagePrice}" class="w-full px-4 py-3 border border-gray-200 rounded-xl"></div>
                            <button onclick="saveAdminSettings()" class="w-full py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700">ğŸ’¾ Simpan</button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¥ Kelola Pengguna</h2>
                    <div id="adminUserList" class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-gray-50"><th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Email</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Nama</th><th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th><th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th></tr></thead><tbody id="adminUserBody"><tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Memuat...</td></tr></tbody></table></div>
                </div>
            </div>
        `;
        loadAdminData();
    }

    async function loadAdminData() {
        try {
            const snapshot = await db.collection('users').get();
            let total = 0, premium = 0, free = 0;
            const users = [];
            snapshot.forEach(doc => {
                const d = doc.data();
                total++;
                if (d.subscription === 'premium') premium++; else free++;
                users.push({ id: doc.id, ...d });
            });
            document.getElementById('adminTotal').textContent = total;
            document.getElementById('adminPremium').textContent = premium;
            document.getElementById('adminFree').textContent = free;
            
            document.getElementById('adminUserBody').innerHTML = users.map(u => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${u.email}</td>
                    <td class="px-4 py-3 text-sm">${u.name || '-'}</td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 text-xs font-medium rounded-full ${u.subscription === 'premium' ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-600'}">${u.subscription === 'premium' ? 'Premium' : 'Free'}</span></td>
                    <td class="px-4 py-3 text-center">
                        ${u.subscription === 'premium' ? 
                            `<button onclick="setSubscription('${u.id}', 'free')" class="px-3 py-1 text-xs bg-red-100 text-red-600 rounded-lg hover:bg-red-200">Cabut</button>` : 
                            `<button onclick="setSubscription('${u.id}', 'premium')" class="px-3 py-1 text-xs bg-green-100 text-green-600 rounded-lg hover:bg-green-200">Set Premium</button>`
                        }
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function setSubscription(userId, status) {
        try {
            await db.collection('users').doc(userId).update({ subscription: status, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            showToast(`Status berhasil diubah ke ${status}`, 'success');
            loadAdminData();
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal mengubah status', 'error');
        }
    }

    async function saveAdminSettings() {
        try {
            APP_CONFIG.whatsappNumber = document.getElementById('adminWhatsapp').value;
            APP_CONFIG.individualPrice = parseInt(document.getElementById('adminPriceIndiv').value);
            APP_CONFIG.schoolPackagePrice = parseInt(document.getElementById('adminPriceSchool').value);
            await db.collection('settings').doc('app').set({ ...APP_CONFIG, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            showToast('Pengaturan berhasil disimpan!', 'success');
        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal menyimpan pengaturan', 'error');
        }
    }

    // Print Function
    function printDocument(elementId) {
        const element = document.getElementById(elementId);
        if (!element) { showToast('Tidak ada dokumen untuk dicetak', 'warning'); return; }
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Print</title>
                <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Times New Roman', serif; padding: 20px; font-size: 12pt; }
                    .arabic-text { font-family: 'Amiri', serif; direction: rtl; font-size: 14pt; }
                    table { width: 100%; border-collapse: collapse; }
                    th, td { border: 1px solid #000; padding: 6px; }
                    th { background-color: #f0f0f0; }
                    .no-print { display: none; }
                    @media print { body { padding: 0; } }
                </style>
            </head>
            <body>${element.innerHTML}</body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // Load App Settings
    async function loadAppSettings() {
        try {
            const doc = await db.collection('settings').doc('app').get();
            if (doc.exists) {
                const data = doc.data();
                APP_CONFIG.whatsappNumber = data.whatsappNumber || APP_CONFIG.whatsappNumber;
                APP_CONFIG.individualPrice = data.individualPrice || APP_CONFIG.individualPrice;
                APP_CONFIG.schoolPackagePrice = data.schoolPackagePrice || APP_CONFIG.schoolPackagePrice;
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    // ==================== AUTH STATE OBSERVER ====================
    auth.onAuthStateChanged(async (user) => {
        document.getElementById('loadingScreen').classList.add('hidden');
        
        if (user) {
            currentUser = user;
            await loadUserProfile();
            await loadAppSettings();
            
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            navigateTo('dashboard');
        } else {
            currentUser = null;
            userProfile = null;
            
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
    });
    </script>
</body>
</html>
