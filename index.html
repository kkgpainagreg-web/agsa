<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Guru Super App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìö</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .arabic-text { font-family: 'Amiri', serif; direction: rtl; font-size: 1.25rem; }
        .sidebar-item:hover { transform: translateX(4px); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .gradient-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        /* Print Styles - Sama dengan Preview */
        .print-doc { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; }
        .print-doc table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .print-doc th, .print-doc td { border: 1px solid #000; padding: 6px 8px; vertical-align: top; }
        .print-doc th { background-color: #f0f0f0; font-weight: bold; }
        .print-doc .header-doc { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .print-doc .signature-area { display: flex; justify-content: space-between; margin-top: 40px; }
        .print-doc .signature-box { text-align: center; width: 45%; }
        .print-doc .signature-line { border-bottom: 1px solid #000; display: inline-block; min-width: 200px; margin-top: 60px; }
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#667eea', 600: '#5b21b6', 700: '#4c1d95' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h2 class="text-xl font-semibold text-gray-700">Admin Guru Super App</h2>
            <p class="text-gray-500">Memuat aplikasi...</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">üìö</div>
                <h1 class="text-3xl font-bold text-gray-800">Admin Guru Super App</h1>
                <p class="text-gray-500 mt-2">Single Input - Multi Output</p>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Masuk dengan Google</h2>
                <div id="authError" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-4 text-sm"></div>
                <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-50 transition-all">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    <span class="font-medium">Masuk dengan Google</span>
                </button>
                <p class="text-center text-sm text-gray-500 mt-4">Hanya akun Gmail yang dapat digunakan</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Mobile Header -->
        <header class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-40 px-4 py-3">
            <div class="flex items-center justify-between">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <h1 class="font-bold text-gray-800">Admin Guru</h1>
                <img id="mobileAvatar" src="" class="w-8 h-8 rounded-full">
            </div>
        </header>

        <!-- Sidebar Overlay -->
        <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black/50 z-40 lg:hidden" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 bg-white shadow-xl z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center text-white text-2xl">üìö</div>
                    <div><h1 class="font-bold text-gray-800">Admin Guru</h1><p class="text-xs text-gray-500">Super App v1.0</p></div>
                </div>
            </div>
            <div class="p-4 border-b">
                <div class="flex items-center gap-3">
                    <img id="sidebarAvatar" src="" class="w-10 h-10 rounded-full">
                    <div class="flex-1 min-w-0">
                        <p id="sidebarName" class="font-medium text-gray-800 truncate"></p>
                        <p id="sidebarEmail" class="text-xs text-gray-500 truncate"></p>
                    </div>
                    <span id="subBadge" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">Free</span>
                </div>
            </div>
            <nav class="p-4 space-y-1" id="navMenu"></nav>
            <div class="p-4 border-t space-y-2">
                <button id="upgradeBtn" onclick="showUpgrade()" class="w-full gradient-secondary text-white px-4 py-3 rounded-xl font-medium">‚≠ê Upgrade Premium</button>
                <button onclick="signOut()" class="w-full flex items-center justify-center gap-2 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-xl">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    <span>Keluar</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="lg:ml-72 min-h-screen pt-16 lg:pt-0">
            <div id="contentArea" class="p-4 lg:p-8"></div>
        </main>
    </div>

    <!-- Modals & Toast -->
    <div id="modals"></div>
    <div id="toasts" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
    // ==================== FIREBASE ====================
    const firebaseConfig = {
        apiKey: "AIzaSyDe4ie2wSPEpNbAgWP-q03vTuHyxc9Jj3E",
        authDomain: "agsa-e5b08.firebaseapp.com",
        projectId: "agsa-e5b08",
        storageBucket: "agsa-e5b08.firebasestorage.app",
        messagingSenderId: "916052746331",
        appId: "1:916052746331:web:357cbadbfd8658f1689f7e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ==================== STATE ====================
    let currentUser = null;
    let userProfile = null;
    let currentPage = 'dashboard';
    const SUPER_ADMIN = 'afifaro@gmail.com';
    let CONFIG = { wa: '6281234567890', priceIndiv: 100000, priceSchool: 500000 };

    // Data storage
    let calendarData = null;
    let scheduleData = [];
    let cpData = [];
    let promesData = []; // Generated promes with dates
    let studentsData = [];

    // ==================== DATA BUKU PAI ====================
    const dataBuku = {
        kelas1: {
            fase: "A", semester1: [
                { bab: 1, elemen: "Al-Qur'an dan Hadis", judul: "Aku Belajar Huruf Hijaiyah", tujuan: "Peserta didik dapat mengenal dan melafalkan huruf hijaiyah dengan benar", tp: ["Mengenal 28 huruf hijaiyah", "Melafalkan huruf hijaiyah dengan benar", "Menulis huruf hijaiyah"], pertemuan: 4, aktivitas: ["Menyanyikan lagu huruf hijaiyah", "Mencocokkan huruf"], karakter: ["Tekun", "Sabar"] },
                { bab: 2, elemen: "Akidah", judul: "Allah Tuhanku", tujuan: "Peserta didik dapat meyakini Allah SWT sebagai Tuhan Yang Maha Esa", tp: ["Menyebutkan bahwa Allah Maha Esa", "Menyebutkan ciptaan Allah", "Mengucap syukur kepada Allah"], pertemuan: 3, aktivitas: ["Menyebutkan ciptaan Allah"], karakter: ["Beriman", "Bersyukur"] },
                { bab: 3, elemen: "Akhlak", judul: "Aku Anak Saleh", tujuan: "Peserta didik dapat menunjukkan perilaku terpuji", tp: ["Berkata jujur", "Menyayangi teman", "Menghormati orang tua"], pertemuan: 3, aktivitas: ["Bermain peran anak jujur"], karakter: ["Jujur", "Penyayang"] },
                { bab: 4, elemen: "Fikih", judul: "Aku Belajar Bersuci", tujuan: "Peserta didik dapat memahami tata cara bersuci sederhana", tp: ["Mengenal najis", "Cara membersihkan najis", "Praktik istinja"], pertemuan: 3, aktivitas: ["Praktik mencuci tangan"], karakter: ["Bersih", "Mandiri"] },
                { bab: 5, elemen: "Sejarah Peradaban Islam", judul: "Nabi Muhammad SAW Panutanku", tujuan: "Peserta didik dapat mengenal Nabi Muhammad SAW sebagai teladan", tp: ["Mengenal kelahiran Nabi", "Mengenal sifat Nabi", "Meneladani akhlak Nabi"], pertemuan: 3, aktivitas: ["Mendengarkan kisah Nabi"], karakter: ["Meneladani Nabi"] }
            ],
            semester2: [
                { bab: 6, elemen: "Al-Qur'an dan Hadis", judul: "Aku Menghafal Surah Pendek", tujuan: "Peserta didik dapat menghafal surah Al-Fatihah dan An-Nas", tp: ["Melafalkan Al-Fatihah", "Menghafal Al-Fatihah", "Melafalkan An-Nas"], pertemuan: 4, aktivitas: ["Menghafal bersama"], karakter: ["Cinta Al-Qur'an"] },
                { bab: 7, elemen: "Akidah", judul: "Malaikat Allah", tujuan: "Peserta didik dapat mengenal malaikat sebagai makhluk Allah", tp: ["Mengenal malaikat", "Menyebutkan nama malaikat", "Mengetahui tugas malaikat"], pertemuan: 3, aktivitas: ["Menyebutkan nama malaikat"], karakter: ["Beriman"] },
                { bab: 8, elemen: "Akhlak", judul: "Aku Sayang Temanku", tujuan: "Peserta didik dapat menunjukkan sikap persahabatan", tp: ["Berteman dengan baik", "Tolong-menolong", "Memaafkan teman"], pertemuan: 3, aktivitas: ["Bermain bersama"], karakter: ["Tolong-menolong"] },
                { bab: 9, elemen: "Fikih", judul: "Aku Belajar Wudhu", tujuan: "Peserta didik dapat mengetahui tata cara wudhu", tp: ["Mengenal wudhu", "Mengetahui tata cara wudhu", "Praktik wudhu"], pertemuan: 3, aktivitas: ["Praktik wudhu"], karakter: ["Bersih", "Tertib"] },
                { bab: 10, elemen: "Sejarah Peradaban Islam", judul: "Kisah Nabi Adam AS", tujuan: "Peserta didik dapat mengenal kisah Nabi Adam AS", tp: ["Mengenal Nabi Adam", "Mengetahui kisah Nabi Adam", "Mengambil hikmah"], pertemuan: 3, aktivitas: ["Mendengarkan kisah"], karakter: ["Bertaubat"] }
            ]
        },
        kelas2: { fase: "A", semester1: [], semester2: [] },
        kelas3: { fase: "B", semester1: [], semester2: [] },
        kelas4: { fase: "B", semester1: [], semester2: [] },
        kelas5: { fase: "C", semester1: [], semester2: [] },
        kelas6: { fase: "C", semester1: [], semester2: [] }
    };

    // ==================== UTILITIES ====================
    function getAcademicYears() {
        const now = new Date();
        const y = now.getFullYear();
        return now.getMonth() >= 5 ? [`${y}/${y+1}`, `${y+1}/${y+2}`] : [`${y-1}/${y}`, `${y}/${y+1}`];
    }

    function toast(msg, type = 'info') {
        const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-amber-500', info: 'bg-blue-500' };
        const t = document.createElement('div');
        t.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg animate-fade-in`;
        t.innerHTML = `${msg} <button onclick="this.parentElement.remove()" class="ml-2">√ó</button>`;
        document.getElementById('toasts').appendChild(t);
        setTimeout(() => t.remove(), 5000);
    }

    function modal(content, opts = {}) {
        const m = document.createElement('div');
        m.className = 'fixed inset-0 z-50 flex items-center justify-center modal-overlay animate-fade-in p-4';
        m.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-${opts.size || 'lg'} max-h-[90vh] overflow-hidden flex flex-col">
                ${opts.title ? `<div class="flex items-center justify-between p-4 border-b"><h3 class="text-lg font-bold text-gray-800">${opts.title}</h3><button onclick="this.closest('.fixed').remove()" class="p-2 hover:bg-gray-100 rounded-lg">‚úï</button></div>` : ''}
                <div class="p-4 overflow-y-auto flex-1">${content}</div>
            </div>
        `;
        m.addEventListener('click', e => { if (e.target === m) m.remove(); });
        document.getElementById('modals').appendChild(m);
        return m;
    }

    function formatDate(date) {
        return new Date(date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    }

    function formatShortDate(date) {
        return new Date(date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
    }

    function formatCurrency(n) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
    }

    function getDayName(date) {
        return new Date(date).toLocaleDateString('id-ID', { weekday: 'long' });
    }

    // ==================== AUTH ====================
    async function signInWithGoogle() {
        try {
            const result = await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
            if (!result.user.email.endsWith('@gmail.com')) {
                await auth.signOut();
                document.getElementById('authError').textContent = 'Hanya akun Gmail yang dapat digunakan!';
                document.getElementById('authError').classList.remove('hidden');
                return;
            }
            toast('Berhasil masuk!', 'success');
        } catch (e) {
            document.getElementById('authError').textContent = e.message;
            document.getElementById('authError').classList.remove('hidden');
        }
    }

    async function signOut() {
        await auth.signOut();
        toast('Berhasil keluar', 'info');
    }

    // ==================== USER PROFILE ====================
    async function loadProfile() {
        if (!currentUser) return;
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists) {
            userProfile = doc.data();
        } else {
            userProfile = {
                uid: currentUser.uid, email: currentUser.email,
                name: currentUser.displayName || '', photoURL: currentUser.photoURL || '',
                nip: '', phone: '', subscription: 'free',
                subjects: [{ name: 'PAI dan Budi Pekerti', hoursPerMeeting: 2, meetingsPerWeek: 1 }],
                school: { name: '', npsn: '', level: 'SD', location: '', principalName: '', principalNip: '' }
            };
            await db.collection('users').doc(currentUser.uid).set(userProfile);
        }
        updateUI();
    }

    function updateUI() {
        const avatar = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.email)}`;
        document.getElementById('sidebarAvatar').src = avatar;
        document.getElementById('mobileAvatar').src = avatar;
        document.getElementById('sidebarName').textContent = userProfile?.name || currentUser.displayName || 'User';
        document.getElementById('sidebarEmail').textContent = currentUser.email;
        
        const badge = document.getElementById('subBadge');
        const isPrem = userProfile?.subscription === 'premium' || currentUser.email === SUPER_ADMIN;
        badge.textContent = isPrem ? 'Premium' : 'Free';
        badge.className = `px-2 py-1 text-xs font-medium rounded-full ${isPrem ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-600'}`;
        document.getElementById('upgradeBtn').classList.toggle('hidden', isPrem);
        
        renderNav();
    }

    function isPremium() {
        return userProfile?.subscription === 'premium' || currentUser?.email === SUPER_ADMIN;
    }

    // ==================== NAVIGATION ====================
    const menuItems = [
        { id: 'dashboard', icon: 'üè†', label: 'Dashboard' },
        { type: 'divider', label: 'Data Dasar' },
        { id: 'profile', icon: 'üë§', label: 'Profil' },
        { id: 'calendar', icon: 'üìÖ', label: 'Kalender Pendidikan' },
        { id: 'schedule', icon: 'üïê', label: 'Jadwal Pelajaran' },
        { id: 'students', icon: 'üë®‚Äçüéì', label: 'Data Siswa' },
        { type: 'divider', label: 'Perangkat Ajar' },
        { id: 'cp', icon: 'üéØ', label: 'Capaian Pembelajaran' },
        { id: 'atp', icon: 'üìã', label: 'ATP' },
        { id: 'prota', icon: 'üìÜ', label: 'Prota' },
        { id: 'promes', icon: 'üìë', label: 'Promes' },
        { id: 'modul', icon: 'üìñ', label: 'Modul Ajar', premium: true },
        { type: 'divider', label: 'Pembelajaran' },
        { id: 'journal', icon: 'üìì', label: 'Jurnal' },
        { id: 'attendance', icon: '‚úÖ', label: 'Absensi' },
        { id: 'grades', icon: 'üìä', label: 'Daftar Nilai' },
        { id: 'lkpd', icon: 'üìù', label: 'LKPD', premium: true },
        { id: 'banksoal', icon: 'üè¶', label: 'Bank Soal', premium: true },
        { type: 'divider', label: 'Bantuan' },
        { id: 'ai', icon: 'ü§ñ', label: 'AI Assistant' },
        { id: 'guide', icon: 'üìö', label: 'Panduan' }
    ];

    function renderNav() {
        const nav = document.getElementById('navMenu');
        let html = '';
        menuItems.forEach(item => {
            if (item.type === 'divider') {
                html += `<div class="pt-4 pb-2"><p class="px-4 text-xs font-semibold text-gray-400 uppercase">${item.label}</p></div>`;
            } else {
                html += `<button onclick="goTo('${item.id}')" data-nav="${item.id}" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600 hover:bg-gray-100 transition-all">
                    <span class="text-xl">${item.icon}</span><span>${item.label}</span>
                    ${item.premium ? '<span class="ml-auto text-xs bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full">Premium</span>' : ''}
                </button>`;
            }
        });
        if (currentUser?.email === SUPER_ADMIN) {
            html += `<div class="pt-4 pb-2"><p class="px-4 text-xs font-semibold text-red-400 uppercase">Admin</p></div>
                <button onclick="goTo('admin')" data-nav="admin" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-red-600 hover:bg-red-50"><span class="text-xl">‚öôÔ∏è</span><span>Panel Admin</span></button>`;
        }
        nav.innerHTML = html;
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('-translate-x-full');
        document.getElementById('sidebarOverlay').classList.toggle('hidden');
    }

    function goTo(page) {
        const premiumPages = ['modul', 'lkpd', 'banksoal'];
        if (premiumPages.includes(page) && !isPremium()) { showUpgrade(); return; }
        
        currentPage = page;
        document.querySelectorAll('[data-nav]').forEach(btn => {
            btn.classList.toggle('bg-primary-50', btn.dataset.nav === page);
            btn.classList.toggle('text-primary-600', btn.dataset.nav === page);
        });
        if (window.innerWidth < 1024 && !document.getElementById('sidebar').classList.contains('-translate-x-full')) toggleSidebar();
        
        renderPage(page);
    }

    function renderPage(page) {
        const c = document.getElementById('contentArea');
        c.innerHTML = '<div class="flex justify-center py-20"><div class="loading-spinner"></div></div>';
        setTimeout(() => {
            const pages = { dashboard: renderDashboard, profile: renderProfile, calendar: renderCalendar, schedule: renderSchedule, students: renderStudents, cp: renderCP, atp: renderATP, prota: renderProta, promes: renderPromes, modul: renderModul, journal: renderJournal, attendance: renderAttendance, grades: renderGrades, lkpd: renderLKPD, banksoal: renderBankSoal, ai: renderAI, guide: renderGuide, admin: renderAdmin };
            (pages[page] || (() => c.innerHTML = '<p class="text-center py-20">Halaman tidak ditemukan</p>'))();
        }, 100);
    }

    function showUpgrade() {
        modal(`
            <div class="text-center mb-6"><div class="text-6xl mb-4">‚≠ê</div><h3 class="text-2xl font-bold">Upgrade ke Premium</h3></div>
            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="border-2 rounded-xl p-6"><h4 class="font-bold mb-2">Perorangan</h4><p class="text-2xl font-bold text-primary-600">${formatCurrency(CONFIG.priceIndiv)}/tahun</p><ul class="text-sm mt-4 space-y-1"><li>‚úÖ Semua fitur</li><li>‚úÖ Modul Ajar</li><li>‚úÖ Bank Soal & LKPD</li></ul></div>
                <div class="border-2 border-primary-500 rounded-xl p-6 bg-primary-50"><h4 class="font-bold mb-2">Paket Sekolah</h4><p class="text-2xl font-bold text-primary-600">${formatCurrency(CONFIG.priceSchool)}/tahun</p><ul class="text-sm mt-4 space-y-1"><li>‚úÖ Unlimited guru</li><li>‚úÖ Support prioritas</li></ul></div>
            </div>
            <a href="https://wa.me/${CONFIG.wa}?text=Halo, saya ingin upgrade Premium. Email: ${currentUser?.email}" target="_blank" class="block w-full bg-green-500 text-white text-center py-3 rounded-xl font-medium hover:bg-green-600">üì± Hubungi via WhatsApp</a>
        `, { title: 'Upgrade Premium', size: 'xl' });
    }

    // ==================== LOAD ALL DATA ====================
    async function loadAllData() {
        await Promise.all([loadCalendarData(), loadScheduleData(), loadCPData(), loadStudentsData()]);
        generatePromesData();
    }

    async function loadCalendarData() {
        const doc = await db.collection('users').doc(currentUser.uid).collection('settings').doc('calendar').get();
        calendarData = doc.exists ? doc.data() : null;
    }

    async function loadScheduleData() {
        const snap = await db.collection('users').doc(currentUser.uid).collection('schedules').get();
        scheduleData = [];
        snap.forEach(d => scheduleData.push({ id: d.id, ...d.data() }));
    }

    async function loadCPData() {
        const snap = await db.collection('users').doc(currentUser.uid).collection('cp').orderBy('kelas').orderBy('bab').get();
        cpData = [];
        snap.forEach(d => cpData.push({ id: d.id, ...d.data() }));
    }

    async function loadStudentsData() {
        const snap = await db.collection('users').doc(currentUser.uid).collection('students').orderBy('name').get();
        studentsData = [];
        snap.forEach(d => studentsData.push({ id: d.id, ...d.data() }));
    }

    // ==================== GENERATE PROMES DATA WITH DATES ====================
    function generatePromesData() {
        promesData = [];
        if (!calendarData || cpData.length === 0) return;
        
        // Get schedule days for each class
        const classDays = {};
        scheduleData.forEach(s => {
            const key = s.className;
            if (!classDays[key]) classDays[key] = [];
            if (!classDays[key].includes(s.day)) classDays[key].push(s.day);
        });
        
        const dayMap = { 'Senin': 1, 'Selasa': 2, 'Rabu': 3, 'Kamis': 4, 'Jumat': 5, 'Sabtu': 6 };
        
        // Generate for each semester
        [1, 2].forEach(sem => {
            const semKey = sem === 1 ? 'semester1' : 'semester2';
            const semData = calendarData[semKey];
            if (!semData?.start || !semData?.end) return;
            
            const startDate = new Date(semData.start);
            const endDate = new Date(semData.end);
            const holidays = (calendarData.holidays || []).map(h => h.date);
            
            // Get CP for this semester
            const semesterCP = cpData.filter(cp => cp.semester === String(sem));
            
            // For each class in schedule
            const classes = [...new Set(scheduleData.map(s => s.className))];
            
            classes.forEach(kelas => {
                const kelasNum = kelas.replace(/[A-Za-z]/g, '');
                const kelasCP = semesterCP.filter(cp => cp.kelas === kelasNum);
                const teachingDays = classDays[kelas] || ['Senin'];
                
                let currentDate = new Date(startDate);
                let cpIndex = 0;
                let pertemuanCount = 0;
                
                while (currentDate <= endDate && cpIndex < kelasCP.length) {
                    const dayOfWeek = currentDate.getDay();
                    const dayName = Object.keys(dayMap).find(k => dayMap[k] === dayOfWeek);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    
                    // Check if this is a teaching day and not a holiday
                    if (teachingDays.includes(dayName) && !holidays.includes(dateStr)) {
                        const cp = kelasCP[cpIndex];
                        const maxPertemuan = cp.pertemuan || 2;
                        
                        promesData.push({
                            kelas,
                            semester: sem,
                            cpId: cp.id,
                            bab: cp.bab,
                            judul: cp.judul,
                            elemen: cp.elemen,
                            tp: cp.tp || [],
                            tujuan: cp.tujuan,
                            pertemuanKe: pertemuanCount + 1,
                            totalPertemuan: maxPertemuan,
                            tanggal: dateStr,
                            hari: dayName,
                            aktivitas: cp.aktivitas,
                            karakter: cp.karakter
                        });
                        
                        pertemuanCount++;
                        if (pertemuanCount >= maxPertemuan) {
                            cpIndex++;
                            pertemuanCount = 0;
                        }
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
        });
    }

    // ==================== DOCUMENT GENERATOR ====================
    function generateDocHeader(title, subtitle = '') {
        const s = userProfile?.school || {};
        return `
            <div class="header-doc">
                <h2 style="font-size: 16pt; font-weight: bold; margin: 0;">${title}</h2>
                ${subtitle ? `<p style="margin: 5px 0 0 0;">${subtitle}</p>` : ''}
            </div>
            <table style="border: none; margin-bottom: 15px;">
                <tr style="border: none;"><td style="border: none; width: 150px;">Satuan Pendidikan</td><td style="border: none;">: ${s.name || '...........................'}</td><td style="border: none; width: 150px;">Tahun Pelajaran</td><td style="border: none;">: ${getAcademicYears()[0]}</td></tr>
                <tr style="border: none;"><td style="border: none;">Mata Pelajaran</td><td style="border: none;">: PAI dan Budi Pekerti</td><td style="border: none;">Guru Pengampu</td><td style="border: none;">: ${userProfile?.name || '...........................'}</td></tr>
            </table>
        `;
    }

    function generateSignature() {
        const s = userProfile?.school || {};
        return `
            <div class="signature-area">
                <div class="signature-box">
                    <p>Mengetahui,</p>
                    <p>Kepala ${s.name || 'Sekolah'}</p>
                    <p class="signature-line">${s.principalName || '...........................'}</p>
                    <p>NIP. ${s.principalNip || '...........................'}</p>
                </div>
                <div class="signature-box">
                    <p>${s.location || '...............'}, ........................ ${new Date().getFullYear()}</p>
                    <p>Guru Mata Pelajaran</p>
                    <p class="signature-line">${userProfile?.name || '...........................'}</p>
                    <p>NIP. ${userProfile?.nip || '...........................'}</p>
                </div>
            </div>
        `;
    }

    function printDoc(elementId) {
        const el = document.getElementById(elementId);
        if (!el) { toast('Tidak ada dokumen', 'warning'); return; }
        const w = window.open('', '_blank');
        w.document.write(`<!DOCTYPE html><html><head><title>Print</title>
            <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
            <style>
                body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; padding: 20px; }
                .arabic-text { font-family: 'Amiri', serif; direction: rtl; font-size: 14pt; }
                table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                th, td { border: 1px solid #000; padding: 6px 8px; vertical-align: top; }
                th { background-color: #f0f0f0; }
                .header-doc { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                .signature-area { display: flex; justify-content: space-between; margin-top: 40px; page-break-inside: avoid; }
                .signature-box { text-align: center; width: 45%; }
                .signature-line { border-bottom: 1px solid #000; display: inline-block; min-width: 200px; margin-top: 60px; margin-bottom: 5px; font-weight: bold; }
                .no-print { display: none; }
                @page { margin: 2cm; }
            </style>
        </head><body>${el.innerHTML}</body></html>`);
        w.document.close();
        setTimeout(() => w.print(), 500);
    }

    // ==================== PAGES ====================

    // Dashboard
    function renderDashboard() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8"><h1 class="text-2xl font-bold text-gray-800">Selamat Datang, ${userProfile?.name || 'Guru'}! üëã</h1><p class="text-gray-500">Tahun Ajaran: ${getAcademicYears()[0]}</p></div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white rounded-2xl p-6 card-hover"><div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center text-2xl mb-4">üë®‚Äçüéì</div><p class="text-2xl font-bold">${studentsData.length}</p><p class="text-sm text-gray-500">Total Siswa</p></div>
                    <div class="bg-white rounded-2xl p-6 card-hover"><div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center text-2xl mb-4">üéØ</div><p class="text-2xl font-bold">${cpData.length}</p><p class="text-sm text-gray-500">Capaian Pembelajaran</p></div>
                    <div class="bg-white rounded-2xl p-6 card-hover"><div class="w-12 h-12 bg-amber-500 rounded-xl flex items-center justify-center text-2xl mb-4">üìÖ</div><p class="text-2xl font-bold">${scheduleData.length}</p><p class="text-sm text-gray-500">Jadwal Mengajar</p></div>
                    <div class="bg-white rounded-2xl p-6 card-hover"><div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center text-2xl mb-4">üìë</div><p class="text-2xl font-bold">${promesData.length}</p><p class="text-sm text-gray-500">Pertemuan Promes</p></div>
                </div>
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold mb-4">üìã Status Dokumen</h2>
                        <div class="space-y-3">
                            ${[
                                { icon: 'üìÖ', name: 'Kalender', status: calendarData ? 'Lengkap' : 'Belum diisi', ok: !!calendarData },
                                { icon: 'üïê', name: 'Jadwal', status: scheduleData.length ? `${scheduleData.length} jadwal` : 'Belum diisi', ok: scheduleData.length > 0 },
                                { icon: 'üéØ', name: 'CP/TP', status: cpData.length ? `${cpData.length} CP` : 'Belum diisi', ok: cpData.length > 0 },
                                { icon: 'üìë', name: 'Promes', status: promesData.length ? `${promesData.length} pertemuan` : 'Belum generate', ok: promesData.length > 0 }
                            ].map(d => `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl"><div class="flex items-center gap-3"><span class="text-xl">${d.icon}</span><span>${d.name}</span></div><span class="px-3 py-1 text-xs rounded-full ${d.ok ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-600'}">${d.status}</span></div>`).join('')}
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-primary-500 to-purple-600 rounded-2xl p-6 text-white">
                        <h2 class="text-lg font-bold mb-2">üí° Tips</h2>
                        <p class="text-sm opacity-90 mb-4">Lengkapi Kalender ‚Üí Jadwal ‚Üí CP untuk mengaktifkan Promes otomatis dengan tanggal detail.</p>
                        <button onclick="goTo('guide')" class="w-full bg-white/20 hover:bg-white/30 rounded-xl py-2 text-sm font-medium">Baca Panduan ‚Üí</button>
                    </div>
                </div>
            </div>
        `;
    }

    // Profile
    function renderProfile() {
        const s = userProfile?.school || {};
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in max-w-4xl mx-auto">
                <h1 class="text-2xl font-bold text-gray-800 mb-8">üë§ Profil</h1>
                <form id="profileForm" class="space-y-6">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold mb-4">Data Pribadi</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-2">Nama Lengkap</label><input type="text" id="pName" value="${userProfile?.name || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-2">NIP</label><input type="text" id="pNip" value="${userProfile?.nip || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-2">Email</label><input type="email" value="${currentUser?.email}" readonly class="w-full px-4 py-3 border rounded-xl bg-gray-50"></div>
                            <div><label class="block text-sm font-medium mb-2">No. HP</label><input type="tel" id="pPhone" value="${userProfile?.phone || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold mb-4">üè´ Satuan Pendidikan</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium mb-2">Nama Sekolah</label><input type="text" id="sName" value="${s.name || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-2">NPSN</label><input type="text" id="sNpsn" value="${s.npsn || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-2">Jenjang</label><select id="sLevel" class="w-full px-4 py-3 border rounded-xl"><option value="SD" ${s.level==='SD'?'selected':''}>SD/MI</option><option value="SMP" ${s.level==='SMP'?'selected':''}>SMP/MTs</option><option value="SMA" ${s.level==='SMA'?'selected':''}>SMA/MA/SMK</option></select></div>
                            <div><label class="block text-sm font-medium mb-2">Lokasi (Kota/Kab)</label><input type="text" id="sLoc" value="${s.location || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-2">Nama Kepala Sekolah</label><input type="text" id="sPrincipal" value="${s.principalName || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-2">NIP Kepala Sekolah</label><input type="text" id="sPrincipalNip" value="${s.principalNip || ''}" class="w-full px-4 py-3 border rounded-xl"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4"><h2 class="text-lg font-bold">üìö Mata Pelajaran</h2><button type="button" onclick="addSubject()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm">+ Tambah</button></div>
                        <div id="subjectList" class="space-y-3">${renderSubjects()}</div>
                    </div>
                    <button type="submit" class="w-full py-3 gradient-primary text-white rounded-xl font-medium">üíæ Simpan Profil</button>
                </form>
            </div>
        `;
        document.getElementById('profileForm').onsubmit = saveProfile;
    }

    function renderSubjects() {
        const subs = userProfile?.subjects || [];
        return subs.length ? subs.map((s, i) => `
            <div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
                <input type="text" value="${s.name}" onchange="updateSub(${i},'name',this.value)" class="flex-1 px-3 py-2 border rounded-lg text-sm" placeholder="Nama Mapel">
                <input type="number" value="${s.hoursPerMeeting||2}" onchange="updateSub(${i},'hoursPerMeeting',this.value)" class="w-20 px-3 py-2 border rounded-lg text-sm" placeholder="JP">
                <input type="number" value="${s.meetingsPerWeek||1}" onchange="updateSub(${i},'meetingsPerWeek',this.value)" class="w-20 px-3 py-2 border rounded-lg text-sm" placeholder="x/minggu">
                <button type="button" onclick="removeSub(${i})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">‚úï</button>
            </div>
        `).join('') : '<p class="text-gray-500 text-center py-4">Belum ada mapel</p>';
    }

    function addSubject() {
        if (!userProfile.subjects) userProfile.subjects = [];
        userProfile.subjects.push({ name: 'PAI dan Budi Pekerti', hoursPerMeeting: 2, meetingsPerWeek: 1 });
        document.getElementById('subjectList').innerHTML = renderSubjects();
    }
    function updateSub(i, f, v) { if (userProfile.subjects?.[i]) userProfile.subjects[i][f] = f === 'name' ? v : parseInt(v); }
    function removeSub(i) { userProfile.subjects?.splice(i, 1); document.getElementById('subjectList').innerHTML = renderSubjects(); }

    async function saveProfile(e) {
        e.preventDefault();
        const data = {
            name: document.getElementById('pName').value,
            nip: document.getElementById('pNip').value,
            phone: document.getElementById('pPhone').value,
            school: {
                name: document.getElementById('sName').value,
                npsn: document.getElementById('sNpsn').value,
                level: document.getElementById('sLevel').value,
                location: document.getElementById('sLoc').value,
                principalName: document.getElementById('sPrincipal').value,
                principalNip: document.getElementById('sPrincipalNip').value
            },
            subjects: userProfile.subjects || [],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('users').doc(currentUser.uid).update(data);
        userProfile = { ...userProfile, ...data };
        updateUI();
        toast('Profil berhasil disimpan!', 'success');
    }

    // Calendar
    function renderCalendar() {
        const c = calendarData || {};
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üìÖ Kalender Pendidikan</h1><button onclick="saveCalendar()" class="px-4 py-2 bg-primary-600 text-white rounded-xl">üíæ Simpan</button></div>
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold mb-4">Semester 1 (Ganjil)</h2>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium mb-2">Tanggal Mulai</label><input type="date" id="s1Start" value="${c.semester1?.start||''}" class="w-full px-4 py-3 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-2">Tanggal Selesai</label><input type="date" id="s1End" value="${c.semester1?.end||''}" class="w-full px-4 py-3 border rounded-xl"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-lg font-bold mb-4">Semester 2 (Genap)</h2>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium mb-2">Tanggal Mulai</label><input type="date" id="s2Start" value="${c.semester2?.start||''}" class="w-full px-4 py-3 border rounded-xl"></div>
                            <div><label class="block text-sm font-medium mb-2">Tanggal Selesai</label><input type="date" id="s2End" value="${c.semester2?.end||''}" class="w-full px-4 py-3 border rounded-xl"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4"><h2 class="text-lg font-bold">üéâ Hari Libur Tambahan</h2><button onclick="addHoliday()" class="text-primary-600 font-medium">+ Tambah</button></div>
                    <div id="holidayList" class="space-y-2">${renderHolidays()}</div>
                </div>
            </div>
        `;
    }

    function renderHolidays() {
        const h = calendarData?.holidays || [];
        return h.map((x, i) => `<div class="flex items-center gap-4 p-3 bg-gray-50 rounded-xl"><input type="text" value="${x.name}" onchange="updateHoliday(${i},'name',this.value)" class="flex-1 px-3 py-2 border rounded-lg"><input type="date" value="${x.date}" onchange="updateHoliday(${i},'date',this.value)" class="px-3 py-2 border rounded-lg"><button onclick="removeHoliday(${i})" class="p-2 text-red-500">‚úï</button></div>`).join('') || '<p class="text-gray-500 text-center py-4">Belum ada hari libur tambahan</p>';
    }

    function addHoliday() {
        if (!calendarData) calendarData = { holidays: [] };
        if (!calendarData.holidays) calendarData.holidays = [];
        calendarData.holidays.push({ name: 'Libur', date: new Date().toISOString().split('T')[0] });
        document.getElementById('holidayList').innerHTML = renderHolidays();
    }
    function updateHoliday(i, f, v) { if (calendarData?.holidays?.[i]) calendarData.holidays[i][f] = v; }
    function removeHoliday(i) { calendarData?.holidays?.splice(i, 1); document.getElementById('holidayList').innerHTML = renderHolidays(); }

    async function saveCalendar() {
        calendarData = {
            semester1: { start: document.getElementById('s1Start').value, end: document.getElementById('s1End').value },
            semester2: { start: document.getElementById('s2Start').value, end: document.getElementById('s2End').value },
            holidays: calendarData?.holidays || [],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('users').doc(currentUser.uid).collection('settings').doc('calendar').set(calendarData);
        generatePromesData();
        toast('Kalender berhasil disimpan! Promes di-generate ulang.', 'success');
    }

    // Schedule
    const DAYS = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];

    function renderSchedule() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üïê Jadwal Pelajaran</h1><button onclick="addSchedule()" class="px-4 py-2 bg-primary-600 text-white rounded-xl">‚ûï Tambah</button></div>
                <div class="bg-white rounded-2xl p-6 overflow-x-auto">
                    <table class="w-full min-w-[800px]">
                        <thead><tr class="bg-gray-50"><th class="px-4 py-3 text-left">Jam</th>${DAYS.map(d=>`<th class="px-4 py-3 text-center">${d}</th>`).join('')}</tr></thead>
                        <tbody id="scheduleTable">${renderScheduleTable()}</tbody>
                    </table>
                </div>
                <div class="mt-6 bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <p class="text-sm text-amber-700">‚ö†Ô∏è Jadwal akan digunakan untuk generate Promes dengan tanggal detail per pertemuan.</p>
                </div>
            </div>
        `;
    }

    function renderScheduleTable() {
        return Array.from({length:8},(_,i)=>i+1).map(h=>`
            <tr class="border-b"><td class="px-4 py-3 font-medium">Jam ${h}</td>
            ${DAYS.map(d=>{
                const entry = scheduleData.find(s=>s.day===d&&s.hour===h);
                return `<td class="px-2 py-2">${entry?`<div class="bg-primary-100 border border-primary-200 rounded-lg p-2 text-xs cursor-pointer hover:bg-primary-200" onclick="editSchedule('${entry.id}')"><div class="font-medium text-primary-800">${entry.subject}</div><div class="text-primary-600">${entry.className}</div></div>`:`<button onclick="addScheduleAt('${d}',${h})" class="w-full h-12 border-2 border-dashed rounded-lg hover:border-primary-300 hover:bg-primary-50 text-gray-400">+</button>`}</td>`;
            }).join('')}</tr>
        `).join('');
    }

    function addSchedule() { addScheduleAt(DAYS[0], 1); }
    function addScheduleAt(day, hour) {
        const subs = userProfile?.subjects || [{ name: 'PAI dan Budi Pekerti' }];
        modal(`
            <form id="schedForm" class="space-y-4">
                <input type="hidden" id="schedId" value="">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-2">Hari</label><select id="schedDay" class="w-full px-4 py-3 border rounded-xl">${DAYS.map(d=>`<option value="${d}" ${d===day?'selected':''}>${d}</option>`).join('')}</select></div>
                    <div><label class="block text-sm font-medium mb-2">Jam</label><select id="schedHour" class="w-full px-4 py-3 border rounded-xl">${Array.from({length:8},(_,i)=>`<option value="${i+1}" ${i+1===hour?'selected':''}>${i+1}</option>`).join('')}</select></div>
                </div>
                <div><label class="block text-sm font-medium mb-2">Mata Pelajaran</label><select id="schedSubject" class="w-full px-4 py-3 border rounded-xl">${subs.map(s=>`<option value="${s.name}">${s.name}</option>`).join('')}</select></div>
                <div><label class="block text-sm font-medium mb-2">Kelas/Rombel</label><input type="text" id="schedClass" placeholder="4A" class="w-full px-4 py-3 border rounded-xl"></div>
                <div class="flex gap-3"><button type="submit" class="flex-1 py-3 bg-primary-600 text-white rounded-xl">Simpan</button><button type="button" id="schedDel" class="hidden px-4 py-3 bg-red-600 text-white rounded-xl" onclick="delSchedule()">Hapus</button></div>
            </form>
        `, { title: 'üìÖ Jadwal', size: 'md' });
        document.getElementById('schedForm').onsubmit = saveSchedule;
    }

    function editSchedule(id) {
        const s = scheduleData.find(x=>x.id===id);
        if (!s) return;
        addScheduleAt(s.day, s.hour);
        setTimeout(() => {
            document.getElementById('schedId').value = s.id;
            document.getElementById('schedSubject').value = s.subject;
            document.getElementById('schedClass').value = s.className;
            document.getElementById('schedDel').classList.remove('hidden');
        }, 100);
    }

    async function saveSchedule(e) {
        e.preventDefault();
        const id = document.getElementById('schedId').value || db.collection('temp').doc().id;
        const day = document.getElementById('schedDay').value;
        const hour = parseInt(document.getElementById('schedHour').value);
        
        // Check conflict
        const conflict = scheduleData.find(s => s.id !== id && s.day === day && s.hour === hour);
        if (conflict) { toast(`Konflik di ${day} Jam ${hour}`, 'error'); return; }
        
        await db.collection('users').doc(currentUser.uid).collection('schedules').doc(id).set({
            day, hour, subject: document.getElementById('schedSubject').value,
            className: document.getElementById('schedClass').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.querySelector('.modal-overlay').remove();
        await loadScheduleData();
        generatePromesData();
        toast('Jadwal disimpan! Promes di-generate ulang.', 'success');
        renderSchedule();
    }

    async function delSchedule() {
        const id = document.getElementById('schedId').value;
        if (!id || !confirm('Hapus jadwal?')) return;
        await db.collection('users').doc(currentUser.uid).collection('schedules').doc(id).delete();
        document.querySelector('.modal-overlay').remove();
        await loadScheduleData();
        generatePromesData();
        toast('Jadwal dihapus', 'success');
        renderSchedule();
    }

    // Students (simplified)
    function renderStudents() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üë®‚Äçüéì Data Siswa</h1><div class="flex gap-3"><button onclick="importCSV()" class="px-4 py-2 border rounded-xl">üì• Import CSV</button><button onclick="addStudent()" class="px-4 py-2 bg-primary-600 text-white rounded-xl">‚ûï Tambah</button></div></div>
                <div class="bg-white rounded-2xl overflow-hidden">
                    <table class="w-full"><thead><tr class="bg-gray-50"><th class="px-4 py-3 text-left">No</th><th class="px-4 py-3 text-left">NISN</th><th class="px-4 py-3 text-left">Nama</th><th class="px-4 py-3 text-center">L/P</th><th class="px-4 py-3 text-center">Kelas</th><th class="px-4 py-3 text-center">Aksi</th></tr></thead>
                    <tbody>${studentsData.length ? studentsData.map((s,i)=>`<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3">${i+1}</td><td class="px-4 py-3">${s.nisn||'-'}</td><td class="px-4 py-3 font-medium">${s.name}</td><td class="px-4 py-3 text-center"><span class="px-2 py-1 text-xs rounded-full ${s.gender==='L'?'bg-blue-100 text-blue-600':'bg-pink-100 text-pink-600'}">${s.gender}</span></td><td class="px-4 py-3 text-center">${s.kelas}${s.rombel||''}</td><td class="px-4 py-3 text-center"><button onclick="delStudent('${s.id}')" class="p-1 text-red-600">üóëÔ∏è</button></td></tr>`).join('') : '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Belum ada data</td></tr>'}</tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function addStudent() {
        modal(`<form id="stuForm" class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-2">NISN</label><input type="text" id="stuNisn" class="w-full px-4 py-3 border rounded-xl"></div><div><label class="block text-sm font-medium mb-2">Nama *</label><input type="text" id="stuName" required class="w-full px-4 py-3 border rounded-xl"></div><div><label class="block text-sm font-medium mb-2">L/P</label><select id="stuGender" class="w-full px-4 py-3 border rounded-xl"><option value="L">L</option><option value="P">P</option></select></div><div><label class="block text-sm font-medium mb-2">Kelas</label><input type="text" id="stuKelas" placeholder="4" class="w-full px-4 py-3 border rounded-xl"></div><div><label class="block text-sm font-medium mb-2">Rombel</label><input type="text" id="stuRombel" placeholder="A" class="w-full px-4 py-3 border rounded-xl"></div></div><button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl">Simpan</button></form>`, { title: 'üë®‚Äçüéì Tambah Siswa', size: 'md' });
        document.getElementById('stuForm').onsubmit = async e => {
            e.preventDefault();
            await db.collection('users').doc(currentUser.uid).collection('students').add({
                nisn: document.getElementById('stuNisn').value, name: document.getElementById('stuName').value,
                gender: document.getElementById('stuGender').value, kelas: document.getElementById('stuKelas').value,
                rombel: document.getElementById('stuRombel').value, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.querySelector('.modal-overlay').remove();
            await loadStudentsData();
            toast('Siswa ditambahkan', 'success');
            renderStudents();
        };
    }

    async function delStudent(id) {
        if (!confirm('Hapus siswa?')) return;
        await db.collection('users').doc(currentUser.uid).collection('students').doc(id).delete();
        await loadStudentsData();
        toast('Siswa dihapus', 'success');
        renderStudents();
    }

    function importCSV() {
        modal(`<div class="space-y-4"><p class="text-gray-600">Import dari Google Spreadsheet CSV</p><input type="url" id="csvUrl" placeholder="https://docs.google.com/.../pub?output=csv" class="w-full px-4 py-3 border rounded-xl"><div class="bg-blue-50 rounded-xl p-4"><p class="text-sm text-blue-700">Format: nisn,nama,jenis_kelamin,kelas,rombel</p></div><button onclick="processCSV()" class="w-full py-3 bg-primary-600 text-white rounded-xl">Import</button></div>`, { title: 'üì• Import CSV', size: 'lg' });
    }

    async function processCSV() {
        const url = document.getElementById('csvUrl').value;
        if (!url) { toast('Masukkan URL', 'warning'); return; }
        try {
            const res = await fetch(url);
            const text = await res.text();
            const lines = text.split('\n').filter(l=>l.trim());
            const batch = db.batch();
            let count = 0;
            for (let i = 1; i < lines.length; i++) {
                const [nisn, nama, gender, kelas, rombel] = lines[i].split(',').map(v=>v.trim());
                if (nama) {
                    batch.set(db.collection('users').doc(currentUser.uid).collection('students').doc(), {
                        nisn, name: nama, gender: gender?.toUpperCase(), kelas, rombel
                    });
                    count++;
                }
            }
            await batch.commit();
            document.querySelector('.modal-overlay').remove();
            await loadStudentsData();
            toast(`${count} siswa diimport`, 'success');
            renderStudents();
        } catch(e) { toast('Gagal import', 'error'); }
    }

    // CP
    function renderCP() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üéØ Capaian Pembelajaran</h1><div class="flex gap-3"><button onclick="loadPAIDefault()" class="px-4 py-2 bg-green-600 text-white rounded-xl">üìö Load PAI Default</button><button onclick="addCP()" class="px-4 py-2 bg-primary-600 text-white rounded-xl">‚ûï Tambah</button></div></div>
                <div id="cpList" class="space-y-4">${cpData.length ? renderCPList() : '<div class="bg-white rounded-2xl p-8 text-center"><div class="text-6xl mb-4">üìö</div><h3 class="text-xl font-bold mb-2">Belum Ada CP</h3><p class="text-gray-500">Load CP PAI default atau tambah manual</p></div>'}</div>
            </div>
        `;
    }

    function renderCPList() {
        const grouped = {};
        cpData.forEach(cp => {
            const k = `Kelas ${cp.kelas} - Semester ${cp.semester}`;
            if (!grouped[k]) grouped[k] = [];
            grouped[k].push(cp);
        });
        return Object.entries(grouped).map(([k, cps]) => `
            <div class="bg-white rounded-2xl overflow-hidden">
                <div class="gradient-primary px-6 py-4 text-white"><h3 class="font-bold">${k}</h3><p class="text-sm opacity-80">${cps.length} CP</p></div>
                <div class="p-4 space-y-3">${cps.map(cp => `
                    <div class="border rounded-xl p-4 hover:border-primary-300">
                        <div class="flex items-start justify-between">
                            <div><span class="px-2 py-1 text-xs bg-primary-100 text-primary-700 rounded">${cp.elemen||'Umum'}</span> <span class="text-xs text-gray-500">Bab ${cp.bab}</span><h4 class="font-medium mt-2">${cp.judul}</h4><p class="text-sm text-gray-600">${cp.pertemuan||2} pertemuan</p></div>
                            <button onclick="delCP('${cp.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('')}</div>
            </div>
        `).join('');
    }

    function loadPAIDefault() {
        modal(`<div class="space-y-4"><p>Pilih kelas untuk load CP PAI default:</p><div class="grid grid-cols-3 gap-3">${[1,2,3,4,5,6].map(k=>`<button onclick="importPAI(${k})" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 text-center"><div class="text-2xl mb-1">üìö</div>Kelas ${k}</button>`).join('')}</div></div>`, { title: 'üìö Load CP PAI', size: 'lg' });
    }

    async function importPAI(kelas) {
        const data = dataBuku[`kelas${kelas}`];
        if (!data?.semester1?.length && !data?.semester2?.length) { toast('Data belum tersedia', 'warning'); return; }
        const batch = db.batch();
        let count = 0;
        [1, 2].forEach(sem => {
            const semData = data[`semester${sem}`] || [];
            semData.forEach(bab => {
                batch.set(db.collection('users').doc(currentUser.uid).collection('cp').doc(), {
                    kelas: String(kelas), semester: String(sem), bab: bab.bab, elemen: bab.elemen,
                    judul: bab.judul, tujuan: bab.tujuan, tp: bab.tp || [], pertemuan: bab.pertemuan || 2,
                    aktivitas: bab.aktivitas, karakter: bab.karakter,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                count++;
            });
        });
        await batch.commit();
        document.querySelector('.modal-overlay').remove();
        await loadCPData();
        generatePromesData();
        toast(`${count} CP diimport`, 'success');
        renderCP();
    }

    function addCP() {
        modal(`<form id="cpForm" class="space-y-4 max-h-[70vh] overflow-y-auto">
            <div class="grid grid-cols-3 gap-4"><div><label class="block text-sm font-medium mb-2">Kelas</label><select id="cpKelas" class="w-full px-4 py-3 border rounded-xl">${[1,2,3,4,5,6].map(k=>`<option value="${k}">Kelas ${k}</option>`).join('')}</select></div><div><label class="block text-sm font-medium mb-2">Semester</label><select id="cpSem" class="w-full px-4 py-3 border rounded-xl"><option value="1">1</option><option value="2">2</option></select></div><div><label class="block text-sm font-medium mb-2">Bab</label><input type="number" id="cpBab" min="1" class="w-full px-4 py-3 border rounded-xl"></div></div>
            <div><label class="block text-sm font-medium mb-2">Elemen</label><select id="cpElemen" class="w-full px-4 py-3 border rounded-xl"><option value="">Pilih</option><option>Al-Qur'an dan Hadis</option><option>Akidah</option><option>Akhlak</option><option>Fikih</option><option>Sejarah Peradaban Islam</option></select></div>
            <div><label class="block text-sm font-medium mb-2">Judul *</label><input type="text" id="cpJudul" required class="w-full px-4 py-3 border rounded-xl"></div>
            <div><label class="block text-sm font-medium mb-2">Tujuan</label><textarea id="cpTujuan" rows="2" class="w-full px-4 py-3 border rounded-xl"></textarea></div>
            <div><label class="block text-sm font-medium mb-2">TP (pisah baris)</label><textarea id="cpTP" rows="3" class="w-full px-4 py-3 border rounded-xl"></textarea></div>
            <div><label class="block text-sm font-medium mb-2">Jumlah Pertemuan</label><input type="number" id="cpPertemuan" min="1" value="2" class="w-full px-4 py-3 border rounded-xl"></div>
            <button type="submit" class="w-full py-3 bg-primary-600 text-white rounded-xl">Simpan</button>
        </form>`, { title: 'üéØ Tambah CP', size: 'xl' });
        document.getElementById('cpForm').onsubmit = async e => {
            e.preventDefault();
            await db.collection('users').doc(currentUser.uid).collection('cp').add({
                kelas: document.getElementById('cpKelas').value, semester: document.getElementById('cpSem').value,
                bab: document.getElementById('cpBab').value, elemen: document.getElementById('cpElemen').value,
                judul: document.getElementById('cpJudul').value, tujuan: document.getElementById('cpTujuan').value,
                tp: document.getElementById('cpTP').value.split('\n').filter(t=>t.trim()),
                pertemuan: parseInt(document.getElementById('cpPertemuan').value) || 2,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.querySelector('.modal-overlay').remove();
            await loadCPData();
            generatePromesData();
            toast('CP ditambahkan', 'success');
            renderCP();
        };
    }

    async function delCP(id) {
        if (!confirm('Hapus CP?')) return;
        await db.collection('users').doc(currentUser.uid).collection('cp').doc(id).delete();
        await loadCPData();
        generatePromesData();
        toast('CP dihapus', 'success');
        renderCP();
    }

    // ATP
    function renderATP() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üìã ATP</h1><button onclick="printDoc('atpDoc')" class="px-4 py-2 bg-primary-600 text-white rounded-xl">üñ®Ô∏è Cetak</button></div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex gap-4">
                    <select id="atpKelas" onchange="loadATP()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option>${[1,2,3,4,5,6].map(k=>`<option value="${k}">Kelas ${k}</option>`).join('')}</select>
                    <select id="atpSem" onchange="loadATP()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Semester</option><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                </div>
                <div id="atpContent" class="bg-white rounded-2xl p-6"><p class="text-center py-12 text-gray-500">Pilih kelas dan semester</p></div>
            </div>
        `;
    }

    function loadATP() {
        const kelas = document.getElementById('atpKelas').value;
        const sem = document.getElementById('atpSem').value;
        if (!kelas || !sem) return;
        
        const filtered = cpData.filter(cp => cp.kelas === kelas && cp.semester === sem);
        if (!filtered.length) {
            document.getElementById('atpContent').innerHTML = '<p class="text-center py-12 text-gray-500">Belum ada data CP</p>';
            return;
        }
        
        const s = userProfile?.school || {};
        document.getElementById('atpContent').innerHTML = `
            <div id="atpDoc" class="print-doc print-area">
                ${generateDocHeader('ALUR TUJUAN PEMBELAJARAN (ATP)')}
                <table style="border: none; margin-bottom: 10px;"><tr style="border:none;"><td style="border:none;">Kelas / Semester</td><td style="border:none;">: ${kelas} / ${sem}</td><td style="border:none;">Fase</td><td style="border:none;">: ${kelas<=2?'A':kelas<=4?'B':'C'}</td></tr></table>
                <table>
                    <thead><tr><th style="width:30px">No</th><th>Elemen</th><th style="width:40px">Bab</th><th>Capaian Pembelajaran</th><th>Tujuan Pembelajaran</th><th style="width:40px">JP</th></tr></thead>
                    <tbody>${filtered.map((cp,i)=>`<tr><td style="text-align:center">${i+1}</td><td>${cp.elemen||'-'}</td><td style="text-align:center">${cp.bab||i+1}</td><td><strong>${cp.judul}</strong><br><span style="color:#666">${cp.tujuan||''}</span></td><td><ol style="margin:0;padding-left:20px">${(cp.tp||[]).map(t=>`<li>${t}</li>`).join('')}</ol></td><td style="text-align:center">${(cp.pertemuan||2)*2}</td></tr>`).join('')}</tbody>
                </table>
                ${generateSignature()}
            </div>
        `;
    }

    // Prota
    function renderProta() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üìÜ Prota</h1><button onclick="printDoc('protaDoc')" class="px-4 py-2 bg-primary-600 text-white rounded-xl">üñ®Ô∏è Cetak</button></div>
                <div class="bg-white rounded-2xl p-4 mb-6">
                    <select id="protaKelas" onchange="loadProta()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option>${[1,2,3,4,5,6].map(k=>`<option value="${k}">Kelas ${k}</option>`).join('')}</select>
                </div>
                <div id="protaContent" class="bg-white rounded-2xl p-6"><p class="text-center py-12 text-gray-500">Pilih kelas</p></div>
            </div>
        `;
    }

    function loadProta() {
        const kelas = document.getElementById('protaKelas').value;
        if (!kelas) return;
        
        const sem1 = cpData.filter(cp => cp.kelas === kelas && cp.semester === '1');
        const sem2 = cpData.filter(cp => cp.kelas === kelas && cp.semester === '2');
        
        document.getElementById('protaContent').innerHTML = `
            <div id="protaDoc" class="print-doc print-area">
                ${generateDocHeader('PROGRAM TAHUNAN (PROTA)')}
                <table style="border:none;margin-bottom:10px;"><tr style="border:none;"><td style="border:none;">Kelas</td><td style="border:none;">: ${kelas}</td></tr></table>
                
                <h3 style="margin:15px 0 10px;font-weight:bold;">SEMESTER 1 (Ganjil)</h3>
                <table><thead><tr><th style="width:30px">No</th><th>Bab / Materi</th><th style="width:50px">JP</th><th>Keterangan</th></tr></thead>
                <tbody>${sem1.map((cp,i)=>`<tr><td style="text-align:center">${i+1}</td><td><strong>Bab ${cp.bab||i+1}:</strong> ${cp.judul}</td><td style="text-align:center">${(cp.pertemuan||2)*2}</td><td>${cp.elemen||''}</td></tr>`).join('')}
                <tr style="background:#f0f0f0;font-weight:bold"><td colspan="2" style="text-align:right">Total JP Semester 1</td><td style="text-align:center">${sem1.reduce((s,c)=>s+((c.pertemuan||2)*2),0)}</td><td></td></tr></tbody></table>
                
                <h3 style="margin:15px 0 10px;font-weight:bold;">SEMESTER 2 (Genap)</h3>
                <table><thead><tr><th style="width:30px">No</th><th>Bab / Materi</th><th style="width:50px">JP</th><th>Keterangan</th></tr></thead>
                <tbody>${sem2.map((cp,i)=>`<tr><td style="text-align:center">${i+1}</td><td><strong>Bab ${cp.bab||i+1}:</strong> ${cp.judul}</td><td style="text-align:center">${(cp.pertemuan||2)*2}</td><td>${cp.elemen||''}</td></tr>`).join('')}
                <tr style="background:#f0f0f0;font-weight:bold"><td colspan="2" style="text-align:right">Total JP Semester 2</td><td style="text-align:center">${sem2.reduce((s,c)=>s+((c.pertemuan||2)*2),0)}</td><td></td></tr></tbody></table>
                
                ${generateSignature()}
            </div>
        `;
    }

    // PROMES - WITH DETAIL DATES
    function renderPromes() {
        const classes = [...new Set(promesData.map(p => p.kelas))].sort();
        
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üìë Promes</h1><button onclick="printDoc('promesDoc')" class="px-4 py-2 bg-primary-600 text-white rounded-xl">üñ®Ô∏è Cetak</button></div>
                ${!promesData.length ? '<div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6"><p class="text-amber-700">‚ö†Ô∏è Lengkapi Kalender, Jadwal, dan CP untuk generate Promes dengan tanggal otomatis.</p></div>' : ''}
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="promesKelas" onchange="loadPromes()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option>${classes.map(k=>`<option value="${k}">${k}</option>`).join('')}</select>
                    <select id="promesSem" onchange="loadPromes()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Semester</option><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                </div>
                <div id="promesContent" class="bg-white rounded-2xl p-6"><p class="text-center py-12 text-gray-500">Pilih kelas dan semester</p></div>
            </div>
        `;
    }

    function loadPromes() {
        const kelas = document.getElementById('promesKelas').value;
        const sem = document.getElementById('promesSem').value;
        if (!kelas || !sem) return;
        
        const filtered = promesData.filter(p => p.kelas === kelas && p.semester === parseInt(sem));
        if (!filtered.length) {
            document.getElementById('promesContent').innerHTML = '<p class="text-center py-12 text-gray-500">Belum ada data Promes. Pastikan Kalender, Jadwal, dan CP sudah diisi.</p>';
            return;
        }
        
        // Group by BAB
        const byBab = {};
        filtered.forEach(p => {
            if (!byBab[p.bab]) byBab[p.bab] = { ...p, pertemuan: [] };
            byBab[p.bab].pertemuan.push({ ke: p.pertemuanKe, tanggal: p.tanggal, hari: p.hari });
        });
        
        const months = sem === '1' ? ['Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'] : ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'];
        
        document.getElementById('promesContent').innerHTML = `
            <div id="promesDoc" class="print-doc print-area">
                ${generateDocHeader('PROGRAM SEMESTER (PROMES)', `Semester ${sem}`)}
                <table style="border:none;margin-bottom:10px;"><tr style="border:none;"><td style="border:none;">Kelas</td><td style="border:none;">: ${kelas}</td><td style="border:none;">Semester</td><td style="border:none;">: ${sem}</td></tr></table>
                
                <table style="font-size:10pt;">
                    <thead>
                        <tr><th rowspan="2" style="width:25px">No</th><th rowspan="2">Materi/Bab</th><th rowspan="2">Tujuan Pembelajaran</th><th rowspan="2" style="width:30px">JP</th><th colspan="${months.length}">Bulan</th><th rowspan="2">Ket</th></tr>
                        <tr>${months.map(m=>`<th style="width:40px">${m}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${Object.values(byBab).map((bab, i) => {
                            // Get dates by month
                            const datesByMonth = {};
                            months.forEach((m, mi) => datesByMonth[mi] = []);
                            bab.pertemuan.forEach(p => {
                                const d = new Date(p.tanggal);
                                const monthIndex = sem === '1' ? d.getMonth() - 6 : d.getMonth();
                                if (monthIndex >= 0 && monthIndex < months.length) {
                                    datesByMonth[monthIndex].push(d.getDate());
                                }
                            });
                            
                            return `<tr>
                                <td style="text-align:center">${i+1}</td>
                                <td><strong>Bab ${bab.bab}:</strong> ${bab.judul}</td>
                                <td style="font-size:9pt"><ol style="margin:0;padding-left:15px">${(bab.tp||[]).slice(0,3).map(t=>`<li>${t.substring(0,50)}...</li>`).join('')}</ol></td>
                                <td style="text-align:center">${bab.totalPertemuan * 2}</td>
                                ${months.map((m, mi) => `<td style="text-align:center;font-size:9pt">${datesByMonth[mi].length ? datesByMonth[mi].join(', ') : ''}</td>`).join('')}
                                <td style="font-size:9pt">${bab.elemen||''}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
                
                <h4 style="margin:20px 0 10px;font-weight:bold;">Detail Tanggal Pertemuan:</h4>
                <table style="font-size:10pt;">
                    <thead><tr><th style="width:25px">No</th><th>Bab/Materi</th><th>Pertemuan</th><th>Hari/Tanggal</th></tr></thead>
                    <tbody>
                        ${Object.values(byBab).map((bab, i) => bab.pertemuan.map((p, pi) => `
                            <tr>
                                ${pi === 0 ? `<td rowspan="${bab.pertemuan.length}" style="text-align:center">${i+1}</td><td rowspan="${bab.pertemuan.length}"><strong>Bab ${bab.bab}:</strong> ${bab.judul}</td>` : ''}
                                <td style="text-align:center">${p.ke} / ${bab.totalPertemuan}</td>
                                <td>${p.hari}, ${formatDate(p.tanggal)}</td>
                            </tr>
                        `).join('')).join('')}
                    </tbody>
                </table>
                
                ${generateSignature()}
            </div>
        `;
    }

    // MODUL AJAR - SINKRON DENGAN PROMES
    function renderModul() {
        if (!isPremium()) { showUpgrade(); return; }
        
        const classes = [...new Set(promesData.map(p => p.kelas))].sort();
        
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üìñ Modul Ajar</h1></div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-blue-700">üí° Pilih dari Promes yang sudah di-generate untuk membuat Modul Ajar. Data akan terisi otomatis.</p>
                </div>
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="modulKelas" onchange="loadModulOptions()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option>${classes.map(k=>`<option value="${k}">${k}</option>`).join('')}</select>
                    <select id="modulSem" onchange="loadModulOptions()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Semester</option><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                </div>
                <div id="modulOptions" class="space-y-4"></div>
            </div>
        `;
    }

    function loadModulOptions() {
        const kelas = document.getElementById('modulKelas').value;
        const sem = document.getElementById('modulSem').value;
        const container = document.getElementById('modulOptions');
        
        if (!kelas || !sem) { container.innerHTML = ''; return; }
        
        const filtered = promesData.filter(p => p.kelas === kelas && p.semester === parseInt(sem));
        
        // Group by bab
        const byBab = {};
        filtered.forEach(p => {
            if (!byBab[p.bab]) byBab[p.bab] = { ...p, pertemuan: [] };
            byBab[p.bab].pertemuan.push(p);
        });
        
        if (!Object.keys(byBab).length) {
            container.innerHTML = '<p class="text-center py-8 text-gray-500">Belum ada data Promes</p>';
            return;
        }
        
        container.innerHTML = Object.values(byBab).map(bab => `
            <div class="bg-white rounded-2xl p-6">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <span class="px-2 py-1 text-xs bg-primary-100 text-primary-700 rounded">${bab.elemen||'Umum'}</span>
                        <h3 class="font-bold mt-2">Bab ${bab.bab}: ${bab.judul}</h3>
                        <p class="text-sm text-gray-600">${bab.tujuan||''}</p>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    ${bab.pertemuan.map(p => `
                        <div class="border rounded-xl p-4 hover:border-primary-300 cursor-pointer" onclick="createModulFrom('${JSON.stringify(p).replace(/'/g, "\\'")}')">
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-medium">Pertemuan ${p.pertemuanKe}</span>
                                <span class="text-xs text-gray-500">${p.hari}, ${formatShortDate(p.tanggal)}</span>
                            </div>
                            <p class="text-sm text-gray-600">TP: ${(p.tp||[])[0]?.substring(0,50)||'-'}...</p>
                            <button class="mt-2 text-sm text-primary-600 font-medium">üìñ Buat Modul ‚Üí</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function createModulFrom(dataStr) {
        const data = JSON.parse(dataStr);
        const s = userProfile?.school || {};
        
        modal(`
            <div id="modulDoc" class="print-doc print-area max-h-[70vh] overflow-y-auto">
                ${generateDocHeader('MODUL AJAR')}
                <table style="border:none;margin-bottom:15px;">
                    <tr style="border:none;"><td style="border:none;width:150px;">Kelas / Semester</td><td style="border:none;">: ${data.kelas} / ${data.semester}</td></tr>
                    <tr style="border:none;"><td style="border:none;">Fase / Elemen</td><td style="border:none;">: ${data.kelas<=2?'A':data.kelas<=4?'B':'C'} / ${data.elemen||'-'}</td></tr>
                    <tr style="border:none;"><td style="border:none;">Topik</td><td style="border:none;">: <strong>${data.judul}</strong></td></tr>
                    <tr style="border:none;"><td style="border:none;">Pertemuan Ke</td><td style="border:none;">: ${data.pertemuanKe} dari ${data.totalPertemuan}</td></tr>
                    <tr style="border:none;"><td style="border:none;">Hari/Tanggal</td><td style="border:none;">: ${data.hari}, ${formatDate(data.tanggal)}</td></tr>
                    <tr style="border:none;"><td style="border:none;">Alokasi Waktu</td><td style="border:none;">: 2 x 35 menit</td></tr>
                </table>
                
                <h4 style="background:#f0f0f0;padding:8px;margin:10px 0;font-weight:bold;">A. TUJUAN PEMBELAJARAN</h4>
                <div style="padding:0 10px;">
                    <ol style="margin:0;padding-left:20px;">
                        ${(data.tp||[]).map(t=>`<li>${t}</li>`).join('')}
                    </ol>
                </div>
                
                <h4 style="background:#f0f0f0;padding:8px;margin:10px 0;font-weight:bold;">B. PROFIL LULUSAN</h4>
                <div style="padding:0 10px;">
                    <p>Keimanan, Akhlak Mulia, Penalaran Kritis, Kemandirian</p>
                </div>
                
                <h4 style="background:#f0f0f0;padding:8px;margin:10px 0;font-weight:bold;">C. KEGIATAN PEMBELAJARAN</h4>
                <div style="padding:0 10px;">
                    <p><strong>1. Pendahuluan (10 menit)</strong></p>
                    <ul style="margin:5px 0;padding-left:20px;">
                        <li>Guru membuka dengan salam dan doa</li>
                        <li>Guru mengecek kehadiran siswa</li>
                        <li>Guru menyampaikan tujuan pembelajaran</li>
                        <li>Apersepsi: mengaitkan materi dengan kehidupan sehari-hari</li>
                    </ul>
                    
                    <p><strong>2. Kegiatan Inti (50 menit)</strong></p>
                    <ul style="margin:5px 0;padding-left:20px;">
                        ${(data.aktivitas||['Menyimak penjelasan guru', 'Diskusi kelompok', 'Presentasi hasil diskusi', 'Tanya jawab']).map(a=>`<li>${a}</li>`).join('')}
                    </ul>
                    
                    <p><strong>3. Penutup (10 menit)</strong></p>
                    <ul style="margin:5px 0;padding-left:20px;">
                        <li>Guru bersama siswa menyimpulkan materi</li>
                        <li>Refleksi pembelajaran</li>
                        <li>Doa penutup dan salam</li>
                    </ul>
                </div>
                
                <h4 style="background:#f0f0f0;padding:8px;margin:10px 0;font-weight:bold;">D. ASESMEN</h4>
                <div style="padding:0 10px;">
                    <ul style="margin:5px 0;padding-left:20px;">
                        <li>Asesmen Formatif: Observasi aktivitas siswa, tanya jawab</li>
                        <li>Asesmen Sumatif: Tes tertulis/praktik</li>
                    </ul>
                </div>
                
                <h4 style="background:#f0f0f0;padding:8px;margin:10px 0;font-weight:bold;">E. KARAKTER YANG DIKEMBANGKAN</h4>
                <div style="padding:0 10px;">
                    <p>${(data.karakter||['Religius', 'Mandiri', 'Gotong royong']).join(', ')}</p>
                </div>
                
                ${generateSignature()}
            </div>
            <div class="mt-4 flex gap-3">
                <button onclick="printDoc('modulDoc')" class="flex-1 py-2 bg-primary-600 text-white rounded-xl">üñ®Ô∏è Cetak Modul</button>
                <button onclick="createLKPDFrom('${dataStr.replace(/'/g, "\\'")}')" class="px-4 py-2 bg-amber-600 text-white rounded-xl">üìù Buat LKPD</button>
            </div>
        `, { title: `üìñ Modul: ${data.judul} - Pertemuan ${data.pertemuanKe}`, size: '3xl' });
    }

    // LKPD - SINKRON DENGAN MODUL/PROMES
    function renderLKPD() {
        if (!isPremium()) { showUpgrade(); return; }
        
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8"><h1 class="text-2xl font-bold">üìù LKPD</h1><p class="text-gray-500">Lembar Kerja Peserta Didik</p></div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-blue-700">üí° LKPD dapat dibuat dari Modul Ajar. Buka Modul Ajar ‚Üí Pilih pertemuan ‚Üí Klik "Buat LKPD"</p>
                </div>
                <button onclick="goTo('modul')" class="px-6 py-3 bg-primary-600 text-white rounded-xl font-medium">üìñ Buka Modul Ajar ‚Üí</button>
            </div>
        `;
    }

    function createLKPDFrom(dataStr) {
        const data = JSON.parse(dataStr);
        
        // Close previous modal if exists
        document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
        
        modal(`
            <div id="lkpdDoc" class="print-doc print-area max-h-[70vh] overflow-y-auto">
                <div class="header-doc">
                    <h2 style="font-size:16pt;font-weight:bold;">LEMBAR KERJA PESERTA DIDIK (LKPD)</h2>
                    <p>${userProfile?.school?.name || 'Sekolah'}</p>
                </div>
                
                <table style="border:none;margin-bottom:15px;">
                    <tr style="border:none;"><td style="border:none;">Nama</td><td style="border:none;">: ...................................</td></tr>
                    <tr style="border:none;"><td style="border:none;">Kelas</td><td style="border:none;">: ${data.kelas}</td></tr>
                    <tr style="border:none;"><td style="border:none;">Hari/Tanggal</td><td style="border:none;">: ${data.hari}, ${formatDate(data.tanggal)}</td></tr>
                    <tr style="border:none;"><td style="border:none;">Materi</td><td style="border:none;">: <strong>${data.judul}</strong></td></tr>
                </table>
                
                <div style="background:#e8f5e9;border:1px solid #4caf50;border-radius:8px;padding:15px;margin:15px 0;">
                    <h4 style="margin:0 0 10px;color:#2e7d32;">üéØ Tujuan Pembelajaran</h4>
                    <p>Setelah mengikuti pembelajaran ini, kamu diharapkan dapat:</p>
                    <ol style="margin:10px 0;padding-left:20px;">
                        ${(data.tp||[]).map(t=>`<li>${t}</li>`).join('')}
                    </ol>
                </div>
                
                <div style="background:#e3f2fd;border:1px solid #2196f3;border-radius:8px;padding:15px;margin:15px 0;">
                    <h4 style="margin:0 0 10px;color:#1565c0;">üìù Petunjuk</h4>
                    <ol style="margin:0;padding-left:20px;">
                        <li>Baca dan pahami materi dengan baik</li>
                        <li>Kerjakan semua soal dengan teliti</li>
                        <li>Tanyakan kepada guru jika ada yang tidak dipahami</li>
                        <li>Kumpulkan LKPD setelah selesai</li>
                    </ol>
                </div>
                
                <h4 style="margin:20px 0 10px;font-weight:bold;">üìö Ringkasan Materi</h4>
                <div style="border:1px solid #ddd;border-radius:8px;padding:15px;min-height:100px;">
                    <p><em>(Materi tentang ${data.judul})</em></p>
                    <p>.................................................................................................................</p>
                    <p>.................................................................................................................</p>
                    <p>.................................................................................................................</p>
                </div>
                
                <h4 style="margin:20px 0 10px;font-weight:bold;">‚úèÔ∏è Kegiatan</h4>
                
                <p><strong>Kegiatan 1:</strong> Jawablah pertanyaan berikut!</p>
                <div style="margin:10px 0;">
                    <p>1. .................................................................................................................</p>
                    <p style="margin-left:20px;">Jawab: ........................................................................................................</p>
                    <p style="margin-left:20px;">.................................................................................................................</p>
                </div>
                <div style="margin:10px 0;">
                    <p>2. .................................................................................................................</p>
                    <p style="margin-left:20px;">Jawab: ........................................................................................................</p>
                    <p style="margin-left:20px;">.................................................................................................................</p>
                </div>
                <div style="margin:10px 0;">
                    <p>3. .................................................................................................................</p>
                    <p style="margin-left:20px;">Jawab: ........................................................................................................</p>
                    <p style="margin-left:20px;">.................................................................................................................</p>
                </div>
                
                <h4 style="margin:20px 0 10px;font-weight:bold;">üí≠ Refleksi</h4>
                <div style="border:1px solid #ddd;border-radius:8px;padding:15px;">
                    <p>Apa yang sudah kamu pelajari hari ini?</p>
                    <p>.................................................................................................................</p>
                    <p>.................................................................................................................</p>
                </div>
                
                <div style="margin-top:30px;text-align:right;">
                    <p>Nilai: ............</p>
                    <p>Paraf Guru: ............</p>
                </div>
            </div>
            <div class="mt-4">
                <button onclick="printDoc('lkpdDoc')" class="w-full py-2 bg-primary-600 text-white rounded-xl">üñ®Ô∏è Cetak LKPD</button>
            </div>
        `, { title: `üìù LKPD: ${data.judul}`, size: '3xl' });
    }

    // JURNAL - SINKRON DENGAN PROMES
    function renderJournal() {
        const classes = [...new Set(promesData.map(p => p.kelas))].sort();
        
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-8"><h1 class="text-2xl font-bold">üìì Jurnal Pembelajaran</h1><button onclick="printDoc('journalDoc')" class="px-4 py-2 bg-primary-600 text-white rounded-xl">üñ®Ô∏è Cetak</button></div>
                ${promesData.length ? `
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                        <p class="text-blue-700">üí° Pilih dari Promes untuk mengisi jurnal otomatis. Materi dan TP akan terisi sesuai jadwal.</p>
                    </div>
                ` : '<div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6"><p class="text-amber-700">‚ö†Ô∏è Lengkapi Kalender, Jadwal, dan CP untuk sinkronisasi jurnal dengan Promes.</p></div>'}
                <div class="bg-white rounded-2xl p-4 mb-6 flex flex-wrap gap-4">
                    <select id="jKelas" onchange="loadJournalPromes()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Kelas</option>${classes.map(k=>`<option value="${k}">${k}</option>`).join('')}</select>
                    <select id="jSem" onchange="loadJournalPromes()" class="px-4 py-2 border rounded-xl"><option value="">Pilih Semester</option><option value="1">Semester 1</option><option value="2">Semester 2</option></select>
                </div>
                <div id="journalContent" class="space-y-4"></div>
            </div>
        `;
    }

    function loadJournalPromes() {
        const kelas = document.getElementById('jKelas').value;
        const sem = document.getElementById('jSem').value;
        const container = document.getElementById('journalContent');
        
        if (!kelas || !sem) { container.innerHTML = ''; return; }
        
        const filtered = promesData.filter(p => p.kelas === kelas && p.semester === parseInt(sem));
        
        if (!filtered.length) {
            container.innerHTML = '<p class="text-center py-8 text-gray-500">Belum ada data Promes</p>';
            return;
        }
        
        const s = userProfile?.school || {};
        
        container.innerHTML = `
            <div id="journalDoc" class="print-doc print-area bg-white rounded-2xl p-6">
                ${generateDocHeader('JURNAL PEMBELAJARAN', `Semester ${sem}`)}
                <table style="border:none;margin-bottom:10px;"><tr style="border:none;"><td style="border:none;">Kelas</td><td style="border:none;">: ${kelas}</td></tr></table>
                
                <table>
                    <thead><tr><th style="width:25px">No</th><th>Kelas</th><th>Materi</th><th>Tujuan Pembelajaran</th><th style="width:80px">Kehadiran</th><th>Hari/Tanggal</th><th>Hasil</th></tr></thead>
                    <tbody>
                        ${filtered.map((p, i) => `
                            <tr>
                                <td style="text-align:center">${i+1}</td>
                                <td>${p.kelas}</td>
                                <td><strong>Bab ${p.bab}:</strong> ${p.judul}</td>
                                <td style="font-size:10pt">${(p.tp||[])[0]?.substring(0,80)||'-'}...</td>
                                <td style="text-align:center">H: __ S: __<br>I: __ A: __</td>
                                <td>${p.hari}, ${formatShortDate(p.tanggal)}</td>
                                <td>................</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                ${generateSignature()}
            </div>
        `;
    }

    // Attendance (simplified)
    function renderAttendance() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8"><h1 class="text-2xl font-bold">‚úÖ Absensi</h1></div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-blue-700">üí° Absensi terintegrasi dengan Jurnal. Data kehadiran akan otomatis masuk ke jurnal pembelajaran.</p>
                </div>
                <p class="text-gray-500">Fitur absensi tersedia di halaman Jurnal.</p>
                <button onclick="goTo('journal')" class="mt-4 px-6 py-3 bg-primary-600 text-white rounded-xl">üìì Buka Jurnal ‚Üí</button>
            </div>
        `;
    }

    // Grades (simplified)
    function renderGrades() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8"><h1 class="text-2xl font-bold">üìä Daftar Nilai</h1></div>
                <div class="bg-white rounded-2xl p-6">
                    <p class="text-gray-500 text-center py-8">Fitur daftar nilai dengan PH, PTS, PAS, dan Nilai Rapor.</p>
                </div>
            </div>
        `;
    }

    // Bank Soal (simplified)
    function renderBankSoal() {
        if (!isPremium()) { showUpgrade(); return; }
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8"><h1 class="text-2xl font-bold">üè¶ Bank Soal</h1></div>
                <div class="bg-white rounded-2xl p-6">
                    <p class="text-gray-500 text-center py-8">Fitur bank soal terintegrasi dengan ATP dan support teks Arab.</p>
                </div>
            </div>
        `;
    }

    // AI Assistant
    function renderAI() {
        const prompts = {
            cp: `Bantu saya breakdown Capaian Pembelajaran berikut menjadi Tujuan Pembelajaran (TP):\n\nCP: [paste CP]\nKelas: [isi]\n\nBuatkan 3-5 TP yang SMART.`,
            materi: `Bantu saya buat materi pembelajaran:\n\nTopik: [isi]\nKelas: [isi]\nDurasi: 2 x 35 menit\n\nBuatkan materi yang mudah dipahami siswa SD.`,
            soal: `Bantu saya buat soal penilaian:\n\nMateri: [isi]\nKelas: [isi]\nJumlah: 10 soal pilihan ganda\n\nSertakan kunci jawaban.`,
            csv: `Konversi data berikut ke format CSV:\n\n[paste data]\n\nFormat: nisn,nama,jenis_kelamin,kelas,rombel`
        };
        
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in max-w-4xl mx-auto">
                <div class="mb-8"><h1 class="text-2xl font-bold">ü§ñ AI Assistant</h1><p class="text-gray-500">Prompt siap pakai untuk AI</p></div>
                <div class="bg-white rounded-2xl p-6 mb-6">
                    <div class="grid md:grid-cols-2 gap-4">
                        ${Object.entries(prompts).map(([k,v])=>`<button onclick="showPrompt('${k}')" class="p-4 bg-gray-50 rounded-xl hover:bg-primary-50 text-left"><div class="text-2xl mb-2">${k==='cp'?'üéØ':k==='materi'?'üìö':k==='soal'?'‚ùì':'üìä'}</div><h3 class="font-bold">${k==='cp'?'Generate TP':k==='materi'?'Generate Materi':k==='soal'?'Generate Soal':'Format CSV'}</h3></button>`).join('')}
                    </div>
                </div>
                <div id="promptBox" class="hidden bg-white rounded-2xl p-6">
                    <div class="flex justify-between mb-4"><h2 class="font-bold">üìã Prompt</h2><button onclick="copyPrompt()" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm">Copy</button></div>
                    <pre id="promptText" class="bg-gray-50 rounded-xl p-4 text-sm whitespace-pre-wrap"></pre>
                </div>
            </div>
        `;
        window.showPrompt = k => { document.getElementById('promptBox').classList.remove('hidden'); document.getElementById('promptText').textContent = prompts[k]; };
        window.copyPrompt = () => { navigator.clipboard.writeText(document.getElementById('promptText').textContent); toast('Copied!', 'success'); };
    }

    // Guide
    function renderGuide() {
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in max-w-4xl mx-auto">
                <div class="mb-8"><h1 class="text-2xl font-bold">üìö Panduan</h1></div>
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4">1. Konsep Single Input - Multi Output</h2>
                        <p class="text-gray-600 mb-4">Cukup input data dasar sekali, dokumen akan saling sinkron:</p>
                        <div class="bg-primary-50 rounded-xl p-4"><p><strong>Input:</strong> Profil ‚Üí Kalender ‚Üí Jadwal ‚Üí CP</p><p><strong>Output:</strong> ATP, Prota, Promes (dengan tanggal detail), Modul Ajar, LKPD, Jurnal</p></div>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="text-xl font-bold mb-4">2. Langkah Penggunaan</h2>
                        <div class="space-y-4">
                            ${[
                                ['1', 'Profil', 'Isi data diri, NIP, sekolah, dan NIP Kepala Sekolah'],
                                ['2', 'Kalender', 'Atur tanggal mulai/akhir semester dan hari libur'],
                                ['3', 'Jadwal', 'Input jadwal mengajar (hari, jam, kelas)'],
                                ['4', 'CP/TP', 'Load CP PAI default atau input manual'],
                                ['5', 'Generate', 'Promes akan otomatis generate dengan tanggal detail'],
                                ['6', 'Modul & Jurnal', 'Pilih dari Promes, data terisi otomatis']
                            ].map(([n,t,d])=>`<div class="flex gap-4 p-4 bg-gray-50 rounded-xl"><div class="w-10 h-10 bg-primary-600 text-white rounded-full flex items-center justify-center font-bold">${n}</div><div><h4 class="font-bold">${t}</h4><p class="text-sm text-gray-600">${d}</p></div></div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Admin
    function renderAdmin() {
        if (currentUser?.email !== SUPER_ADMIN) { goTo('dashboard'); return; }
        document.getElementById('contentArea').innerHTML = `
            <div class="animate-fade-in">
                <div class="mb-8"><h1 class="text-2xl font-bold">‚öôÔ∏è Panel Admin</h1></div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="font-bold mb-4">üì± WhatsApp</h2>
                        <input type="text" id="adminWa" value="${CONFIG.wa}" class="w-full px-4 py-3 border rounded-xl mb-4">
                        <button onclick="saveConfig()" class="w-full py-2 bg-green-600 text-white rounded-xl">Simpan</button>
                    </div>
                    <div class="bg-white rounded-2xl p-6">
                        <h2 class="font-bold mb-4">üí∞ Harga</h2>
                        <input type="number" id="adminPrice1" value="${CONFIG.priceIndiv}" class="w-full px-4 py-3 border rounded-xl mb-2" placeholder="Perorangan">
                        <input type="number" id="adminPrice2" value="${CONFIG.priceSchool}" class="w-full px-4 py-3 border rounded-xl mb-4" placeholder="Sekolah">
                        <button onclick="saveConfig()" class="w-full py-2 bg-green-600 text-white rounded-xl">Simpan</button>
                    </div>
                </div>
            </div>
        `;
    }

    async function saveConfig() {
        CONFIG.wa = document.getElementById('adminWa').value;
        CONFIG.priceIndiv = parseInt(document.getElementById('adminPrice1').value);
        CONFIG.priceSchool = parseInt(document.getElementById('adminPrice2').value);
        await db.collection('settings').doc('app').set(CONFIG);
        toast('Disimpan!', 'success');
    }

    // ==================== AUTH STATE ====================
    auth.onAuthStateChanged(async user => {
        document.getElementById('loadingScreen').classList.add('hidden');
        if (user) {
            currentUser = user;
            await loadProfile();
            await loadAllData();
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            goTo('dashboard');
        } else {
            currentUser = null;
            userProfile = null;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
    });
    </script>
</body>
</html>
